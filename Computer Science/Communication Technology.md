# 大话通信

## 通信基础

- DICT:CT（Communication Technology）、IT（Information Technology）到ICT（IT+CT），从ICT再到DICT（ICT+DT，DT：Data Technology）
- 通信：通信技术研究的就是从信息的源头到信息的目的地整个过程的技术问题。
  - 根据接收对象的不同
    - 单播
    - 广播
    - 组播
  - 电信：或称电讯（英语：Telecommunication），是用电磁设备实现的利用有线电、无线电或光传输信息的通信方式。
  - 计算机网络（英语：computer network），通常也简称网络，是指容许节点分享资源的数字电信网络
    - 沟通语言：通信协议
      - 通信协议（英语：Communications Protocol，也称传输协议）：在任何物理介质中允许两个或多个在传输系统中的终端之间传播信息的系统标准，也是指计算机通信或网络设备的共同语言。通信协议定义了通信中的语法学、语义学和同步规则以及可能存在的错误检测与纠正。通信协议在硬件、软件或两者之间皆可实现
- 通信和数学不同。
  - 数学是诠释 大自然普遍规律的基础学科，任何定律，虽然是人发现的，但没有人 感性的成分存在。
  - 通信中的大量协议，是在科学基础上人为定义的，它符合科学规律，能够提高效率，但并非只能是这个范围，当然，在人们定义明确以后，就不 
    能再去随意更改和调整了

- 通信协议都是通过通信标准进行定义和规范
  - 通信标准是各个国家之间、机构之间、企业之间或者国家内部协商确定的。
  - 一些行业自己定义了自己的标准，一般称之为“行业标准”。

### 基础概念

- 信号：通信信道上传输的电编码、电磁编码或光编码叫作信号。信号分为模拟信号和数字信号两类。
  - 脉冲编码调制（英语：Pulse-code modulation，缩写：PCM）是一种模拟信号的数字化方法。PCM将信号的强度依照同样的间距分成数段，然后用独特的数字记号（通常是二进制）来量化。
- 信道：信道是传送信号的通路。信道本身可以是模拟方式的，也可以是数字方式的。用以传输模拟信号的信道叫作模拟信道，用以传输数字信号的信道叫作数字信道。
- 信息
  - 凡是在一种情况下能减少不确定性的任何事物都叫信息。
  - 哲学观点：信息是一种带普遍性的关系属性，是物质存在方式及其运动规律、特点的外在表现。
  - 通信观点：生物体通过感觉器官或具有一定功能的机器通过特定装置同外界交换的内容的总称。
- 数据：它是任何描述物体概念、情况、形势的事实、数字、字母和符号。
  - 数据（data）经由处理后称为信息（information），从这些信息中分析出来的讯息称为知识（knowledge），再通过不断地行动与验证，逐渐形成智慧（wisdom）
- 信息和数据的关系：数据是传递信息的实体，而信息是数据的内容或表达形式。
  - 无法用数据描述的信息是无法传递的，比如至今人类还无法通过电信网传递的气味、直觉等。

- 通信概念模糊的原因
  - 任何时代都不可能忽略过去多年的技术积累和资本投入，去重新设计一套与原有技术毫不相干的革命性技术并付诸实践。
  - 由于电信概念、机理和技术发展太快，专家们来不及仔细考虑某个标准定义可能带来的后果。
  - 相互替代性较强的概念，有的定义比较含糊
  - 通信专家的工作习惯和命名时存在的某些缺陷扩大了概念混淆
- 通信概念发展规律：长期上永恒的技术融合和技术发展，短期上不断产生新的、混淆的概念。

## 发展史

- 时期	
  - 古代通信，人类基于最原始的需求，利用自然界的基本规律和人的基础感官可达性建立通信系统
  - 近、现代通信，从电磁技术引入通信开始，人们尝试使用电话、电报、传真，到成规模地建设各种电信网络和专网网络，并创造 了性能更强、质量更好、效率更高的数字通信、光纤通信。
  - 当代通信，是指在前人基础上创造的移动通信、互联网通信、物联网和融合技术的发展历程。
  - 未来通信，是在目前人类文明和科技发展的基础上，在可以预见和不可预见的未来，更加强大的通信工具变革和更加广阔的通信发展前景。

### 古代通信:信息沟通的起步

- 烽火通信是典型的“存储——转发”模式的、半双工模式的（两个相邻烽火台可以互相传递但不能同时互相传递信息）、广播模式的（传递给所有可看到的地方）、可视模式的 （必须视线可达）、无线模式的（没有连接线）、数字化的（只有两种状态“无”和“有”）通信手段。
- 人类的文明史，就是网络的发展史。

### 近现代通信:电磁通信和数字时代的起步

- 利用电和磁的技术，实现通信目的，被称为“电信”。
  - 近代通信起始的标志，就是开始应用“电信技术”。
  - 电磁技术最早的电信应用，就是电报。电报的原理是人们用长、短音电信号来标识文字或者词汇，相当于给每个字（或字母）做了一个编码，发报员只要按照编码把文字或者词汇翻译并通过专用的发报装置发送出去即可。
- 名词
  - ENIAC电子数值积分计算机（英语：Electronic Numerical Integrator And Computer）
  - STM：同步转移模式（synchronous transfer mode）是指传统的电路传送模式，也就是电路交换模式（CSM）+时分复用传输（TDM）。
  - PSTN：公共交换电话网（Public Switched Telephone Network或简称PSTN）是一种用于全球语音通信的电路交换网络，是目前世界上最大的网络，拥有用户数量大约是8亿。PSTN包括电话线（双绞线），光纤电缆，微波传输链路，蜂窝网络，通信卫星，与海底电话电缆，所有互连通过交换中心包括移动和固定电话，从而允许在世界上的任何电话与任何其他终端通信。最初是固定线路的模拟电话系统的网络，PSTN的核心目前几乎已完全数字化。
  - ISDN：综合业务数字网（Integrated Services Digital Network，ISDN）是一个数字电话网络国际标准，是一种典型的电路交换网络系统。ISDN是一种在数字电话网IDN（该网能够提供端到端的的数字连接）的基础上发展起来的通信网络，ISDN能够支持多种业务（包括电话业务以及非电话业务）。ISDN的最重要特征是能够支持端到端的数字连接，并且可实现传统话音业务和分组数据业务的综合，使数据和话音能够在同一网络中传递。
  - ITU：国际电信联盟（ 英语：International Telecommunication Union，简称 ITU）是一个国际组织，主要负责确立国际无线电和电信的管理制度和标准。它的前身是1865年5月17日在巴黎创立的国际电报联盟，是世界上最悠久的国际组织。

- 在模拟PSTN形态的基础上,形成了综合数字网(IDN)的形态。成就
  - 统一了语音信号数字编码标准;
  - 用数字传输系统代替模拟传输系统;
  - 用数字复用器代替载波机;
  - 用数字电子交换机代替模拟机电交换机;
  - 发明了分组交换机。

### 当代通信:移动通信和互联网时代

- 新技术的探索是随着经济的发展、各种自然基础学科的发展、人们生活方式的改变而不断深入的。
- 许多被看好的技术惨遭淘汰,而很多不被看好的技术却异军突起。

### 未来通信:大融合时代

- 一切皆有可能

## 通信的实现

- 人类最大的缺点就是永不满足,人类最大的优点也是永不满足
- 方式：书信、旗语、电报、电话、手机、计算机。。。

### 电信网中的通讯工具

- 电话机，通信网昔日第一终端：电话机是指“固定电话”，曾经是人类最普遍使用的通信终端，统治全球的通信界近100年的时间。电话机是通过电信号双向传输话音的终端设备。早期电话机的原理为：说话声音为空气里的复合振动，可传输到固体上，通过电脉冲于导电金属上传递。
- 传真，不可或缺的通信配角：传真机将需发送的原件按照规定的顺序，通过光学扫描系统分解成许多微小单元（称为像素），然后将这些微小单元的亮度信息由光电变换器件顺序地转变成电信号，经放大、编码或调制后转化为一种被称为“霍夫曼编码”的数字信号送至信道。接收机将收到的信号放大、解码或解调后，按照与发送机相同的扫描速度和顺序，以记录的形式复制出原件的副本。
- 手机，第一终端：移动电话，又称手提式电话机或手提电话，简称手机，是可以在较大范围内使用的便携式电话。
  - 个人数字助理（英语：personal digital assistant，缩写：PDA），一般是指像手机一样大小，却拥有电脑等级硬件的移动电子设备
- 寻呼
- 电报，逐渐消逝的电波。

### 互联网的通讯工具

- 电子计算机（亦称电脑）是利用数字电子技术，根据一系列指令指示并且自动执行任意算术或逻辑操作串行的设备。通用计算机因有能遵循被称为“程序”的一般操作集的能力而使得它们能够执行极其广泛的任务。

### 专业领域的通信工具

- 对讲机

### 家电中的通信工具

- 电视机
- 智能家电
- 智能穿戴设备

## 通信的原理

- 通信的根本问题是报文的再生，在两个端点上报文应该精确地或者近似地重现
- 问题和解决方法
  - 用什么方式传递给对方？
    - ==编码==问题。研究类似人 类语言学的问题，用什么样的表达方式表述信息，通过什么媒介将表述内容传递到对方（假设已经能够确定找到对方），对方能够接收并接受？
  - 如何找到对方？
    - ==寻址==问题。研究类似门牌号码规划、寻找道路等问题。
  - 有没有信息传递的额外要求，如安全、便捷、节约、多需求的并行处理？
    - ==优化==问题。研究加密、节省成本、提高效率、增强管理、方便运营等问题。

- 编码综述

  - 如何把声音、图像、文字等信息变成电磁信号，如何把一系列的电磁信号有效地传送到对方，又如何在对端还原为声音、图像和文字

  - 任何选择都是适应需求的，“绝对适合”任何场景和需求的选择是不存在的。任何编码都是为了适应不同的传送需求

  - 电磁信号的可复制性和可再生性，差错控制。


- 寻址综述

  - 给任何信息的出发点和目的地做个编号, 通过编号可以识别世界.上任何一个出发点和目的地
    - 如何在一个局部区域分配了地址之后，能够让全网知道该地址所在的位置。

  - 通过相关机制，使信息依照一定的路径在这两者之间传送。
    - 寻址方式
      - 用信令寻址后自动建立专门的通道
      - 在路由器上做好路由策略，让数据包根据这些策略寻找到达目的地的路径
      - 将目的地址在全网做广播宣告，真正的目的地址给出回应
      - 在出发地和目的地之间人工建立一条专门的通道等


  - 无论是电话网、传输网，还是数据网，都各有各的编址方法和寻址方法；
    - 移动通信中的FDMA（频分多址，如TACS、 AMPS）、时分多址（TDMA）、码分多址（CDMA）等技术体制， 都有一整套完善的寻址方式。


- 网络优化综述

  - 人们改造世界的过程：先保证解决基本问题，再思考如何用更好的方法解决问题。
    - 网络优化，就是在基本的通信问题（如连通性、信息还原能力）得以解决后，如何更方便、快捷、安全、经济地规划网络、建设网络、使用网络的问题。

  - 互相通信问题：用什么方式能让许多人都能同时通话而投入的平均成本不会大幅度增加？有没有方法让很多人共用中间的传送线缆。

  - 信息交互方式
    - “面向连接”。建立一条确定的线路然后传送信息
      - 实现：PSTN、帧中继、ATM、MPLS网络
    - “无连接”。让每个信息源发出的信息包“一跳一跳”（Hop-Hop）向下一个网络节点迈进，即采用“存储——转发”模式
      - 实现：传统IP网络

  -  优化的高级阶段：人性化

    - 通信理念发展的进程：前人无，我有->前人有，我优->前人优，我人性化。“人性化”是优化问题的高级阶段。

    - “用户体验”,人性化是一个很难标准化的东西，但却是目前通信领域中最重要的课题之一

### 编码

- 背景
  - 以太的由来：19世纪，科学家们逐步发现光是一种波，而生活中的波大多需要传播介质（如声波的传递需要借助于空气，水波的传播借助于水等）。受经典力学思想影响，于是他们便假想宇宙到处都存在着一种称之为以太的物质，是这种物质作为光的传播中的介质。
  - 网络价值与用户数的平方成正比。网络使用者越多，价值就越大。
    - 网络的价值V =K ×N  ；（K  为价值系数，N  为用户数量。）
  - 编码是通信的基本组成部分，是通信里面的“语文课”
  - 信息用什么信息格式传送到目的地
    - 信息论中的信源编码和信道编码过程
    - 数模、模数转换、抽样、复用解复用
    - 各种数据帧、分组、信元等数据报文的封装格式。

- ==香农公式==：“在被高斯白噪声干扰的信道中，计算最大信息传送速率C 的公式”：C =B log2 （1+S /N ）。
  - B 是信道带宽 （Hz）
    - **信道**、频道或波道，是信号在通信系统中传输的通道，由信号从发射端传输到接收端所经过的传输媒质所构成。
    - **带宽**（英语：Bandwidth）指信号所占据的频带宽度；在被用来描述信道时，带宽是指能够有效通过该信道的信号的最大频带宽度。对于模拟信号而言，带宽又称为频宽，以赫兹（Hz）为单位。对于数字信号而言，带宽是指单位时间内链路能够通过的数据量。为了与模拟带宽进行区分，数字信道的带宽一般直接用波特率或符号率来描述。
  - S 是信号功率（W）
  - N 是噪声功率（W）
    - **噪声**（英语：Noise）在电子学中指，信号在传输过程中会受到一些外在能量所产生信号（如杂散电磁场）的干扰，这些能量即噪声。噪声通常会造成信号的失真。其来源除了来自系统外部，亦有可能由接收系统本身产生。噪声的强度通常都是与信号带宽成正比，所以当信号带宽越宽，噪声的干扰也会越大。
    - **信噪比**（英语：Signal-to-noise ratio，缩写为SNR或S/N），又称訊噪比，用于比较所需信号的强度与背景噪声的强度。其定义为信号功率与噪声功率的比率，以分贝（dB）为单位表示。大于比率1:1（高于0分贝）表示信号多于噪声。
  - 信道容量C 与信道带宽B 成正比，同时还取决于系统信噪比以及编码技术种类。
- ![[Coding_mod_channel.png]]
  - **调制信道**是指信号从调制器的输出端传输到解调器的输入端经过的部分。对于调制和解调的研究者来说，信号在调制信道上经过的传输媒质和变换设备都对信号做出了某种形式的变换，研究者只关心这些变换的输入和输出的关系，并不关心实现这一系列变换的具体物理过程。这一系列变换的输入与输出之间的关系，通常用多端口时变网络作为调制信道的数学模型进行描述。
  - **编码信道**是指数字信号由编码器输出端传输到译码器输入端经过的部分。对于编译码的研究者来说，编码器输出的数字串行经过编码信道上的一系列变换之后，在译码器的输入端成为另一组数字串行，研究者只关心这两组数字串行之间的变换关系，而并不关心这一系列变换发生的具体物理过程，甚至并不关心信号在调制信道上的具体变化。编码器输出的数字串行与到译码器输入的数字串行之间的关系，通常用多端口网络的转移概率作为编码信道的数学模型进行描述。

####声音->模拟信号

- 声音是振动产生的声波，通过介质（气体、固体、液体）传播并能被人或动物听觉器官所感知的波动现象。振幅和频率
- 模拟信号（英语：analog signal）是指在时域上数学形式为连续函数的讯号。
- 贝尔发明的碳粒电话机，是基于振膜对碳粒造成忽紧忽松的压力引起其电阻大小的变化
  - 电流=电压/ 电阻，在电阻变化而电压不变的情况下，电流就会发生线性变化。
  - 忽大忽小的电流，就是电信信号。假设这些信号已经陆续传送到对方的听筒。听筒内有一电磁铁随电流大小而磁性不同，它对埋有金属丝的薄膜时吸时 
    放，薄膜便发出了像人说话一样的声音。
- 转换方式
  - 以信号的原始频率（或称为“基带频率”）表示或以另一种频率表示。
  - 电话网络可以将我们的信号与另一更高频率的信号（称为“载波”）结合，然后在不同的频率上传输这些合成的信号。
    - **载波**（carrier wave）是指被调制以传输信号的波形，一般为正弦波。一般要求正弦载波的频率远远高于调制信号的带宽，否则会发生混叠，使传输信号失真。
    - **调制**（英语：modulation）是一种将**一个或多个周期性**的载波混入想传送之信号的技术，常用于无线电波的传播与通信、利用电话线的数据通信等各方面。依调制信号的不同，可区分为数位调制及类比调制，这些不同的调制，是以不同的方法，将信号和载波合成的技术。调制的逆过程叫做“解调”，用以解出原始的信号。
    - 在模拟调制中，表示数据的模拟信号被转换成另一模拟信号，后者就是“已调载波”。

#### 模数/数模转换( A/D和D/A )、PCM和线路编码

- 背景
  - 模拟信号在传输过程中，由于受到外界干扰，总能量会损失惨重，信号本身也会发生畸变和衰减。
- 如果模拟信号以规则的时间间隔抽样，且抽样速率是模拟信号中最高频率的两倍，那么所得样本是原始信号的精确表示。
  - **滤波器**：由电容、电感和电阻组成的滤波电路。滤波器可以对电源线中特定频率的频点或该频点以外的频率进行有效滤除，得到一个特定频率的电源信号，或消除一个特定频率后的电源信号。
  - 人类语音产生的频率的正常范围是300～ 3400Hz。分配4000Hz的信道，当模拟语音信号转换为数字形式时，要保证每秒8000次抽样。
  - 脉冲信号变成数字信号的过程中的关键步骤：量值“阶梯量化”，因为数字信号要求脉冲幅度只能取有限个数值。
  - 把每次抽样的幅度按照256个阶梯排列，每个排列都是一个8位的二进制数。8000×8=64000，也就是64kbit。将64kbit/s称为一路语音信号的带 
    宽需求量。这种量化的方式被称为==脉冲编码调制==（PCM，Pulse Code Modulation）。
    - 脉冲编码信号是一种类比信号(模拟信号)的数位化方法。PCM将信号的强度依照同样的间距分成数段，然后用独特的数位记号（通常是二进位）来量化。
  - 信道编码：将数字信息转换为可以在线路上传送的数字信号的过程。
    - 曼彻斯特编码（Manchester coding），又称自同步码、相位编码（phase encoding，PE），能够用信号的变化来保持发送设备和接收设备之间的同步。它用电压的变化来分辨0和1，从高电平到低电平的跳变代表1，而从低电平到高电平的跳变代表0
    - 差分曼彻斯特编码在每个时钟周期的中间都有一次电平跳变，这个跳变做同步之用。 在每个时钟周期的起始处：跳变则说明该比特是0，不跳变则说明该比特是1。
    - 不归零编码 (non-return-to-zero line code, NRZ) ：信号电平的一次反转代表1，电平不变化表示0，并且在表示完一个码元后，电压不需回到0
    - 原因：要考虑误码率最低、传送准确率最高、最易于差错恢复，需要遵从电流在导线中传导的物理规律。这就造成不同的技术体制采用的信道编码方式会有一定的差异。

#### 复用与解复用

- 方式
  - 时分多路复用（Time-Division Multiplexing，TDM）是一种数字或者模拟（较罕见）的多路复用技术。两个以上的信号或数据流同时在一条通信线路上传输，时间域被分成周期循环的一些小段，每段时间长度是固定的，每个时段用来传输一个子信道。
    - Timeslot（时隙）专用于某一个单个通道的时隙信息的串行自复用的一个部分，通常指PCM E1和T1信号中的一个话音信道（64kbps）。是时分复用模式（TDM）中的一个时间片。
  - 频分多路复用（Frequency-division multiplexing，FDM），也叫分频多任务，是一种将多路基带信号调制到不同频率载波上再进行叠加形成一个复合信号的多路复用技术。
  - 波分复用（Wavelength Division Multiplexing，WDM）是利用多个激光器在单条光纤上同时发送多束不同波长激光的技术。每个信号经过数据（文本、语音、视频等）调制后都在它独有的色带内传输。
- “同步”：在若干个语音64kbit/s的信息流汇聚到一起时，必须步调一致，就像一个大型乐队，需要步调一致才能奏出美妙的音乐。

#### 波特率和比特率

- 波特率是指载波调制状态以多进制数表示时单位时间内信号状态的改变次数。当采用二进制时，即为比特率。

#### 数据技术的数据格式

- 技术体制采用不同的编码格式原因
  - 道路的特征：比如单行道和双向车道是不一样的，车道宽窄是不一样的，水运和空运是不一样的，道路不同，选用容器的类型也不完全相同。
  - 货物的特征：运送不同类型的货物，选用容器的类型也会相同。
  - 货物本身的运送要求：时间要求、安全性要求、完整性要求等，都会对选用容器的类型带来影响。
- 技术本身的特性和所承担的业务类型，决定了其编码格式。编码格式也决定了这种技术本身的特性和适用的业务类型。
- 在数据通信中，各种技术体制都有自己对数据格式的严格定义， 而每种技术体制的数据格式名称各不相同，加上翻译方法上的差别， 造成名称不像数据格式的定义那样统一。
  - IP的数据格式，有的人称为“IP数据包”（IP Packet），有的人称为“IP数据报”（IP Datagram）；
  - 以太网的数据格式，有的人称为“以 太网数据报”（Ethernet Datagram），有的人称为“以太网帧”（Ethernet Frame）；
  - 最统一的叫法，是帧中继中的“帧”和ATM技术中的“信元”（Cell）。
  - 一般来说，“数据报”是比较通用的说法，不限定在任何层，也不限定任何技术；而“帧”一般指数据链路层的数据报；“数据包”一般指网络层的数据报。

##### 以太网帧

- 逻辑上，以太网使用总线型拓扑和载波侦听多路访问——冲突检测（CSMA/CD，Carrier Sense Multiple Access/Collision Detect）的总线争用技术。
- 以太网采用总线型结构，一根主线贯穿始末，其他的线只是主线的分叉，每台主机都通过网线连接到“总线”上
  - 状态切换
    1. 开始：如果线路空闲，则启动传输，否则转到第4步
    2. 发送：如果检测到冲突，继续发送数据直到达到最小报文时间（保证所有其他转发器或终端检测到冲突），再转到第4步。
    3. 成功传输：向更高层的网络协议报告发送成功，退出传 输模式。
    4. 线路忙：等待，直到线路空闲。
    5. 线路进入空闲状态：等待一个随机的时间，转到第1步，除非超过最大尝试次数。
    6. 超过最大尝试传输次数：向更高层的网络协议报告发送失败，退出传输模式。
  - 问题：以太网上的任何节点都可以选择是否监听线路上传输的所有信息
  - 以太网帧：![[image-20220718154143615.png]]
    - 循环冗余校验（Cyclic redundancy check，CRC）：是一种根据网络数据包或电脑文件等数据产生简短固定位数校验码的一种散列函数，主要用来检测或校验数据传输或者保存后可能出现的错误。生成的数字在传输或者存储之前计算出来并且附加到数据后面，然后接收方进行检验确定数据是否发生变化。
    - 前导码和帧开始符：采用0和1交替出现的7个字节的前导码和1个字节的帧开始符作为帧的开始
    - 以太网帧的长度是64~1518字节。

##### IP数据包格式

- ![[image-20220718155710397.png]]
  - 版本号：版本号类型为IPv4和IPv6。
  - 首部长度：这是指IP包头的长度。IPv4以32 位（4字节）为一个单位，从“首部长度”4位的情况看，IP包头最大也就64字节，512位。
  - TOS：标识传送优先级。在具有QoS保障的IP网络，比如MPLS里，TOS的意义才真正体现出来。这个字段由现在不再使用的3个优先权位、4个TOS位和1个必须为0的未用位组成。4个TOS位是：最小延迟、最大吞吐量、最高可靠性和最小费用。这4位只能有1位为1
  - 字节总长度：这是整个IP包的总长度指示，以字节为单位。用这个字段和包头长度做减法，可以得出IP包中 
    数据部分的起始地址和长度。最大尺寸是2的16次方，即65536字节。	
  - 标识：第几个包
  - 片偏移：在最早那个数据包中的位置。标识和片偏移配合使用，才能使分段和重组工作正常进行。
  - 存活時間（Time To Live）：能跨越多少台路由器
  - 协议：携带的信息是属于哪类服务协议。1是ICMP，2是 IGMP，6表示TCP，17表示UDP。
  - 头检验：包头检验值。仅在包头范围进行计算，不涉及包头后面的任何数据。校验的目的只有一个：判断IP包头是否被正确传输。
  - 选项：是该数据包可选信息的可变长列表。
  - 数据：这是IP数据包携带的真实的数据信息。IP数据包其他所有字段，都是为了传送本字段而设立的。

##### 帧中继帧格式

- 特点：用户信息以帧（frame）为单位进行传送，网络在传送过程中对帧结构、传送差错等情况进行检查，对出错帧直接予以丢弃，同时，通过对帧中地址段DLCI的识别，实现用户信息的统计复用。

##### ATM信元

- 异步传输模式（ATM Asynchronous Transfer Mode）、同步传输模式（STM Synchronous Transfer Mode）
- 通信网上的传递方式可分为同步传递方式（STM）和异步传递方式（ATM）两种。
  - STM：在由N 路原始信号复合成的时分复用信号中，各路原始信号都是按一定时间间隔周期性出现。PCM编码格式属于STM
  - ATM：各路原始信号不一定按照一定的时间间隔周期性地出现，因而需要另外附加一个标志来表明某一段信息属于哪一段原始信号。
- ATM的工作原理是：每个分组作为一个单元独立传输，分组之间的传输间隔为任意时间。
  - 信元的开始：ATM的信元头中藏有相关信息，可以识别信元处在哪个位置。这个隐藏的信息就是HEC。
  - 信元的逻辑链路归属：ATM信元头中的VPI/VCI值，就是链路标识符，通过这两个值的搭配使用，系统就能很容易识别这个信元属于哪条逻辑链路

##### SDH与SONET

- 同步数字体系（SDH）与同步数字光纤网（SONET）是国际电信传输的两大标准体系，它们统一了世界上原有的数字传输系列，实现了数字传输体制上的国际标准及多厂家设备的横向兼容，比准同步数字体系（PDH）有更多的优势。
  - 语音、数字数据网（DDN）、帧中继、以太网、IP、ATM都可以承载在SDH/SONET 上。

#### 图像和视频编码

- 通信中提到的图像和视频，有一个专用的英文词叫作Videograph，研究的核心问题是如何实时地传送它们。
  - 实时性要求
  - 清晰度
  - 音画同步
- 大规模应用的基础：国际音视频编解码标准
  - ISO制定的MPEG系列标准
  - ITU针对多媒体通信制定的H.26X系列视频编码标准和 G.7系列音频编码标准。
- H.265目的：在有限带宽下传输更高的网络视频，仅需原先的一半带宽，就可以播放相同质量的视频
- 第二代“信源编码”标准AVS：“信源”是信息的“源头”，信源编码技术解决的重点问题是数字音视频海量数据（初始数据、信源）的编码压缩问题，故也称“数字音视频编解码技术”。

### 寻址

- 交换机类别
  - 步进制自动交换机
    - 程控交换机
- 通信方向：两个网络节点设备之间的数据流方向，并不是指管线本身的数据流方向
  - 单工（Simplex）：数据只能在一个方向上流动，如传统的电视信号传送。
  - 半双工（Half-Duplex）：可切换方向的单工通信，从某一时刻看，是单工的；从总体看，又是双工的，如行业使用的对讲机。
  - 全双工（Full-Duplex）：通信允许数据在两个方向上同时传输，它在能力上相当于两个单工通信方式的结合，如我们的电话、互 
    联网、交互式视频通信等。
- 在任何一个通信网络上，每个节点都需要有规范的、可查询的地址标识。
- 不同的网络，地址标识的设置方式不同。
- 有了地址，还要有找到地址的方法。而同类的网络节点，寻址的方式、方法以及规则必须相同或者类似
  - 路由表（routing table）或称路由择域信息库（RIB, Routing Information Base），是一个存储在路由器或者联网计算机中的电子表格（文件）或类数据库。
    - 路由表存储着指向特定网络地址的路径（在有些情况下，还记录有路径的路由度量值）。
    - 路由表中含有网络周边的拓扑信息。
    - 路由表建立的主要目标是为了实现路由协议和静态路由选择。

#### 电路交换网寻址

- 电话交换网的地址编号就是我们熟悉的电话号码。电话号码在全球都有统一的规范。
  - 原则
    - 电话交换网上的电话号码（地址）必须统一分配
    - 任何电话交换机都必须了解这一分配规则
    - 电话交换机将无条件执行人赋予它的功能
    - 电话交换网上的终端才分配号码，交换机本身并不分配电话号码
  - 分配
    - 给每个国家分配一个唯一标识的国家代码,比如中国是86,美国1
    - 中国大陸手机号码以1开头（未来预留92和98开头），共11位数，前7位数字通常称为手机号段，可用于区分运营商和归属地，其作用类似于固定电话区号，但并不能相互对应。 示例：1XX-YYYY-ZZZZ
      - 第1~3位数表示电信运营商（1XX）；
      - 第4~7位数表示地区号码，即归属地（YYYY）；
      - 第8~11位数表示客户号码（ZZZZ）。

#### 以太网内的寻址

- MAC地址（英语：Media Access Control Address），直译为媒体存取控制位址，也称为局域网地址（LAN Address），MAC位址，以太网地址（Ethernet Address）或物理地址（Physical Address），它是一个用来确认网络设备位置的位址。
- 工作方式：初始节点是根据目标节点的地址 ，将目标节点的IP地址映射到中间节点的MAC地址，找到第一个中间节点。从第一个中间节点出发，根据目标节点的IP地址映射到第二个中间节点的MAC地址，从而找到第二个中间节点……，以此类推，直到当找到最后一个中间节点后，从最后一个中间节点出发，根据目标节点的地址映射到目的节点的MAC地址，从而将数据包传送给目标主机。
  - 不断地将目标节点的地址映射到一个个中间节点的MAC地址，再从一个个中间节点出发，直到找到最终的目标节点
  - MAC地址和IP地址的映射关系，被每台主机不断更新并保存，就成了“地址映射表”。

#### IP网的寻址

- 全球唯一的IP网地址管理机构，互联网名称和数字地址分配机构（ICANN）负责负 IP地址的空间分配、协议标识符的指派、通用顶级域名（gTLD）以 及国家和地区顶级域名（ccTLD）系统以及根服务器系统的管理
- IP网络中，所有的终端都应该有IP地址，而网络上的路由器和带路由功能的交换机，一般情况下每个路由接口也都应分配IP地址
- 组成
  - “主机地址”
  - “子网掩码”，用来标识该IP地址所在的子网（大部分是局域网）网段有多大。
- 分类![[image-20220718180228797.png]]
  - A类、B类和C类是最常用的单播IP地址，D类地址用于组播，E类地址被保留用于扩展和实验开发与研究。
  - 特殊功能地址
    - 0.0.0.0/0，未知网络，通常默认保留，常用于代表“缺省网络”，在路由器表中用于描述“缺省路径”。缺省路径的意思是享有最低优先级，在没有特别定义的情况下，IP数据包会按照该地址所定义的路由表项进行转发。
    - 127.0.0.0/8，表示回环地址和本地软件回送测试之用，保留而不分配。
    - 255.255.255.255/32，有限广播地址。
    - 私有IP地址：![[image-20220718180651102.png]]
      - 这3个IP地址段不会被互联网的公用服务器使用，而是在局域网中使用。

- **域名系统**（英语：Domain Name System，缩写：DNS）是互联网的一项服务。它作为将域名和IP地址相互映射的一个分布式数据库，能够使人更方便地访问互联网。DNS使用TCP和UDP端口53[1]。当前，对于每一级域名长度的限制是63个字符，域名总长度则不能超过253个字符。

##### IP路由

- IP路由的技术原理，就是将任何一个IP数据包的目的IP地址取出，与路由表对照，定位出口在哪里，并将IP数据包输送到该出口上去。当然，如果该输出端口为帧中继端口，那么IP数据包必须按照相关规范封装成特定DLCI值的帧中继帧格式，从该端口传送出去。
- 在PSTN里，每台交换机都存储着一张路由表，这张表，是人为输入的。整个PSTN是一个完全可管理的、可控制的、分层的网络。
- IP路由协议就是路由表获取和建立的机制
  - IP路由协议，如RIP2、OSPF、IS-IS和BGP
- 某主机发送同一数据包到多台主机（一次的、同时的），叫作“组播”。组播可以在一个局域网范围，也可以扩展到整个IP世界。
  - 组播能使一个或多个组播源把数据包只发送给特定的组播组。只有加入该组播组的主机才能接收到数据包，并不影响组播组之外的其他终端。
  - 组播组的地址：5类IP地址中的D类地址。这类地址的范围是224.0.0.0～239.255.255.255，它们又被划分为局部链接组播地址、预留组播地址、管理权限组播地址3类。
    - 局部链接组播地址是为路由协议和其他用途保留的地址，范围是224.0.0.0～224.0.0.255，只有256个地址，路由器并不转发属于这个范围的IP包。
    - 预留组播地址为224.0.1.0～238.255.255.255，可用于全球范围的网 
    - 管理权限组播地址是剩下的239.0.0.0～239.255.255.255，可供组织内部使用，类似于私有IP地址，不能用于互联网，可限制组播范围。
- 一台主机发送同一数据包到**子网**内所有主机，叫作“广播”

### 优化

- 拓扑学：拓扑学（英语：Topology）也可写成拓朴学，或意译为位相几何学，是一门研究拓扑空间的学科，主要研究空间内，在连续变化下维持不变的性质。在拓扑学里，重要的拓扑性质包括连通性与紧致性。
- “优化”隐藏在通信领域的每个细节中，是对诸多技术体制、诸多工程实践的高度浓缩，它无孔不入、无处不在、见缝插针，又由表及里、由外至内、由浅至深。
  - 融入编码、复用、寻址、交换、传输、信令、安全、调度、开发、建设、运维等各个环节中去
    - 网络节点、网络拓扑、拥塞控制、网络安全
    - 内容分发网络（CDN）、VPN技术、P2P、边缘计算、雾计算、负载均衡
    - SDH网的自动倒换技术
- 而“优化”又是相对的，新的代替旧的，先进的代替落后的，哪怕同一种技术体制内，也会出现越来越频繁的技术迭代
- 数据网络互连和安全
  - 多协议标签交换（Multi-Protocol Label Switching，MPLS）是一种在开放的通信网上利用标签引导数据高速、高效传输的新技术。多协议的含义是指MPLS不但可以支持多种网络层层面上的协议，还可以兼容第二层的多种数据链路层技术。
  - 软件定义网络（Software Defined Network，SDN）是一种新型网络创新架构，是网络虚拟化的一种实现方式。其核心技术OpenFlow通过将网络设备的控制面与数据面分离开来，从而实现了网络流量的灵活控制，使网络变得更加智能，为核心网络及应用的创新提供了良好的平台。
    - SD-WAN（软件定义广域网）：SD-WAN(软件定义广域网)产品，是利用SDN(软件定义网络)的技术，通过将网络硬件与其控制平面分离，简化WAN的部署与管理，同时结合了广域网优化、基于应用的智能选路、私有的安全加密隧道、端到端的QoS和全球骨干网等技术，为企业构建高速安全、稳定可靠的广域网，同时大幅降低部署和运维成本，并可基于业务视角来快速构建企业网络。
- 节能与综合利用是通信行业的一个综合优化领域，是关系国计民生的重要课题，也是通信网络优化最严肃、最迫切的课题之一。

#### 通信分层结构

- 作用
  - 每层的职责范围明确定义
  - 明确层之间的关系
  - 明确对等层之间的关系
- 要求
  - 要分出若干层次，管理上类似的功能要放在同一层，在实现技术经常变化的地方增加层次，每个层次有自己的职责；
  - 要明确每个层次与上下层的关系，层次之间的边界要合理，使层次间的信息流量尽量最小；
  - 要明确每个层面与其对等层面的关系。
- 设计：ISO/OSI（International Organization for Standardization/Open Systems Interconnection）
  - 层次
    - 物理层：物理层解决最基础的传送通道问题，涉及建立、维护和释放物理链路所需的机械的、电气的/光学的、功能的和规程的特性等
    - 数据链路层：在物理层提供的按“位（bit）”服务的基础上，在相邻的网络节点之间提供简单的、以帧为单位传输的数据，同时它还强调数据链路不要拥堵，减少出错，出错了要想办法弥补。
    - 网络层：在数据链路层的“帧”的服务上，网络层所干的工作，就是进行路由选择、拥塞控制和网络互连。
    - 传输层：在网络层的“数据包”的服务上，传输层的任务是向用户提供可靠的、透明的端到端的数据传输， 以及差错控制和流量控制机制。
      - 面向连接：在一次通信过程中，信令在需要通信的双方或者多方之间呼叫， 利用网络资源建立起一条通道，并在这条通道上传递信号，在通信结束后关闭这一通道，这就是面向连接。
      - 面向非连接：在一次数据传送过程中，数据包逐节点传递，在每个网络节点上，根据数据包中的目的地址，借助于网络节点的路由信息，选择通往下一个节点的通道。
    - 会话层：在不同的机器之间提供会话进程的通信，如建立、管理和拆除会话进程。会话层还提供了许多增值服务，如交互式对话管理、允许一路交 
      互、两路交换和两路同时会话；管理用户登录远程系统；在两机器之间传输文件，进行同步控制等。
    - 表示层：表示层就是处理通信进程之间交换数据的表示方法，包括语法转换、数据格式的转换、加密与解密、压缩与解压缩等。
    - 应用层：应用层负责管理应用程序之间的通信。应用层为用户提供最直接的服务，包括虚拟终端、文件传输、事务处理、网络管理等。
- TCP连接的建立
  - 第一次握手：建立连接时，客户端发送SYN包到服务器，并进入SYN_SEND（已经发送SYN）状态，等待服务器确认。
  - 第二次握手：服务器收到SYN包，必须确认客户的SYN，同时自己也发送一个SYN包，即SYN+ACK包，此时服务器进入SYN_RECV（已经接收到SYN）状态。
  - 第三次握手：客户端收到服务器的SYN＋ACK包，向服务器发送确认包ACK，这个包发送完毕，客户端和服务器进入ESTABLISHED（已经建立）状态，完成3次握手。之后，客户端与服务器开始传送数据。
- TCP连接的断开
  1. 客户端调用 close() 函数后，向服务器发送 FIN 数据包，进入FIN_WAIT_1状态。FIN 是 Finish 的缩写，表示完成任务需要断开连接。
  2. 
     1. 服务器收到数据包后，检测到设置了 FIN 标志位，知道要断开连接，于是向客户端发送“确认包”，进入CLOSE_WAIT状态。
        - 注意：服务器收到请求后并不是立即断开连接，而是先向客户端发送“确认包”，告诉它我知道了，我需要准备一下才能断开连接。
     2. 客户端收到“确认包”后进入FIN_WAIT_2状态，等待服务器准备完毕后再次发送数据包。
  3. 等待片刻后，服务器准备完毕，可以断开连接，于是再主动向客户端发送 FIN 包，告诉它我准备好了，断开连接吧。然后进入LAST_ACK状态。
  4. 客户端收到服务器的 FIN 包后，再向服务器发送 ACK 包，告诉它你断开连接吧。然后进入TIME_WAIT状态。
     - 服务器收到客户端的 ACK 包后，就断开连接，关闭套接字，进入CLOSED状态。

#### 复用技术

- 确定复用
  - 在一次呼叫过程中
    - 同时建立两个方向的连接;
    - 每个方向只涉及一条电路;
    - 使用一一个电路的一部分 确定容量;
    - 在整个呼叫过程中始终专用这部分容量
  - 来源于电话网
  - 技术：FDM、PDH、SDH、 MSTP、WDM
- 统计复用
  - 在多次呼叫过程中
    - 一次呼叫只建立一个方向的连接;
    - 随机使用一个方向的所有电路;
    - 数据包竞争使用一条电路的全部容量;
    - 整个呼叫过程中，断续使用随机电路
  - 每条业务连接通过各自的标识号来进行区分，各个业务连接根据自身需要来争抢资源，系统会定义争抢的优先级以及拥塞时的抛弃优先级
  - 技术：PSPDN（X.25）、 帧中继、点对点协议（PPP，Point-to-Point Protocol）、ATM、以太网、IP网、IPRAN、PTN。
    - PPP是高级数据链路控制（HDLC）协议族的一般报文格式。它是为两个对等实体间传送数据包建立简单链接而设计的全双工操作。

#### 网络拓扑

- 根据每种网络所提供服务的不同，可以采用合适的拓扑结构。在节约投资的基本要求下，合理的拓扑结构会帮助尽可能多的用户从尽可能近的地方、尽可能快地获取尽可能丰富的信息。
- 传统的电信网，都会分为核心层、汇聚层和接入层。在上述每个层次中，它们的“布阵方法”又千差万别。如总线型、星形、网状、环状、树形、双子星形等
  - 每一种类型都不能用“好”和“不好”来评价，而只能以“合理”和“不合理”来衡量。

####机理分类

- 寻址技术和网元设备分类方法
  - 按可用资源分类
  - 按应用场合分类
  - 按实现技术分类或者按实现技术机理分类。
    - 连接操作寻址技术
      - 实现：语音交换网PSTN和多协议标签交换MPLS网
    - 无连接操作寻址技术
      - 实现：传统路由器和交换机组成的IP网络
    - 与复用技术相比，有连接和无连接从另外一个角度节省了通信网络的资源， 提高了网络的综合利用率，提高了通信网络的传输和交换效率，并让通信网更加可用、易用。

#### 传输损耗

- 损耗类型
  - 误码（Error）：接收与发送数字信号之间的单个数字的差异。如把0变成了1，1变成了0。
  - 抖动（Jitter）：数字信号的各有效瞬间相对于其理想时间位置的短时的、非累积性的偏移。如信号的个别迟到随即又恢复的现象。
  - 漂移（Wander）：数字信号的各有效瞬间相对于其理想时间位置的长期偏移。就好比每天晚来一点点，并得寸进尺，来得越来越晚。
  - 滑动（Slip）：数字信号连续数字位置不可恢复地丢失或增加。 如因时间不一致而造成的“无中生有”或者“丢三落四”
  - 时延（Delay）：数字信号的各有效瞬间相对于其理想时间位置的推迟，就是信号的整体“迟到”。
  - 时延抖动（Delay Variation）：数字信号的各有效瞬间相对于其理想时间位置的推迟变化幅度，也就是信号“迟到”时间长度的变化区间。
  - 分组（信元）丢失（Packet Loss&Cell Loss）：数据分组或数据信元不可恢复的丢失，就是连续的信号段的完全丢失。
- 无论是数据网还是语音网，都对传输损耗参数制定规范，并提出损耗类型的最大可接受值。
- 传输损耗是永远存在的。只能通过优化，尽力减小其对业务的影响。百分之百去除任何一种损耗，不现实。
- 解决办法：通信技术的综合发展，如传输介质、编码格式、校验技术、同步技术等的发展。

#### 网络安全

- 大部分对“网络安全”的定义，基本都是针对计算机网络而言的，其实质内容多数是指计算机系统安全。
  - 最可能发生危险的地方才有对“安全”的讨论，基本不可能发生危险的地方，人们是不会去考虑安全问题的。
- 含义
  - 信息安全：信息内容的保密性
    - 通信和密码的结合->计算机系统安全->网络的边界保护
  - 网络通道的安全：通信“管道”（信道）本身的安全性
    - 广电网的典型网络安全问题是电视插播问题
    - PSTN和移动通信网的典型网络安全问题：电话骚扰；垃圾短信；通信诈骗等
    - 互联网的网络安全问题：数据包目的地地址容易被发现；IP源地址很容易修改伪造等
    - 无线网络的典型网络安全问题：黑客截取电波信号并解调数据；干扰阻断通信形成拒绝服务攻击等
- 信息系统(互联网)由信息基础设施（基础架构）和信息业务系统（内容）组成；信息基础设施由电信网络和计算机系统组成。互联网是一种电信网络。
- 安全服务
  - 访问控制服务：防止未授权使用系统资源，或者当网络资源已经饱和，防止新的呼叫进入，如连接接纳控制（CAC，Call Access Control）机制。PSTN、 ATM、MPLS网络都有相应的CAC机制。
  - 鉴别服务：防止假冒伪劣，盗用其他用户的身份，包括IP地址、MAC地址、无线频率等占用网络资源
  - 数据完整性服务：防止数据非法修改、插入、删除、中断，如黑客被商家雇用攻击竞争对手的网站这样的行为。
  - 数据保密性服务：防止泄密、信息流量分布，对保密性信息必须进行数据加密。
  - 抗抵赖性服务：防止抵赖，应尽可能做到可以追溯历史数据
  - 木马检测服务

#### 数据加密

- 方面
  - 数据本身的加密
  - 数据传输的加密

#### 压缩技术

- 目的
  - 节约存储空间、节省线路带宽、节省传送时间
  - 资源有限不得不压缩。
- 压缩造成的失真，如果用户能够接受，这种压缩就是成功的；如果用户不感知，这种压缩就是非常成功的
- 语音压缩技术ADPCM，中文翻译为“差分自适应PCM”。是一种采用平均值的方法来压缩语音编码的技术，采用差值替代绝对值。比如要传送一组较大的数字，只需传送其中一个数字和其他数字与它的差值即可。

#### 通信服务质量

- 服务质量（QoS，Quality of Service）是指决定用户满足程度的业务性能的综合效果
  - 研究通信的QoS问题，并不只是研究如何提高QoS，而是研究如何用最低的代价、最少的投入，让通信网满足更多的业务QoS的需求。
- 国际电信联盟电信标准化部门(ITU Telecommunication Standardization Sector,ITU-T)提出了一套严肃、规范、难以理解的描述服务质量的参量
  - 业务保障性能：电信主管部门提供业务，并且在使用过程中提供支持的能力。
  - 业务适用性能：通信网络保证业务能够支持用户成功而且方便操作的能力。
  - 服务能力性能：通信网络保障用户请求提供业务和在请求过程中继续提供服务的能力。
  - 业务完善性能：电信网络保证业务建立之后传输损伤不能超过限定范围的能力。

#### 应用

- SDH的线路保护：对于受重点保护的线路，从发送端到接收端可以理解为沿着光纤环路两个方向都有线路可以达到，当主用线路发生故障时，系统将自动切换到备用线路上去，并且切换时间要求控制在50ms以内，从而保证业务的连续性。
- 异步传输模式（ATM Asynchronous Transfer Mode）和IP：ATM技术复杂得让人窒息，从而使其开放性和灵活性远远落后于IP技术。而IP技术吸收了ATM中的优秀成分
- 多协议标签交换（Multi-Protocol Label Switching）：MPLS将IP数据包根据其业务类型打上不同的“标签”，每种标签标识不同的传送优先级。
  - 优势
    - QoS：MPLS可以给每种数据包打标签，标签可用于标识传送优先级
    - VPN：MPLS可以组成VPN。打上标签的数据包只会沿着特定路径传送，这就给公网上运行企业专用线路提供了技术基础。
    - 流量工程：MPLS可以根据网络的瞬时状态进行路径选择
  - 服务质量
    - IntServ集成服务：任何一个信息流都有一次资源预留的操作，将严重消耗系统资源
      - 资源预留协议（Resource Reservation Protocol，简称RSVP）：RSVP要求接收者在连接建立之初进行资源预留，它必须支持单播和多播数据流
    - DiffServ区分服务
      - 运营商在与客户签署的服务等级协议（SLA,Service Level Agreement）或流量调解协议中明确定义服务等级， DiffServ将根据不同的服务等级设置不同的ToS值
- 流媒体业务
  - 接收网络信息到本地方式
    - 下载：需要比较大的存储容量、需要完整下载、版权问题
    - 流：不需要较大的存储容量、“边看边下”、版权保护
- TCP加速技术
  - 双边TCP优化：TCP连接的两端部署硬件设备或安装软件，TCP透明代理工作在TCP连接的两端，两个代理之间通常通过UDP或其他自定义协议进行工作。
  - 单边TCP优化：只在TCP的一端部署软件或设备，一个基本要求就是经过透明代理出去的协议必须是TCP。单边TCP加速的透明代理，在广域网一侧运行的应该是一个与标准TCP兼容，同时性能提高的TCP。绝大多数的单边TCP加速，都通过改进TCP的拥塞控制算法来进行TCP加速。单边比多边适应性更广且更灵活
- TCP BBR加速
  - BBR（Bottleneck Bandwidth and Round-trip propagation time）：以往大部分拥塞算法是基于丢包来作为降低传输速率的信号，而BBR则基于模型主动探测。该算法使用网络最近出站数据分组当时的最大带宽和往返时间来建立网络的显式模型。数据包传输的每个累积或选择性确认用于生成记录在数据包传输过程和确认返回期间的时间内所传送数据量的采样率。

- p2p、p4p
  - p2p是去中心化、依靠用户群（peers）交换信息的互联网体系。对等网络的每个用户端既是一个节点，也有服务器的功能，任何一个节点无法直接找到其他节点，必须依靠其户群进行信息交流。

## 通信网络框架

- 通信之美：错综复杂的逻辑关系、构思巧妙的设计理念、严丝合缝的理论推演、千变万化的表现形式
- 对每个类型的通信网络的研究重点进行提纲性分析
  - 目的：在不同业务种类的通信网技术之间进行比较，区分各种技术之间的关联。区分各个概念所属的范畴
- 分类本身的价值如果无法体现，反倒会引起更大的困惑

### 传送网：一切的基础

- 传送网是电信网的基础网络，专门用于多种业务的传送保障，使每个业务网的不同节点之间、不同业务网之间互相连接在一起，形成四通八达的业务网络。

- 研究重点：传送网的容量、安全性、容错能力、成本及其适用范围。

- 定位：它一般处于交换网、数据网、移动网和支撑网之下，是用来提供信号传送和转换的基础架构。
- 这一行业的从业人员往往管这个领域叫“传输专业”。

### 语音网

- 语音网为用户提供相互之间的语音通信，包括固定网（PSTN）和移动网（PLMN）的语音通信，它往往被称为“交换网”。

- 介质实体：程控交换机、移动基站、接入网设备、软交换、NGN、IMS，当然也包括电话机、传真机、手机、SIM卡等。

- 技术：有A/D和D/A转换、交换原理、电话号码管理、 传真技术、语音压缩技术等。

- 定位：PSTN是最成熟的电信网，和数据网的结合越来越紧密。随着NGN(Next Generation Network)/IMS技术的发展，PSTN被逐步替代。

- “交换专业”。

### 数据网

- 数据网是用来传送数据信息的，包括互联网数据、DDN、帧中继、VPN、视频业务等，随着业务的不断融合，语音也作为数据业务传送，典型的案例是4G网络的语音就全部采用VoLTE。
- 介质实体：路由器、交换机、防火墙、服务器、视频终端、MCU、音视频编码等。
- 技术：帧中继技术、ATM技术、 TCP/IP、路由协议、MPLS、P2P（P4P）、CDN、流媒体、未来数据网络（FDN）等。
- 定位：数据网技术体制多样，应用广泛，以TCP/IP为基础的数据网成为电信网的基础承载网络。
- “数据专业”。

### 支撑网

- 支撑网是现代电信网运行的支撑系统。一个完整的电信网除了有以传递电信业务为主的业务网之外，还需有若干个用来保障业务网正常运行、增强网络功能、加强网络控制和管理能力、提高网络服务质量的支撑网络。
- 范围：支撑网中传递相应的监测和控制信号。支撑网包括同步系统、公共信道信令网、传输监控系统、计费、认证和营账系统以及网络管理系统等，其并非业务开通必需的系统，但没有它们，电信网就不能称之为电信网；
- 作用：传统增值服务、管理、运维、营账、计费、监控等
- “支撑专业”。

### 综合网

- 背景：通信网中的新鲜事物，大都具备“不遵守规则”的特征。可能跨度几种网络， 综合几种技术体制的优势和特点，给通信学界带来新的热点，但是， 却难以分类。
- MSTP，将以太网技术、IP技术和SDH技术结合在一起，能够解决城域网中IP传送的安全问题
- NGN和移动网的IMS只是一种网络架构，它应该由语音网、数据网、支撑网等多种网络混合而成，提供的也是语音、数据以及它们相结合的业务（如Voicemail等）
- ATM网络是利用固定帧长的ATM技术，承载数据业务、语音业务和视频业务，其统计复用的特点，能够同时将多种业务根据各自服务要求等级在同一个网络上传送
- ASON,Automatically Switched Optical Network:在光传送网中引入控制平面，以实现网络资源的按需分配从而实现光网络的智能化。 使未来的光传送网能发展为向任何地点和任何用户提供连接的网，成为一个由成千上万个交换接点和千万个终端构成的网络，并且是一个智能化的全自动交换的光网络。

### 各种网络的结构关系

- ![[image-20220720110658521.png]]

## 传送介质和传输网

- 光纤，是一种由玻璃或塑料制成的纤维，利用光在这些纤维中以全内反射原理传输的光传导工具。
  - 全内反射（英语：Total Internal Reflection），又称全反射，是一种光学现象。当光线经过两个不同折射率的介质时，部份的光线会于介质的界面被折射，其馀的则被反射。但是，当入射角比临界角大时（光线远离法线），光线会停止进入另一介面，全部向内面反射。
  - 只发生在当光线从光密介质（较高折射率的介质）进入到光疏介质（较低折射率的介质），入射角大于临界角(critical angle)时。因为没有折射（折射光线消失）而都是反射，故称之为全内反射。
- 容量的影响因素：线路的介质本身，和线路“两端的设备”，都会对其承载带宽造成决定性影响

- 传送介质的选择依据
  - 拓扑结构：如星形结构不适合选用同轴电缆，可选择双绞线等方式（注意这里提到的星形结构是指物理结构，实际上双绞线组成的局域网从机理角度来说，应该是总线型结构）。
  - 容量：介质提供的传输速率、可靠性和差错率应能够满足要求。在可能的情况下，尽量选择可靠性高的介质。当然，可靠性高的介质，其本身的成本也会增加。
  - 应用环境：包括传输距离、环境恶劣程度、信号强度等。 
  - 成本：选择网络介质的一个重要因素是考虑已有投资成本，以及新投资的成本

###频谱、带宽

- 频谱
  - 频谱是频率谱密度的简称，是频率的分布曲线。复杂振荡分解为振幅不同和频率不同的谐振荡，这些谐振荡的幅值按频率排列的图形叫做频谱。
  - 电磁波在物理介质中传播，不同频率、波长的电磁波，其穿透过程和结果是不一样的；同一个频率的电磁波，在不同的物理介质中传送，其过程和结果也是不一样的。
- 通过频率：物理介质能够通过的电磁波的频率范围。
  - 作用
    - 频率越高，在相同时间内可做的动作就越多。并不是每个高频自身的波形都一定携带更丰富的信息量。
      - 调制把低频率的信号搬移到高频率中去，让信号更易于在线路上传送，不易受到干扰源的影响，使通信的传输距离和传输质量都获得质的飞跃。
        - 调制之前或解调之后的信号，称为“基带信号”，一般都在低频范围内，这时候每个波形承载的信息量越大，其数据带宽则越宽。
        - 调制之后的信号，称为“频带信号”，其数据带宽并没有发生改变，只是信号更容易在线路中传送了。
- 带宽
  - 频率范围（单位是 Hz），
  - 数据流的频率（单位是bit/s，每秒钟的位数）
  - 模拟通信和数字通信中，频率范围和数据流的频率所表示的含义有所不同

### 有线网络

#### 传输介质

- 光纤
  - 模式组成：由圆柱形玻璃纤芯和玻璃包层构成，最外层是一种弹性耐磨的聚乙烯护套，整根光纤呈圆柱形。
  - 影响因素：纤芯的粗细、材料和包层材料的折射率
  - 模式
    - 单模光纤：单模光纤纤芯极细，直径一般小于10µm，模间色散很小，适合于远程通信，一般承载1310nm或者1550nm波长的光波
      - 模间色散：一种频率的光波以不同的角度入射到光纤中，到达终端的时间先后顺序不同，造成了脉冲展宽，从而出现的色散现象，这种现象将会降低数据精确度，造成了对传送距离的限制
    - 多模光纤：多模光纤纤芯较粗，通常直径在50µm（接近头发丝直径），模间色散较大，承载850nm或者1310nm波长的光波
      - 1310nm正好处于光纤的低损耗窗口，因此成为光纤通信的理想工作窗口，也是现在实用光纤通信系统的主要工作波段
  - 光纤收发器：将接收来的以太网电信号转化为光信号，并在光纤上传送，接收到光信号后还原为电信号，送入路由或者交换 设备、终端上的电接口。“光猫”
    - 单模光调制解调器
    - 多模光调制解调器
- 海底光缆：又称海底通讯光缆（英语：Submarine communication cables），是用绝缘材料包裹的导线，铺设在海底，用于设立国家或地区之间的电信或电力传输。

- 同轴电缆：同轴电缆由同轴的内外两个导体组成，内导体是一根金属线，外导体是一根圆柱形的套管，一般是细金属线编制成的网状结构，内外导体之间有绝缘层。
- 双绞线：每一对双绞线由绞合在一起的相互绝缘的两根铜线组成，每根铜线的直径在1mm左右，可以用于模拟或数字传输。
  - 作用：在通信中是为了抗干扰，也就是防止“噪声”对数据造成影响。
  - 分类
    - 屏蔽双绞线（STP，Shielded Twisted Pair）的抗干扰性好，性能高，用于远程中继线时，最大距离可以达到十几千米。价格高，被光纤取代
    - 非屏蔽双绞线（UTP，Unshielded Twisted Pair），其传输距离一般为100m左右，常用的有5类线、超5类线、6类线等， 5类线可以支持100Mbit/s，而6类线则可以支持1000Mbit/s的以太网连接，是连接桌面设备的首选传输介质。

#### 网络技术

- 线路物理特征决定其传送的容限和特征
- 线缆两端连接着设备，它们的作用是接收外部信号并进行有效的信号调整，以保证信号在接下来的线路上稳定传送，或者将调整后的信号通过某种方式呈现出来。
- PDH：准同步数字系列(Plesiochronous Digital Hierarchy)
  - 在数字通信网的每个节点上都分别设置高精度的时钟，这些时钟的信号都具有统一的标准速率。尽管每个时钟的精度都很高，但总还是有一些微小的差别。为了保证通信的质量，要求这些时钟的差别不能超过规定的范围。因此，这种同步方式严格来说不是真正的同步，所以叫做“准同步”。
  - 在数字通信系统中，传送的信号都是数字化的脉冲序列。这些数字信号流在数字交换设备之间传输时，其速率必须完全保持一致，才能保证信息传送的准确无误，这就叫做“同步”。
- SDH：同步数字系列（Synchronous Digital Hierarchy）
  - 一开始提出了SONET（Synchronous Optical Network），通过一系列有关SONET的标准，而后ITU的前身CCITT接受了SONET概念，并将其重新定名为“同步数字系列”，使之成为不仅适用于光纤也适用于微波和卫星传输的通用技术体制。
  - SDH拥有全世界统一的网络节点接口（NNI），它是真正的数字传输体制上的国际性标准。
  - 优点
    - 它拥有一套标准化的信息结构等级，称为同步传送模块 （STM），并采用同步复用方式，使得利用 软件就可以从高速复用信号中一次分出、插入低速支路信号，不仅简化了上下话路的业务，也使交叉连接得以方便实现。SDH拥有丰富的开销比特（约占信号的5%），以用于网络的运行、维护，并实现了远程管理。
    - SDH具有自愈保护功能，可大大提高网络的通信质量和应付紧急状况的能力。SDH的环保护能力。
    - SDH网的结构有很强的适应性，PDH、ATM、IP甚至Ethernet都能够承载。

- MSTP：多业务传送平台（Multi-Service Transport Platform）
  - 背景：随着各种数据业务的比例持续增大，TDM、ATM和以太网等多业务混合传送需求的增多，广大用户的接入网和驻地网都陆续升级为宽 
    带，城域网原本的承载语音业务的定位无论是在带宽容量还是在接口数量上都不再能达到传输汇聚的要求。
  - 将传统的SDH复用器、光波分复用系统终端、数字交叉连接器、网络二层交换机以及IP边缘路由器等各种独立的设备合成为一个网络设备，进行统一的控制和管理，所以它也被称为基于SDH技术的多业务传送平台。
- WDM：波分复用 （WDM，Wavelength Division Multiplexing）
  - 光通信信号复用方式
    - 频分复用系统，指按频率进行分割
    - 时分复用系统，指按时间进行分割
    - 波分复用 （WDM，Wavelength Division Multiplexing）系统，指按波长进行分割
    - 空分复用 （SDM，Space Division Multiplexing）系统，指按空间进行分割
  - c=λf  ，频率f  与波长λ 的乘积则是光速c，光速c是恒定的，波长λ 和频率f  成反比关系。
    - 波长（wavelength）是指波在一个振动周期内传播的距离。
    - “频分”本应和“波分”没有区别，但在光通信系统中，由于波分复用系统采用专门的光学分光元件分离波长，不同于一般通信中采用的滤波器（限制不需要的频率通过的装置），所以两者属于完全不同的系统。
  - WDM利用一根光纤可以同时传输多个不同波长的光载波的特点，把光纤可能应用的波长范围划分成若干个“波段”，每个波段作为 一个独立的通道，来传输一种预定波长的光信号。光波分复用的实质是在光纤上进行光频分复用（OFDM），只是因为光波通常采用波长参数而不用频率参数来描述、监测与控制。
    - 密集波分复用（DWDM，Dense WDM）：波长的密度高
    - 粗波分复用（CWDM，Coarse WDM）：波长的密度低
- PTN：分组传送网(Packet Transport Network)：PTN就是利用传统传送思维来解决分组数据传送的一种技术，底层技术使用了MPLS标签转发，但是去掉了IP/MPLS中的动态部分，改由网管集中下发和管理，对于TDM业务则通过一系列的仿真技术来兼容(PWE3)。同时具有了分组数据的高效和传送网络强大OAM特性。
- IPRAN:IP化无线接入网(IP Radio Access Network)
  - IPRAN并非无线接入部分，而是对基站类设备进行用户的无线接入后，通过有线网络将数据信息在城域范围内传送到中心机房的传送技术
- SPN:切片分组网(Slicing Packet Network)
  - SPN架构融合了从物理层到网络层的功能，设备形态是光电一体的融合设备
- OTN:光传送网（optical transport network）
  - 以波分复用技术为基础，利用其中与SDH/SONET类似的电层，为客户信号提供在波长或子波长上传送、复用、交换、监控和保护恢复的技术。
- ASON:自动交换光网络(Automatically Switched Optical Network)
  - 以OTN为基础的自动交换传送网， 基本设想是在光传送网中引入控制平面，以实现网络资源的按需分配从而实现先网络的智能化

### 无线传输技术

- “无线网”是一个笼统的概念，不用线缆的传输都是无线传输
- 根据频率、应用场合、传送信号类型的不同，常见的无线网络通信系统除了广播、电视外，还有Wi-Fi、移动网（从GSM到5G）、蓝牙、ZigBee、对讲系统、LMDS/MMDS、卫星等。
- 频率或波长分类
  - 长波：主要沿地球表面进行传播，又称地波，也可在地面与大气层中的电离层之间形成的波道中传播，距离可达几千千米到上万千米，能穿透海水和土壤。但波长越长，干扰噪声也会越大。
  - 中波 ：中波在白天主要靠地面传播，夜间也可由电离层反射传播，主要用于广播和导航。一般中波广播（MW）采用了调幅方式（AM），。实际上中波广播只是诸多利用AM调制方式中的一种。
    - 振幅调变（Amplitude Modulation，AM），也可简称为调幅，是在电子通信中使用的一种调变方法，最常用于无线电载波传输信息。在振幅调制中，载波的振幅（信号强度）是与所发送的波形成比例变化的。
    - 振幅（amplitude）是在波动或振动中距离振荡中心的最大位移
  - 短波：短波主要靠电离层反射的天波传播，可经电离层一次或多次反射，传播距离可达几千甚至上万千米，适用于应急、抗灾通信和远距离越洋通信
  - 微波：微波主要是以直线距离传播，但受到地形、地物及雨、雪、雾、 灯天气因素影响较大。它传播稳定、传输带宽宽，地面传播距离只有几十千米，能穿透电离层，对空传播可达数万千米，主要用于干线或支线无线通信、卫星通信等。

#### 微波通信

- 物理学中的微波，是指频率在300MHz～300GHz的微波信号，波长在0.1mm～1m的电磁波，也叫作“超高频电磁波”，说它“高”，是和一般的电磁波 
  相比；说它“微”，是指波长值很小。

- 波段

  - | 波段   | 频率      | 说明                                                         |
    | ------ | --------- | ------------------------------------------------------------ |
    | L波段  | 1～2GHz   | 常用于移动通信                                               |
    | S波段  | 2～4GHz   | 主要应用于微波接力通信和地球站之间的卫星通信。               |
    | C波段  | 4～8GHz   | 主要应用于微波接力通信和地球站之间的卫星通信，C波段是其中应用最多的。 |
    | X波段  | 8～13GHz  | 主要应用于微波接力通信和地球站之间的卫星通信。               |
    | Ku波段 | 13～18GHz | 主要应用于微波接力通信和地球站之间的卫星通信。               |
    | K波段  | 18～28GHz | 主要应用于空间通信和近距离的地面通信。                       |
    | Ka波段 | 28～40GHz | 主要应用于地球站与空间站之间的通信。                         |

    - 我国的3G、4G网络运行在L和S波段
    - 我国的5G将采用S和C波段。当前工业和信息化部向三大电信运营商发放了5G系统中低频段试验频率使用许可

- 微波站的设备包括天线、收发信机、调制器、多路复用设备以及电源设备、自动控制设备

- 微波作为通信首选频段的原因：频带宽、容量大、传播稳定，地面传播距离只有几十千米，能穿透电离层，对空传播可达数万千米。

  - 弱点
    - 经空中传送，微波易受其他外部环境的干扰，在同一微波电路上不能在同一方向使用相同的频率
    - 由于微波直线传播的特性，在电波波束方向上，不能有高楼阻挡

#### 调制和解调

- 背景
  - 辐射效率：为了获得较高的辐射效率，天线的尺寸一般应大于发射信号波长的四分之一
  - 多路复用：将原始频率的信号调制到载波频率上，可以把多个基带信号分别搬移到不同的载波频率上，可以实现信道的多路复用
  - 干扰能力：经过调制后的信号，系统抗干扰、抗衰落能力明显增强，传输的信噪比也会提高
- 方式
  - 模拟信号->模拟调制
    - 调幅（AM）、调频（FM）和 调相（PM）等
  - 数字信号->数字调制
    - 振幅键控（ASK）:通过两种振幅图形表示0和1
    - 移频键控 （FSK）:用两种频率图形表示0和1
    - 移相键控（PSK）:两种相位变化表示0和1
    - 差分相移键控（DPSK）、正交幅度调制（QAM）、正交频分复用（OFDM）等
- 数字调制技术比模拟调制技术具有更好的抗噪声能力、稳定性高、灵活性强、安全性好，但传输带宽较大，对设备的处理能力要求也随之提高。目前，微波通信大都采用数字调制。

#### 扩频

- 扩频（Spread Spectrum，SS）是将传输信号的频谱（spectrum）打散到较其原始带宽更宽的一种通信技术，常用于无线通信领域。
  - 扩频调制之后，其信号传输带宽应远大于原始信号；
  - 传输端会采用一个独特的码（code），此码与发送数据是无关的，接收端也必须使用这个独特的码才能解扩频以获得传输端的数据。
- 实现方式
  - 直接序列扩频（简称直序扩频，Direct-sequence spread spectrum，DSSS）
    - 直接用具有高码率的扩频码序列在发送端去扩展信号的频谱，而在接收端用相同的扩频码序列去进行“解扩”，把展宽的扩频信号还原成原始的信息。
    - 在应用中，实际信号与一系列精心挑选过的“噪声”信号相结合
  - 跳频（Frequency-hopping spread spectrum，FHSS）
    - 指用伪随机码序列进行频移键控，使载波频率不断跳变而扩展频谱的一种方法。
    - 移动通信信道环境恶劣，各种干扰会不约而至。为了抵御出现的某些频率的干扰，采用跳频技术是有效的方法之一。
  - 跳时扩频、混合扩频等。
- FHSS和DSSS构成了无线LAN初期标准的功能基础，并最终被融进我们再熟悉不过的Wi-Fi中

#### WIFI

- Wi-Fi已经成为无线局域网（WLAN）的代名词
  - WLAN的最初目的是在传统的局域网中引入无线的概念，从而使局域网中的用户可以摆脱线缆的束缚而具有一定的移动性。
- AC（Access Controller）+AP(Access Point)
- 协议：802.11->802.11a->802.11b->802.11g->802.11n->802.11ac->802.11ax
  - 802.11ac及之前Wi-Fi标准采用的都是OFDM调制方式
  - 而802.11ax采用的是正交频分多址（OFDMA）调制方式，这项技术是OFDM技术的演进版本。

#### 蓝牙技术

- 蓝牙技术（Blue Tooth）目的是实现终端之间短距离数据传送，比如手机和耳机之间、笔记本和手机之间、笔记本之间的数据传送。由于其传输速率不高，传输距离也不能太远，因此被称为“短距离无线电技术”。
- 蓝牙技术可使一些能随身携带的移动通信设备和计算机设备，不必借助电缆就能连网，并且能够实现无线接入互联网
- 蓝牙设备采用的是跳频技术（FHSS），能够抗信号衰减，有效地减少同频干扰，提高通信的安全性。与Wi-Fi早期所占用的频段一样，它也运行于全球范围开放的2.4GHz上。

#### 其他无线通信技术

- WAPI:无线局域网鉴别与保密基础结构(WLAN Authentication and Privacy Infrastructure)，是无线局域网（WLAN） 中的一种传输协议，它与现行的802.11b传输协议比较相近。WAPI是针对IEEE802.11系列中所涉及的安全问题，经反复论证并充分考虑各种应用模式，在中国无线局域网国家标准GB15629.11中提出的WLAN安全解决方案。
  - WAPI是我国自行制定的无线网传输标准。
-  “无线光纤”
  - LMDS：工作频段在10GHz以上的点到多点固定无线传输设备一般称为本地多点分配系统（LMDS，Local Multipoint Distribution System）
  - MMDS：3.5GHz频率的设备被称为多通道微波分配系统（MMDS，Multichannel Microwave Distribution System）。
- 超宽带（UWB，Ultra Wide Band）：该技术是一种以极低的功率（约20mW），在极宽的频率范围内（最高可达7.5GHz），以极高的速率（可达500Mbit/s）传输信息的无线通信技术。
- ZigBee技术：一种耗电极低的短距离无线网络技术。
- Z-Wave技术：Z-Wave是一种低成本、低能耗、高可靠性的短距离双向无线通信技术，主要应用于家庭自动化、小型工业控制等领域。
- RFID技术：无线射频识别技术（RFID，Radio Frequency Identification），它利用无线电射频与被识别物体进行双向通信，实现数据交换，从而达 
  到识别物体的目的。
- 无线Mesh网：又称为“无线网状网”或者“无线多路网”。它可以与各种宽带接入技术和移动通信技术结合在一起，组成一个含有多跳无线链路的无线网状网。

#### 天线

- 所有无线网络都离不开天线
- 手机也有天线，但由于技术进步，被隐藏起来了。
- 无线电发射机输出的射频信号功率，通过馈线（电缆）输送到天线，由天线以电磁波的形式辐射出去。电磁波到达接收地点后，由天线接下来（仅仅接收很小一部分能量），并通过馈线送到无线电接收机。
- 分类
  - 频率：短波天线、超短波天线、微波天线等
  - 用途：通信天线、电视天线、雷达天线等
  - 方向性：全向天线、定向天线、点对点天线等
  - 外形：线状天线、面状天线
- 辐射原理
  - 当导体上通以高频电流时，在其周围空间会产生电场与磁场。按电磁场在空间的分布特性，可分为近区、中间区和远区。
  - 设R  为空间一点距导体的距离
    - 在R  <<λ /2π时的区域称近区，在该区内的电磁场与导体中电流、电压有紧密的联系。
    - 在R  >>λ /2π的区域称为远区，在 该区域内电磁场能离开导体向空间传播，它的变化相对于导体上的电流、电压就要滞后一段时间，此时传播出去的电磁波已不与导线上的 电流、电压有直接的联系了，此区域的电磁场称为辐射场。
    - 注意：
      - 当导线的长度L 远小于波长λ 时，辐射很微弱；
      - 导线的长度L 增大到波长的四分之一左右时，导线上的电流将大大增加，因而就能形成较强的辐射。

### 卫星通信

- 地球上（包括地面和低层大气中）的无线电通信站间利用卫星作为中继而进行的通信
  - 卫星在空中起“中继站”的作用，即把地球站发上来的电磁波放大后再反送回另一地球站
- 组成：卫星、对应的一系列装置
- 静止卫星在赤道上空3600km，它绕地球一周的时间恰好与地球自转一周一致。三颗相距120°的卫星就能覆盖整个赤道圆周

## 电话交换网

- 自动交换机从步进制、纵横制发展到程控交换机和今天的软交换

### 公共电话交换网(PSTN)

- 分层架构
  - Class 1 (regional center)
  - Class 2 (sectional center)
  - Class 3 (primary center)
  - Class 4 (toll center)
  - Class 5 (local exchange)
  - 在中国，最早划分是按照C1为大区中心、C2为省中心、C3为地区中心、C4为县中心、C5为端局设计的，但是在实际的交换网络建设中，C2、C3逐渐退化并最终消失，只有C1、 C4和C5交换机真实存在
- 电话号码分配
  - 要求
    - 号码长度必须规范
    - 号码前缀代表某个特定地区或者特定应用
  - 国际上制定了全球规范，各个国家在国际规范的基础上结合自身特点制定了本国规范。中国本地网规范：
    - 本地网的编号：本地网用户进行长途、特种业务等通信时，由首位号区分。
      - 1为特种业务号码或移动电话号码的首位号
      - 2～8为市话号码的首位号
      - 9为长市话号码或市郊号码的首位号 
      - 0为长途全自动的字冠前缀
    - 特种业务号码和特服号码
      - 特种业务号码不同于普通用户的号码，是作为电信业务和社会服务而设的，要求接续速度快、准确无误，因此特种业务的电话号码位数少，有利于用户记忆和拨打。
      - 10开头的5位号码，是电信运营商保留的特别服务号码，如10000。以10开头的3位号码，都是和国际电话业务有关的特服号码。部分以13、14、 
        15、17和18开头的11位号码，属于移动运营商使用的手机号码段。
    - 长途网的编号：长途前缀（“0”）+区号+本地网号码
    - 国际电话编号
      - 要拨打国际长途，就必须先拨呼叫国际电话的标志号，这个号由国内长话局接收识别后，呼叫接入国际电话网。每个国家的标志号不完全相同。
      - 国际长途的区号，国家号码：按ITU规定， 国家号码由1～3位数字组成，第1位数为“世界编号区”，即世界分成若干个编号区，每个编号区配1位号码。
- 拓扑结构
  - PSTN是由电话机、电话交换机和它们之间的连线组成的。PSTN中的交换机组成特定的“形状”，有助于有效利用资源、提高电话呼叫的稳定性。
  - 程控交换机都有一个中继单元，中继单元上有若干个中继端口，任意两台程控交换机的中继端口，如果速率一致、信令一致，就可以通过数字中继线连接起来。信令可以是7号信令，也可以是PRI信令。
  - 电话交换网最适合的拓扑结构是树状结构，自上而下的行政管理模型。但是在较为核心的层面，一般采用全网状或不完全网状结构，用于对路由备份
  - 城市的每台直接连接用户的交换局都部署一定容量的程控交换机，它们一边通过铜线连接用户的电话机，一边通过E1/T1或者STM-1连接汇接层交换机。这就是我们之前提到的C5局连接到C4局。
  - 国家级语音骨干网一般按照国家行政区划分为几个大区，每个大区设置一个核心节点，所有该大区的省份，其核心地市的交换机直连大区核心节点
  - 交换机一般都可以设置“迂回路由”

-  电话接入网（AN）
  - “接入网”（AN，Access Network），特指语音网络。AN是一种将PSTN用更加廉价的方式接入企业和家庭的网络形式。
- 话务强度测定
  - 在语音通信网络中，“爱尔兰”（Erl）是衡量话务量大小的指标。它根据语音信道的占空比来计算。
  - 呼叫频率
    - 忙时试呼次数（BHCA，Busy Hour Call Attempts）：在一小时之内，系统能建立通话连接的绝对数量值
    - 每秒建立呼叫数量（CAPS，Call Attempts Per Second）：BHCA值最后体现为CAPS， CAPS×3600=BHCA

### 交换机原理

- 交换机基本能力
  - 寻址：必须能够通过路由表识别出应该如何找到被叫方。
  - 建链/拆链：必须有指挥“搭通”电路的能力，并在通话结束后拆除电路。
  - 交换：可以识别主叫方的请求并通过内部机制搭通电路。
  - 馈电：如果连接了电话机，必须能够向电话机供电。
  - 记录：CDR（Call Detail Records），存储能够存储所有电话通话的重要参数，如起始时间、终止时间、时长、主叫号码、被叫号码等，以作为计费的依据。

#### 程控交换机

- 路由表
  - 路由表中所有内容都是根据实际网络情况人为设定的，不是交换机通过某种机制自动获得的。程控交换网的号码分配非常规则，因此路由也非常规则：根据不同的被叫号码，选择不同的出局路径。
- 信令
  - 在网络中传输着各种信号，其中一部分是我们需要的（例如打电话的语音，上网的数据包等等），而另外一部分是我们不需要的（只能说不是直接需要）它用来专门控制电路的，这一类型的信号我们就称之为信令，信令的传输需要一个信令网。
  - 作用：通过特定格式的“语言”，在PSTN的各个交换机之间、交换机与电话机之间互相转告消息，并共同处理一次通信的整个过程。
  - 作用区域分类
    - 用户线信令：在用户线两头交互，用于电话机和交换机之间的信令传递
    - 局间信令：在交换机之间的中继线两头交互，也就是两台交换机之间的信令传递。
  - 话路数量分类
    - 随路信令：随路信令是指信令和语音在同一条话路中传送的信令方式
    - 共路信令：共路信令是在一条高速数据链路上传送一群话路信令的信令方式

### 智能网

- “增值业务”：指通话以外的所有业务
- 增值业务方式
  - 直接通过程控交换机实现
    - 缩位拨号：在电信公司办理完这项业务后，你就可以把自己经常拨打的一些电话，用1～3位自编代码来代替。
    - 呼叫前转：你可以在离开家或办公室时，把临时去处的电话号码“告诉”PSTN，这以后，打到你家或者办公室的电话便会自动转移到你的临时去处的电话号码
    - 遇忙回叫：启用“遇忙回叫”服务后，拨不通电话时便可挂上话筒等待，一旦对方电话空出来，交换机便会自动回叫你的电话
    - 三方通话：在不中断与对方通话的情况下拨叫第三方，实现三方共同通话。
  - “智能网”：控制权的分离，程控交换机只完成基本的交换和话务统计功能，业务控制逻辑则由专门的部件——业务控制点（SCP，Service Control Point）来完成

#### 软交换网络

- 背景：智能网提出了业务与交换分离，但这两者之间的复杂信令，让技术体制上的分离，变成了技术难度垄断上的合并，没有足够的实力，要通过智能网开发新业务，仍然困难重重
- 下一代网络（Next Generation Network，NGN）：NGN不是某个具体协议，也不是某项具体的技术创造或者技术创新，而是在基于任何传送、交换、路 
  由等技术机制的网络架构基础上的、更加符合行业价值链成长的、更能快速实现用户个性化需求的新一代电信网络架构。
- 交换硬度分类，交换芯片与控制软件是否解耦
  - “硬交换”：控制软件不独立于交换芯片
  - “软交换”：控制软件独立于交换芯片
- 要求
  - 承载与控制分离：控制是指对NGN中所有组成部件的协调、组织和管理，而这种控制不依托于任何一种承载网络。
  - 业务与呼叫分离
- NGN/软交换是基于TDM的PSTN语音网络和基于IP/MPLS分组网络融合的产物
- 特点
  - 平滑继承PSTN的语音业务和智能网业务；
  - 语音增值业务提供能力更为灵活，且具备支持多媒体业务的能力。
- 组件
  - 内部控制部分：采用通用的CPU或者专用高端CPU，加入IP端口，采用标准信令呼叫协议（如 H.323或SIP或其他），并提供标准的增值业务开发API，就成了一台软交换服务器（“大脑”）。
  - 外接线部分：外接口线部分增加IP端口后，加入适当的逻辑控制部分，就成了我们常说的“网关”（Gateway）或综合接入设备（IAD，Integrated Access Device），网关和IAD就是“四肢”了。
- 实体：应用服务器、信令网关、媒体网关

#### IP呼叫信令

- NGN主要承载在IP/MPLS网络之上。NGN、软交换的各种实体都将采用IP呼叫信令来建立链路，这就像基于TDM网络的PSTN各个实体之间采用电话信令进行通信一样。最常用的IP呼叫信令有H.323、SIP、MGCP/H.248等

##### H.323协议

- 会议电视系统标准：把基于局域网的多媒体系统连接到基于广域网络的多媒体系统上。
  - H.320：基于ISDN的TDM电路
  - H.323：基于IP分组
- H.323是一个“协议族”，由一系列协议组成的“框架性结构规范”，包含了多种ITU标准。H.323架构定义了4个主要的组件终端（Terminal）、网关（Gateway）、关守（Gatekeeper，简写为GK，也称“网守”）、多点控制单元（MCU， Multi-Point Control Unit）。
  - GK作为核心管理和控制部件，与所有终端建立关系， 当有呼叫申请，通过号码把主叫与被叫呼通，并通过MCU控制媒体流的混合和分发，形成会议机制。
  - 当需要与其他体制的网络互通时，如和PSTN语音互通，还要通过网关在中间进行翻译

##### SIP

- 会话初始化协议（SIP，Session Initial Protocol）
- SIP是一种应用层控制协议，它可用来创建、修改或终止多媒体会话
- SIP 能够邀请参与者加入已存在的会话，如组播会议。现有的会话中可以添加或删除媒体。SIP 支持名称映射和重定向服务，其支持用户移动性。

##### H.323协议与SIP

- H.323和SIP分别是通信领域与互联网两大阵营推出的建议
  - H.323试图把IP电话当作是众所周知的传统电话，只是传输方式发生了改变，由电路交换变成了分组交换。 
  - SIP侧重于将IP电话作为互联网上的一个应用，较其他应用（如FTP、E-mail等）增加了信令和QoS的要求。

##### MGCP与MeGaCo/H.248

- 媒体网关控制协议（MGCP）一般应用于分开的多媒体网关单元之间。
  - 组成部件
    - 媒体网关控制器（MGC）：负责媒体控制，执行对媒体网关的管理、控制
    - 多媒体网关（MG）：负责媒体处理和转换的叫作，执行由TDM语音到VoIP的转化。
- MeGaCo/H.248被看作是MGCP的升级版本

#### VoIP

- VoIP，其实就是将语音的媒体流从TDM转换到IP网络的所有技术体制的总称。
- VoIP技术为NGN、软交换技术提供了丰富的历史经验和教训，并成为这两者的重要技术基础。

#### NGN

- 业务驱动型网络架构：NGN被定义为一种全新的电信网络体系架构， 它融合了IP/MPLS技术和多媒体通信技术，提出了分层和开放的概念，从面向技术和管理的传统电信网络转变成面向客户、面向业务的新一代网络
- 关键技术：软交换
- 特点：架构开放、业务驱动、支持分组化承载和拥有独立的网络控制层
- 问题
  - 网络安全
  - 承载网QoS
  - 网络互连互通
- 未来：融合：“融合”可以向用户提供各种形式的业务和“一站式”的服务，使用户不管是在固定环境中还是在移动环境中都能享受同样的服务。

### 实时传输协议RTP

- Real-time Transport Protocol，RTP协议详细说明了在互联网上传递音频和视频的标准数据包格式。它一开始被设计为一个多播协议，但后来被用在很多单播应用中。RTP协议常用于流媒体系统（配合RTSP协议）
- 升级：RTP结合RTCP
  - RTP本身并不能为按顺序传送数据包提供可靠的传送机制，也无法规避网络拥塞
  - RTCP触发每个参与通话者周期性地传送RTCP包，其中含有已发送数据包的数量、丢失数据包的数量等统计资料。 发送方可以利用这些信息动态地改变传输速率，甚至改变有效载荷类型

### IP网络的语音编码

- 在IP网络上传送语音，可以对数字语音编码进行压缩后传送，节省带宽资源，减少语音时延，但也不可避免地损失了声音的信息。
- G.711编码
  - G.711编码是指用一个64kbit/s未压缩通道传输语音信号，这种64kbit/s的通道，可以是TDM的E1通道，也可以是IP通道。如果采用IP通道，一般在IP网络边缘将PCM的64kbit/s语音信号直接“塞入”IP数据包后进行传送。在IP网络质量完全有保障的前提下，使用G.711格式，音质与PSTN是没有区别的；在IP网络质量无保障的情况下，使用G.711格式会有较大隐患：IP网络稍有问题，如某个时刻发生网络拥塞，语音质量将严重下降。

- G.729编码
  - 提供了分组化语音应用所需的“静音抑制”算法，G.729对语音进行编码和压缩，使语音的传输速率降低为8kbit/s即可。VAD（静音检测）、DTX（断续传送）、CNG（静音抑制）配合使用
- G.723编码
  - 双速率语音编码
    - 5.3kbit/s：代数码激励线性预测（ACELP）
    - 6.3kbit/s：多脉冲最大似能量化（MP-MLQ）
  - G.723是压缩率较高的IP语音编码，与G.729B一样，在VoIP系统中获得了广泛的应用。实际上，大量的VoIP系统都采用G.711、G.723和G.729混合编码。
- iLBC编码
  - iLBC编码格式是一种特别适合互联网传送的编码方式。无论在高丢包率条件下还是在没有丢包的条件下，iLBC的语音质量都优于目前流行的G.723、G.729等标准的编解码。
  - Skype使用iLBC编码
- G.726编码
  - 自适应差分脉冲编码调制 （ADPCM，Adaptive Differential Pulse Code Modulation）
  - ADPCM是针对16位（或8位或者更高）声音波形数据的一种有损压缩算法，它将声音流中每次抽样的16位数据以4位存储，压缩比1∶4。压缩/解压缩算法非常简单，是一种低空间消耗、高质量、高效率声音获得的好途径。

### IP多媒体子系统IMS

- IP多媒体子系统（IP Multimedia Subsystem，IMS）或IP多媒体核心网络子系统（IP Multimedia Core Network Subsystem, IMCNS）是一个基于互联网协议提供多媒体业务的体系架构。传统移动电话使用类电路交换网络提供语音通话服务，而非使用计算机分组交换通信方式的网络。
- 技术机理：对控制层功能进行了进一步分解，实现了会话控制和承载控制在功能上的分离，使网络架构更为开放、灵活
- 安全性保障：鉴权认证、接入安全建立、信令加密、承载和业务流的安全控制、划分安全域等方式

### 统一通信

- 统一通信（UC，Uniform Communication）
- 内容都集合到一起，可以用手边的任何一款设备发送和获取信息。
- UC是一个概念、一个理想，并不是一种特定的技术体制。

### ICT

- 背景
- 通信如何为信息服务、信息如何利用通信渠道
- IT：IT是随着计算机的广泛应用发展起来的。IT涵盖了计算机信息的存储、运算、读写、识别、鉴权、压缩、查询、检索等环节的处理工作，也就是说，如何利用计算机的CPU来生成、管理、分析和使用大量的数据。
- CT：CT是电话、传真、数据、互联网等技术的统称。CT解决信息的传送问题。也就是说，根据信息的属性不同，采用合理的手段交换信息。

## 数据通信

- 假想图灵机：由一个控制器、一个读写头和一根无限长的纸带组成。纸带起着存储的作用，读写头能够读取纸带上的信息，纸带上可以用固定间隔是否有小孔表示1和0，将运算结果写进纸带，控制器则负责对搜集到的信息进行处理。
- 定义：数字信息的接收、存储、处理和传输

### xDSL

- 数字用户线路（Digital Subscriber Line，缩写：DSL）是通过铜线或者本地电话网提供数字连接的一种技术。可以让数字信号加载到电话线路未使用频段，这就实现了不影响话音服务的前提下在普通电话线上提供数据通信。
- 技术
  - ADSL：非对称数字用户线路（Asymmetric Digital Subscriber Line).是一个依靠铜质电话线的数据传输技术比传统的调制器更快。ADSL因为上行（从用户到电信服务提供商方向，如上传动作）和下行（从电信服务提供商到用户的方向，如下载动作）带宽不对称（即上行和下行的速率不相同）因此称为非对称数字用户线路。
    - 网络登录方式
      - 桥接，直接提供静态IP
      - PPPoA（Point-to-Point Protocol over Asynchronous Transfer Mode），基于ATM的端对端协议
      - PPPoE（Point-to-Point Protocol over Ethernet），基于以太网的端对端协议
  - HDSL：高比特DSL（High Speed Data Rate DSL）非常成熟并已经获得较为广泛的应用。这种技术可以通过现有的铜双绞线以全双工T1或E1方式传输，且传送距离可达3.6～5km！
  - VDSL：高比特率DSL（VDSL，Very High Data Rate DSL）技术是部分高端IP用户享受的一种IP接入方式
  - SDSL：对称比特DSL（SDSL，Symmetric Data Rate DSL）技术也是部分高端IP用户享用的、对称的IP接入方式，一般应用于双向带宽相同的线路中
  - 带有G字头的若干DSL技术。
- 随着光纤入户的流行，DSL技术正在逐渐退出历史舞台。

### 帧中继

- 帧中继（FR，Frame Relay）是一种连接局域网的技术。
- 将数据信息以“帧”的形式传送，并采用存储转发模式，其使用的传输链路只是一种逻辑链路，可以实现统计复用，而不像电话交换网那样是实际的物理连接。
- 在一条物理连接上，可以同时通过多条帧中继的逻辑链路，不同的逻辑链路，用不同的数据链路通路标识符（DLCI，Data Link Channel Identity）来进行标识（如用颜色来标识逻辑链路），而每个DLCI标识出来的“链路”，将承载一个业务流
- 帧中继是典型的面向连接的交换技术
- 随着ATM的成熟，帧中继业务被承载在ATM网络上，纯粹的帧中继网逐渐退出了历史舞台。

### ATM

- ATM是以信元为基础的一种分组交换和复用技术，它是一种为了多种业务设计的通用的面向连接的传输模式。信元的长度为固定帧长53个字节
- 特性
  - 协议标准严谨：无论ATM的分层结构还是帧格式，以及ATM的适配层协议，每一种封装、每一种适配，都是精心设计出来的
  - 应用宽泛而有序：ATM适应所有语音、数据和视频业务，并提供所有业务的承载能力。
  - QoS完美而烦琐：对可能影响网络形态的所有参数都考虑进去了，但也提升了复杂度

#### 技术要点

- 固定帧长保证快速交换
  - 固定帧长有利于交换芯片的转发。在通信网这个完全自治的系统中，固定的分组长度，可以很容易判断头和体，而不需要耗费专门的机制去确认
    - 信元头中有该信元要路过的通道的标志。虚通道标识（VPI，Virtual Path Identity）和虚通路标识 （VCI，Virtual Channel Identity）值。VPI和VCI在信元中作为帧的标识，也在ATM交换机中用于电路的标识。
- 统计复用支持多种业务
  - 统计复用就是动态而非静态地、见缝插针地、勤俭节约地、公平合理地利用信道资源
    - 优先级最高的人独享其中的一部分；剩下的，按照优先级高低来分享。
    - ATM把业务按照优先级特点起名为CBR、VBR、 UBR、ABR等。利用不同的适配层（AAL，ATMAdaptation Layer）， 接入交换机将数据信息向ATM信元进行“适配”
- 两级交换实现粗细颗粒
  - ATM技术充分考虑了配置链路过程中的便捷性。一般来说，某一类型的业务用一个VPI进行标识，这类业务中的每个呼叫用VPI/VCI的组合进行标识

### IPover SDH

- IP是一种不定包长的、突发性强的技术；而SDH则是固定帧格式的传送模式。SDH的稳定性、安全性让IP技术觊觎已久。不断创新的通信技术让IP享受到了SDH的承载水平
- 方式
  - IPover ATMover SDH
    - 对于急件可以保证其先运输出来，对于时间要求不严的货物，可以晚些运送
    - 优：IPover ATM可以充分利用ATM速度快、容量大、多业务支持能力强，以及IP简单、灵活、易扩充和统一性强的优点
    - 缺：然而其网络体系复杂、传输效率低、开销损失大（25%～30%），而且ATM设备比较昂贵，因此无法满足IP业务发展的要求。
  - IP/PPP/HDLC/SDH
    - 将货物分堆摆放，每堆分别装入通用容器（PPP和HDLC），然后装船。通用的容器存放货物，稍显麻烦，有一定开销，效率中等。
    - PPP/HDLC是IETF定义的IPover SDH链路层映射协议，它是将IP数据包通过PPP进行分组，并使用HDLC协议对PPP分组进行封装，构成一个个HDLC的帧，最后将其映射到SDH的虚容器中。这种方式开销损失少，比IPvoer ATM的方式在效率方面有所提高。这种方式的具体应用就是路由器上的POS端口（Packet over SDH）
  - IP/LAPS/SDH
    - 将货物分堆摆放，每堆分别装入专用容器LAPS中，然后装船。专用的容器更加适合货物存放，因此效率较高。
    - 优点：SDH上的链路接入规程（LAPS，Link Access Procedure SDH）与PPP/HDLC类似，但它是把以太网的MAC帧直接封装到LAPS帧的数据区，比 
      PPP/HDLC操作简单，因而效率提高。这种方式的具体体现是MSTP中的以太网传送，有时候称为EoS（Ethernet over SDH）
  -  GFP封装方式
    - 各种业务都可以通过一种叫作GFP的技术进行封装后在SDH上传输，使用GFP一方面可以克服ATM开销大的缺点，同时它还能避免LAPS、PPP/HDLC等采用帧标志定位带来的一系列缺点；另一方面它又能提供各种数据接口，使SDH能承载多种类型的业务。

### IPover WDM/OTN

- 背景：SDH的最高商用速率是10Gbit/s，已经不能满足数据流量的爆炸式增长
- IPover WDM/OTN，在WDM/OTN系统中采用SDH帧或者GE/10GE/40GE/100GE等帧结构，将IP业务映射进WDM/OTN系统，通过WDM/OTN系统的波道复用技术，实现IP业务的超大带宽传输。目前商用OTN可接入的IP速率可以达到400Gbit/s以上。

### MSTP

- 在SDH设备上增加IP板卡，并进行一定技术优化，最终形成了一个新的传输网门类——多业务传送平台（MSTP，Multi-Services Transport Platform）
  - MSTP是以SDH技术为基础的，吸取SDH安全、可靠的优点，既能提供传统的TDM语音链路，也能提供日益增长的、突发性强的数据和视频专线链路。
- 原理：把以太网的帧“塞入”GFP、PPP、LAPS、 VC虚级联（如DCAS）等容器里，将端到端的以太网线路隐藏在了SDH中
- “多业务”特征
  - 支持丰富的业务端口，而不仅仅是支持IP端口或者TDM端口； 
  - 提供的交换、交叉连接带宽丰富，能够支持各种大带宽业务； 
  - 对每种业务类型都有所贡献，而不仅仅提供透明的传送通道；否则，几乎所有的网络形态都可以称为“多业务网”，那么也就无所谓“多业务网”了；
  - 对每种业务的QoS差异有所考虑，对带宽的利用率提高有所贡献。

### 无线光网络PON

- PON下行采用广播方式，上行采用时分多址方式，可以灵活地组成树形、星形、总线型等拓扑结构，在光分支点只需要安装一个简单的无源光分支器即可
  - 无源光网络（PON，Passive Optical Network）的光分支器不需要电源
- 最初的PON包括基于ATM的PON（APON）和基于以太网的PON（EPON/GPON）
  - GPON（吉比特以太网无源光网络）的标准，它可以灵活地提供多种对称和非对称上下行速率，传输距离至少达60km。
- EPON/GPON特点
  - 高接入带宽：  GPON下行速率高达2.5Gbit/s，上行速率也可达1.25Gbit/s，EPON采用上下行各1.25Gbit/s的速率。两者的速率都不低。
  - 节省光纤资源： 都采用点到多点的树状广播形网络拓扑结构，从局端的一芯光纤，最后可以分支到32/64个终端ONU设备，极大地节省了馈线部分的光纤资源，特别是对于地域广阔的地区，或者原有光纤资源有限的运营商，采用PON技术组网可以大大提高光纤资源的使用效率。
  - 设备运维和管理成本低：  PON光纤接入技术，只有局端（OLT）和用户侧设备（ONU）为有源设备，其中间的光分布网络采用稳定性高、体积小巧、成本低的无源光分支器。

### CATV（Cable TV）

- CATV是由光纤和同轴电缆混合而成的网络
- 光纤同轴电缆混合网(Hybric of Fiber and Coax):HFC是一种综合应用模拟和数字传输技术、同轴电缆和光缆技术、射频技术、高度分布式智能形的接入网络，是电信网和有线电视(CATV)网相结合的产物是将光纤爱渐向用户延伸的一种新型、经济的演进策略。
- CATV的双向改造，本质上是对其光纤和同轴电缆两部分分别进行从单向传输到双向传输的改造过程。从前端到光纤节点这一段光纤通道，可采用WDM方式。从光节点到住户这段同轴电缆通道，一般采用FDM频分复用。

## 路由与交换

### 路由和交换节点

- HUB、以太网交换机和路由器
  - 目的：将真实数据从出发地发送到目的地
    - “真实数据”：终端设备之间传送的、携带有效信息的数据。
- HUB的工作原理是广播，一个数据包需要送达所有端口
- 交换式以太网的交换机保存着每个终端的MAC地址对应表，可以直接传送数据，无需广播到所有端口
  - 二层交换机：二层交换机工作在TCP/IP架构的第2层——数据链路层，就是以太网层。二层交换机不处理任何路由功能，与之连接的每个终端都在同一个IP地址段中。
    - VLAN（虚拟局域网）：“虚拟”是“逻辑”的意思。也就是说，按照一定的逻辑关系将主机划分为若干群组，这种群组是逻辑组，和主机所在的物理位置无关。
    - 在一个VLAN内，由一台主机发出的信息只能被具有相同虚拟网编号的其他主机接收，局域网的其他成员则收不到这些信息。
  - 三层交换机。三层交换机则可以工作在第2层和第3层（协议层，即IP层）。三层交换机则带有路由功能。
    - 在一个以太网内的主机，如果被划分在不同的VLAN中，它们之间的通信，只要通过一台路由设备就行
    - 三层交换机的路由查找是针对“流”的，它利用高速缓存技术，在成本不高的情况下能够实现快速转发。
- 路由器
  - 路由器是一个信息中转站，它能够将不同制式的网络连接在一起。数据可能以各种方式进入路由器，如以太网帧、ATM信元、SDH帧、PPP帧、HDLC帧、帧中继帧等。无论采用哪种方式，路由器都会把数据“打开”并进行分析，根据出口线路的类型重新封装到帧或者信元中。
  - 路由器还是一台特殊的计算机。早期的路由器，就完全采用传统计算机的体系结构。路由器专门执行各种路由协议，并进行数据包的转发工作。
  - 路由器还能做很多诸如安全、拨号、VPN、流量控制、负载均衡、地址转换、安全等方面的工作
  - 路由器的接口类型可以涵盖通信技术中几乎所有的接口类型，选择哪些接口类型的路由器，完全取决于它们的应用场景
    - 以太网接口：包括电接口（RJ-45居多）和光接口（单模或多模光纤接口）
    - E1/E3接口、T1/T3接口、DS3接口：BNC接口、RJ-48接口，在逻辑上还分信道化、非信道化，信道化是指可以将一个E1/E3、 T1/T3、DS3接口拆分成多个逻辑端口，每个逻辑端口可以有自己独立的IP地址、封装格式等。
    - 通用串行接口
    - POS接口
    - 电话接口
    - ATM接口
  - 每台路由器可以静态存储一些路由表，这些静态存储的路由表项叫作“静态路由”；也可以按照一定规则动态更新它的记忆，也就是通过某些机制不断获取并更新自己的路由表
  - 分类：路由器因所管辖范围的不同，体积、容量、端口类型和密度、转发性能也有很大的差异
    - 核心路由器（也可称作“骨干层路由器”）、汇聚路由器（有人称作“分发层路由器”）和接入路由器（又称“访问层路由器”）
  - 性能提升
    - 使用精简指令集（ASIC）芯片装备路由器
    - 放弃使用共享总线，采用交换背板，这就是“交换式路由技术”。
    - 并行处理技术在路由器中运行，模块化设计

### 路由协议

- 路由协议是为了满足路由器获取路由表的需要而制定的标准化协议。通过一系列路由协议，让IP网的所有路由器快速、准确地获取全网路由信息，从而指 
  引IP数据包的方向。
- 静态路由协议和动态路由协议。路由表获取方式，是一种混合方式，通过人工设定一部分，通过路由协议获取一部分，由这两部分合成完整的路由表。
  - 静态路由中，一类是由于明确知道某个IP地址段的精确方向，而由人工设定该路由表项；另一类则称为“缺省路由”，就是向路由表中没有明确 
    标识方向的所有数据包提供一个统一的、默认的出口。缺省路由非常重要，使用好了可以简化路由表，使用不当可能导致路由循环。
  - 动态路由，采用动态路由协议获取路由信息。常用的动态路由协议有RIP2、OSPF、IS-IS、EIGRP、IGRP、BGP等。动态路由协议能够在一定范围内很快通知所有运行相同路由协议的相关路由器进行路由表的更新
- 自治域AS（Autonomous system）：在IP网络中，一个自治域是拥有同一选路策略、在同一技术管理部门下运行的一组路由器。
  - 整个路由环境首先被分割成许多AS，每个AS都使用自己的内部路由环境。
  - 域间路由环境描述了AS间是如何互联的，并且避开维护各个域内的传输路径。

#### RIP2和RIPng：距离向量协议

- 在RIP中，路由器每隔30s就将所谓的“距离向量”信息发送到相邻路由器，路由表只存储到目的地站点的最佳路径的下一跳地址。RIP允许最大跳数为15跳（Hop，就是通过的网络节点数），超过15跳被认为是不可达的。新的基于IPv6的RIP协议RIPng，在信息格式和地址方面比RIP2有所加强。

#### OSPF：开放最短路径优先

- 开放最短路径优先（OSPF，Open Shortest Path First）是一种典型的“内部网关协议”。
  - 采用SPF（最短路径优先）算法：把每一台路由器都作为“根”（Root）来计算其到每一个目的地路由器的距离，每一台路由器根据一个统一的数据库计算出网络的拓扑结构图，这个结构图类似于一棵树
- 流程：路由器A，假设它已经做好了相关的物理连接、路由协议、IP地址的配置
  1. 路由器进行初始化或网络结构发生变化（如增减路由器、 链路状态发生变化等）时，路由器会产生链路状态广播数据包 （LSA，Link-State Advertisement），这个数据包里包含路由器上所有相连链路的信息——其实也是所有端口的状态信息。
  2. 所有路由器会通过刷新（Flooding）的方法来交换链路状态数据。Flooding是指路由器将其LSA数据包传送给所有与其相邻的运行OSPF协议的路由器，相邻路由器根据其接收到的链路状态信息更新自己的数据库，并将该链路状态信息转送给与其相邻的路由器，直至全网稳定。
  3. 经过传送LSA的过程，每个路由器都开始根据SPF算法计算到达所有网段的最短路径，并自动编写一条条路由表项。路由表中包含路由器到每一个可到达目的地的成本以及到达该目的地所要转发的下一个路由器（Next-Hop）。

#### IS-IS：中间系统互连协议

- 在ISO规范中，一台路由器就是一个中间系统（IS，Interactive System），一台主机就是一个末端系统（ES，End System）。提供IS和ES（路由器和主机）之间通信的协议，就是ES-IS；提供IS和IS（路由器和路由器）之间通信的协议（也就是路由协议），叫IS-IS
- 与OSPF一样，IS-IS也维护一个链路状态数据库，并使用SPF算法得出最佳路径，采用Hello报文来查找和维护邻居关系。但是IS-IS使用“区域”来维护一个“等级”的概念，在区域之间都可以使用路由汇总来减少路由器的负担，并具有认证功能。

####BGP：边界网关协议

- 互联网上每个AS都通过BGP向其“对等互联伙伴”广播其网络信息。

- BGP是一种“路径向量协议”，因为它所广播的是到达某一特定目的地所需的路径信息，而不像前面讲到的OSPF一样采用LSA广播路由器的直连网段。
- BGP拥有的一些属性让它比别的路由协议多了一些路由控制手段，其实就是AS的管理手段
  - AS_PATH属性：由AS路径段的序列组成，BGP允许通过加长BGP路由表项中的AS_PATH属性来影响选路结果，从而达到管理者的某种目的。
  - COMMUNITY属性：就是一系列4个八位组的数值，BGP允许 在路由中携带附加的数值，并在两个AS之间传递互连双方已经商量好的数值，这些数值可看作是区分不同用户的“暗号”，这样就方便对不同的“暗号”实施不同的路由策略了。

### 互联网报文控制协议ICMP

- 互联网报文控制协议（ICMP，Internet Control Message Protocol）：它用于网际协议（IP）中发送控制消息，提供可能发生在通信环境中的各种问题反馈。通过这些信息，使管理者可以对所发生的问题作出诊断，然后采取适当的措施解决。

## 通信方式

### 互联网通信

- 电脑网路与电脑网路之间所串连成的庞大网路系统。这些网路以一些标准的网路协议相连
- 实现
  - e-mail：POP3、SMTP
  - www：HTTP、HTTPS
  - BBS
  - FTP
  - Telnet
  - 即时通信（IM，Instant Messaging）：ICQ来源于I seek you
  - 搜索引擎
  - 电子商务：按照甲方乙方类型可以分为B2C（企业对用户）、 B2B（企业对企业）、C2C（个人对个人）和B2G（企业对政府）4 类。
  - 远程教学、远程通信、网络游戏、网络直播、共享经济、知识付费
- Web2.0：是一种更广泛利用社会资源的管理理念。每个人都可以成为互联网信息的发布者，从而更深入地参与互联网信息的发布

#### Internet数据中心IDC

- 基础服务类型
  - 主机托管：把服务器保存在机房并且通过一定带宽连接到互联网上去
  - 虚拟主机托管：多个客户把信息存放在同一台服务器里，对于每个客户而言，都仿佛拥有一台自己的计算机，而实际上，只是大家共享一台而已，这就叫“虚拟”主机，如VPS
- 电信级的IDC必备要素
  - 带宽
  - 对等网络、独立的AS和IP地址
  - 以太网交换机
  - 服务器：IDC的核心设施是服务器。专门为ISP、ICP和ASP设计的Internet服务器，除在性能上满足Internet应用的要求外，从结构上考虑，它应当是一种薄型机架式服务器，或者“刀片式”服务器
  - 存储设备

#### 网络攻击

- 主动攻击：攻击者携带访问所需信息主动出击，他们伪装成用户需要的信息类型，对被攻击者实施破坏行为
  - 篡改消息：消息的某些部分被篡改、删除。
  - 伪造消息：攻击者发出含有其他实体身份的数据信息，假扮成其他实体，从而以欺骗方式获取一些合法的数据或者用户权限。
  - 拒绝服务型：对被攻击者实施的导致其异常的、资源耗尽的、欺骗型的攻击类型。
  - 数据驱动攻击：包括缓冲区溢出、格式化字符串攻击、输入验证攻击、同步漏洞攻击、信任漏洞攻击。
- 被动攻击：不进行数据修改，而是收集被攻击者的信息
  - 窃听类：键击记录、网络监听、非法访问数据、获取密码文件等。
  - 欺骗类：主动获取口令、隐藏恶意代码、部署网络欺骗。
- 木马病毒
- APT攻击
  - 高级持续性威胁（APT，Advanced Persistent Threat），就是利用先进的攻击手段对特定目标进行长期、持续性网络攻击的入侵形式。
  - 步骤：扫描探测、工具投递、漏洞利用、木马植入、远程控制、横向渗透（从一台被攻击的机器向内网延伸），行动
- 分布式拒绝服务DDoS（distributed denial-of-service attack）攻击
  - 
  - 借助于客户/服务器技术，将多台计算机联合起来作为攻击平台，对一个或多个目标发动DDoS攻击，从而成倍地提高拒绝服务攻击的威力。

#### 安全防护

##### 防火墙

- 硬件防火墙可以理解为一台计算机，也可以理解为一台路由器。

  - 它拥有和一台计算机一样的CPU、内存操作系统、软件等，只是它的作用比较单一。

  - 它具备如路由器一样的物理接口，还具备基本的路由功能。

- 技术变革

  - 最早的网络层防火墙为第一代防火墙，采用了包过滤技术，也就是把包打开，看看源地址是哪里，目的地址是哪里，协议类型是什么，源端口、目的端口是什么，根据这些信息来判断这个包是否安全，并决定这个包接收（Accept）还是放弃（Drop）。
  - 第二代防火墙能够主动截获TCP与被保护主机间的连接，并代表主机完成握手工作。当握手完成后，防火墙负责检查，只有属于该连接的数据分组才可以通过，而不属于该连接的则被拒绝
  - 第三代防火墙是在建立连接之前，基于应用层对数据进行验证，所有数据包都在应用层被检测，并且维护了完整的连接状态以及序列信息。
  - 第四代防火墙可以同时工作在OSI的第3、4、5层上。这一代防火墙也称为有状态的防火墙，它通过本地的状态监控表，用来追踪通过流量的各种信息，包括源/目的TCP和UDP端口号、TCP序列号、TCP标记、TCP会话状态以及基于计时器的UDP流量追踪；同时，有状态防火墙通常内置高级IP处理的特性，比如数据分片的重新组装以及IP选项的消除或者拒绝。

- 防火墙作为企业保护自身数据和网络安全的关键设备，从传统的数据包过滤、网络地址转换、协议状态检查以及VPN为技术主体过渡到以深度数据包检测（DPI）、全栈可视化、内容检测、统一防护等为主体的下一代防火墙（NGFW），从而实现企业的智能化主动防御。

##### 态势感知

- 态势感知是一种基于环境的、动态而整体地洞悉安全风险的能力，是以安全大数据为基础，从全局视角提升对安全威胁的发现识别、理解分析、响应处置等能力的一种安全策略

### 移动通信

- 技术变革
  - 第一代移动通信是指模拟移动网技术。当然，“第一代”是模拟移动通信技术的“庙号”，因为在它高速发展时，并没有“第一代”这个称谓，GSM网开始规模建设并放号后，业界对之前基于模拟网的移动通信统称为第一代移动通信。
  - 第二代：GSM和CDMA
    - GSM
      - 移动台（MS）:手机+SIM卡就是MS的一种
      - 基站收发台（BTS）:基站收发台是基站子系统（BSS）的信号收发部分。在一定的无线电区域覆盖范围内，通过移动通信交换中心，与移动电话终端之间进行信息传递的无线电收发信电台。
      - 基站控制器（BSC）:通常控制几个基站收发台，通过收发台和移动台的远端命令，基站控制器负责所有移动通信接口的管理，主要是无线信道的分配、释放和管理。
      - 移动业务交换中心（MSC）:从基站获取手机信号进入交换机，采用和PSTN一致的方式进行交换。MSC和所有的基站都有逻辑通道，协调多个基站
      - 拜访位置寄存器（VLR）：存储与呼叫处理有关的数据，如用户的号码、所处位置区、向用户提供的服务类型等参数
      - 归属位置寄存器（HLR）：任何一部手机原始的注册地
      - 设备识别寄存器（EIR）：存储有关移动台设备参数的数据库，用于识别手机标识的数据库服务器。
      - 鉴权中心（AUC）：主管用户的鉴权
      - 操作维护中心（OMC）：负责对整个网络的管理和维护
    - CDMA：“码分多址”是每一个信号被分配一个“伪随机二进制”的序列进行扩频，不同信号被分配到不同的伪随机序列中。在接收机中，信号用“相关器”加以分离，这种“相关器”只接收选定的二进制序列并压缩其频谱，凡不符合该用户二进制序列的信号就不被压缩带宽。结果只有有用信号的信息才被识别和提取出来。
    - 数字集群移动调度系统：把有限的信道集中起来，通过自动、动态、快捷的分配方式，为众多行业用户建立一套统一的无线电调度系统，采用统一 
      的频率
  - 第三代：IMT-2000，IMT是指International Mobile Telecommunication
    - 标准：宽带码分多址（WCDMA，Wideband CDMA）、cdma2000、时分同步的码分多址技术（TD-SCDMA，Time Division- 
      Synchronous CDMA）以及2007年年底加入的WiMax
  - 第四代：IMT-Advanced标准
    - 标准：LTE-Advanced和WirelessMAN-Advanced
    - 制式：频分双工（FDD，Frequency DivisionDuplexing）和时分双工（TDD，Time Division Duplexing）
  - 第五代：革命性的、刚刚走出实验室的、标准化进程已经初具规模的新一代移动通信技术
- “多址移动通信”问题：让每部手机都要有一个和其他手机不一样的“地址”，让移动通信的网络系统能根据这个地址准确地找到它，而这个地址一定不能是手机号码，而是临时的。
- c=λf：c是光速，为3×10^8m/s;λ是波长；f是频率
- 无线多址的主要方式有：模拟系统中的FDMA、数字系统中的TDMA和CDMA。
  - 实现“多址”连接的理论基础是信号“分割”技术，也就是说，发送端进行恰当的信号设计，使发送的每一路信号都有所差异，以形成不同的信道，对应每个接收终端（如手机）；接收端必须安装具有信号识别能力的装置，从混合信号中分离、选择出相应的信号，反之亦然。

### 个人和家庭的通信

- 固定电话、移动通信、电力网、有限电视电缆、IPTV(Internet Protocol Television)

### 行业和企业的通信

- VPN
  - VPN的隧道协议有PPTP、L2TP、IPSec、GRE以及MPLS VPN。
  - 应用场景分类
    - 远程接入VPN（Access VPN）：客户端到网关，使用公网作为骨干网在设备之间传输VPN数据流量。
    - 内联网VPN（Intranet VPN）：网关到网关，通过公司的网络架构连接来自同公司的资源。
    - 外联网VPN（Extranet VPN）：与合作伙伴企业网构成Extranet，将一个公司与另一个公司的资源进行连接
- 企业存储网络
  - 直连式存储（DAS，Direct Access Storage）：将存储设备通过SCSI接口直接连接到一台服务器上使用。
  - 存储区域网络（SAN，storage area network）：是一种连接外接存储设备和服务器的架构。连接到服务器的存储设备，将被操作系统视为直接连接的存储设备
  - 网络接入存储（NAS，Network Attached Storage）：NAS是一种带有网络文件服务器操作系统的存储设备。NAS设备直接连接到TCP/IP网络上，网络文件服务器通过IP网络存取和管理数据，网络文件服务器将多块硬盘的数据统一管理和调度
- 独立硬盘冗余阵列（RAID, Redundant Array of Independent Disks）
  - 利用虚拟化存储技术把多个硬盘组合起来，成为一个或多个硬盘阵列组，目的为提升性能或资料冗余，或是两者同时提升。

## 电信业务

- 为了满足特定的电信需求，由主管部门或者经过认可的经营机构向其客户提供的服务。
- 服务能力分类
  - 承载业务：用户群可以是电信网本身，也可以是企业用户，比如用SDH网络承载语音业务，DWDM承载IP业务等，都属于一种技术体制“搭载”在另外一种技术体制之上，并不是直接向最终用户提供服务
  - 用户终端业务：一般是指家庭、个人接入PSTN、接入互联网、接入移动网等。
  - 补充业务：种类繁多，来电显示、会议电话、彩铃、彩信等，它们都是语音、数据业务的附属产品，是对单调的基本通话和数据业务的“补充”。

- 基础电信业务

  - 第一类基础电信业务
    - 固定通信业务、移动通信业务、第一类卫星通信业务
    - 第一类数据通信业务：数据通信业务是通过互联网、帧中继、ATM、DDN等技术体制提供的各类数据传送业务

  - 第二类基础电信业务
    - 集群通信业务、无线寻呼业务
    - 第二类数据通信业务：固定网国内数据传送业务、无线数据传送业务，包括拨号、ADSL、GPRS、Wi-Fi等
    - 第二类卫星通信业务：卫星转发器出租、出售业务、国内VSAT通信业务
    - 网络接入业务
    - 国内通信设施服务业务
    - 网络托管业务

- 增值电信业务

  - 固定电话网增值电信业务：包括电话信息服务、呼叫中心服务、语音信箱、可视电话会议服务。
  - 移动网增值电信业务，如彩铃、彩信、来话提醒、手机报纸等。
  - 卫星网增值电信业务。
  - 互联网增值电信业务：包括IDC、信息服务、虚拟专用网、 CDN、会议电视图像服务、托管式呼叫中心和其他互联网增值电信业务。
  - 其他数据传送网络增值电信业务：包括计算机信息服务、电子数据交换、语音信箱、电子邮件、传真存储转发。

## 运营支持和管理计费

- 同步：采用技术手段保持同一个节奏，接收端和发送端保持节拍一致，不至于在发送端开始发送信息时，接收端还没有调整好节奏来接收信息。“时钟同步”是通信网调整基准“节奏”的过程。同步网就是电信网络节点的“时钟”，它保证整个电信网（尤其是TDM网络）在某一个特定的“节奏”下步调一致地交互信息
  - 实现
    - 在通信中，一台设备可以取同步卫星或者原子钟、石英钟等公认的标准时钟，它必须具有获取标准时钟的装置，这个装置就是“局钟设备”
      - 局钟设备是一个高可靠性的频率综合设备，实现时钟提纯、频率变换、并行输出标准时钟等功能。其中的输入接口单元接收来自本地原子钟、石英钟或上级局钟的5MHz标准频率信号。
    - 在通信网中，设备可以从传输线路中“提取”时钟
- 认证和鉴权
- 网络管理：配置管理、故障管理、性能管理、账务管理、安全管理
- 计费模式：时长*单价、数据流量、次数、带宽、发起接收、混合
- 网络运维
  - 封网：在规定时间、规定范围内停止有关电信网络的工程施工、系统割接与升级、电路调度、业务开通与调整、局数据制作、网管数据制作（不含用户数据制作与接入端设备调整）等工作
  - 网络割接：“割”原有网络的线路、设备等；把新的线路、设备接上去
  - 重保：在特殊历史时期的特殊保护措施，如特殊的节日
  - 信息登记包含：信息安全等级保护国家重要信息、法人和其他组织及公民的专有信息以及公开信息在存储、传输、处理过程中，分等级实行安全保护，对信息系统中使用的信息安全产品实行按等级管理

## 通信前沿技术

### 云计算

- 云计算（cloud computing）是分布式计算的一种，指的是通过网络“云”将巨大的数据计算处理程序分解成无数个小程序，然后，通过多部服务器组成的系统进行处理和分析这些小程序得到结果并返回给用户。
- 服务模式分类
  - IaaS（Infrastructure as a Service），即基础设施即服务。指把IT基础设施作为一种服务通过网络对外提供，并根据用户对资源的实际使用量或占用量进行计费的一种服务模式。
  - PaaS是（Platform as a Service），是指平台即服务。 把服务器平台作为一种服务提供的商业模式，通过网络进行程序提供的服务称之为SaaS(Software as a Service)
  - SaaS(Software-as-a-Service)，即通过网络提供软件服务.SaaS平台供应商将应用软件统一部署在自己的服务器上，客户可以根据工作实际需求，通过互联网向厂商定购所需的应用软件服务，按定购的服务多少和时间长短向厂商支付费用，并通过互联网获得Saas平台供应商提供的服务。
- 目标群体分类：公有云、私有云和混合云
- 虚拟化：在操作系统和硬件之间加入一个“虚拟化软件层”，通过存储空间上的分割、CPU时间上的分时以及模拟物理机的实现机理，将服务器物理资源“抽象”成逻辑资源，向上层操作系统提供一个与其原先期待一致的服务器硬件环境。
- 容器技术可以同时将操作系统镜像和应用程序加载到内存当中。 还可以从网络磁盘进行加载它能够在同一台服务器上创建相当于之前两倍的虚拟机实例数量

### 大数据

- 利用人们在互联网上留下的各种数据信息，以及人们在各个机构提交的可处理和分析的数据信息，将所有信息用新的处理模式统一整理，从而获取具有更强的决策力、洞察发现力和流程优化能力的海量、高增长率和多样化的信息资产
- 特征
  - 数据体量巨大（Volume）
  - 数据类型繁多（Variety）
  - 价值密度低（Value）
  - 处理速度快（Velocity）

### 物联网

- 物联网（英语：Internet of Things，简称IoT）是一种计算设备、机械、数字机器相互关系的系统，具备通用唯一识别码（UID），并具有通过网络传输数据的能力，无需人与人、或是人与设备的交互
  - 构成
    - 感知层：让物品说话的层次，传感器（执行器）、传感器网关是这一层的主要构件
    - 网络层：需要将感知层说出的话准确无误地传送到应用层。由各种私有网络、互联网、无线通信网、网管系统及云计算平台等组成的。
    - 应用层：物联网和用户（包括人、组织）的接口，它与行业的具体需求结合，实现物联网的智能服务。
  - 关键技术
    - 传感器技术
    - RFID标签：射频识别（Radio Frequency IDentification，RFID）是一种无线通信技术，可以通过无线电信号识别特定目标并读写相关数据，而无需识别系统与特定目标之间建立机械或者光学接触。
    - 嵌入式系统技术
    - ipv6和云计算、模糊识别等其他智能计算技术

### 软件定义网络

- SDN ( Software Defined Network )即软件定义网络,是一种网络设计理念， 或者一种推倒重来的设计思想。只要网络硬件可以集中式软件管理,可编程化,控制转发层面分开,则可以认为这个网络是一个SDN网络。
- 传统通信设备的三个方面
  - 交换和转发平面负责数据的转发
  - 控制平面，用于控制各种网络协议的运行
  - 管理平面，提供给网络管理人员使用telnet、Web、ssh、SNMP、RMON等方式管理设备的各种管理接口。
- 良好的系统设计应该是使控制平面与转发平面尽量分离，互不影响，各自寻求最优化的算法。
- SD-WAN ( Software Defined Wide Area Network，软件定义的广域网)将企业的分支、总部和多云之间互联起来,应用在不同混台链路( MPLS , Internet, 5G , LTE等)之间选择最优的进行传输,提供优质的上云体验。

### 量子通信

- 将处于量子态的原子所携带的信息转移到一组别的原子上去，从而实现量子信息的传递

### 区块链

- 区块链是一个分布式的公共账本。任何人都可以对这个公共账本进行核查，但不存在一个单一的用户对其进行控制。在区块链系统中的所有参与者，会共同维持账本的更新

### 人工智能

- 人工智能（英语：artificial intelligence，缩写为AI）亦称智械、机器智能，指由人制造出来的机器所表现出来的智能。通常人工智能是指通过普通计算机程序来呈现人类智能的技术。该词也指出研究这样的智能系统是否能够实现，以及如何实现。

### VR和AR

- 虚拟现实（英语：virtual reality，缩写VR），简称为虚拟技术，也称虚拟环境，是利用电脑模拟产生一个三维空间的虚拟世界，提供使用者关于视觉等感官的模拟，让使用者感觉仿佛身历其境，可以即时、没有限制地观察三维空间内的事物。
- 增强现实(Augmented Reality，AR)技术是一种将虚拟信息与真实世界巧妙融合的技术，广泛运用了多媒体、三维建模、实时跟踪及注册、智能交互、传感等多种技术手段，将计算机生成的文字、图像、三维模型、音乐、视频等虚拟信息模拟仿真后，应用到真实世界中，两种信息互为补充，从而实现对真实世界的“增强”。

# 大话无线通信

- ![[image-20220928101126074.png]]
  - BSS = ‘BTS’ （ Base Transceiver Station ， 基 站 收 发 信机）+ ‘BSC’（Base Station Controller，基站控制器）
  - ‘HLR’（Home Location Register， 归属位置寄存器），存储了IMSI号、Ki号及其他详细信息
  - ‘VLR’（Visitor Location Register，访问位置寄存器）
    - 情况一旦有所变化，‘VLR’都会实时和‘HLR’联系，到HLR下属的AuC’（Authentication Center，鉴权中心）里进行认证。
- 信令
  - ![[image-20220928101552929.png]]
  - BTS<->MS
    - TCH（Traffic CHannel，业务信道）
    
      - ![[image-20221008164840169.png]]
    - CCH（Control CHannel，控制信道）等几类
    
      - ![[image-20221008164424654.png]]
      - SDCCH,独立专用控制信道（Stand-Alone Dedicated Control Channel）
      - SACCH(Slow Associated Control Channel 慢速随路控制信道)
      - FACCH（Fast Associated Control CHannel,快 速 随 路 控 制 信 道 ）
      - ‘BCCH’ （ Broadcast Control CHannel，广播控制信道）
      - ‘FCCH’（Frequency Correction CHannel ， 频 率 校 正 信 道 ）
      - ‘SCH’ （ Synchronization CHannel ， 同 步 信 道 ） 
      - CCCH（  通 用 控 制 信 道 ， Common Control CHannel）
        - 还未建立起连接的就称为通用，已经建立好连接的，单独占用一条信道的就称为专用。在RACH、AGCH、PCH之时，移动台尚未与网络建立起连接，尚未单独占用一条独立的信道用于通信，所以称为通用控制信道。
      - RACH（随机接入信道，Random Access CHannel）:MS通过此信道申请分配一个独立专用控制信道（SDCCH），可作为对寻呼的响应或MS主叫／登记时的接入。RACH在上行BCCH载频的0号时隙上传送。
      - AGCH（允许接入信道，Access Grant CHannel）:AGCH用于为MS分配一个独立专用控制信道（SDCCH），AGCH在下行BCCH载频的0号时隙上传送。
      - PCH（寻呼信道，Paging CHannel）:PCH用于寻呼MS（可以通过IMSI、TMSI、IMEI来寻呼移动台），PCH在下行BCCH载频的0时隙上传送。
      - CBCH（小区广播信道，Cell Broadcast CHannel）PCH消息是以位置区进行寻呼（其实也是广播）的，而CBCH消息是以小区来进行广播的.该信道用来传递需要广播到小区中所有移动台的信息。CBCH用专用控制信道（SDCCH）来发送信息，但是通常被看作是通用信道，因为小区内所有的移动台都能收到它发送的信息。
  - 编号
    - Cell：‘CI’（Cell Identity，小区标识）
    - BSC：‘LAC’（Location Area Code，位置区域码）
    - BTS：‘BSIC’（Base Station Identity Code，基站标识码）

## 通信系统

- ![[image-20220928144638892.png]]
  - 信源编码是以提高通信有效性为目的的编码。信源编码的效率通常是通过压缩信源的冗余度来实现的。信源编码追求的是相同信息量的最少比特位。
  - 信道编码是以提高信息传输的可靠性为目的的编码。通常通过增加信源的冗余度来实现。
    - 在信源编码的基础上，另外安排了一些冗余的比特传给收端，让收端自行验证信息是不是都收对了，这些“冗余信息”就称为信道编码。
      1. 检错重发法
      2. 前向纠错法
      3. 反馈校正法
- DRX（Discontinuous Reception）技术
  - 是一种在移动通信中用于节省移动设备电池电量的方法。
  - 移动设备和网络协商数据传输发生的阶段。在其他时间，设备会关闭其接收器并进入低功耗状态。
  - GSM按IMSI号把手机划分为不同的寻呼组，没有轮到寻呼自己这个组的时候，GSM手机处于睡眠状态（也就是待机状态），对于网络的寻呼消 
    息直接忽略；当寻呼到本组时，GSM手机开始对PCH信道的消息进行解码，查看要找的究竟是不是自己。

- 不连续发射（Discontinuous Transimission，DTX）
  - 在没有信息传输的时候降低速率
  - 通过话音激活检测（Voice Activity Detection，VAD）技术，由编码器来检测是否有声音发出。

- 功率控制
  - 手机在小区移动时，它的发射功率需要变化。当它离基站较近时，需要降低发射功率，以减少对其他用户的干扰；当它离基站较远时，就应该增大发射功率，以用于克服增加了的路径衰耗。


## GSM系统组成

- ![[image-20220929133836870.png]]
  - 一 套 完 整 的 蜂 窝 无 线 通 信 系 统 通 常 由 交 换 子 系 统 （ NSS ， Network Switched Subsystem ） 、 基 站 子 系 统 （ BSS ， Base Station 
    Subsystem），移动台（MS，Mobile Station）以及操作维护中心（OMC，Operations & Maintenance Center）构成。
    - NSS包括移动业务交换中心（MSC）、访问位置寄存器（VLR）、归属位置寄存器（HLR）、鉴权中心 （ AuC ） 和 移 动 设 备 识 别 寄 存 器 （ EIR ） ；
    - BSS 包 括 基 站 控 制 器（ BSC ） 和 基 站 收 发 信 机 （ BTS ） 。 
    - 交 换 子 系 统 和 其 他 网 络 如 PSTN（Public Switched Telephone Network，公用电话交换网）、 PLMN（Public Lands Mobile-communication Network，公用陆地移动通信网）之间一般都有接口。
  - GSM系统的接口
    - ![[image-20220929161601316.png]]
  - WCDMA的接口
    - ![[image-20220929165059709.png]]
      - 无线网络控制器（RNC，Radio Network Controller）
      - Uu：UMTS Air Interface，This is the radio interface between the UTRAN (UMTS Terrestrial Radio Access Network) and the UE (User Equipment) utilizing CDMA.
  - ![[image-20220929175359894.png]]
- 手机部件
  - 天线
    - 一是将空中的电磁波转化为高频电流并将其输送到接收电路中。发射的时候则恰好相反，把高频电流转化为电磁波；
    - 二是分离发射信号与接收信号，避免二者之间互相干扰

  - LNA（Low Noise Amplifier，低噪声放大器）
  - 射频滤波器：对特定接收频段以外的信号通通过滤掉
  - 超外差电路：把高频电流信号降下来变成中频电流信号， 然后进行放大和选频的电路
  - ![[image-20220930094015088.png]]

- BSC
  - 链路
    - MTL（Message Transition Link，消息传送链路）：MTL存在于MSC与BSC之间，采用C7信令系统，此链路在BSC-MSC、MSC-MS之间提供所有控制信息，包括：初始连接请求、通话过程中任何属性的变化、处理切换。
    - RSL（Radio Signalling Link，无线信令链路）：RSL存在于BSC和BTS之间。RSL使用格式化的LAPD信令，一般都需要占用一个64kbit/s的时隙，也有占用一个16kbit/s的信道的。该链路主要是为BTS上的话务处理软件提供支持，允许BSC向BTS发送和接收控制信息。它也支持统计信息的收集和故障报告工作。
      - 实现MS与BSC的业务管理消息的互通；
      - 在BSC的控制下完成一部分无线资源管理功能。
    - OML （ Operations and Maintenance Link ， 操 作 和 维 护 链 路 ）
    - CBL（Cell Broadcast Link，小区广播链路）
- 交换子系统
  - 移动交换中心（MSC）
    1. 完成话音的接续功能，主要工作就是我们前面所说的交换，包括被叫用户所在地查询与寻呼、信道的分配、话务量控制以及计费等功能；
    2. 作为网络的核心，配合HLR/AUC和VLR完成移动用户位置登记、自动漫游、合法性检验等功能；
    3. 配合BSC完成跨BSC的切换，以及通过信令来指示无线信道的建立和释放；
    4. 提供面向系统其他功能实体和面向固定网（PSTN、ISDN等）的接口功能。

  - 归属位置寄存器（HLR),GSM中的根DNS
    - 静态数据，也称为用户参数，包括用户号码（MSISDN）、移动用户识别码IMSI号、Ki号、接入的优先等级、补充业务等；
    - 动态数据，也称为用户的位置信息，用户会经常漫游到HLR所服务的区域之外，那么HLR需要登记由该区传来的位置信息。

  - 访问位置寄存器（VLR）,GSM中的本地DNS
    - HLR可以指向MS所在的VLR，VLR再指向MS所在的位置区，最后通过位置区寻呼找到该用户。
    - VLR往往和MSC合并在一个设备实体中，因为每一次呼叫，这两者之间总有大量的信令流通。
    - VLR是用来存储用户当前位置信息的数据库。当用户漫游到新的MSC控制区时，它必须向该地区的VLR申请登记。VLR要从该用户的HLR查询有关的参数，要为该用户分配一个新的漫游号码（MSRN），并通知其HLR修改该用户的位置信息，准备为其他用户呼叫此移动用户时提供路由信息。如果移动用户从一个VLR服务区移动到另一个VLR服务区，HLR在修改了该用户的位置信息后，还得通知原来的VLR删除此移动用户的位置信息。
    - VLR是一个动态的数据库，它的数据随用户的变化而不断改变；VLR也相当于一个分布式的HLR。它也存储了两类信息：一是当前VLR下的用户参数，该参数是从HLR中获得的；二是当前交换区MS的位置区标识 （LAI）。

  - 鉴权中心（AuC）,GSM系统的守护神
    - AuC属于HLR的一个功能单元部分，专用于GSM系统的安全性管理。 它的作用是产生一个三参数组——RAND、SRES和Kc的功能实体。这几个参数用于确定移动用户的身份和对呼叫进行加密。
    - AuC存储着鉴权信息，用来对用户进行鉴权，防止非法用户的接入；AuC还存储着密钥，用来对无线接口上的语音、数据、信令信号进行加密，保证用户的通信安全。
    - 每个用户在运营商处进行开户登记的时候，就会被分配一个用户号码（MSISDN号）和用户识别码（IMSI号）。IMSI通过SIM卡写卡机写入SIM卡中，同时在写卡机中又产生了一个对应此IMSI的唯一的用户密钥Ki。IMSI号与Ki号在SIM卡和AuC中都有存储，便于核对。
    - AuC的两大功能是鉴权和加密，AuC中有一个伪随机码发生器，用于产生一个不可预测的伪随机数（RAND）。RAND和Ki经A8算法（加密算法）产生一个Kc，经A3算法（鉴权算法）产生一个响应数（SRES）。 由RAND、SRES、Kc一起组成了一个用户的三参数组，AUC每次对一个用户产生7～10组三参数组，传送给HLR，HLR将其存储在该用户的用户资料库中。
      - ![[image-20221008114533333.png]]
      - ![[image-20221008114558018.png]]


- 编号
  - ![[image-20221008142728999.png]]
    - MSISDN（Mobile Station International ISDN Number）：指主叫用户为呼叫数字公用陆地蜂窝移动通信网中的用户所需拨的号码。
      - 综合业务数字网（Integrated Services Digital Network，ISDN）是一个数字电话网络国际标准，是一种典型的电路交换网络系统（circuit-switching network）。
    - CC（Country Code）＝国家码，即在国际长途电话通信网中要使用的标识号
    - NDC（National Destination Code）＝国内目的地码，即网络接入号，也就是平时手机拨号的前3位。
    - SN（Subcriber Number）＝用户号码，采用等长8位编号计划。
  - ![[image-20221008143436614.png]]
    - MCC（Mobile Country Code）＝移动国家号码，由3位数字组成，唯一地识别移动用户所属的国家，我国为460。
    - MNC（Mobile Network Code）＝移动网号，由2位数字组成，用于识别移动用户所归属的移动网。中国移动的GSM PLMN网为00，中国联通的GSM PLMN网为01。MSIN（Mobile Station Identity Number）＝移动用户识别码，采 
    - 用等长10位数字构成，用于唯一地识别国内GSM移动通信网中的移动用户。
  - 移动台漫游号码（MSRN，Mobile Station Roaming Number）
    - MSRN的结构和MSISDN的完全一致，所不同的地方是这个号码是由用户漫游地的MSC/VLR临时分配的，不像MSISDN是在HLR中长久记录的。
    - 被叫用户所归属的HLR知道该用户目前是处于哪一个MSC/VLR业务区，为了提供给入口MSC/VLR（GMSC）一个用于选路的临时号码，HLR 
      请求被叫所在业务区的MSC/VLR为该被叫用户分配一个MSRN，并将此号码送至HLR，HLR收到后再发送给GMSC，GMSC根据此号码选路，将呼叫 
      接至被叫用户目前正在访问的MSC/VLR交换局。路由一旦建立，此号码就可立即释放。
  - 临时移动用户识别码（TMSI，Temporary Mobile Subscriber Identity）
    - TMSI是为了对用户身份进行保密，而在无线通道上代替IMSI使用的临时移动用户标识，这样可以保护用户在空中的话务及信令通道的隐 
      私，它的IMSI不会暴露给别人。它是由VLR分配给在其覆盖区内漫游的移动用户的标识码，和用户的IMSI号相对应，只在本地VLR内有效， 
      TMSI可用作位置更新、切换、呼叫、寻呼等操作时的用户识别码，并可在每次鉴权成功之后被重新分配，该号只在本MSC内有效。
  - 国际移动台设备识别码（IMEI，International Mobile Equipment Identity）
    - 该识别码用于唯一地识别一个移动台设备，而与使用该手机的SIM卡用户无关。在用户不用SIM卡作紧急呼救时，IMEI可被用作用户标识号码，这也是唯一的IMEI用于呼叫的情况。
    - IMEI＝TAC＋FAC＋SNR＋SP
      - TAC＝型号批准码，由欧洲型号认证中心分配。
      - FAC＝工厂装配码，由厂家编码，表示生产厂家及其装配地。 
      - SNR＝序号码，由厂家分配，识别每个TAC和FAC中的某个设备的。 
      - SP＝备用，备作将来使用。
  - ![[image-20221008154237285.png]]
    - 位置区识别码（LAI）
      - LAI代表MSC业务区的不同位置区（如图4.61所示），用于移动用户的位置更新
        - LAI＝MCC＋MNC＋LAC
        - LAC＝位置区号码，用于识别一个GSM网中的位置区，LAC的最大长度为16bit，在一个GSM PLMN中可定义65536个不同的位置区。
    - 全球小区识别码（CGI）
      - CGI用来识别一个位置区内的小区，一个位置区有若干个BTS，每个BTS一般有3个位置区。它是在位置区识别码，（LAI）后加上一个小区识别码（CI，Cell Identity）
      - CGI＝MCC＋MNC＋LAC＋CI
  - 基站识别码（BSIC）
    - 它不是唯一的，它的位数很短，数量也很少。其主要目的是用于移动台识别相邻的、采用相同载频的、不同的基站收发信机（BTS）。
    - BSIC＝NCC＋BCC
      - NCC是网络色码，用于识别GSM移动网。 
      - BCC是基站色码，用于识别基站。

## 接口物理层设计

### TDMA空中接口技术

- GSM在无线路径上的传输单位是由GMSK调制的比特组成的脉冲串，称 为 “Burst”—— 突 发 脉 冲 
- 突发脉冲在一个时间和频率的窗口上发送，这个窗口称为“time slot”——时隙
  - ![[image-20221008155337643.png]]
- TDMA信道上一个时隙中的信息格式称为突发脉冲序列。
  - 普通突发（NB，Normal Burst）脉冲序列
  - 空闲突发（DB，Dummy Burst）脉冲序列
  - 频率校正突发（FB， Frequency Correction Burst ） 脉 冲 序 列 
  - 同 步 突 发 （ SB ，Synchronization Burst）脉冲序列
  - 接入突发（AB，Access Burst）脉冲序列。
- 普通突发脉冲序列
  - 普通突发脉冲序列用于携带业务信道（TCH）及除RACH、SCH、FCCH控制信道上的信息。
  - ![[image-20221008160204767.png]]
    - TB（Tail Bit）是尾比特的意思，TB的数值总是000，以帮助均衡器识别起始位和终止位。
    - 普通突发脉冲序列有一个26bit的训练序列，这是一串特定的比特序列，共有8种。BTS在设置BSIC号的时候，相应的比特序列也就设置了。其作用是帮助均衡器产生和修正信道模型， 以消除时间色散
    - GP（Guard Period）是保护间隔，共8.25bit，大约30ms，这是一段空白信息，防止有时隙交错时，有用的比特信息不会交错
    - Encrypted bit是加密比特的意思，语音信号经过A5算法加密后就填充进了上述两段比特信息中
    - F是借用标志的意思，打电话的时候，我们一直占用的是TCH，信令都没地方传了，如果出现了比较紧急的信令要传递，比如说切换信息，那就把两个F位“偷帧信号”置为1，说明此时突发脉冲序列已经被FACCH信令借用。如果只设置了一个比特，表示突发脉冲序列只有一半被盗用。其中，“0”表示是TCH，“1”表示是FACCH。
- 频率校正突发脉冲序列
  - 突发脉冲序列传送下行的FCCH，使MS能校正自己振荡器的频率并锁定到BTS的频率，它相当于一个特定频率的未调制的载波在FCCH上发送
  - ![[image-20221008160754363.png]]
  - 频率校正突发脉冲序列也有前后各3bit的尾比特和8.25bit的保护比特，其作用和普通突发脉冲序列相同。142个固定比特全为0，这个信息很特殊，便于MS一眼识别并锁定载波频率
- 同步突发脉冲序列
  - 同步突发脉冲序列用于MS和BTS间的时间同步，这里含有一个长同步序列TDMA帧号（FN，Frame Number）以及基站识别码（BSIC）的相关信息。
  - ![[image-20221008161452573.png]]
    - 与突发脉冲序列有所不同的是，它有长达64bit的同步序列。这个同步序列是固定的，也可以看作是训练序列，此时网络还未建立连接，需要更多的比特位用于信道均衡来确保信息传递的有效性。
- 接入突发脉冲序列
  - ![[image-20221008162009925.png]]
  - 接入突发脉冲序列用于MS的随机接入。这种突发脉冲序列设置了一个较长的保护间隔（GP），所以其有用信息比其他类型的脉冲序列短很多。因为MS试图接入到系统时还不知道发射定时，所以要增加保护带。MS发送该突发脉冲序列时，BTS并不知道MS的位置，所以来自MS的消息的定时也无法准确计算（接入突发脉冲序列仅为上行）。由于第一个突发脉冲序列中没有时间调整，MS接入与后一个串有一定的交错，基站可以根据交错码个数来计算TA值。
- 空闲突发脉冲序列
  - ![[image-20221008162221054.png]]
  - 在其他信道不发送突发脉冲序列时，基站收发信机须在小区配置中C0的下行信道的每个时隙发送一个突发脉冲。因为MS是要不断监视BCCH射频的功率的，以便于进行小区选择。如果BCCH载频的TCH时隙有时候不发送信号，就会影响周围的MS对该载频信号强度的评估，因为 
    评估信号强度是根据采样点取平均值而得来的。所以如果有BCCH载频的时隙处于空闲状态，那就要发送空闲突发脉冲序列，不能让它闲着。
- TDMA帧
  - 在GSM的TDMA中，每个载频被定义为一个TDMA帧，每个帧包含8个时隙（TS0～TS7），需要定义TDMA帧号。TDMA帧号需要用来做MS与BTS的 
    同步以及语音信号的加密，同步用在SCH上，加密是和Kc以及原始信号一起通过A5算法进行的。
  - 有了TDMA帧号，MS也可以判断当前载频到底是BCCH载频还是TCH载频，它的0号时隙传递的到底是BCCH信号还是TCH信号。因为BCCH载频包含了SCH，SCH告知了BCCH的TDMA帧号，因此载频的性质是可以根据TDMA帧号来分辨的。
  - 复帧，复帧是针对TDMA帧中的一个特定时隙来定义的
    - ![[image-20221008163037715.png]]
    - 含26帧持续时间为120ms复帧结构
      - 26帧的复帧包括26个TDMA帧，持续时间为120ms，一般用于TCH（以及跟随TCH的SACCH和FACCH），作为话音信道及其随路控制信道。
      - 在26帧业务信道复帧中，帧12（帧从0号帧算起，所以是第13帧）被用作慢速随路控制信道（SACCH），用来在MS和BTS之间传送链路控制信息。小区给每个业务信道分配的时隙都是这种格式，也就是说，最开始是12个突发脉冲序列的业务信息，接下来是1个Burst的SACCH， 然后是12个Burst的业务信息和一个空闲的Burst。
      - 当采用半速率时，26帧业务复帧中每个用来传业务的帧可以传两路 MS用户通话（空中接口中MS的数据速率是原来的一半）。尽管业务数 据速率减半了，但SACCH信息没有少，所以要把原来空闲的帧25也用作SACCH。图5.10就是一个典型的26帧复帧。
    - 含51帧持续时间为235.8ms
      - 51帧的复帧包括51个TDMA帧，持续时间为235.385ms。这种复帧用于携带BCH和CCCH，专用于控制信道。
  - 超帧（Superframe）：51帧和26帧之间是没有公约数的，要设置一种帧可以容纳这两种帧，那么这个帧的容量就必须要达到51×26＝1326帧。这种 
    帧称为超帧，1326个TDMA帧相当于6.12s的时间。
  - 巨帧（Hyperframe）:一个巨帧包含了2048个超帧结构 。 巨 帧 结 构 含 26×51×2048 ＝ 2715648 个 TDMA 帧 ， 持 续 时 间 为3h28min53s760ms。每个TDMA帧由帧计数器（FN）来标记。这些TDMA帧按照顺序排列，依次从0到2715647，帧号在同步信道中传送。巨帧也与加密和跳频有关系，一个巨帧持续3个多小时，每当一个新的巨帧开始时，加密和跳频算法也重新开始。
  - ![[image-20221008163921953.png]]

## 第三层协议以及七号信令

- 无线资源管理（RRM， Radio Resource Management ） RRM的职能在于管理无线接口，包括信道的配置、传输的模式、上下行电平及通信质量的测量、切换的操作等内容，其目的在于建立一条点对点的链路，并负责这条链路的维护和控制；
  1. 初始过程：随机接入和信道分配。
  2. 寻呼过程的管理。
  3. 传输模式与加密模式管理过程。
  4. 切换判决与处理。
  5. 呼叫重建。
  6. RR连接释放。
  7. 负载管理过程。
  8. SACCH管理过程。
  9. 广播消息（系统消息）
- 移 动 性 管 理 （ MM ， Mobility Management）:MM是建立在RRM之上用于处理移动性和安全保密性的功能组；
- 接续管理（CM，Connection Management）:CM位于上述两组之上，用于完成点对点通信的建立和释放。   

### 信令

1. 分类
   - 传送信令的通道：随路信令和共路信令
   - 功能：线路信令、路由信令和管理信令
   - 工作区域：用户线信令和局间信令
2. 分析
   1. 结构形式
      - 未编码
      - 已编码：起止式单频二进制信令、双频二进制编码信令及多频制信令
   2. 传送方式
      - 端到端方式：速度快，拨号后等待时间短。
      - 逐段转发方式：对线路要求低；信令在多段路由上的类型可以多种多样；信令传送速度慢，接续时间长。
      - 混合方式：在实际中，通常将端到端方式和逐段转发方式结合起来使用，这就是混合方式。
   3. 控制方式
      - 非互控方式（脉冲方式）：发端不断地将需要发送的连续或脉冲信令发向收端，而不管收端是否收到。设备简单，但可靠性差。
      - 半互控方式：发端向收端每发一个或一组脉冲信令后，必须等待收到收端回送的接收正常的证实信令后，才能接着发下一个指令。由发端发向收端的信令叫前向信令，由收端发向发端的信令叫后向信令。半互控方式就是前向信令受后向信令控制。
      - 全互控方式：发端发前向信令不能自动中断，要等收到收端的证实信令后，才停止发送；收端发证实信令也不能自动中断，须在发端信令停发后，才能停发证实信令。因为前向信令和后向信令均为连续的，所以称之为连续互控。这种方式抗干扰能力强，但是设备很复杂。
3. 定义：贝尔发明了电话，史端乔发明了交换机，电话加交换机合在一起就可以组成一个通信网络了。然而光有物理设备还不够，得发明一整套 
   指挥系统来控制这些设备本身以及上面跑来跑去的比特流，才能完成 
   正常的通信。==在通信网络中，这个指挥系统的指令称之为“信令”==。
4. 七号信令的基本功能结构由消息传递部分（MTP）和用户部分 （ UP ） 组 成 。 UP 可 以 是 电 话 用 户 部 分 （ TUP ） 、 数 据 用 户 部 分 （DUP）、ISDN部分（ISUP）等
   - 消息传递部分（Message Transfer Part，MTP）就包含了OSI模型一至三层的功能。
     1. MTP-1：为信令传输提供一条双向数据通道，定义了信令数据链路的物理、电气功能特性和链路接入方法。
     2. MTP-2：定义了在信令数据链路上传送信令消息的功能和程序。它和第一级一起共同保证信令消息在两信令点之间的链路上可靠地传送。
        - 消息信令单元（Message Signal Unit，MSU）、链路状态信令单元（Link Status Signal Unit，LSSU）、插入信令单元（Fill-In Signal Unit，FISU）
          - ![[image-20221110112428257.png]]
        - 定界：采用码型为“01111110”的标志码作为信令单元的分界，它既表示上一信令单元的结束，又表示下一信令单元的开始。信令单元里本身的“01111110”码型。在信令的发送端进行“0”比特插入，在接收端进行“0”比特删除。“0”比特插入，就是在发端连续发5个“1”之后插入一个比 特“0”，到了接收端，把这个插入的“0”去掉就是“0”比特删除。
        - 信令单元定位
        - 误差检测：将信息单元的所有比特对一个生成多项式G （x ）做一个 
          除法运算，得出一个16比特的余数r （x ），取其二进制反码附在这 
          些信息位的后面，称为CK字段
        - 误差校正：前向序号（Forward Sequence Number，FSN），前向指示比特（Forward Indicator Bit， FIB），后向序号（Backward Sequence Number，BSN），后向指示比特（Backward Indicator Bit，BIB）
        - 插入信令单元（FISU），当链路上没有MSU或者LSSU在跑的时候它就冒出来了，为的就是让大家知道这条链路还是好的，没有中断
        - 链路状态信令单元（LSSU）：有个叫SF的字段，SF（Status Flag）为状态标志，可以为8bit或16bit
        - LI（Length Indicator）：长度指示码，指示LI至CK间的八位位组个数，用于区分3种信 
          令单元
     3. MTP-3：在消息的实际传递中，将信令消息传至适当的信令链路或用户部分；当遇到故障或拥塞时，完成信令网的重新组合，以保证信令消息仍能可靠地传递。
        - ![[image-20221110114128531.png]]
        - 编号：SP，Signal Point，信令点。STP， Signal Transfer Point，信令转接点
        - 发信地址称为OPC（Original Point Code，源点码），收信地址称为DPC（Destination Point Code，目的地码），信令传输中SP之间可能有多条路径，用4bit的链路选择字段SLS（Signal Link Select）来标注这些不同的道路。
        - 管理消息![[image-20221110113233356.png]]
          - CHM：倒换和倒回消息。
            ECM：紧急倒换消息。
            FCM：信令业务流量控制消息。 
            TFM：禁止、允许、受限传递消息。 
            RSM：信令路由组测试消息。
            MIM：管理阻断消息。
            TRM：业务再启动允许消息。 
            DLM：信令数据链路连接消息。 
            UFC：用户部分流量控制消息。
        - 源地址和目的地地址识别、链路识别和管理消息在一起称为MSU的SIF（Signal Information Field，信令信息字段）
        - 4bit的SSF 字段，SSF字段的A、B bit备用，C、D bit为网络指示语（NI），用于 区分国内消息或国际业务消息
        - 4bit的SI为业务字段，用于指明该MSU是到第三级的消息还是到第 
          四级某一模块去的消息
        - 
   - UP（User Part）：由各种不同的用户部分组成，每个用户部分定义和某一类用户相关的信令功能和过程。

# LTE

## 原理和实现

### 概述

![[image-20221111111749230.png]]

- LTE 系 统 只 是 一 个 通 俗 的 说 法 ， 实 际 上 规 范 的 称 法 是 EPS （ Evolved Packet System ， 演 进 的 分 组 系 统 ） 。 EPS 由 核 心 网 EPC （ Evolved Packet Core ， 演 进 的 分 组 核 心 网 ） 以 及 E- UTRAN（演进的无线网）组成。EPS基于SAE（System Architecture Evolution，系统架构演进）技术，E-UTRAN基于LTE技术。
- ![[image-20221111112058609.png]]

#### SAE核心网

1. 电路交换需要为业务分配专用的通道，仿佛是在端到端之间建立了一条电路，把主叫方和被叫方连接在一样。因此，CS业务需要独占资源，能保证良好的业务质量，但资源的利用率不高。
2. PS分组交换业务。分组交换业务是伴随着IP技术而成长起来的，随着IP技术的一统天下，Internet的普及，各种 业 务 都 分 组 化 了 ， PS业 务 日 渐 兴 盛 。 我 们 最 常 用 的 PS业 务 就 是 上网。
3. 电 路 域 的 设 备 包 括 MSC-Server和 MGW（ Media Gateway ， 媒 体 网 关 ） 两 种 网 元 。 MSC是 移 动 交 换 机 的 意 思 ， MSC- Server可以简写为MSC-S。
4. 分 组 域 的 主 要 设 备 是 SGSN （ GPRS 服 务 支 持 节 点 ） 和 GGSN（ GPRS网 关 支 持 节 点 ） 。 SGSN的 角 色 类 似 于 电 路 域 的 MSC- S， 负 责 为 服 务 区 域 内 的 分 组 数 据 用 户 提 供 服 务 ， 并 进 行 分 组 数 据 用户的接入控制、安全认证和位置管理等工作。GGSN负责将分组数据传送到相应的网络，是GPRS网络与外部分组交换网络的接口，还要完成协议转换、路由选择和消息过滤等工作。分组业务数据流先经过SGSN，再经过GGSN。
5. ![[image-20221111114554159.png]]
   - MME （ Mobility Management Entity ， 移 动 性 管 理 实 体 ） ： 这 是 EPC中 的 主 要 网 元 ， 从 名 称 上 就 可 以 看 到 ， MME负 责 管 理 和 控 
     制，相当于班长。
   - SGW （ Serving GateWay ， 业 务 网 关 ） ： 这 也 是 EPC 中 的 主 要 网元，负责处理业务流。
   - PGW（PDN GateWay，PDN网关）：这也是EPC中的主要网元， 负责与PDN接口。所谓PDN（分组数据网），通常是指Internet。 
   - HSS（Home Subscribers Server，归属用户服务器）：这是HLR的升级，但是作用与HLR一样，负责存储用户的关键信息。 
   - PCRF（ Policy and Charging Rules Function， 策 略 以 及 计 费 规 则 功 
     能）：这是用来控制服务质量QoS的网元。

##### MME

1. 用户鉴权：这是移动通信系统最基本的功能，本功能需要与HSS交互。
2. 移动性管理（寻呼、切换）：是移动通信系统最基本的功能。 
3. 漫游控制：当漫游用户接入系统后，MME需要访问漫游用户所属的HSS，从而得到该用户的信息。
4. 网关选择：MME下会连接多个SGW，用户业务选择哪个SGW，由MME来指派。
5. 承载管理：承载是WCDMA引入的概念，对应用户数据流。承载管理涉及承载的建立、释放等工作。
6. TA列表管理：TA（Tracking Area，跟踪区）是LTE中引入的新术语 ， 类 似 WCDMA 和 GPRS 系 统 的 路 由 区 RA ， 当 终 端 离 开 所 属TA ， 就 需 要 做 TA 更 新 。 在 LTE 系 统 中 ， eNodeB 可 以 属 于 多 个TA（多达16个），同样终端也可以归属于多个TA（多达16个）， 这样就为LTE系统带来了更多的灵活性。

##### SGW

1. SGW的 功 能 与 MME相 呼 应 。 简 单 地 说 ， SGW就 是 SGSN的 业 务面，负责处理用户的业务，用来完成移动数据业务的承载，并且与eNodeB、MME和PGW等设备进行交互
2. 漫游时分组核心网的接入点； 
3. LTE系统内部移动性的锚点； 
4. 空闲状态时缓存下行数据； 
5. 数据包路由和转发；
6. 计费； 
7. 合法监听

##### PGW

1. 外网互联的接入点；
2. 用户IP地址分配； 
3. 数据包路由和转发；计费；
4. 策略控制执行（PCEF）； 
5. 合法监听。

##### EPC

- 在建立业务承载时，EPC有两个选择：就近接入和回归接入
- ![[image-20221111135058870.png]]

#### LTE无线网络

- ![[image-20221111140348676.png]]
- ![[image-20221111141254086.png]]
  - RRC（ Radio Resource Control， 无线资源控制）
    - RRC只处理控制面的信息，主要负责LTE空中接口的无线资源分配与控制，还承担了信令的处理和发送。由于RRC负责LTE空中接口的无线资源管理工作，可以看成LTE空中接口的大脑，因此是LTE空中接口最重要的组成部分。
  - PDCP（Packet Data Convergence Protocol，分 组 数 据 汇 聚 协 议 ） 
    - PDCP是链路层L2的最上面的一个子层，主要工作是压缩IP包头， 另外也实施加密和无损切换。从PDCP子层开始，可以同时处理业务面和控制面的信息。
  - RLC （ Radio Link Control ， 无 线 链 路 控 制 ） 
    - RLC可以为上层应用提供可靠的数据传输业务，是LTE空中接口上保证服务质量（QoS）的一个重要环节。根据不同级别的QoS要求，RLC可以提 供 3种 模 式 的 数 据 传 输 服 务 ： 透 明 模 式 TM、 非 确 认 模 式 UM和 确 认模 式 AM。 透 明 模 式 的 服 务 质 量 最 低 ， 非 确 认 模 式 次 之 ， 确 认 模 式 的服 务 质 量 是 最 高 的 。
  - MAC（Medium Access Control，媒介接入控制）
    - 主要负责与物理层接口，进行传输格式选择和信道的复用，支持无线网络的处理机制，如随机接入、调度、HARQ、上行功率控制等功能。
    - 进 行 信 道 编 解 码 ， 支 持 OFDM 调 制 复 用 、 支 持 多 天线，体现了LTE技术革命性的一面。
  - PHY物 理层，
- ![[image-20221111141818527.png]]
- 信 令 无 线 承 载 ：Signal Radio Bearer，SRB
- 无 线 承 载：Signal Radio Bearer， RB
- Non Access Stratum，NAS 非接入层
- Access Stratum，AS 接入层
- ![[image-20221111142946872.png]]
- ![[image-20221111143800133.png]]
- ![[image-20221111143926592.png]]

## 流程和机制

- ![[watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBA5Lic5ZOlVjV-,size_20,color_FFFFFF,t_70,g_se,x_16.png]]
  
- 系统架构演进（又名SAE，System Architecture Evolution）是3GPP所制定的LTE无线通信的核心网络标准。
  - 移动性管理实体（MME，Mobility Management Entity）：MME是LTE接入网络的关键控制节点。它负责空闲模式UE（用户设备）跟踪和寻呼控制。这些内容也包括UE的注册与注销过程，同时帮助UE选择S-GW，以完成LTE系统核心网络（CN）节点切换。

- LTE系统的处理机制及信令流程
  - 处理机制与信令流程这两块内容是透视LTE系统运行 、优化LTE系统运作的必由之路
  - LTE系统的处理机制与LTE终端的工作模式密切相关，而工作模式可以理解为终端的状态。
    - 来源：gsm->wcdma->lte
    - 关机、待机、联机

### 待机状态

- ![[image-20220927164459908.png]]
- ![[image-20220927164524456.png]]
- 待机状态的最大特点是终端的任务比较少，还没有建立与网络的业务连接，基本不占用网络的资源，也就是待机状态开销小、省资源。
- 终端工作模式的差别
  - 关机后终端并没有完全断电，还有一部分模块以极低的功耗工作着。
  - 处在联机状态的终端需要消耗大量的资源，无论是终端自身还是网络侧的开销都很大
    - 终端就是为了联机状态而生，有了联机状态终端才有存在价值。
- 目的
  - 必须跟对小区，团结在合适的基站的周围； 
    - 闻——测量周边环境
    - 听——小区广播和寻呼
  - 时刻准备建立业务连接。
- 要求
  - 省电：也就是尽量延长终端的待机时间； 
  - 响应快：也就是网络寻呼后终端能尽快连接。
    - DRX（Discontinuous Recive，不连续接收）：就是把待机状态再细分为休眠和唤醒两种状态，两种状态周期性地出现
      - DRX机制就是终端平时休眠，短时唤醒，唤醒时才会执行待机状态的相关工作。
      - 计时以无线帧为单位，终端唤醒的时刻是固定的，与无线帧的系统帧编号SFN相关。
      - DRX周期：把两个相邻唤醒时刻的时间差定义为一个休眠周期
        - LTE的 技 术 规 范 TS36.331定 义 了 4种 DRX周 期 长 度 ， 分 别 是 32、 64、128或256个无线帧，对应320ms、640ms、1.28s或2.56s。
        - LTE系统为每个小区设置一种默认的DRX周期，还允许为终端设置独立的DRX周期。终端最终使用其中最短的一个DRX周期。
        - 解决特定问题求解步骤的描述
- 任务
  - PLMN选择；
    - User PLMN、Operator PLMN、forbidden PLMN、Interrogating PLMN、Home PLMN、Visited PLMN、Equivalent PLMN
  - 小区选择与重选； 
  - 位置登记。
- 运行流程
  - ![[image-20220926134717179.png]]
    - 小区
      - 服务小区，终端当前驻留的小区；
      - 邻区，终端能感知到的其他小区。

#### 驻留

- Camp
- 度量：看终端是否与小区同步。
  - 同步：指的是终端接收到了小区广播的系统信息，包括接入参数、邻区信息等一系列的系统信息。
- 要求
  - 需要终端始终监听网络的寻呼，从而实现一呼即应，就像孩子时刻听从父母的召唤一样。
  - 需要终端始终驻留在最好的小区中，这样可以保证终端在建立业务连接后，业务效果是最好的。这就要求终端不间断地感知周边的环境。

#### PLMN选择

- 原因：用户只能在归属PLMN、等价PLMN和漫游PLMN上得到服务
- PLMN选 择 基 于 PLMN在 无 线 侧 的 三 大 特 性 
  - 工 作 频 段
    - 工 作 频 段 与 终 端 的 制 式 有 关 ， 现 在 的 LTE 终 端 普 遍 都 是 多 模 终端，还可以支持3G或者2G的制式
  - 频 点 
  - PLMN标识
- 过程
  - PLMN搜索：这个步骤与频点和PLMN标识相关；
    - PLMN 搜 索 是 终 端 扫 描 所 在 区 域 的 PLMN 信 息 ， 产 生 一 个 可 用PLMN列表，列表中包括工作频点以及PLMN标识，PLMN标识也就是 
      MCC和MNC。
      - 终端在进行PLMN搜索时，将进行初始小区选择的过程，以获得PLMN标识和工作频点。
      - 在初始小区选择的过程中，终端搜索工作频段上的各个频点，得到PLMN标识，加入到一个可用的PLMN列表中。可用PLMN列表中包括 USIM 卡 上 存 储 的 PLMN 信 息 ， 还 包 含 PLMN 搜 索 过 程 中 得 到 的PLMN。可用PLMN列表中的PLMN按优先级进行排序。
      - 
  - PLMN注册。
    - PLMN注册是终端根据PLMN列表的信息注册到PLMN中，PLMN注册又称为附着，终端需要与网络交互。
      - PLMN注册从普通小区选择过程开始，以终端驻留到一个合适的小区结束。
      - 终端在选定PLMN对应的频点上进行普通小区选择过程，找到目标小区后，终端进行附着，注册到PLMN中。注册成功后，终端进入驻留状态。

#### 小区选择

- 小区选择分为初始小区选择和普通小区选择两种方式
  - ![[image-20220926141823701.png]]
    1. 在进行初始小区选择时，终端并不确定工作频点；而在进行普通小区选择时，终端已经确定了工作频点。工作频点的信息，可能来自 
       终 端 和 USIM卡 中 存 储 的 信 息 ， 也 可 能 来 自 初 始 小 区 选 择 得 到 的 可 用PLMN列表。
    2. 初始小区选择用于终端开机后以及从覆盖盲区回到覆盖区域 的 PLMN搜 索 过 程 中 ； 而 普 通 小 区 选 择 用 于 终 端 开 机 后 的 PLMN注 
       册过程或者从联机状态返回待机状态。
- 普通小区选择![[image-20220926142035218.png]]

- 初始小区选择
  - 终端在进行初始小区选择时需要了解所有频段的环境，因此会在每个频段上扫描频点；
  - 在每个频点上终端只关注最强的小区信号，并与之同步； 
  - 终端同步后只需要获得PLMN标识，而且不需要驻留到目标小区中。
  - 初始小区选择是个循环过程，直到扫描完全部频段。

#### 小区重选

- ![[image-20220926142447783.png]]

#### 终端的测量机制与判决

- 测量（Measurement）
- 小区选择中的测量
  - 测量对象
    - RSRP：RSRP (Reference Signal Receiving Power，参考信号接收功率) 是LTE网络中可以代表无线信号强度的关键参数以及物理层测量需求之一，是在某个符号内承载参考信号的所有RE(资源粒子)上接收到的信号功率的平均值。
    - RSRQ：RSRQ（Reference Signal Receiving Quality）表示LTE参考信号接收质量，这种度量主要是根据信号质量来对不同LTE候选小区进行排序。这种测量用作切换和小区重选决定的输入。
  - 测量范围
    - 初始小区选择。这时终端会对全频段进行测量，耗时会比较长。
    - 普通小区选择，是指终端根据确定的频点信息对进行小区选择。
- 小区重选中的测量
  - 测量对象
    - 小 区 重 选 与 小 区 选 择 类 似 ， 终 端 需 要 测 量 RSRP 或 者RSRQ（R9），同样，对于LTE系统而言，终端通常测量RSRP就足够了。
  - 测量范围
    - 在小区重选时，终端需要测量服务小区以及周围的邻区。
- 判决（Criterion）：判决很简单，就是终端根据测量结果，决定要不要动作，判决的依据就是算法的结果。
- 小区重选过程与判据
  - 考量
    - LTE系统设置了很多门限值，只有达到了相应的门限，终端才会启动相应的测量。
    - 优先级，不同的频点可以设置不同的优先级，这样网络侧更容易控制终端的重选行为
    - 终端的移动速度
  - ![[image-20220926150102789.png]]

#### 小区同步

- LTE的时间结构

  - FDD
    - FDD LTE空中接口的时间结构分无线帧、子帧和时隙三个层次，无线帧的时长为10ms，子帧的时长为1ms，时隙的时长为0.5ms。每个时隙还由多个OFDM符号组成，每个OFDM符号的时长也是固定的，与子载波间隔相关。在现网中，子载波间隔为15kHz，对应的OFDM符号时长为66.7s。66.7s等于2048个Ts，Ts是采样点时长的意思，是LTE系统最小的一个时间单位。
    - ![[image-20220926160124619.png]]

  - TDD
  - 尽管TD-LTE增加了一层时间结构，并且引入了可变的上下行比例和特殊子帧格式，但是无线帧、子帧和时隙的时长以及时隙的内部结构与FDD LTE还是保持了高度地一致，实现了尽可能地兼容。

- 过程

  - 时间同步，就是在终端侧复制小区的时间结构，实现的方法就是同步机制。
  - 为了实施同步机制，终端还需要小区的帮助，提供一些信号，这些信号用于同步过程，称为同步信号。
  - ![[image-20220926160738912.png]]

#### 小区广播机制

- 小区通过广播各种系统信息，可以控制终端相应的处理机制。

- 小区会采用周期性广播系统信息的方式，循环发送系统信息，保证终端都能尽快地接收到系统信息。当然，终端为了省电，只要接收到了有效的系统信息，就不用总是去接收系统信息了。

  - MIB是主信息块的缩写，全称是Master Information Block；

    - LTE系统的MIB一共有24比特
    - 下行带宽：长3比特，对应6、15、25、50、75和100个RB六种带宽，也就是1.4MHz、3MHz、5MHz、10MHz、15MHz和20MHz的带宽。
    - PHICH信道位置：长1比特，对应正常或扩展的PHICH信道。
    - PHICH信道参数：长2比特，代表PHICH信道参数Ng，对应1/6、1/2、1或2四种取值。关于PHICH的配置，请大家翻阅《LTE教程：结构与实施》一书。
    - SFN系统帧号：长8比特，代表SFN的高8位，剩下的低2位需要终端自行判断。
    - 预留比特：长度为10比特，目前没有使用。
    - 注意：MIB还利用编码，附带传送了天线的数量，只有知道了天线数量，终端才能准确测量出RSRP。

  - SIB是系统信息块的缩写，全称是System Information Block。

    - PLMN标识：MCC和MNC，LTE小区可广播多达6组RLMN标识；
    - TAC：跟踪区标识；
    - CID：小区标识，注意这个标识与PCI不是一回事，CID用于核心网，而PCI只用于无线网；
    - 小区选择参数：Qrxlevmin；
    - 工作频段标识：如果是中国联通和中国电信的1.8G FDD LTE网络，对应的频段标识就是3，如果是中国移动的TD-LTE网络，对应的频段标识是38、39或者40；
    - SIB调度信息；
    - TDD配置参数：包含上下行比例和特殊子帧格式等信息。

  - | 类型 | 内容                      | 特点 |
    | ---- | ------------------------- | ---- |
    | MIB  | 系统基本信息              | 必备 |
    | SIB1 | 小区选择参数、SIB调度信息 | 必备 |
    | SIB2 | 随机接入参数、信道配置    | 必备 |
    | SIB3 | 小区重选参数              | 必备 |
    | SIB4 | 同频邻区信息              | 必备 |
    | SIB5 | 异频邻区信息              | 可选 |
    | SIB6 | WCDMA/TD-SCDMA邻区信息    | 可选 |
    | SIB7 | GSM邻区信息               | 可选 |
    | SIB8 | cdma2000邻区信息          | 可选 |

#### 位置登记与寻呼机制

- 位置区
  - 由地理上相邻的小区组成的一个区域，这些小区实现连续覆盖。
  - 设置了位置区后，终端只有改变了位置区，才会向基站汇报，进行位置更新，这样终端的汇报频率就大幅减少了，大大降低了网络和终端的开销。
  - 网络侧掌握的终端位置从小区变成了位置区，不够精确。为了解决这个问题，需要寻呼机制的支持，而且位置区也不是越大越好。
  - 移动通信系统
    - GSM系统采用了位置区Location Area，缩写是LA，WCDMA系统的电路交换CS业务也沿用了LA。
    - GPRS系统则采用了路由区Routing Area，缩写是RA，WCDMA系统的分组交换PS业务也沿用了RA。
    - LTE系统变为跟踪区Tracking Area，缩写是TA，TA继承自RA。
      - TA列表：可以理解为TA组，也就是1～16个相邻TA的组合。
        - 作用：在LTE系统中，LTE终端如果在TA列表的范围内移动，即使改变了TA，也不用进行位置更新。
- 寻呼
  - Paging，用于网络侧呼叫终端，从而实现被叫。另外，无线网络还可以通知终端系统信息发生了改变，从而触发终端重新来接收系统信息。
  - 网络侧采用S-TMSI来寻呼终端，S-TMSI是LTE终端在核心网EPC中的临时标识。如果终端没有分配到S-TMSI，就只能用终端的 IMSI来寻呼终端了
    - 临时移动用户识别（Temporary Mobile Subscriber Identity，TMSI）。
    - S-TMSI：为了保证用户身份的机密性，在E-UTRAN系统中，MME会分配临时移动用户识别码S-TMSI访问移动用户。S-TMSI是GUTI的一种缩短格式，以保证能够对无线信令进行更有效的处理（如寻呼及服务请求）。S-TMSI由MMEC和M-TMSI组成，用于对用户进行寻呼。
  - 寻呼区域：网络侧知道终端所在的TA列表，所以寻呼区就等于终端TA列表中的所有基站。如果终端没有响应寻呼，网络还可以进行第二次寻呼，这时网络可以扩大寻呼区，变成在MME下属的所有基站中寻呼。
  - 消息发送方式：
    - 在LTE系统中，寻呼信息由PDSCH信道来承载，与业务数据和其他信令一起分享PDSCH信道
    - 寻呼帧：寻呼帧就是承载有寻呼消息的无线帧，6种密度，对应每个DRX周期无线帧中寻呼帧的比例，分别是1、1/2、1/4、1/8、1/16和1/32
    - 寻呼时机（Paging Occasion，PO），就是寻呼帧中承载有寻呼信息的子帧。，按FDD和TDD两种双工方式，各定义了3种密度的寻呼时机的位置分布，一个无线帧中可以安排1、2或4个子帧来承载寻呼信息寻。呼时机的密度在规范TS36.304中称为Ns，取值为1、2或4。
    - 寻呼信息的发送
      - 子帧发送位置：与终端的UE_ID参数相关，而UE_ID等于终端的IMSI对1024取模的结果。
      - 基站寻呼步骤
        1. 得到终端的UE_ID。
        2. 得到一个DRX周期中寻呼帧的数量N。
        3. 根据UE_ID和N，采用散列的方法，确定终端寻呼信息所在无线帧的SFN。
        4. 得到每个寻呼帧中寻呼信息占用的子帧数量Ns。
        5. 根据双工方式、UE_ID、N和Ns，采用散列的方法，再确定终端寻呼信息所在的寻呼时机。

### 联机状态

- Connect mode，终端可以说就是为了联机状 态而生，有了联机状态终端才有存在价值。
  - ![[image-20220927170131152.png]]

- 使命
  - 建立业务连接；
  - 建立安全的业务连接； 
  - 保持业务连接的连续性； 
  - 减少对其他设备的干扰。
- 流程
  - ![[image-20220927171454329.png]]
- 重要参数
  - ![[image-20221111150238605.png]]
  - ![[image-20221111150300840.png]]
  - ![[image-20221111150315402.png]]

- 联机id
  - ![[image-20221111150410496.png]]


#### 随机接入

- 所谓随机，可以理解为异步，也就是终端自行其是，可以随时发起随机接入，基站不能预测、也不能控制终端什么时候进行随机接入。而接入就是终端与基站建立联系，从而能获得网络的资源，建立业务连接。不过在建立业务连接之前，必须让基站实现与终端的同步。

##### 接入时间

- 待机状态的终端有信息要发送，但是没有相应的传输通道，这时就需要随机接入过程，称为初始接入
- 终端监听到了PDCCH上的DCI，发现是自己的C-RNTI（Cell Radio Network Temporary Identifier，小区级无线网临时标识），但是又没有上行资源；或者终端发送调度请求SR后，得不到基站的响应，退而求其次，就需要执行随机接入过程。
  - DCI：Downlink Control Information
- 终端的切换过程也需要进行随机接入

##### 作用

1. 终端获得C-RNTI
   - C-RNTI是终端在无线网络中的标识，是PDCCH物理信道中用来区分不同用户DCI的标识。
   - PDSCH：物理下行共享信道，Physical Downlink Shared Channel
   - PDCCH：PDCCH（Physical Downlink Control Channel）指的是物理下行控制信道。PDCCH承载调度以及其他控制信息，具体包含传输格式、资源分配、上行调度许可、功率控制以及上行重传信息等。
   - LTE物理下行信道中的一种，是LTE承载主要用户数据的下行链路通道，所有的用户数据都可以使用，还包括没有在PBCH中传输的系统广播消息和寻呼消息-LTE中没有特定的物理层寻呼信道。
2. 终端实现TA时间提前。实现了TA时间提前，也就实现了上行同步
3. 终端获得上行资源

##### 问题

1. 区分终端
   - LTE系统引入了伪随机码ZC序列来表示终端的代号，也就是终端的标识
2. 避免终端之间的冲突
   - 非竞争随机接入，就是由基站来指定RAPID，这样终端的RAPID肯定不会冲突。显然这种方式要求终端已经与基站建立连接，也就是只能用于切换。
   - 竞争性随机接入更为普遍，由终端自由选择PRACH信道和RAPID，同一PRACH信道中不同终端的RAPID可能相同，从而产生冲突，这就需要LTE空中接口MAC子层来解决冲突。
3. 解决终端之间的干扰
   - PRACH（Physical Random Access Channel，物理随机接入信道），是UE一开始发起呼叫时的接入信道，UE接收到FPACH响应消息后，会根据Node B指示的信息在PRACH信道发送RRC Connection Request消息，进行RRC连接的建立。

#### 安全机制

##### 鉴权

1. 用户标识IMSI
2. 用户密码又称密钥，在LTE系统中称为K参数，是个128比特的二进制数，也存储在用户的USIM卡以及核心网的数据库HSS中
3. ![[image-20221110162251667.png]]

##### 加密

1. 核心网通常不直接呼叫用户的IMSI，而是呼叫用户的代号，称为S-TMSI（SAE用户临时号码）。

##### 完整性保护

1. 完整性保护类似于压缩文件后进行的CRC校验，也是在原始信息后附加一段内容。附加内容的产生基于特定的算法，称为完整性保护算法。在执行算法前，需要输入原始数据、完整性保护密钥、计数器的数值以及其他一些参数，这样才能得到正确的附加内容。

#### 资源调度

1. 资源在移动通信系统中，指的是空中接口上由各个用户分享的物理资源，也称为无线资源。在LTE系统中，资源就是时频网格。在随机接入过程中我们已经看到了上行的时频网格，下行方向同样有时频网格，上下行都有相应的资源。
2. 调度，Scheduling，也就是资源在不同用户之间的分配。
3. 特点
   1. 调度分下行和上行两个方向来进行。
   2. 无论是上行资源还是下行资源，都由基站来掌控。
   3. 调度过程由基站的调度器来执行，调度器基于调度算法来工作。
   4. 调度过程需要终端的参与。
4. 单位
   1. 时频资源是以调度块为单位来计量的，调度块的英文缩写为SB。一个调度块占用的时频资源等于，时域上1个子帧，也就是1ms或频域上12个连续子载波，也就是1个RB的带宽。

##### 下行资源调度

1. 高速下行分组接入（High Speed Downlink Packet Access，缩写为*HSDPA*）是一种移动通信协议，又称为3.5G（3½G），属于W-CDMA技术的延伸。
2. 调度过程在基站的调度器中进行，需要输入很多信息，分别来自终端、基站和网络侧。调度器根据调度算法，在终端间安排和分配无线资源，包括调度块SB的数量、时频分布、调制与编码方式等内容。
3. 调度频率：调度器多长时间调度一次。TTI ， Transport Time Interval。LTE系统的TTI为1ms，等于1个子帧的时长，比HSDPA系统TTI的2ms缩短了一倍。
4. 优先级：1——重传的信令； ->2——初传信令;->3——重传的数据;->4——初传数据。
5. 状 态 信 息 中  CQI （ Channel Quality Indicator，信道质量指示）:终端不断测量基站广播的小区参考信号CRS，推导出相应的CQI，然后发送给基站。
6. 调度算法：轮询RR（Round Robin）；比例公平PF（Proportional Fair）； 小区最大吞吐率MAX。

##### 上行资源调度

1. 终端首先需要发送调度请求（Scheduling Request，SR），表明终端有数据要上传
2. ![[image-20221111103453378.png]]
3. SR可以通过随机接入过程上传，这时将采用终端的C-RNTI作为冲突检测的标识。基站也可以为终端预先分配传送SR的PUCCH信道，这样SR上传的时延会比较少。另一种基站收到终端通过PUCCH信道发送的SR 后，会给终端分配PUSCH信道，分配信息称为上行许可（UL Grant）， 用终端的C-RNTI加扰后，通过PDCCH信道下发。
4. 终端收到上行许可后，根据分配的信息，先用这个PUSCH信道来上报缓冲区中待发的上行数据量，称为BSR（Buffer State Report）。

#### 功率控制

1. 功率控制（Power Control），即发射功率控制。

##### 功率源：功放

- LTE无线网络中的基站通常是三扇区的基站，每个扇区连接双端口天线，采用双发射的工作模式，每路发射通道配置一个功放，每个扇区需要配置两个功放。

##### 功率分布：信道与信号

- 下行信号有小区参考信号和同步信号；
- 下行物理信道有PBCH、PCFICH、PHICH、PDCCH、PDSCH信道； 
- 上行物理信道有PRACH、PUCCH、PUSCH信道。

##### 功率控制方法

- 下行恒定功率
- 上行可变功率

#### 测量与切换机制

- 测量的目的是为了更好地切换。 切换是为了保持业务的连续性。

### S1和X2接口协议

- ![[image-20221111151557251.png]]
  - 接入层 （Access Stratum，AS）和非接入层（Non Access Stratum，NAS）两 
    大部分：接入层（AS）包含物理层、链路层和网络层，而非接入层 （NAS）为上层，如图3.10所示。接入层（AS）通过服务接入点 （SAP）为非接入层（NAS）提供服务。

#### S1接口

##### S1-U

- 用户面，用来连接SGW与eNB。

- ![[image-20221111152015251.png]]
  - GPRS隧道协议（GPRS Tunnelling Protocol，简称GTP）是GPRS核心网目前定义的基于IP的协议。大体上说，这个协议允许GSM或WCDMA网络的最终用户可以随处移动，而同时持续地连接到因特网，如同只是从GGSN的同一个位置进行的。
  - 它通过承载从当前正在为签约用户（subscriber）提供服务的SGSN到当前正在处理该签约用户的会话的GGSN的签约用户数据来实现。GPRS核心网使用三种形式的GTP。
  - GTP协议本质上是一种IP包的封装协议，也就是IP over IP。，所谓用户面PDU，就是IP数据包。这些IP数据包经过GTP协议的封装，可以在LTE核心网中传送。
  - S1-U接口上传送着多个用户的数据流，每个用户也可能并发多个数据流，这些数据流的QoS各不相同。在S1-U接口上，数据流是利用TEID（Tunnel Endpoint Identifier，隧道端点ID）来区分的，而TEID恰恰是GTP协议中的地址

1. ![[image-20221111151908700.png]]
2. ![[image-20221111152519953.png]]

##### S1-MME

- 控制面，用来连接MME与eNB；
- ![[image-20221111152830638.png]]
  - SCTP 是 Stream Control Transmission Protocol的缩写，也就是流控传输协议。SCTP是TCP协议的升级版，性能优于TCP协议。
- ![[image-20221111152945363.png]]
- 功能
  - UE上下文的管理；
    - UE上下文就是终端的上下文，可以理解为终端和用户的档案，是终端和用户相关信息的集合
  - 传输NAS信令；
    - 涉及用户的鉴权、加密等过程，与具体的终端相关。
  - 业务承载E-RAB的管理； 
  - 终端切换的处理；
  - 寻呼。

#### X2接口

##### X2-CP，控制面

- X2-CP接口的协议栈结构，除了最上层由S1- AP变成X2-AP，也就是X2接口的应用层协议外，其他的协议栈都保持一致。
- X2-CP的对等层通信最上层为X2-AP协议，其他和S1-U接口对等层通信一样
  - 切换；
  - 小区间负载均衡； 
  - 小区间干扰协调
- ![[image-20221111154548320.png]]
  - 源基站在X2-CP接口上向目标基站发出Handover Request消息， 请求切换。
  - 目标基站收到Handover Request消息后，判断可以接纳终端的切入，向源基站回复Handover Request Acknowledge消息。

##### X2-U，用户面

- X2-U接口的分层结构和S1-U接口协议栈一样
- X2-U的对等层通信S1-U接口对等层通信一样

### 空中接口

#### 概述

- 空中接口（Radio Interface，也称为Air Interface），是移动通信系统中基站与终端之间的接口
  - LTE空中接口上传送的信令分为两种：一种是NAS信令，终点是MME；另外一种是RRC信令，终点是eNB。这两种信令在LTE空中接口上，都用SRB来承载。
  - LTE空中接口利用无线承载（RB）来传送业务数据，RB是Radio Bearer的缩写。
    - ![[watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9pcy1jbG91ZC5ibG9nLmNzZG4ubmV0,size_16,color_FFFFFF,t_70.png]]
- ![[image-20221111160541646.png]]
- 信令的传输过程![[image-20221113203107333.png]]
- ![[image-20221113203229548.png]]
- ![[image-20221111161404975.png]]
  - 这些信道是子层之间SAP的专用术语
  - 逻辑信道位于RLC子层与MAC子层之间
  - 传输信道位于MAC子层与物理层之间
  - 而物理信道是物理层的输出。


#### 分层

- ![[image-20221113190511702.png]]
- ![[image-20221113190615892.png]]
  - PDCP （ Packet Data Convergence Protocol ， 分 组 数 据 汇 聚 协 议 ） 
  - RLC （ Radio Link Control，无线链路控制）以及
  - MAC（Medium Access Control，媒体访问 控 制 ） 子 层 
  - RRC（ Radio Resource Control， 无 线 资 源 控 制 ） 是L3的一个子层。子层的名称通常来源于子层采用的协议。
  - NAS不是WCDMA空中接口的组成部分，但是产生的信令需要在WCDMA空中接口上传输，所以用虚线框标识。

- ![[image-20221113190755185.png]]

##### RRC

- ![[image-20221113191019524.png]]

  - RRC子层只有一半的宽度，这是因为RRC子层只处理信令。

  - RRC子层主要负责LTE空中接口的无线资源分配与控制。

  - 由于RRC子层承担了LTE空中接口的无线资源管理工作，可以看成LTE空中接口的大脑，因此是LTE空中接口最重要的组成部分。

  - LTE空中接口中的各种信令承载以及无线承载，包括逻辑信道、传输信道和物理信道的具体配置，都需要通过RRC子层来指定。另外，RRC子层还参与了待机状态和联机状态的众多处理机制， 比如广播、寻呼、鉴权、加密、业务连接的建立与释放、测量配置与测量报告等。以上这些处理机制，可以通过RRC消息的处理和NAS信令的收发来体现。

  - ![[image-20221113191427126.png]]

  - RRC信令

    - 

    - | 信令                                    | 主要用途              | 内容                      |
      | --------------------------------------- | --------------------- | ------------------------- |
      | RRC Connection Request                  | 建立RRC连接           | 终端的ID，建 立连接的原因 |
      | RRC Connection Setup                    | 建立RRC连接           | SRB1的信道配 置信息       |
      | RRC Connection Setup Complete           | 建立RRC连接           | PLMN标识以 及MME标识      |
      | RRC Connection Reconfiguration          | 建立SRB与RB           | SRB和RB的信 道配置信息    |
      |                                         | 测量配置              | 测量配置信息              |
      |                                         | 切换                  | 切换信息                  |
      | RRC Connection Reconfiguration Complete | 反馈执行完毕          | 无                        |
      | Measurement Report                      | 测量报告              | 测量报告                  |
      | Security Mode Command                   | 加密                  | 加密算法和完 整性保护算法 |
      | Security Mode Complete                  | 加密                  | 无                        |
      | Paging                                  | 寻呼                  | 终端D                     |
      | DLInformation Transfer                  | 承载来自MME 的NAS信令 | NAS信令                   |
      | ULInformation Transfer                  | 承载来自UE的 NAS信令  | NAS信令                   |

##### PDCP

- 功能
  - 在控制面上，PDCP子层执行加密和完整性保护；
  - 在用户面上，PDCP子层执行加密、包头压缩以及切换支持（也就是顺序发送和 
    重复性检查）。
  - 其主要功能是压缩IP数据包的包头。由于IP数据包都带有一个很大尺寸的包头（20字节），仅仅传输这些头部信息就需要占用大量的无线资源，而这些头部信息往往又可压缩。为了提高IP数据流在空中接口上的传输效率，需要对IP数据包头部信息进行压缩。
  - 一方面将加密功能也收归旗下，因此也就从仅仅处理用户面，而且扩展到了用户面和控制面，大小通吃；
  - 另一方面还加入了对无损切换的支持，用来避免在切换过程中丢失数据包。
  - 在 LTE系 统 中 ， 定 义 了 多 种 加 密 算 法 ， 分 别 编 号 为 eea0、 eea1和eea2 。 其 中 ， eea0 代 表 不 加 密 ， eea1 代 表 采 用 SNOW 3G 加 密 算 法 ， eea2代表采用AES加密算法

##### RLC

- RLC的主要功能是保证点到点数据的可靠传输
  - 分段；
  - 重发（ARQ（Automatic Repeat Request）机制）； 
  - 重组（排序）。
- 工作模式，根据不同级别的QoS要求
  - 透明传输模式（TM）：TM模式负责传输上层PDU，不附加任何的RLC信息，不保证数据传输的正确性，实时性最高。TM模式不执行分段／重组功能，基本没有开销。LTE系统的广播与寻呼信息采用了TM模式。
  - 非确认传输模式（UM）：UM模式负责传输上层PDU，携带有PDU的编号信息。UM模式下利 用 编 号 信 息 可 以 实 现 传 输 信 息 的 唯 一 性 。 UM模 式 下 不 进 行 数 据 重传 ， 因 此 不 保 证 数 据 传 输 的 正 确 性 ， 但 系 统 开 销 较 小 。 LTE 系 统 的 VoIP语音数据包采用了UM模式。
  - 确认传输模式（AM）：AM模 式 负 责 传 输 上 层 PDU， 能 进 行 数 据 重 传 ， 以 保 证 能 将 数 据正确地送达对等接收实体。当发生意外情况接收端不能正确接收时，AM会通知调用其的上层协议实体。AM模式的缺点是需要更多的处理过程，因此会引入较大的处理延迟，系统开销最大。LTE系统的信令以及数据业务采用了AM模式。
  - ![[image-20221113202018109.png]]

##### MAC

- MAC子 层 的 主 要 作 用 是 实 现 逻 辑 信 道 的 复 用 。 MAC子 层 可 以 将逻辑信道DCCH、DTCH以及BCCH等复用到共享传输信道SCH上。此外，MAC子层还支持HARQ机制、随机接入机制、时间提前机制以及调度机制。

##### PHY

-  LTE系 统 的 OFDM和 多 天 线 两 大 关 键 技术，就是应用于物理层；

- 至于测量以及功率控制等处理机制，也需要物理层来实施。

#### 信息传输

##### 上行

- ![[image-20221113202413947.png]]

##### 下行

- ![[image-20221113202803374.png]]

##### 对等层

- ![[image-20221113202820854.png]]

### 信令流程

- 背景
  1. 信令就是控制信息。
  2. 信令流程，就是通信系统不同设备之间信令的交互过程。这些交互过程发生在设备间的接口之上。
  3. 在接口上传递的信息必须遵循一定的协议，接口两端的设备才能正确理解。由于通信系统功能复杂，因此接口采用了分层结构，分层结构依据OSI分层模型的原理，每层都采用一种协议，每种协议完成一种 特 定 的 功 能 。
     1. 定义信息的种类；
     2. 定义信息的格式与内容； 
     3. 定义信息的时间顺序。
  4. 在协议中，通常信令的内容以消息为单位，格式由相应的协议来规定；而消息的先后顺序也是由协议规定的，这就是信令流程。协议对理解信令流程非常重要，可以说，协议是信令流程的基石，而信令流程就是协议的具体体现。
- ![[image-20221113221544191.png]]
  - SRB0用 来 承 载 RRC信 令 ， 逻 辑 信 道 是 CCCH， 其 RLC子 层为虚线框，代表采用TM的传输模式。SRB0的处理路径为SRB0-CCCH- SCH-PDSCH。
  - SRB1用来承载RRC信令和NAS信令，对应RRC连接，是最重要的SRB。SRB1要经过PDCP子层的处理，进行加密和完整性保护；SRB1的 RLC 子 层 采 用 AM 的 传 输 模 式 。 SRB1 的 处 理 路 径 为 SRB1-DCCH1- SCH-PDSCH。
  - SRB2用来承载NAS信令。SRB2也要经过PDCP子层的处理，进行加密和完整性保护；SRB1的RLC子层同样采用AM的传输模式。SRB2处理路径为SRB2-DCCH2-SCH-PDSCH。
- ![[image-20221113230939141.png]]
  1. 当终端需要从待机状态转入联机状态时，在随机接入过程中，利用CCCH信道建立起SRB0，用来收发RRC信令。在SRB0上，终端会接收到eNB发送的RRC connection setup消息，在消息中eNB为终端指配了SRB1的资源。
  2. 终端根据eNB的指示，建立起SRB1，用于收发RRC信令以及部分NAS信令。当终端的SRB1建立成功后，终端占用的SRB0就释放了。
  3. 在 SRB1 上 ， 终 端 会 接 收 到 eNB 发 送 的 RRC connectionreconfiguration消息，在消息中eNB为终端指配了SRB2的资源。之所以需要建立SRB2，是为了分流SRB1的信令负荷。
  4. 在联机状态，终端最后将是SRB1和SRB2并存。
- ![[image-20221113231515942.png]]

#### 位置更新流程

- TAU（Tracking Area Update，跟踪区更新），也就是当终端改变所在的TA后，终端通过TAU流程通知网络自己新的TA。

- 时间
  1. 最常见的一种情况，就是终端在小区重选后，发现进入了新的TA，而且新的TA又不在网络下发的TA列表中，这时终端就会发起TAU。
  2. 终端根据一个定时参数，周期性地进行TAU。周期性TAU的目的是确保网络侧能及时跟踪到终端的位置。
  3. 终端从异系统返回，也就是从GSM、WCDMA等系统返回LTE系统后，需要进行TAU。

- TA
  - 在 基 站 广 播 的 SIB1 消 息 中 ， 包 含 了 跟 踪 区 TA 的 信 息 ， 称 为TAI（Tracking Area Identity），终 端 根 据 SIB1中 的 TAI， 就 知 道 小 区 重 选 后 跟 踪 区 TA是 否 发 生了改变。
  - ![[image-20221113232125621.png]]

- 如何知道终端
  - 在 TAU过 程 中 ， 用 到 的 终 端 标 识 称 为 GUTI（ Globally Unique Temporary UE Identity），也就是终端全球唯一标识，由核心网分配。
  - ![[image-20221113232551128.png]]
    - 16比 特 的 MMEGI代 表 MME池 组 的编 号 ， 8比 特 的 MMEC代 表 MME的 代 码 ， 32比 特 的 M-TMSI则是MME为终端分配的临时标识。

- 过程
  - ![[image-20221113233120114.png]]
  - ![[image-20221113233153910.png]]
  - ![[image-20221114114649990.png]]

- TAU Request的主要内容

  - | 项目                                                         | 说明                           |
    | ------------------------------------------------------------ | ------------------------------ |
    | Security info                                                | 安全相关的信息                 |
    | Active Flag                                                  | 位置更新后是否进入联机 状态    |
    | EPS Update Type                                              | 位置更新方式（如联合位置更新） |
    | EPS Mobile Identity - o1d GUTI                               | 终端的原GUTI标识               |
    | UE Network Capability                                        | 终端的能力                     |
    | Tracking Area Identity - Last visited Registered TAI         | 终端原来的TAI                  |
    | DRX Parameter                                                | DRX参数                        |
    | EPS Bearer Context Status                                    | 承载的状态                     |
    | MS Network Capability                                        | GSM终端的能力                  |
    | Location Area Identification - old location Area Identification | GSM终端原来的LAI               |
    | Mobile Station Classmark 2                                   | GSM终端的能力2                 |
    | Mobile Station Classmark 3                                   | GSM终端的能力3                 |
    | GUTI Type - old GUTI Type                                    | 终端原GUTI的类型               |

- 鉴权

  - ![[image-20221114134123666.png]]

- NAS加密

  - ![[image-20221114134748476.png]]

- 接收位置更新

  - ![[image-20221114135234794.png]]
    - RRC的Security Mode Command消息用于启动接入层AS的加密机制，消息中指定了在AS加密所用的加密算法和完整性保护算法。终端收到后响应Security Mode Complete消息，表明开始接入层的加密。于是，继NAS加密后，AS加密也启动了。

- TAU Accept的主要内容

  - | 项目                        | 说明                          |
    | --------------------------- | ----------------------------- |
    | Security Info               | 安全相关的信息                |
    | EPS Update Result Value     | 位置更新方式（联合位置 更新） |
    | EPS Mobile Identity - GUTI  | 终端的标识GUTI                |
    | GPRS Timer - T3412 Value    | 周期性位置更新参数            |
    | Tracking Area Identity List | TA列表                        |
    | EPS Bearer Context Status   | 承载的状态                    |
    | EPS Network Feature Support | 网络的业务能力（含 VoLTE）    |

- 完成位置更新

  - ![[image-20221114140225941.png]]
  - 如果MME没有为终端分配新的GUTI，终端就不用回复TAU Complete消息。
    如果MME为终端分配了GUTI，那么终端在收到TAU Accept消息后， 将回复TAU Complete消息，eNB将终端的TAU Complete消息转发给MME

#### Attach流程

- Attach，即终端在PLMN中注册，从而建立了自己的档案，即前面讲过的终端上下文
- 时间
  1. 终端开机后需要进行附着，这种附着称为初始附着。这是最常见的一种情况。
  2. 终端从覆盖盲区返回到覆盖区，需要进行附着。
  3. 终端原来没有插SIM卡，后来插入SIM卡了，就需要进行附着。
- 作用
  - 终端在PLMN中注册，并驻留到小区；
  - 在MME中建立终端上下文； 
  - 为终端建立默认承载。
    - 默认承载，Default Bearer，也翻译为缺省承载。这是一个为了实现终端始终在线（Always On），减少处理时延而提供的EPS承载。
    - 默认承载意味着终端在附着后从核心网那里得到了一个IP地址以及默认的QoS设置，并且在SGW、基站和终端之间也建立了相应的E-RAB，对应SGW与基站间的S1承载以及基站与终端间的无线承载RB。
- ![[image-20221114143435110.png]]

##### 流程

1. ![[image-20221114141102465.png]]
   - ![[image-20221114141511265.png]]
2. ![[image-20221114141442155.png]]
3. ![[image-20221114141811487.png]]
4. 鉴权
5. NAS加密
6. ![[image-20221114142013136.png]]
   - MME在确认用户是合法用户后，为用户在eNB中创建相应的终端上下文，并开始建立默认承载。
   - 建立默认承载需要MME与SGW交互，并通过PGW最终建立默认承载，交互的过程反映在核心网的信令上。
7. 完成附着
   - ![[image-20221114142849416.png]]

#### 收发数据

- 收发数据是LTE终端的主要工作，LTE系统利用EPS承载来传输数据。EPS承载落实到无线网络就是E-RAB，因此终端收发数据流程是围绕建立E-RAB展开的。

##### 待机

###### 终端发起

- 如果终端处于待机状态，那么需要先经过随机接入的过程，终端获得资源，从而建立起E-RAB，用来承载数据。建立E-RAB其实是重建默认承载对应的E-RAB。这是因为默认承载在初始附着过程中就已经建立好了。
- ![[image-20221130140656213.png]]
- ![[image-20221130140718734.png]]
  - ![[image-20221130140825817.png]]
  - ![[image-20221130141028005.png]]

###### 网络发起

- ![[image-20221130142643480.png]]
  1. ![[image-20221130142614826.png]]

##### 联机

###### 终端发起

- 联机状态下终端已经建立了SRB1和SRB2，不需要经过随机接入过程，就可以发起建立EPS承载的过程
- ![[image-20221130141244561.png]]
  1. ![[image-20221130141506996.png]]
  2. ![[image-20221130141553454.png]]
  3. ![[image-20221130142032145.png]]

###### 网络发起

- ![[image-20221130142804385.png]]

#### 切换流程

- ![[image-20221130143032692.png]]
- ![[image-20221130143114855.png]]
  1. ![[image-20221130143546403.png]]

##### 基于X2接口的切换

- ![[image-20221130143751167.png]]
  1. ![[image-20221130143803280.png]]
  2. ![[image-20221130144253689.png]]
  3. ![[image-20221130144336768.png]]

##### 基于S1接口的切换

- ![[image-20221130144510645.png]]

#### 释放流程

- 一个是RRC连接的释放过程，另一个是去附着的过程。

##### RRC连接释放

- ![[image-20221130150330976.png]]

##### detach

- 去附着是附着过程的逆过程，去附着执行后，终端的默认承载会被清除。
- 去附着可以由终端发起，也可以由网络发起，最常见的是手机关机引起的去附着。

- 关机引起的detach，去附 着 类 型 为 关 机 （ Switch Off ）
  - ![[image-20221130151550673.png]]
- 非手机关机引起的去附着，去附着类型为正常去附着（Normal Detach）
  - ![[image-20221130152633673.png]]

### IRAT

- 介绍：IRAT就是终端在4G系统与2G或者3G系统之间的切换。
  - IRAT是Inter Radio Access Technology的缩写，中文翻译为异系统互操作。
    - 异系统，指的是2G、3G系统，比如GSM、WCDMA、TD-SCDMA、cdma2000系统，相对于LTE系统来说，都是异系统。
    - 互操作，就是转移的意思，与切换类似，是终端从一个系统转换到另外一个系统。
- 背景
  1. 4G网络的覆盖不够完善，还存在很多覆盖盲区
  2. 4G网络无法支持某些业务，比如语音业务。LTE系统中原生态只支持分组交换业务，除非部署了VoLTE，不然是没有办法支持基于电路交换技术的语音业务。
     - CSFB：Circuit Switched Fallback，电路域回落
       - CSFB不是由于覆盖原因导致的切换，而是由于业务原因导致的切换，我们认为进行CSFB时多模终端应该切换到同覆盖的3G或者2G的邻区。
       - 由于是同覆盖，因此在LTE系统中的测量过程就不是特别重要了。 
       - 考虑到在CSFB中关键的指标是呼叫时延，为了加快切换速度，缩短呼叫时延，实施CSFB时终端可以采用盲切的方式，直接切换到预先定义的3G或者2G的邻区。
- 种类
  - 待机状态下，IRAT就是多模终端的跨制式小区重选
  - 联机状态下，IRAT有三种方式，分别是切换PSHO、重定向以及快速返回FR
  - ![[image-20221130160516226.png]]
    - 切换PSHO就是在LTE的联机状态和3G的联机状态间转换；
    - 重定向就是从LTE的联机状态进入2G或3G的待机状态；
    - 快速返回FR就是从3G的联机状态进入LTE的待机状态。
- 性能对比
  - ![[image-20221202154245285.png]]

#### 联机策略

- ![[image-20221130161408880.png]]
- ![[image-20221130161433662.png]]
- ![[image-20221130161447965.png]]
  - EVDO：CDMA2000 1xEV-DO的简称是EVDO，EVDO（EV-DO)实际上是三个单词的缩写：Evolution（演进）、 Data Only。1xEV的意思是 'Evolution'，也表示标准的发展，DO的意思为Data Only(后来有为了能够更好地表达此技术的含义，把Data Only改为Data Optimized,表示EV-DO技术是对CDMA2000 1X网络在提供数据业务方面的一个有效的增强手段)。

#### 小区重选

- 原因：LTE网络的覆盖范围有限
- ![[image-20221202101816411.png]]

##### 跨制式小区重选

1. 接收系统信息
   - ![[image-20221202110655924.png]]
2. 测量与判决
   - LTE系统引入了参数S nonIntraSearchP，在SIB3中广播。当终端测量到服务小区的RSRP低于S nonIntraSearchP对应的信号强度后，才会启动异频测量
   - 小区重选可能涉及两个以上的制式，LTE系统中引入了频点的优先级，以控制多系统之间小区重选的效果，让优先级高的频点优先重选。通过频点与制式之间明确的映射关系，隐含建立了制式的优先级。
   - 相邻小区的频点和频点的优先级在系统信息中广播，
     - threshXHigh（SIB6/SIB7/SIB8）；
     - threshServingLow（SIB3）；
     - threshXLow（SIB6/SIB7/SIB8）。
     - SIB6对应异系统邻区为WCDMA或TD-SCDMA邻区，SIB7对应异系统邻区为GSM/GPRS邻区，SIB8对应异系统邻区为cdma2000邻区。
     - 终端在异频测量中，得到了高优先级邻区的RSRP，利用S算法转换为Srxlev，n，如果Srxlev，n满足Srxlev，n >threshXHigh，终端就会重选到高优先级邻区。
3. 随机接入
4. RAU/TAU
   - 在待机状态下，LTE核心网基于跟踪区TA管理LTE终端的位置，而对于WCDMA和GPRS系统的终端，核心网的位置管理基于路由区RA。
   - Track area update/Routing Area Update
   - ![[image-20221202111955620.png]]
5. 信道释放

##### 异系统重选整体流程

- ![[image-20221202112519921.png]]
- ![[image-20221202112539172.png]]

#### 异系统切换

- 特点
  - 异系统切换是多模终端从LTE系统的联机态转换到异系统的联机态，由于LTE系统基于分组交换PS，因此这种切换简称为PSHO
    - PSHO：Packet Switch HandOver
  - 异系统切换只发生在4G系统与3G系统之间，4G系统与GSM系统之间不支持PSHO
  - 即使是3G系统，WCDMA系统与TD-SCDMA系统支持PSHO的情况也是有差别的，支持能力与具体设备厂家有关
- 流程
  - ![[image-20221202140126437.png]]
    1. 测量：PSHO与普通切换一样，也是通过测量过程来启动的。eNB收到多模终端发出的测量报告后，发现目标小区是3G邻区，而且支持PSHO，就会进行PSHO。当然，如果目标小区不满足PSHO的条件，eNB会发起重定向的过程。
    2. 切换
       1. ![[image-20221202140654155.png]]
       2. ![[image-20221202140726983.png]]

#### 异系统互操作的测量过程

- 基站利用测量事件来启动异频测量。
- 同频测量A3事件，异频测量A2事件
  - A2事件定义为服务小区的信号弱于一个绝对门限，因此如果发生了A2事件，基站就可以要求终端启动异频测量。
  - 异系统测量的相关事件通常是B2事件，也就是服务小区信号弱于绝对门限1而异系统邻区信号强于绝对门限2。
  - 如果发生了B2事件，那么终端需要切换PSHO或者重定向到异系统的邻区。
  - ![[image-20221202141601214.png]]

#### 重定向

- 重定向，Redirect，就是终端从一 种制式的联机状态转到另外一种制式的待机状态。
- 原因：无法进行PSHO。PSHO要求太高，当前网络没有办法支持。
- 类别（根据源网络与目标网络的区别）
  1. 从4G系统切换到3G系统
     - 重定向（R8）
     - 增强重定向（R9）
  2. 从4G系统切换到GSM系统
     - CCO（Cell Change Order，改变小区指令）； 
     - NACC（网络辅助的CCO，等价于增强重定向）。
  3. 从4G系统切换到cdma2000系统
     - 非优化切换（等价于重定向）。
  4. 从3G系统切换到4G系统
     - FR（FastReturn，快速返回，等价于重定向）。

##### 重定向（R8）的流程

- LTE规范R8版本中定义的重定向，非优化激活切换以及FR也是基于类似的处理流程
- ![[image-20221202152001808.png]]
  - eNB收到B2测量事件后，判断需要进行重定向，于是向多模终端发送RRC Connection Release消息，其中携带Release with redirect信息单元，包含了3G系统的频点号ARFCN。
  - 多模终端在ARFCN指定的频点上搜索小区，接收目标小区的系统信息广播，从而获得接入参数。最后，多模终端根据接入参数进行随机接入。

##### 增强重定向（R9）的流程

- 增强重定向的改进在于，在基站下发的Release with Redirect信息单元中，还携带了3G系统信息广播的内容。
- 要想实施增强重定向，eNB必须掌握周边3G邻区的系统信息广播内容，这就要求在eNB与3G的RNC之间建立信息通道，并能传送相应的系统信息
- ![[image-20221202153337430.png]]

##### CCO的流程

- CCO（Cell Change Order，改变小区指令）是从4G系统切换到GSM系统的专用流程
- ![[image-20221202153917765.png]]

# IMS

## 概述

- IP  Multimedia  Subsystem(IMS) is a global, access-independent and standard-based IP connectivity and service control architecture that enables various types of multimedia services to end-users using common Internet-based protocols.
- ![[image-20221202162519919.png]]
- ![[image-20221205173119191.png]]
- From  GSM  to  3GPP  Release  7
  - ETSI：The European Telecommunications Standards Institute
  - GSM：Global System for Mobile Communications
  - GPRS：General Packet Radio Service
  - UTRAN：UMTS Terrestrial Radio Access Network
  - BTS：Base Transceiver Station
  - RNC：Radio Network Controller
  - SGSN：Serving GPRS Support Node 
  - OSA: Open Service Architecture 
  - MSC：Mobile Switching Centre
  - MGW：Server–Media Gateway
  - ![[image-20221202170242855.png]]

## 架构

### Architectural  requirements

1. IP  multimedia  sessions
   1. Existing communication networks are able to oﬀer voice, video and messaging type of services using circuit-switched bearers.
   2. end-users’ service oﬀerings should not decline
   3. oﬀering enriched communication means
   4. IMS users are able to mix and match a variety of IP-based services in any way they choose during a single communication session.
2. IP  connectivity
   1. IPv4，IPv6
   2. IP connectivity can be obtained either from the home network or the visited network
   3. ![[image-20221202181548173.png]]
      - This would allow users to use new, fancy IMS services even when they are roaming in an area that does not have an IMS network but 
        provides IP connectivity.
3. Ensuring  quality  of  service  for  IP  multimedia  services
   - Quality of Service (QoS)
   - Via the IMS, the UE negotiates its capabilities and expresses its QoS requirements during a Session Initiation Protocol (SIP) session setup or session modiﬁcation procedure.
     - Media  type,  direction  of  traﬃc.
     - Media  type  bit  rate,  packet  size,  packet  transport  frequency. 
     - Usage  of  RTP  payload  for  media  types.
     - Bandwidth  adaptation.
4. IP  policy  control  for  ensuring  correct  usage  of  media  resources
   - the capability to authorize and control the usage of bearer traﬃc intended for IMS media
   -  The policy control element is able to verify that values negotiated in SIP signalling are used when activating bearers for media traﬃc.This allows an operator to verify that its bearer resources are not misused
   - The policy control element is able to enforce when media traﬃc between the end points of a SIP session start or stop.This makes it possible to prevent the use of the bearer until session establishment is completed and allows traﬃc to start/stop in synchronization with the start/stop of charging for a session in IMS.
   - The policy control element is able to receive notiﬁcations when the IP connectivity access network service has either modiﬁed, suspended or released the bearer(s) of a user associated with a session.This allows IMS to release an ongoing session because, for instance, the user is no longer in the coverage area.
5. Secure  communication
   - ![[image-20221205112444635.png]]
6. Charging  arrangements
   - The IMS architecture allows diﬀerent charging models to be used
   - ![[image-20221205113341882.png]]
     - the IMS adds the possibility to charge for user IP traﬃc in a more granular manner than before.
7. Support  of  roaming
   - 所谓用户平面，就是真正传输业务数据（e.g. DNS Request、HTTP Request）的平面，简称 UP。相对应的，传送信令数据（e.g. E-RAB Setup Request、Create Bearer Request）的平面称为控制平面（Control Plane），简称 CP。
8. Interworking  withother  networks
9. Service  control  model
   - the entity that has access to the subscriber database and interacts directly with service platforms is always located at the user’s home network
10. Service  development
11. Layered  design
    - ![[image-20221205140133668.png]]
12. Access  independence
    - IMS services can be provided over any IP connectivity networks 

### entities  and  functionalities

- Session  management  and  routing  family  (CSCFs). 
- Databases  (HSS,  SLF).
- Services  (application  server,  MRFC,  MRFP).
- Interworking  functions  (BGCF,  MGCF,  IMS-MGW,  SGW). 
- Support  functions  (PDF,  SEG,  THIG).
- Charging.

#### Call  Session  Control  Functions  (CSCF)

- 分类
  - Proxy-CSCF (P-CSCF)
  - Serving-CSCF (S-CSCF) 
  - Interrogating-CSCF (I-CSCF)
- 作用：
  - they all play a role during registration and session establishment and form the SIP routing machinery
  - Both entities are able to release sessions on behalf of the user (e.g., when S-CSCF detects a hanging session or P-CSCF receives a notiﬁcation that a media bearer is lost) and are able to check the content of the Session Description Protocol (SDP) payload and to check whether it contains media types or codecs, which are not allowed for a user. When the proposed SDP does not ﬁt the operator’s policy, the CSCF rejects the request and sends a SIP error message to the UE.

#### Proxy Call  Session  Control  Function(P-CSCF)

- the ﬁrst contact point for users within the IMS
- 任务：SIP compression, IPSec security association, interaction with Policy Decision Function (PDF) and emergency session detection.

#### Interrogating  Call  Session  Control  Function  (I-CSCF)

- a contact point within an operator’s network for all connections destined to a subscriber of that network operator
- 任务
  - Obtaining  the  name  of  the  next  hop  (either  S-CSCF  or  application  server)  from  the  Home  Subscriber  Server  (HSS).
  - Assigning an S-CSCF based on received capabilities from the HSS
  - Routing  incoming  requests  further  to  an  assigned  S-CSCF  or  the  application  server
  - Providing  Topology  Hiding  Inter-network  Gateway  (THIG)  functionality

#### Serving  Call  Session  Control  Function  (S-CSCF)

-  the focal point of the IMS as it is responsible for handling registration processes, making routing decisions and maintaining session states, and storing the service proﬁle(s)
  - service proﬁle：A service proﬁle is a collection of user-speciﬁc information that is permanently stored in the HSS
- ![[image-20221205153219110.png]]

#### 紧急呼叫会话控制功能（E-CSCF)

- 紧急呼叫会话控制功能（E-CSCF)是一个处理IMS紧急请求，比如报警、火警和急救的专用功能实体。

#### Databases

- Home  Subscriber  Server  (HSS) 
  - the main data storage for all subscriber and service-related data of the IMS
  - 类型
    - user identities：
      - private  user identities：registration and authorization
      - public user identities：other users can use for requesting communication with the end-user
    - registration information
    - access parameters：to set up sessions and include parameters like user authentication, roaming authorization and allocated S-CSCF names
    - service-triggering information：enables SIP service execution
  - ![[image-20221205155035073.png]]
- Subscription  Locator  Function  (SLF)：a resolution mechanism that enables the I-CSCF, the S-CSCF and the AS to ﬁnd the address of the HSS that holds the subscriber data for a given user identity when multiple and separately addressable HSSs have been deployed by the network operator

#### 服务功能

- 类别：多媒体资源功能控制器( Multimedia Resource Function Controller，MRFC)、多媒体资源功能处理器( Multimedia Resource Function 
  Processor，MRFP)和应用服务器(Application Server，AS)。

##### 应用服务器

- 功能
  - 处理和影响从IMS接收到的SIP来话的能力;
  - 发起SIP请求的能力;
  - 向计费功能实体发送账目信息的能力。
- 提供的业务并不局限于基于SIP的服务，因为运营商能够为其IMS用户基于移动网络增强逻辑的定制应用（Customized Applications for Mobile 
  network Enhanced Logic，CAMEL)服务环境（Service Environment，CSE)和开发服务结构（Open Service Architecture，OSA)提供服务接入。因此，“AS”是一个术语，一般用来捕捉SIP AS、OSA服务性能服务器(Service Capability Server，SCS）和CAMEL IP多媒体服务交换功能（CAMEL IP Multimedia Service Switching Function，IM-SSF)的行为。
- ![[image-20221205165842504.png]]

##### 多媒体资源功能处理器( MRFP)

- 输入媒体流的混合（例如为多方通话进行的混合);
- 媒体流信源（如多媒体公告信源);
- 媒体流处理(例如音频代码转换、媒体分析)

##### IMS-CS互连互通功能

- ![[image-20221205170502408.png]]

##### 支撑功能

- 策略与计费规则功能（ PCRF)
  - PCRF负责根据从P-CSCF获得的会话和媒体相关信息来制定策略。
- 互连边界控制功能(IBCF)
  - 互连边界控制功能提供特定的功能以实现两个运营商域间的互连。它能支持IPv6与IPv4 IMS应用间的互通、实现网络拓扑隐藏、控制传输平面功能、屏蔽SIP信令消息、选择合适的信令互通、产生计费数据记录等。
- 传输网关（TrGW)
  - IBCF内的ALG功能可以控制传输网关（TrCW)，该网关负责不同IP版本在传输平面的互通（也就是修改真正传输IMS应用媒体的IP包，如RTP等)。
- 安全网关（SEG)
  - 安全网关（SEG)有在安全域间保护控制平面流量的功能。
- 位置检索功能（LRF)。
  - 位置检索功能（LRF)协助E-CSCF来处理IMS紧急会话，它将发起IMS紧急会话的UE的位置信息或/和会话所发往的公共安全应答点( PSAP)的地址传送到E-CSCF。

##### GPRS实体

- 服务GPRS支持节点( SCSN)：服务GPRS支持节点( SCSN)连接RAN和分组核心网。它负责为PS域进行控制和业务处理功能。控制部分包括两大主要功能:移动性管理和通话管理。移动性管理处理UE的位置和状态，并且对用户和UE进行鉴权。控制部分的通话管理处理连接接纳控制和现有数据连接中的任何变化，它也负责监督管理3G网络业务和资源，而且它还负责业务处理的执行。SGSN是作为用户数据通道的网关，换言之，它是UE和GGSN之间用户业务的中继。作为这个功能的一部分，SGSN也需要保证这些连接接收到适当的QoS。另外，SGSN还生成计费信息。
- 网关GPRS支持节点（GGSN)：网关GPRS支持节点（GCSN)提供与外部分组数据网之间的互连。GCSN的主要功能就是提供UE与外部数据网之间的连接，而外部数据网提供基于IP的应用和业务。例如，外部数据网可以是IMS或者因特网。

### IMS参考点

- ![[image-20221205173119191.png]]
- Gm参考点
  - Gm参考点连接UE和IMS。它用于传输UE和IMS之间所有的SIP信令消息。IMS中相对应的部分是P-CSCF。Gm参考点中的过程可以分为三大类:注册、会话控制和处理
  - 在注册过程中，UE使用Gm参考点发送注册请求给P-CSCF，该注册请求包含UE支持的安全机制的指示。在注册过程中，UE为其自身的鉴权与网络的鉴权需要交换必要的参数，获得固有的已注册的用户身份，协商与P-CSCF的安全关联的必要参数，还可能启动SIP压缩。另外，如果网络侧发起注销或者重鉴权请求时，需要Gm参考点通知UE。
  - 会话控制过程包含了移动台侧发起会话和移动台侧终止会话中的机制。在移动台侧发起会话中，Gm参考点用于转发从UE到P-CSCF的请求。在移动台终止侧会话中，Gm参考点用于转发从 P-CSCF到UE的请求。
  - 处理( transaction）过程通过Gm参考点发送独立的请求（例如 MESSAGE消息请求）和接收该请求所对应的所有响应（例如200 OK消息)。处理过程与会话控制过程之间的差别在于通话没有建立。
- Mw参考点
  - Gm参考点连接UE到IMS（也就是P-CSCF)。接下来，就需要不同CSCF之间基于SIP的参考点，这个参考点就是Mw。Mw参考点中的过程可以分为三大类:注册、会话控制和处理
  - 在注册过程中，P-CSCF使用Mw参考点转发来自UE的注册请求给I-CSCF。然后I-CSCF使用Mw参考点传送这个请求给S-CSCF。最后，S-CSCF的响应再通过Mw参考点反向传输回来。另外，在网络侧发起的注销和重授权过程中，S-CSCF使用Mw参考点将相应事件报告给UE。基于这个信息，UE和 P-CSCF可以执行必要的操作。例如，假设网络侧发起注销过程，P-CSCF要求PCRF确保所有传输层的资源都被相应地释放掉。
  - 会话控制过程包含了移动台侧发起会话和移动台侧终止会话中的机制。在移动台侧发起的会话中，Mw参考点用于转发从P-CSCF 到 S-CSCF和从 S-CSCF到I-CSCF的请求。在移动台侧终止会话中，Mw参考点用于转发从I-CSCF到 S-CSCF和从S-CSCF到P-CSCF的请求。这个参考点也用于网络侧发起的会话释放。例如，如果P-CSCF接收到了来自PCRF的媒体承载丢失指示，它就可以向S-CSCF发起一个会话释放。另外，计费相关的信息也是通过Mw参考点进行传输的。
  - 处理过程通过Mw参考点发送独立的请求（例如MESSAGE请求）和接收该请求所对应的所有响应（例如200 OK消息)。正如前面已经提到的，处理过程与会话控制过程之间的差别在于会话没有建立。

- 

- | 参考点名称 | 与之相关实体                                            | 目的                                                         | 协议      |
  | ---------- | ------------------------------------------------------- | ------------------------------------------------------------ | --------- |
  | Gm         | UE，P-CSCF                                              | 该参考点用于在UE和CSCF之间交 互消息                          | SIP       |
  | Mw         | P-CSCF，I-CSCF，s-CSCF,                                 | 该参考点用于在不同CSCF 之间交 互消息                         | SIP       |
  | ISc        | s-CSCF，AS                                              | 该参考点用于在S-CSCF与AS之间 交互消息                        | sIP       |
  | Ma         | 1-CSCF，AS                                              | 该参考点用于在I-CSCF 与 AS之间 交互消息                      | SIP       |
  | Cx         | 1-CSCF，s-CSCF，HSS                                     | 该参考点用于1-CSCF/S-CSCF和 HSS之间的通信                    | Diameter  |
  | Dx         | l-CSCF，s-CSCF，SLF                                     | 该参考点用于在多HSS环境下选择 合适的HSS                      | Diameter  |
  | Sh         | SIP AS，OSA sCs，HSS                                    | 该参考点用于在SIP AS/OSA SCS和 HSS之间进行通信               | Diameter  |
  | si         | IM-SSF，HSS                                             | 该参考点用于在IM-SSF 和 HSS之 间交互消息                     | MAP       |
  | Dh         | SIP AS，OSA，SCF, IM-SSF，HSS                           | 该参考点用于在多HSS环境下AS 找到合适的HSS                    | Diarmeter |
  | Mm         | I-CSCF，s-CSCr, IBCF，外部IP网                          | 该参考点用于在IMS和外部IP网之 间交互消息                     | sIP       |
  | Mg         | MGCF一1-CSCF                                            | 该参考点用于在MGCF和I-CSCF之 间呼叫消息                      | SIP       |
  | Mi         | s-CSCF BCCF                                             | 该参考点用于在S-CSCF与 BCCF之 间交互消息                     | sIP       |
  | Mj         | BGCFMGCF                                                | 该参考点用于在相同IMS网络中的 BGCF与 MGCF之间的交互          | SIP       |
  | Mk         | BGCF→BGCF                                               | 该参考点用于不同IMS网络中的 BGCF之间的交互                   | SIP       |
  | Mr         | s-CsCF，MRFC                                            | 该参考点用于在S-CSCF与MRFC之 间交互消息                      | SIP       |
  | Mp         | MRFC，MRFP                                              | 该参考点允许MRFP的用户平面资 源控制                          | H248      |
  | Mn         | MGCF，IMS-MGw                                           | 该参考点允许IMS-MGW的用户平 面资源控制                       | H.248     |
  | Ut         | UE，AS ( SIP AS, OSASCS，IM-SSF)                        | 该参考点使得UE可以管理与它的 业务相关的信息                  | HTTP      |
  | Cx         | PCRF，接人网关                                          | 该参考点用于将策略和计费规则推 人接人网关，获得传输平面事件通知， 交换计费标识符 | Diameter  |
  | Rx         | P-CSCF，PCRF                                            | 该参考点用于向PCRF传递注册和 会话信息，获得传输层事件通知，并 交换计费标识符 | Diameter  |
  | Ro         | As，MRCF，S-CSCF，oCs                                   | AS/MRFC/s-CSCF用该参考点来向 OCS执行在线计费。备注:在S-CSCF 与OCS之间可能需要一个进行协同的 逻辑功能 | Diameter  |
  | Rf         | P-CSCF，s-CSCF, 1-CSCF，BGCF，MGCF, AS，MRFC，IBCF，CDF | IMS实体用该参考点来向CDF执行 离线计费                        | Diameter  |
  | Ml         | E-CSCF，LRF                                             | 该参考点用于为去往紧急呼叫中心 的路由请求交换必要的信息      | 未定义    |
  | Mx         | CSCF，BGCF，IBCF                                        | 当与不同运营商进行通信时，用该 参考点来使用IBCF的能力        | 未定义    |
  | lx         | IBCF，TrGw                                              | 该参考点允许进行trGW资源控制                                 | 未定义    |
  | lq         | P-CSCF，IMS接人网关                                     | 该参考点允许进行IMS接人网关 控制                             | 未定义    |

## 概念

- 注册
  - 在IMS注册之前，用户设备（UE)必须找到它要发送一个REGISTER请求的IMS实体，这个概念被称为代理呼叫会话控制功能（P-CSCF）发现。另外，在注册过程之前，UE需要从身份模块中取出用户身份。
  - 在注册过程中，将给UE分配一个服务CSCF( s-CSCF)，用以进行认证和建立相应的安全机制，之后用户配置将被下载到所分配的S-CSCF中，会话初始化协议（SIP)压缩也得到初始化，并传递隐性注册的公共用户身份。

### 注册

- 注册过程使得UE可以使用IMS服务。在进行IMS注册之前，UE必须获得一个IP连接承载，并且发现IMS系统的人口点（即P-CSCF)。
- ![[image-20221207161114939.png]]
  - 左侧显示了第一阶段——网络如何向UE注册表示异议（ challenge);
  - 右侧展示了第二阶段——UE如何对网络的异议进行响应，并完成注册过程。
  - 流程
    1. UE发送一个SIP注册（ SIP REGISTER)请求给已发现的P-CSCF。这个请求包含要注册的身份和归属域名称（问询CSCF或称I-CSCF的地址)。该P-CSCF处理这个 RECISTER请求，并使用所提供的归属域名称来解析I-CSCF的IP地址。随后I-CSCF将会联系归属用户服务器（HSS)，以便为S-CSCF选择过程来获取所需的S-CSCF能力要求。在S-CSCF选定之后，I-CSCF将 RECISTER请求转发给选定的S-CSCF。s-CSCF会发现这个用户没有被授权，因此它向HSS索取认证数据，并且通过一个401未授权响应来对该用户的注册表示异议。其次，UE将计算对这个异议的响应，并且发送另外一个 RECISTER请求给P-CSCF。P-CSCF再次找到I-CSCF，并且I-CSCF也将依次找到S-CSCF。最后，S-CSCF检查这个响应，如果这个响应正确，它就从HSS下载用户配置，并且通过一个200 OK响应来接受该注册。一旦UE成功被授权，UE就能够发起和接收会话了。在注册过程中，UE和P-CSCF会了解到网络中的哪个S-CSCF将要为UE提供服务。
    2. 通过周期性的注册更新，UE可以保持其注册处于激活状态，这是UE功能。如果UE没有更新其注册信息，那么在注册计时器超时的时候，S-CSCF将毫无声息地清除该注册。当UE想要解除在IMS中的注册时，它就简单地发送一个REGISTER请求，该请求中的注册计时器取值为0（过期)。

### Go接口单次多用户身份注册

- 一个用户有时需要分配一个以上的公共用户标识，这样能将其朋友和家人知道的个人身份与同事们所知道的企业公共身份区分开来，或者用来满足不同的服务需求。
- SIP只允许一次注册一个公共用户身份，因此，如果一个用户有多于一个公共用户身份，那么他必须分别注册每一个公共用户身份。
- 隐性注册：一个隐性注册集是指通过单条注册请求来注册的一组公共用户身份。当集合内的一个公共用户身份注册后，所有与该隐性注册集合相关联的公共用户身份均同时被注册。同样地，当该集合内的一个公共用户身份被注销时，所有已隐性注册的公共用户身份也同时被注销。属于一个隐性注册集合的公共用户身份可能指向不同的服务配置。这些公共用户身份中的一些也可能指向相同的服务配置。

### 会话发起

- ![[image-20221207165425253.png]]
- 当用户A想要与用户B进行会话时，UEA就生成一个SIP INVITE请求，并且通过Gm参考点将该请求发送给P-CSCF。P-CSCF会对这个请求进行处理，例如，它在将这个请求通过Mw参考点向S-CSCF转发之前，将其解压缩，并且验证呼叫发起用户的身份。S-CSCF继续处理这个请求，执行服务控制，这可能包括与应用服务器(AS)的交互，并且通过SIP INVITE请求中用户B的身份最终确定用户B的归属运营商的入口点。I-CSCF会通过Mw 参考点收到该请求，并且通过Cx 参考点来联系HSs,以找到正在为用户B提供服务的S-CSCF。该请求通过Mw参考点传送到S-CSCF。该s-CSCF负责处理这个终结的会话，这可以包括与应用服务器的交互，并最终通过Mw参考点将该请求发送给P-CSCF。经过进一步处理（例如压缩和隐私检查）之后，P-CSCF通过Gm参考点将这个SIP INVTTE请求发送给UE B。UEB生成一个响应，即183会话进行中。该响应将按照从UEA到UEB的相同路径反向传回UEA（也就是UE B→P-CSCF→s-cSCF→I-CSCF_S-CSCFP-CSCF→UE A)。再经过几次往返之后，两个UE都完成了会话建立过程，并且能够开始真正的应用了（例如一个棋类游戏)。在会话建立过程期间，运营商可以对媒体业务流所使用的承载进行控制。

### 标识

- 类别：用户（公共用户身份)、用户的订购（私有用户身份)、用户设备与公共用户身份的结合（全球可路由的用户代理URI)、服务（公共服务身份）或IMS网络实体。

#### 公共用户身份

- IMS网络中的用户身份被称作公共用户身份，它们是用于请求与其他用户通信时所用的身份。
- 公共身份可以被公布（例如在电话本中、网页上和名片上)。
- IMS用户能够发起和接收与很多不同网络（例如GSM 网络和因特网）间的会话。为了从CS侧可以访问到，公共用户身份必须遵循电信编号方式（例如+358501234567)。与此类似，请求与因特网客户端通信时，公共用户身份就必须遵循因特网命名规则（例如joe. de@ example. com)。
- IMS体系对公共用户身份提出了下列要求[3GPP TS 23.228，TS 23.003 ] :
  - 公共用户身份采用SIP统一资源标识符（URI)或者电话统一资源定位符（ telURL)的格式。
  - ISIM 应用中要安全地存储至少一个公共用户身份。
  - UE无法修改公共用户身份。
  - 在一个公共用户身份被用于发起IMS会话和与IMS会话无关的过程（例如MESSAGE、SUBSCRIBE、NOTIFY)之前，公共用户身份需要先被注册。
  - 在充当IMS会话终结点之前，其公共用户身份应先被注册，并且与终结的IMS会话无关的过程将被传送到公共用户身份所归属用户的终端UE上。这些并不会阻碍未注册的用户使用网络中的服务。
  - 通过一个UE请求就可以一次注册多个公共用户身份。
  - 在注册过程中，网络不会对公共用户身份进行认证。

#### 私有用户身份

- 私有用户身份是一个由归属网络运营商定义的具有惟一性的全球身份，可用于在归属网络中从网络的角度惟一地标识用户[3GPP TS 23.228]。它并不是标识用户本身，相反地，它标识了用户的订购关系。因此，它主要用于认证的目的，但使用私有用户身份来实现计费和管理目的也是可以的。
- IMS体系对私有用户身份提出了下列要求[3GPP TS 23.228，TS 23.003]:
  - 私有用户身份采用「 RFC2486]所定义的网络接入标识符(NAI)的形式。
  - 私有用户身份会被包含在所有从UE发往归属网络的注册请求中。
  - 私有用户身份仅在用户的注册期间被认证（包括重新注册和注册解除)。
  - s-CSCF需要从注册中和未注册的终结中获取并存储私有用户身份。
  - 私有用户身份不会被用于SIP消息的路由转发。
  - 私有用户身份被永久地分配给用户，并安全地存储在IMS身份模块（ISIM)应用中。私有用户身份在用户与归属网络间的订购关系存在期间内是有效的。
  - UE无法修改存储在ISIM 应用中的私有用户身份。
  - HSS需要存储私有用户身份。
  - 根据运营商的策略，私有用户身份可以作为可选项放入计费记录中。
  - NAI举例：private_user1@ home1. operator. net

####  私有用户标识和公共用户标识的关系

- 多对多
- 一个IMS用户可以拥有一个私人用户身份和多个公共用户标识。
- 用户公共标识可以被多个用户设备共享。因此，这个特殊的用户公共标识，可能同时被拥有不同私有用户标识和不同联系地址的用户设备注册。
- ![[image-20221207173928723.png]]

#### 没有ISIM的身份生成

- ISIM：IP Multimedia Services Identity Module

-  私有用户标识和公共用户标识都存储在ISIM中

- 在这个模型中，私有用户身份、公共用户身份和归属域名称都从国际移动用户标识符（IMSI)中导出。这个机制非常适合具有通用用户身份模块（USIM)应用的UE。

- 导出的私有用户身份：由IMSI导出的私有用户身份是根据下列步骤构建的[3GPP TS 23.003 ] 

  1. 私有用户身份的用户部分由IMSI 的整串数字所构成。
  2. 私有用户身份的域部分由IMSI的 MCC和 MNC值所组成，并且有一个预先定义的域名:IMSI. 3gppnetwork. org。这三个部分组合在一起，并且按照下列顺序用圆点隔离:移动网络代码(MNC，一个数字或者多个数字的组合，公共陆地移动网络的惟一标识)、移动国家代码（MCC，移动用户所属国家的惟一标识代码）和预先定义的域名
     - 234150999999999@ 234.15.IMSI. 3gppnetwork. org

- 临时公共用户身份

  - 如果没有ISIM应用来保存公共用户身份，就要基于IMSI来导出一个临时公共用户身份。临时公共用户身份采用SIP URI的形式“sip: user@domain”。用户部分和域部分都是使用与私有用户身份类似的方法导出的。
  - IMS体系对临时公共用户身份提出了下列要求[3GPP TS 23.228]:
    - 对于IMS的非注册过程，强烈推荐设置临时公共用户身份为“被禁止(Barred)”，这样它就无法用于IMS通信。如果临时公共用户身份被设置为“被禁止”，那么就要遵守下列附加要求:
      - 临时公共用户身份不能显示给用户，并且也不能用于公共场合（例如，显示在名片上)。
      - 临时公共用户身份只能用于在注册期间获取隐性注册的公共用户身份（隐性注册的公共用户身份的概念请参见3.3节)。
    - 在其他SIP消息和随后的注册过程中，隐性注册的公共用户身份将被用于会话处理。
    - 在初始注册之后,只有UE使用隐性注册的公共用户身份。·只有CSCF和HSS节点可以获得临时公共用户身份。

- 服务的标识（公共服务身份)

  - 通过前面对标准的在线状态、消息、会议和组服务能力的介绍可以发现，对于AS所拥有的服务和组，也必须使用标识符来进行识别。用于这些目的的身份也可以在服务过程中临时创建，换言之，它们可以由用户根据需要而在AS中创建，并且在使用之前不需要进行注册。普通的公共用户身份不足以适应这种特点，因此版本6中引入了一个新的身份类型:公共服务身份。公共服务身份采用SIP URI的形式或者tel URL格式。

- 用户设备标识

  - 背景：在IMS 中，公共用户身份用于到达接收方，同时单个公共用户身份可以在同一个订购下的多个设备间共享。这就意味着，当有一个以上设备使用同一个公共用户身份注册时，就不可能识别出会话具体是发往哪个设备的。
  - 为了到达某个特定的设备，必须使用一个特殊的称为全球可路由用户代理URI(CRUU)的标识。
  - ![[image-20221208095849318.png]]
  - 定义有两种GRUU，即临时GRUU和公共GRUU。IMS中的公共GRUU是用户的公共用户身份与设备的标识之间的组合，通过该组合，公共用户身份注册到IMS。公共GRUU的目的是实现具有长久地到达某个特定设备的能力，因为只要“公共用户身份-设备”这一对存在，到达设备就总是相同。相反，临时CRUU是一个具有有限存在期的标识（新的临时GRUU在每次进行IMS注册请求时创建)，并且它会让公共用户身份得到隐藏，比如，他根本就不包含用户的公共用户身份。

### IP多媒体服务身份模块

- IP多媒体服务身份模块（ISIM)是一个位于通用集成电路卡 ( UICC)上的应用，这是一个物理上安全的设备，它可以从UE中插入和取出，在UICC中可以有一个或多个应用，例如通用用户身份模块（USIM)和ISIM。ISIM本身存储了主要由IMS运营商提供的IMS专用的用户数据，主要在用户将一个设备注册到IMS时使用。例如,当一个用户从运营商获得IMS订购时，将存储如下数据。
  - 用户的私有用户身份。它用于在注册请求中标识用户的订购关系（参见3.5.2节中的进一步说明)。
  - 用户的一个或多个公共用户身份。它用于在注册请求中标识要注册的身份，并且用于请求与其他用户间建立通信（参见3.5.1节中的进一步说明)。
  - 归属网络的人口名称（归属网络的域名)。用于在注册请求中，将请求路由到用户的归属网络。
  - 管理数据。包括多种数据，可以被IMS用户用于IMS操作，或者被设备商用来执行厂家自定义的自检。
  - 接入准则参考。它所存储的信息被用来检验用户的个人标识符号码是否被允许访问特定的应用。
  - P-CSCF的地址。当接人技术不支持动态P-CSCF发现时，可用该地址。
  - 与通用启动加载体系（Generic Bootstrapping Architecture）有关的安全参数。安全参数用于进行IMS认证。

### 多终端间共享单个公共用户身份

- 版本6的IMS 允许用户通过多个UE来注册同一个公共用户身份。另外，用户可以在注册阶段指出其对于某一个UE的优先选择。不同的注册可通过私有用户身份和所使用的IP地址加以区分。
- ![[image-20221208102508346.png]]
  - 如果请求中没有包含具体去往哪个设备的信息时，则由他的S-CSCF首先来决定到底联系哪个UE。该决策可基于注册阶段给定的优先级别来完成。
  - 除了基于优先选择( preference-based）的路由外，S-CSCF也可能进行分叉( forking)。
    - 顺序分叉是指逐个联系不同的UE。例如，S-CSCF首先将请求发送到2号UE;如果一定时间期限内用户没有响应，则S-CSCF接着尝试通过1号UE来到达Joe。
      并行分叉是指同时联系不同的UE。例如，当两个UE同时振铃时，用户可以决定使用哪个UE来对到达的会话进行接听，不过最终会话只能接往一个UE。

### IMS的入口点的发现

- 为了与IMS网络通信，UE必须知道P-CSCF的至少一个P地址。UE找到这些地址的机制就被称为“P-CSCF发现”
- 在第三代合作伙伴计划（3GPP)中对P-CSCF发现定义了两种动态机制:动态主机配置协议（ DHCP）域名系统（DNS）过程和GPRS过程。另外，也可以在UE配置P-CSCF名字或者P-CSCF的IP地址。
- ![[image-20221208104244664.png]]
  - 在GPRS过程中，UE在PDP上下文激活请求（或者次PDP上下文激活请求）中包含了P-CSCF地址请求标记，并且在响应中得到P-CSCF的P地址。这个信息是在协议配置可选信息单元中传送的[ 3GPP TS24.008 ]。网关GPRS支持节点( GGSN)如何获得P-CSCF的IP地址的机制并没有标准化。版本5之前的GCSN不支持该机制。
- ![[image-20221208104417884.png]]
  - 在DHCP DNS过程中，UE发送一个 DHCP请求给IP连接接入网络(例如GPRS )，该网络将这个请求转发给DHCP服务器。根据〔 RFC3319]和[ RFC3315]，UE可以请求一个SIP服务器域名形式的P-CSCF 列表，或者请求一个SIP服务器IPv6地址形式的P-CSCF列表。当返回域名时，UE需要执行一个DNS查询(NAPTR/SRV)来找到P-CSCF的IP地址。DHCP DNS机制是一个与接入无关的发现P-CSCF的方式。

### S-CSCF的指定

- 情况
  - 用户向网络中注册。
  - s-CSCF需要代表未注册用户运行服务。
  - 先前指定的S-CSCF没有响应。

#### 注册期间的S-CSCF指定

- 当用户向网络中注册时，UE发送一个 REGISTER请求给已发现的P-CSCF，P-CSCF找到用户的归属网络实体I-CSCF，接下来I-CSCF 与HSS交换消息UAR和 UAA 。其结果是只要没有先前指定的S-CSCF , I-CSCF会接收到S-CSCF能力集。基于接收的能力集，I-CSCF选择一个合适的S-CSCF。能力集信息在HSS和1-CSCF之间使用服务器-能力属性值对(AVP)进行传送。
- 服务器-能力AVP类型〔3GPP TS 29.228]和[3GPP TS 29.229]:
  - 零个或多个必选能力AVP——这个AVP的值是一个无符号整数，包括S-CSCF的必选能力。每个运营商的网络中可以利用的每个必选能力都将被分配一个惟一的值。
  - 零个或多个可选能力AVP——这个AVP的值是一个无符号整数，包括S-CSCF的可选能力。每个运营商的网络中可以利用的每个可选能力都将被分配一个惟一的值。
  - 零个或多个服务器-名字AVP——这个AVP包含用于标识一个SIP服务器的SIP URI。
- 基于必选和可选能力AVP，一个运营商就可以根据每个S-CSCF拥有的不同能力集（用户服务所要求的能力集、运营商基于每个用户的优先选择等)，将用户在S-CSCF之间进行分配。运营商需要负责定义必选和可选能力的确切含义(可能基于部署在网络中的每个S-CSCF所提供的功能)。I-CSCF将首先选择具有该用户所要求的所有必选和可选能力的S-CSCF。如果这不可能，那么I-CSCF就采用一个“最佳选择”算法来选择S-CSCF。这种选择算法没有被标准化（也就是说解决方案取决于具体实现)。

#### 为未注册用户运行服务而指定S-CSCF

- 位置检索过程（也就是说到达的SIP请求将触发LIR/LIA命令来找出服务于用户B的S-CSCF)，如果HSS知道当前没有指定的S-CSCF，而用户又有与未注册状态相关的服务，那么它就会返回S-CSCF能力信息，3.9.1节所述S-CSCF指定过程就会在I-CSCF中发生。

#### 出现错误情况下的S-CSCF指定

- 当指定的S-CSCF没有响应的时候，3GPP标准允许在注册过程中对S-CSCF进行重新指定

#### s-CSCF指定的解除

- 当用户从网络中解除注册时或者网络决定注销某个用户的时候（例如，由于注册过期或者用户的订购关系过期)，S-CSCF指定就会被解除。S-CSCF负责从 HSS中清除所存储的S-CSCF名字。

#### s-cSCF指定的保留

- 当用户从网络中解除注册时或者S-CSCF注册计时器超时时，运营商可以决定为这个未注册的用户保留其对同一个S-CSCF的指定。S-CSCF负责向HSS通知用户已经解除注册，不过，S-CSCF可以指出它希望保留用户配置。这就优化了Cx参考点的负荷，因为当用户一旦进行再次注册，或者有与未注册状态相关服务需要接收会话时，就不需要再传输用户配置了。

### 承载业务流的控制机制

- 背景：控制平面和用户平面的分离可能是IMS网络设计中最重要的方面之一。这两层之间完全独立并不可行，因为没有用户平面和控制平面之间的交互，运营商将无法控制服务质量（QoS)、IMS媒体业务流的源/目的地址，以及媒体业务流开始和停止的时间。因此，创建了一种机制来对IMS媒体业务流将要使用的承载业务流进行授权和控制
- 策略与计费控制（ PCC)：该机制基于在IMS会话中所协商的会话描述协议（ SDP)参数。这种在接人网和IMS之间进行的全部交互被称为策略控制，而同样的体系结构方案也被用来实现接入网和IMS之间的一致性计费，因此总体概念通常被称为策略与计费控制 ( PCC)。

#### 门控和QoS控制

- IMS 网络中的会话建立和修改包含了使用SIP和SDP进行的端到端消息交换。在这个消息交换期间，UE将协商一套媒体特性（例如通用的编解码方案)。如果一个运营商实施了策略控制，那么P-CSCF就将转发相关的SDP信息给PCRF，PCRF基于这些信息形成IP QS授权数据。
- 当UE为媒体激活或者修改IP CAN承载（例如PDP上下文)时，它必须执行其自身的映射，将SDP参数和应用的要求映射成IP CAN QoS参数（例如UMTS QoS参数)。当接入网关接收到IP-CAN承载激活或修改命令时，它向PCRF询问授权信息。PCRF会将接收到的信息与存储的信息进行比较，并返回一个授权决策。该决策包含送给IP-CAN承载和分组分类器的IP QoS参数，用于建立合适的门控，以及关于如何将业务流绑定到IP-CAN承载的信息。
- 如果是肯定决策，接入网关会将授权的IP QoS参数映射成授权的与接入相关的QoS参数，并且IP-CAN承载激活或修改将被接受。图3-12显示了该功能。为了简化，图中的PCRF表示为P-CSCF的一部分。如果存在独立的PCRF，那么P-CSCF需要将SIP/SDP信令信息映射成合适的Diameter信息单元，并把相应的 Diameter请求通过Rx参考点发送给PCRF。该功能将在3.10.5节中进一步讲述。

#### 业务平面事件报告

- 使用策略控制能力，P-CSCF能够跟踪IMS信令和用户平面承载的状态（新承载创建，承载丢失，丢失的承载已恢复)，这样当某些服务数据流（如视频流）或所有服务数据流（即某个SIP会话的所有媒体流）被去激活时,设备当前正在使用的IP-CAN( s）可以得到通知。通过使用该信息，IMS能够让服务运行得到改进。

#### 网络发起承载激活

- 当GPRS推入市场时，在3GPP版本7中引人了广泛部署的移动通信系统分组承载。
- 在GPRS系统中，移动站(MS）从第一天起就已控制了承载激活（建立）过程。换言之，MS已决定需要多少条PDP上下文，以及它需要在每个PDP上下文中使用哪种业务类型和QoS参数。
- 该模型在版本8中有可能改变，因此称为演进分组系统(EPS)。当前，当使用演进分组系统架构来进行通信时，主要是由网络来决定UE需要什么样的承载。在版本7中，当在GPRS接入网络中定义IMS用户平面流量时，已经将使用网络发起业务承载作为可选能力，这是通往网络发起业务承载的第一步。

### 计费

- 为了提供后付费业务，IMS需要支持离线（ Offline）计费机制。离线计费是在会话之后收集计费信息，而且计费系统不会实时地影响所使用服务的计费过程。在该模型中，用户一般每月收到一张账单，该账单显示一个特定时期内的计费项目。预付费业务需要在线（ Online)计费支持。这就意味着IMS网络实体需要在允许用户使用业务之前咨询在线计费系统（OCS)。这个系统负责实时地与用户账户进行交互，控制或者监视与业务使用相关的费用。

- ![[image-20221209110952140.png]]

  - 离线计费：所有处理SIP信令的IMS实体能够与离线计费实体进行通信—即计费数据功能（ CDF)——-通过使用单一的基于Diameter的 Rf参考点[ 3GPP TS 32.299]。CDF接收到同样来自接入网实体的 Diameter请求，并且基于来自不同实体提供的信息，它就可以创建通过Ga参考点传送给计费网关功能（CCF)的CDR[3GPP TS 32.295]。最后，CGF处理接收到的CDR，并使用Bx参考点转发最后的CDR给计费系统[3GPP TS 32.240]。
  - 在线计费：与离线计费不同，只有三个IMS实体(AS、MRFC和S-CSCF)被用于在线计费。而且，由于版本5时间帧上设计不佳，S-CSCF不能直接与OCS通信。IMS网关功能(IMS-GWF)用于执行必要的协议转换。OCS支持来自其他网络实体的两个参考点。SGSN使用CAMEL应用部分（CAP)，其他实体使用基于Diameter的Ro参考点。就像离线计费中的CGF一样，OCS除了信用( credit)控制处理（实时地认可资源）之外，也能够创建CDR。

- | 离线计费功能       | 关键过程                                                     |
  | ------------------ | ------------------------------------------------------------ |
  | 计费触发功能（CTF) | 监测SIP信令 检测触发器条件 从SIP信令中提取信息并且重组计费信息 发送计费信息给CDF |
  | 计费数据功能（CDF) | 构建CDR 传送CDR给CGF                                         |
  | 计费网关功能（CCF) | 关联、合并、过滤不必要的域并且在接收到的账户信息中增 加运营商特定的信息 CDR错误处理和存储 传送CDR给计费系统 预处理CDR |
  | 计费系统           | 创建实际的账单                                               |

### 用户配置

- 用户配置是用户特定信息的集合，它永久存储在HSS中。当S-CSCF需要为注册和未注册用户运行业务时，就将用户配置下载到S-CSCF中。用户配置至少包含一个私有的用户身份和单个服务配置。
- ![[image-20221209112412930.png]]
  - 公共标识指示运行特定服务配置的一个或多个身份。身份可以是公共用户身份，也可以是公共服务身份。
  - 核心网服务授权：服务授权定义有两种不同的能力，即媒体策略和IMS通信服务标识策略。媒体策略信息包含一个整数，用于标识在S-CSCF中的一个订阅的媒体配置（如允许的SDP参数)。该信息允许运营商在其IMS网络中定义不同的用户配置。IMS通信服务标识策略包含一个服务标识符列表,用来标识哪个IMS通信服务用户可以被授权使用。
  - 服务触发信息采用初始过滤规则的形式表示。初始过滤规则用来描述到来的SIP消息何时被进一步路由到一个特定的应用服务器。用户配置可以同时包含针对用户的服务触发信息（将其编码为初始过滤规则）和一个初始过滤规则的参考值（由S-CSCF本地管理和存储)。后者被称为共享初始过滤规则，编码为一个整数值，该整数值仅在单个运营商网络内有意义。
  - 触发点用来描述应该检查的条件，以决定是否应该联系所指示的应用服务器。如果没有触发点，表明将对AS进行无条件触发。每个触发点包含一个或多个服务点触发器的实例。服务点触发器可通过逻辑表达式的方法（与、或、非）组合起来。
  - 应用服务器定义当触发点被匹配时应该联系的AS。AS可以包含当与AS的联系失败时相关会话的默认处理的信息。基于初始过滤规则中的信息，默认处理或者终止会话，或者让会话继续。另外，应用服务器包含О或1个服务信息的例程。当在注册期间初始过滤规则的条件被满足时，服务信息能够提供通过S-CSCF透明地传送到AS的信息。

### 服务提供

- 严格来讲，IMS本身并不是一个服务，相反地，它是一个基于SIP的体系，以在PS网络之上实现先进的IP服务和应用。IMS为服务的触发提供必要的方法，该功能称为“服务提供( Service Provision )”。IMS服务提供包含以下三个基本步骤。
  1. 定义可能的服务或服务集合。
  2. 当用户定购/修改订购关系（ subscription)时，以初始过滤规则的形式创建用户专有的服务数据。
  3. 将到达的初始请求传递给AS。

### 传统电路交换用户与IMS 用户之间的连接

- ![[image-20221209141656104.png]]
  - MGCF：Mutimedia Gateway Control Function
- ![[image-20221209141815637.png]]

### IMS转接

- ![[image-20221209155901373.png]]

### SIP压缩

- IMS使用IETF定义的信令压缩（ SigComp）方案。该机制中，在通过网络发送消息之前，使用应用协议来进行消息压缩。对于应用来说，就是在应用协议和传送协议[ RFC3320和 RFC4896]之间的一层。SigComp使用通用解压缩虚拟机（UDVM)来对消息进行解压缩。使用SigComp进行压缩的消息称为SigComp消息。
- ![[image-20221209162421224.png]]

## 服务

### 在线状态

- 在线状态服务是指用户的动态配置,这个配置对于其他人是可见的,可用于表达自身，并共享信息和控制服务。

#### 概述

- ![[image-20230112162438811.png]]
  - 个人和终端是否可达;
  - 优选的通信方式;
  - 终端能力;
  - 当前的行为;
  - 位置;
  - 当前可用业务。

#### 模块

- 在线状态服务器（Presence Server)——一个IMS应用服务器，主要用来管理由用户上传的在线状态信息并处理在线状态订阅请求。
- 资源列表服务器(Resource List Server)——一个IMS应用服务器，负责接受和管理在线状态列表中的订阅信息，这可以使得一个观察者应用通过单个订阅交互完成订阅多个用户的在线状态信息的功能。
- XML文档管理服务器(XML Document Management Server)——存储与在线状态服务相关数据的服务器。定义了四种不同的应用服务器:
  1. 在线状态 XDMS ( Pres-ence XDMS，存储在线状态信息订阅和发布规则的服务器)
  2. RLS XDMS（存储用户在线状态好友列表的服务器)
  3. 在线状态内容XDMS ( Presence Content XDMS，为在线状态服务管理多媒体文件的服务器）
  4. 共享XDMS ( Shared XDMS，可以被多个不同的应用服务器使用的服务器)
- 内容服务器(Content Server)——能够为在线状态服务管理MIME对象的功能实体，允许在线状态源或者在线状态服务器存储MIME对象。
- 在线状态源（Presence Source)——向在线状态服务提供在线状态信息的实体。在线状态源可以位于用户的UE内，也可以位于网络实体内。
- 在线状态观察者( Presence Watcher)——请求关于资源（即 Presentities)的在线状态信息的实体。
- 观察者代理( Watcher Agent)——在观察者域控制观察者的在线状态服务用法的实体。
- 观察者信息用户( Watcher Information Subscriber)——向在线状态服务请求观察者信息的实体。
- ![[image-20230112162958718.png]]

#### 发布在线状态

- 为了发布或者更新在线状态信息，在线状态源使用SIP PUBLISH方法向在线状态服务器上传在线状态信息
  - ![[image-20230112163740956.png]]
  - ![[image-20230112163122973.png]]
    - 发布者使用Request-URI来标识即将发布的在线状态的用户身份。发布者使用Event消息头来表明该请求与在线状态有关，S-CSCF根据它将该请求路由至在线状态服务器。Expires消息头指明在线状态的有效期。PUBLISH请求的主体包含用XML语言编码的真实在线状态信息。这里的XML主体内容揭示的信息有该用户已经注册、可用、愿意通信、可用的业务是PoC，以及在用户发布信息时的其他信息。
    - IETF和OMA都指定了不同的在线状态属性值的数目，用这些值来描述在线状态，例如是否愿意使用某种应用、是否可以使用某种应用、通信地址、位置类型、地理位置、时区、心情、头像、时间戳、便笺、会话参与、注册状态、离线状态等。

#### 订阅在线状态

- 为了获取其他用户的在线状态信息或者增强的在线状态服务，观察者通过向特定的用户或者在观察者自身的在线状态列表中的用户发送一条SIP SUBSCRIBER请求。RLS接受该订阅请求并返回200 OK消息。根据协议要求，RLS会立即发送一条NOTIFY请求。如果 RIS在列表中没有发现任何与资源相关的在线状态信息，它将发出一条主体内容为空的NOTIFY请求。一旦RLS从在线状态服务器中获得在线状态信息，它将发送包含有用户在线状态信息的有用的NOTIFY 请求。
  - ![[image-20230112163438028.png]]
  - ![[image-20230112163610655.png]]
  - ![[image-20230112163636369.png]]

#### 观察者消息

- 在线状态信息共享会引发安全性和私密性方面的问题，为此定义了用于控制哪些用户可以看到发布在线状态信息用户的状态的机制。用户可以在状态服务器中设置他的在线状态授权规则，他可以设定允许某些用户进行在线状态订阅，拒绝某些用户进行在线状态订阅，或者每当有新的在线状态订阅请求时，要求在线状态服务器询问他是否愿意接受。

- ![[image-20230112164334068.png]]

#### 设置在线状态授权

- 不同的观察者可以获得不同级别和不同范围的在线状态信息，这意味着可以授权不同的观察者观看在线状态实体的在线状态信息的不同部分。在线状态实体拥有给谁看什么的选择权，在线状态实体可以使用XCAP定义的方案，以许可声明的形式来设置这些授权级别。

#### 群组管理

- 背景：用户希望所有设备都能使用他们的服务数据
- 群组管理的一个好处是用户能够创建、修改和删除这个名单，并自动进行同步，因为上传和修改这个好友名单还有一个内置功能，就是将好友名单的变化通知给其他设备。

#### XML配置接入协议

- XML configuration access protocol
- 在XML配置接入协议（XCAP)中，用户可以将信息上传到XCAP服务器，然后通过XCAP服务器将这些上传的信息提供给应用服务器使用，以满足用户提出的请求。利用XCAP，用户也可以对这些数据进行操作、添加和删除。用户的资源列表就是这类可以被上传的数据。XCAP利用HTTP上传和阅读用户设置的信息

#### 公共策略

- 背景：许多应用可以访问到用户信息，具体形式如在线状态信息或位置信息，这些信息可以揭示有关用户状态或其他内容的个人详细信息。这些详细信息的日渐丰富给通信带来了特别的机会，但同时也对隐私构成了很大的威胁。因此，当出现这些应用时，需要建立一个健壮且同样丰富的系统，来控制信息的隐私设置。
- 模型和规则结构
  - 公共策略模型最重要的方面就是可以对许可进行追加。这就意味着某种资源的隐私设置总是从根本没有许可开始的，然后由用户基于某种形式的需要，来向设置添加许可条款，例如，某用户可能通过观察者信息[ RFC3857]机制，发现另一个用户想订阅他们的在线状态信息。

#### 资源列表

- SIP(会话初始化协议）特定的事件通知机制允许用户（订阅用户）请求得到资源状态变化的通知。
- [ RFC4662]描述了一种事件通知扩展的方法，使用户能仅用一条SUBSCRIBE请求就能订阅一个资源列表。这个列表用URI来标识，可以包括0个或多个URI，指向原子资源（ atomic resources）或其他列表。
- ![[image-20230206155134225.png]]

##### 资源列表的XCAP用法

- 创建和维护资源列表。列表创建方法利用了XCAP(见5.3节)。
- ![[image-20230206155651402.png]]

##### OMA 群组管理

- ![[image-20230206160320831.png]]
  - 

### POC基于蜂窝网络的按键通话

- Push to talk over Cellular

#### 体系架构

- ![[image-20230302174558751.png]]
  - OMA（开放移动联盟）定义的PoC标准版本1的体系架构，构建于PoC客户端、PoC应用服务器、PoC XML文档管理服务器（XDMS)之上。可以把XDMS看作是一种应用配置设置管理服务器，因为它保存了特定应用的配置设置。存储了PoC特定数据的XDMS服务器就称为“PoC XDMS”服务器。利用基于XCAP的参考点PoC-8(见图6-3)，PoC服务器能够获取与PoC相关的文档（如访问列表);利用基于XCAP的参考点PoC-5(见图6-3 )，PoC服务器能够从共享的XDMS服务器中获取通用列表(如myfriends@ example. com列表中的成员)。PoC服务器处理特定应用的任务，如通话突发时间片控制（为某个用户预留通话突发时间片）和PoC会话控制。它们还为运营商提供了配置和网管系统的接口，创建特定应用的CDR(计费数据记录）话单。PoC服务器通过IMS服务控制参考点接入IMS 网。IMS处理通用的功能，如 PoC用户鉴权、会话路由和基于SIP的通用计费。通常PoC客户端是UE（用户设备〉中的软件，但也可能是应用程序（可能在PC中)。

##### POC服务器

- PoC服务器是IMS体系架构中的应用服务器，为用户提供PoC服务。它控制PoC会话建立过程，执行为PoC群组会话定义的策略（例如，允许谁加入;允许谁邀请更多的成员;当某个特定用户离开时，决定是否要释放会话;当某个特定用户加入时，决定是否要邀请其他用户)，提供用户群组的信息（例如通知某人何时加人群组或何时离开群组)。不仅如此，必要时PoC服务器还处理媒介分配和适配。而且，它还充当通话突发控制点的功能，即 PoC服务器决定谁有权发送媒体，通知其他用户发送媒体的权限已经赋予了某人，等等。这个机制称为“通话突发控制”。于是，简言之，PoC服务器同时处理与PoC服务有关的控制面和用户面的业务流量，为此它使用了IMS的参考点ISC和 Mb。
- OMA中定义了两种不同的PoC服务器角色，即参与PoC功能和主控PoC功能。在PoC会话建立过程中指派PoC服务器角色，只有一个PoC服务器执行主控PoC功能，两个或两个以上的PoC服务器执行参与PoC功能，具体数目取决于参与PoC会话的人数。在一对一PoC会话和自组织PoC群组会话的情况下，实施邀请用户的那个PoC服务器将执行主控PoC功能。在聊天PoC群组或预先安排的群组会话的情况下，拥有或驻留群组标识的那个PoC服务器实施主控PoC功能「OMA PoC AD]。
- ![[image-20230320152226091.png]]
- 服务器功能分布
  - ![[image-20230320152508189.png]]
  - ![[image-20230320152700932.png]]

##### PoC客户端

- 根据OMA标准，PoC客户端是UE上的功能实体，能够使用PoC特性标签将自己注册到IMS中，在SIP REGISTER请求中指示 PoC发行版本，初始化/修改/释放PoC会话，支持用户面过程（例如，从/向PoC服务器接收/发送通话突发，支持通话突发控制机制，用户面适配)，支持PoC服务设置和接收即时个人警示。

#### PoC特性

##### PoC通信

- PoC支持各种类型的通信模式，以满足不同的群组通信需求。这些模式的主要差别在于群组策略和会话建立。换言之，用户如何创建一个组并添加/删除组员?他们如何激活一个群组会话，如何管理访问控制?在拨出群组通信中，用户邀请一组用户加人群组会话。被邀用户接收加入会话的指示，他们可以通过自动应答或手工应答来加入。被邀的群组可以是预定义PoC群组，或临时从主叫用户电话簿中选择的一系列用户（称为临时PoC群组)。在后一种情况下，特别是在进行拨出会话之前如果能够看到其他用户可达性或在线状态，显然能为该用户带来额外收益。拨出会话适合于无事先计划的情况,或必须仔细选择参与方的情况。
  - 预定义PoC群组特殊规则（ OMA 规定)。
    1. 第一，同一个预定义PoC群组中，当任何一个组员要求其他组员加入时，就建立了组员之间的PoC会话。
    2. 第二，在预定组的第一个组员接受了邀请、主控PoC服务器将媒体使用权授予预定组的发起人时，通信即开始了。
    3. 第三，只有预先定义的成员（即预定义组的成员）才允许加入预定义组〔 OMA PoC RD]。
  - 临时PoC群组规则。
    1. 当一个PoC用户邀请一个或多个用户加人PoC会话时（注:一对一PoC会话就是有两个参与人的临时PoC会话)，就创建了临时PoC组。
    2. 只有那些已受邀加人临时PoC会话的用户被允许，即用户必须先从临时组中的一个当前成员处收到加入临时组的请求（如从主控PoC服务器收到SIP INVITE 或SIP REFER)。
    3. 主控PoC服务器的本地策略可能只允许临时PoC组的发起人加人更多的用户（出于计费目的)[OMA PoC RD]。
- 处于聊天PoC会话的状态下，不应该阻止用户同时接收其他会话。用户应该也能够同时加入好几个聊天会话（如“我的家庭”、“篮球球友”、“啤酒酒友”)。这就要求系统能够支持并发会话。
- ![[image-20230320155028407.png]]

##### 并发PoC会话

- 与传统的电话服务相比，PoC提供了同时参加一个以上PoC会话的能力，并且不会挂起任何一个会话，这种能力被称为“并发PoC会话功能”。
- PoC会话时，有一个以上的会话呼入媒体，PoC服务器需要过滤呼入的PoC业务流量。参与PoC功能可以过滤业务流量，以便只听到一个谈话。业务流量过滤遵循如下规则(按优先顺序):
  1. 用户可以将自己锁定在一个群组中。只有该群组的业务流量可以传递给用户(类似于电话服务)。
  2. 用户可以设置某一个会话为首要PoC会话。首要会话的业务流量总是可以传递给用户（如果当前该用户不是正在次要PoC会话中讲话)。尽管一个次要PoC会话中正好也有业务流量。
  3. 在次要PoC会话中，只要当前谈话保持激活状态，就始终传递当前对话谈话的业务流量。在沉默期后（时间长由运营商定义)，PoC服务器从其他会话中选择一个激活的媒体。
- 为了将“我的家庭”组设置为首要会话，她的设备需要在特定属性中设置值为“1”，即在会话请求( SIP INVITE，UPDATE或RE-INVITE)的SDP有效负荷中设置a = poc_sess_priority =“1/0”。为了变化优先级的值，可以使用“0”，或者设备能够向其他组指示优先级“1”，然后就可认定PoC服务器交换了优先级。
- 当Alice想要集中精力到单一群组通信时，她的设备需要在特定属性中设置值为“1”，即在会话请求（SIP INVTTE，UPDATE或RE-INVITE)的SDP有效负荷中设置a= poc_lock =“1/0”。为解除会话锁定，她的设备需要将其他会话锁定，或者发出另一个会话请求并指示值为“0”[ OMA PoC Control Plane]。

##### PoC会话建立模式

- 存在两种不同的会话模式:按需会话和预建立会话。两类会话模式的主要区别在于媒体参数协商。在预建立会话模式中，用户在向其他PoC用户发出PoC会话请求之前，就与其参与PoC功能建立一个会话，并且会先协商所有媒体参数。在按需会话中采用了“通常的”SIP方法，即当用户请求PoC会话时，才开始协商媒体参数。预建立会话模式允许PoC客户端邀请其他PoC客户端或者接受PoC会话而无需再协商媒体参数。这将额外节约会话建立时间
  - ![[image-20230320160129864.png]]
  - ![[image-20230320162217633.png]]

##### 呼入PoC会话处理

- 定义了两种不同的应答模式:自动应答模式和手工应答模式。
  - 当使用自动应答模式时，PoC设备无需等用户做出任何动作便会接受呼入的PoC会话，即能够立即播放呼入媒体流。
  - 手工应答模式是常规模式，用户需要接受呼入PoC会话请求，然后PoC设备才能向PoC服务器确认接受呼入的PoC会话。应答模式也会通过信令回传给执行主控PoC功能的PoC服务器，进而使用SIP响应中的Un-confirmed或Confirmed指示反馈给发起方用户功能。当目的方PoC设备采用手工应答模式、并且已经发出SIP 200 OK响应表示接受了新的PoC会话时，就会给出Confirmed 指示。否则，目的方参与PoC服务器功能就会产生Unconfirmed 指示。
    - Unconfirmed指示是 PoC服务器反馈的指示，用以确认:能够接收媒体，并且PoC客户端能够接收媒体;在PoC服务器发送Unconfirmed指示之后，再确定是否所有外出元素都已就绪或甚至是能够接收媒体。
    - Confirmed指示是PoC服务器反馈的信令消息，用以确认:PoC服务器、PoC服务器和目的方PoC客户端之间的所有的其他中介网元，都能够并且愿意接收媒体。
- 访问控制机制
  - 选择性地允许或阻止来自其他PoC用户和PoC群组的呼入PoC会话。
  - 选择性地定义能够自动接受哪些用户的PoC会话。
  - ![[image-20230320164550534.png]]
    - 如果请求了手工应答覆盖，并且允许主叫用户用这个特性，那么就会执行自动应答模式。如果请求不被获准，那么应答模式的选择就遵从图6-8。

##### 即时个人警示

- 有时主叫用户无法联系接收方（例如用户激活了呼入会话屏蔽)，于是主叫方可能希望留个明确的消息，以便让被叫方回呼。该消息称为“即时个人警示”。当期望使用不那么明显的警示方法时，即时个人警示请求可以用于替代按键通话的语音传输。
- 区分出 PoC即时个人警示使得PoC客户端能够创建自动操作。为此，要求发起方PoC客户端必须在Accept Contact消息头字段包含PoC特性标签,“+g. poc. talkburst”、“re-quire”和“explicit”参数
  - ![[image-20230320165304449.png]]
- 如果用户不想接收即时个人警示，他可以激活Incoming Instant Personal Alert Bar-ring（屏蔽呼入的即时个人警示)。当激活这个服务时，为此用户服务的参与PoC服务器必须阻止传递，并向发送方反馈SIP 480 Temporarily Unavailable错误响应。

##### 群组公告

- 发送群组公告，其中包括了创建组的所有必要信息:组名称（URI和显示名字)，组类型，公告文本。当其他族成员接到组公告时，他们可以决定保存联系信息以便日后通信。使用接收到的信息时，他们能立即决定拨入那个组。
- 一个群组公告可以利用SIP MESSAGE发给一个或多个用户，或者可以一次发给所有的组成员，消息正文中包含了PoC特定内容，并采用MIME（多用途因特网邮件扩展)vnd. poc. advertisement + xml格式。此外，发送方必须包含Accept-Contact消息头字段并填入PoC特性标签“+g. poc. groupad”，且带上“require”和“explicit”参数。使用特性标签和上述参数，能够保证公告只传递给能够理解群组公告消息的支持PoC的UE。
  - ![[image-20230320175724546.png]]
    - `<note >`元素——发送方填入的公告文本;
    - `<group >`元素——包含组类型有关的信息（拨入、拨出、其他)，PoC组的显示名字，PoC组的URI。
    - 当类型属性使用“拨入”时，说明是聊天PoC组。类似地，“拨出”意味着是预建立PoC组。增加了“其他”用于以后扩展
- 主控PoC服务器可以支持传递群组公告给所有的PoC群组成员，也可以实施不同的认证规则，规定允许谁能够向所有群组成员发送群组公告信息。
  - 只有群组拥有者才能向所有群组成员发送群组公告信息﹔
  - 所有群组成员都能向所有群组成员发送群组公告信息。
- 如果PoC客户端不想接收群组公告信息，它应该在SIP RECIRSTER请求中不包含PoC特性标签“+g poc. groupad”。

##### 屏蔽特性

- PoC用户可以利用访问控制列表，选择性地屏蔽PoC呼入会话。此外，PoC用户能够指示PoC服务器拒绝所有新增的呼人PoC会话。这个特性称为ISB ( Incoming Session Barring，呼人会话屏蔽)。当激活屏蔽特性时，参与PoC服务器将利用SIP 480 Temporarily Unavailable响应拒绝所有呼入的会话请求，与此同时，参与PoC服务器将保持进行中的PoC会话不受影响，并向用户传递呼人的即时个人警示。如果用户还想屏蔽即时个人警示，那么他应当激活InstantPersonal Alert Barring （即时个人警示屏蔽)。

##### 参与方信息

- PoC用户可以请求PoC会话参与方的信息，以及他们在PoC会话中的状态。PoC客户端使用会议状态事件包来获知PoC参与方的变化:换而言之，通过通知单，用户能够获知谁加入或谁离开了会议。这个事件包还允许参与方获知用户参与会议的状态(挂起，告警)。

#### 用户面

- PoC的用户面包括三个部分，即媒体流（由通话突发构成)、通话突发控制和质量反馈
  - ![[image-20230324163315626.png]]
- 参与PoC服务器在主控PoC服务器和PoC客户端之间往返转发通话突发数据、通话突发控制消息和质量反馈测量数据,但以下情形除外:
  - PoC客户端与PoC服务器已经有一个预建立的会话;
  - PoC客户端和PoC服务器支持并发会话;
  - PoC服务器需要媒体传送日志,以便支持计费功能;
  - PoC服务器用作服务的码值转换或其他媒体适配功能;
  - PoC服务器需要支持合法的截获操作;
  - PoC服务器作为不同通话突发控制协议之间的网关。
- 如果PoC服务器同时执行参与PoC功能和主控PoC功能，那它就相当于一个RTP转译器。与RTP混合器不同的是，RTP转译器只是把媒体数据包从一个P流传递到另一个IP流，既不重新打包，也不转换媒体格式。

##### 通话突发

- 简单地说，通话突发包就是从参与者流向主控PoC服务器的单独的突发的媒体数据。主控PoC服务器把通话突发包分发给会话中的所有参与者。参与者收到媒体流，用自己的声音系统进行渲染，然后用扬声器播放出来。PoC会话是个共享的平台，也就是说任何时刻，只有惟一一个通话突发包能够成功地进行分发并在接收端播放。此外，因为在一个群组PoC会话中，可能有多个参与者共享这个平台，这就需要有一个仲裁功能——一个平台仲裁人，用来控制在某一时刻允许谁发送媒体数据。对于把持平台的请求将被排成队列，按照顺序进行授权。或者，对于请求要么授权要么拒绝，通常用户通过视觉或声音的指示发现请求的结果----就像使用通常的步话机一样。

##### 通话突发的控制

- 为解决平台控制问题，PoC规范制定了通话突发控制协议(Talk Burst Control Pro-tocol，TBCP)，作为用户面规范的一部分。TBCP用户请求、授权、拒绝和释放PoC会话平台。作为平台仲裁人，TBCP服务器总是充当主控PoC功能。参与PoC服务器通常只是转发来往于PoC客户端的消息，但也可能会执行其他功能，
- TBCP消息:
  1. TBCP通话突发请求(TB_Request)---客户端发出该消息,用以请求允许发送一个通话突发。例如当用户按下发送按键以便进行PoC会话的讲话时，就生成该消息。
  2. TBCP通话突发授权(TB_Granted)——该消息由PoC服务器发往PoC客户端，指示该PoC客户端已经获得PoC平台的授权。这意味着允许该客户端发送一个通话突发，此时在PoC会话中的其他参与者将听到这个人的声音。
  3. TBCP通话突发拒绝(TB_Deny)——该消息由PoC服务器发往PoC客户端,声明已经拒绝该PoC客户端使用PoC平台的权利。这意味着不允许该客户端发送通话突发，此时其他参与者将听不到这个人的声音。
  4. TBCP通话突发释放(TB_Release)——该消息由PoC客户端发往PoC服务器，声明该PoC客户端已经完成了通话突发的发送。
  5. TBCP通话突发取走(TB_Taken)———该消息由PoC服务器发往PoC会话的所有其他的参与者,以通知他们另一个PoC客户端已经获得PoC平台的拥有权，并正处于发送通话突发的过程中。该消息也可以由PoC服务器出于可靠性目的而发出，要求接收到这个消息的参与者立即发出确认。
  6. TBCP通话突发撤回(TB_Revoke)——该消息由PoC服务器发出，撤回已经授予的讲话授权。例如服务器中断过长的通话突发。
  7. TBCP通话突发空闲（TB_ldle)——该消息由PoC服务器发往PoC会话的所有参与者，通知他们PoC平台空闲可用，PoC服务器愿意接收TBCP通话突发请求(TB_Request)消息。
  8. TBCP通话突发应答（TB_Ack )——-该消息由PoC客户端发往PoC服务器，作为收到请求后发回的相应应答。
  9. TBCP通话突发队列状态响应（TB_Queued)——该消息由PoC服务器发往PoC客户端，指示通话突发已经请求并加入队列。该消息也可以指示当前PoC用户在队列中的位置。
  10. TBCP通话突发队列状态请求（TB_Position)—-该消息由PoC客户端发往PoC服务器,请求它在通话突发或平台队列中的位置。
  11. TBCP连接（Connect )——在预建立会话中，该消息由PoC服务器发往PoC客户端，指示已经收到新的会话，并已经为此创建了相应的平台。
  12. TBCP断开连接 (Disconnect )——在预建立会话中，该消息由PoC服务器发往PoC客户端，指示某个特定的会话已经结束，并且相应平台已销毁。
- TBCP使用RTCP的协议格式——实际上，该协议使用了BTCP APP数据包来发送控制消息。由于RTCP运行在不可靠传送之上——UDP协议（用户数据报文协议)，该协议采用请求-应答模式，使用基于特定定时器的应用层重传机制。此外，消息可以可靠地发送，也就是说发送方可以请求立即响应。
  - ![[image-20230324172944731.png]]

##### 质量反馈

- PoC服务器和客户端，能够选择性的创建、发送和处理RTCP质量反馈报告。RTP的接收方能够生成接收质量反馈，它可能采用两种形式之一，即发送方报告(SR）和接收方报告（RR)。SR和RR的区别在于SR还包括发送数据的信息。两个报告都包括接收到的媒体包的统计，包括RTP包总数、接收到数据的总字节数和抖动间隔、媒体包的大致相对传输时间。
- 在PoC用户面，PoC客户端每次完成通话突发的发送之后（即完成了向PoC服务器发送TB_Release消息以后)，就会得到指示产生SR。当发生下面两件事之一时PoC客户端就会得到指示发送RR:
  - PoC客户端收到SR。
  - PoC客户端收到指示，通话突发已经终止（即 TB_Idle消息)。PoC客户端的RTP媒体计时器触发。
- 由于在PoC会话中PoC服务器承担RTP转译器的功能，通常它们只在PoC会话参与方之间转发RTCP报告。这就意味着SR可以从惟一一个发送方发给其他所有人。类似地，那些实际上没有接收到任何媒体的参与方不会发出 RR。这种情况有可能出现在:如果PoC客户端正参与并发的多重会话中，此时若出现呼入的通话突发，就只能听到首要会话了。

#### PoC服务设置

- 如何激活或去激活应答模式、如何屏蔽设置或支持并发会话。

  - OMA PoC版本1采用SIP PUBLISH来进行这些业务设置。

  - 主要原则是，在每个成功的初始注册以后，PoC客户端发出SIP PUBLISH 消息，其中包含PoC特定的MIME“application/ poc-settings + xml”正文格式的内容（XML文档)。此外，发送方必须包含Accept-Contact消息头字段，该字段带有PoC特性标签“+ g. poc. talkburst”以及“require”和“explicit”参数。使用特性标签和上述参数将保证正确地将请求递送到用户的PoC服务器。

  - XML文档本身包含的4个PoC特定的元素

    - ```xml
      <isb-settings > ; active = true/ false
      <am-settings > ; manual/ auto
      <ipad-settings > ; active = true/ false
      <sss-settings > active = true/ false	
      ```

  - 示例：描述了PoC客户端不能激活屏蔽的情形。其中，应答模式设置为自动回复，并且设备能够支持并发PoC会话。

    - ![[image-20230324174859056.png]]

### 消息服务

- 目前有多种可用的消息服务类型。一般来说，消息服务允许一个实体向另一个实体发送消息。消息可以是多种形式，包括多种数据类型和各种传递方式，比较常见的是包含多媒体信息以及文本信息的消息。消息的传递或者是接近实时的，就像现在很多即时消息( instant messaging)系统中那样;或者是作为Email 发到邮箱中。

- 类型：立即消息 （ immediate messaging)和基于会话的消息（ session-based messaging)。每种类型的IMS消息都有其自己的特征。
  - 虽然所有形式的消息服务都是把一条消息从A发到B，但最简单形式的消息仍然可以被看作是单个服务，正是这些特征的差别使得它们每个都各自成为一个服务。但是，在这些服务上创建应用的方式能够很好地隐藏它们是不同形式的消息服务这一事实。实际上，IMS消息服务的一个关键要求就是，易于在不同消息类型之间实现互操作。

#### 立即消息

- 立即消息，或称为分页式消息( page-mode messaging)，采用的是IMS框架中为人们所熟知的即时消息范例。它使用SIP协议的 MESSAGE方法来在通信双方之间接近实时地发送消息。
  - ![[image-20230324175500849.png]]
    - 在立即消息中，用户设备（UE)只需生成一条 MESSAGE请求，填人所需的内容，典型的是文字，也可以包含多媒体片断，例如声音和图片，并将请求URI(统一资源标识符）填写为接收者的地址。接下来该请求就使用与INVITE类似的方式在IMS系统中转发，直到这个立即消息辗转到达接收方用户的UE或者存储在网络中。
    - 当然，很可能会存在一个对该消息的应答。实际上，完整的立即消息很可能是两个用户间的来回对话。但是，与基于会话的消息不同，这个会话的上下文仅存在于参与其中的双方用户处。这种通信过程中会话不包含任何协议，每条立即消息都是一个独立的事务( transaction)，与前面的任何请求都没有关系。
    - 如果当一个IMS用户收到立即消息时处于离线状态或未注册状态，MESSAGE将路由到一个AS（应用服务器)。该AS能够保存消息，并且当用户注册时会将消息递送到最终的目的地。
    - 通常，立即消息是发往对方的公共用户标识。然而，利用IMS列表服务器的扩展，用户也可以把一条消息发给多个接收者。基本上，IMS用户可以利用PSI(公共服务标识)形式的SIP地址来创建一个列表，并把期望加入的成员的SIP URI填在这个列表中。任何时候当MESSAGE方法发到对应于该列表的PSI时，请求就被路由到列表服务器。列表服务器本身就是一个AS，它将截获消息，并为列表中的每个成员生成一条请求。
    - 如果立即消息发送给非IMS订阅者的用户，那么很可能将MESSAGE发送至一个执行消息互通功能的AS，例如该AS将 MESSACE方法转换为SMS或者MMS甚至是Email 的形式。

#### 基于会话的消息

- 基于会话的消息与因特网上早已使用的一种常见的消息范例——因特网中继聊天( Internet Relay Chat，IRC)[ RFC2810]有关。在这种消息模式中，用户参与会话时，主要是以短文本消息作为其主要的媒介成分。与其他类型的会话一样，一个消息会话也具有一个定义完好的生命周期:当参与者启动一个会话时这个消息会话就开始，当他们关闭这个会话时会话就终止。当会话（在参与者之间用SIP和SDP）建立后，媒体就直接在他们之间进行P2P传送。
  - ![[image-20230325114210829.png]]
- 会话中传输消息的实际协议是MSRP(消息会话中继协议)[RFC4975]。MSRP建立于TCP之上，能够传递任何MIME ( Multipurpose Internet Mail Extensions，多用途因特网邮件扩展）封装的数据。消息可以是任意大小，因为协议的特性之一就是能支持用多个小块发送一个完整消息,并在接收端自动完成重组。

#### 消息协同

- SMS 和MMS是在移动网络中广泛使用的两种消息服务技术。SMS可以满足如下需求:简便，普遍，大规模市场占有，临界质量和可靠性。SMS原理易懂，使用便捷，通信失败和长延时也很少出现，现在基本上每台手机都加载了SMS。
- 3GPP的第一步是规定如何在IMS网络中发送和接收SMS，该功能被称作基于IP的SMS。
  - 实际的SMS作为一种特殊的内容类型加入到SIP MESSACE方法中，从而可以将SMS发送到通过非蜂窝网IP-CAN (比如WLAN、WiMAX)接入的设备上。这也可以看作是对目前的承载选项（CS，GPRS)的一个替代的方案。利用这种协作方法，现有的所有类型的增值SMS业务都可以被传输到与IMS连接的UE上。
  - ![[image-20230325114802031.png]]
    1. IP-Short-Message-Gateway应用服务器从SM服务中心收到短消息（ SM);
    2. 生成并发送 SIP MESSAGE。MES-SAGE请求的关键字段如下:Request-URI，指向注册的IMS公共用户标识的;Accept-Contact，表明该请求只发送给已经注册了接收基于P的SMS业务的设备;Request-Disposition的“no-fork”值，表示该请求被发给一个且只能是一个用户;Content-Type，表示消息的有效负载事实上是短消息〔3GPP TS 24.341]。
    3. 基于IP的SMS发起流程。就像终结流程一样，MESSACE请求的正文包含了实际的短消息，但在这里SIP层的目标地址实际是服务中心（接收者的地址被包含在实际的短消息中)。
       - ![[image-20230325114902864.png]]
- 在IMS消息协商中要考虑一个额外因素，那就是消息的长度。SIP MESSAGE[RFC3428]中指定了对长度的限制。该RFC中明确要求如果消息的长度比路由中最小的MTU值（该限制一般是1300B)小200B乃至更多的话，就不允许以会话以外的方式发送出去。如果 IP-SM-GW收到连续的SMS消息（由几个标准长度的短消息构成的一组消息被作为一个较长的消息发出)，那么就有可能会被超出SIP MESSACE的长度限制，此时IP-SM-GW就会使用会话模式来发送该消息。

#### 开放移动联盟定义的即时消息

- IM：instant Message

##### OMA IM架构

- 开放移动联盟（OMA)IM标准版本1的架构基于IM客户端、IM应用服务器和XML文档管理服务器（XDMS)。保存IM特定数据的XDMS服务器被称为“IMXDMS”。IM服务器负责处理针对不同应用的任务，比如向所有的聊天对象发送MSRP消息，以及向好友列表上的所有成员发送立即消息。服务器同时也为运营商策略的实施和网络管理系统提供接口，并创建跟应用相关的计费数据记录（ CDR)。IM服务器通过IMS业务控制（IMS Service Control，ISC)参考点与IMS相连接。IMS负责通用功能，比如为IM进行用户身份认证、会话路由和基于SIP的通用计费。IM客户端在用户设备上一般以软件形式存在，而在 PC上则可以是一个应用积序
  - ![[image-20230327175803742.png]]

###### IM服务器

- IM服务器是IMS架构中的一个应用服务器，为用户提供IM服务。它控制IM的会话建立过程，执行进/出IM的相关策略（例如，谁可以加入，谁可以邀请更多的成员，某个用户离开时是否应该结束会话，某个用户加入时是否要邀请其他的用户，执行运营商关于消息大小和内容的策略)，提供群用户消息（例如，当有人加人/离开群时进行通知)，执行用户的黑名单/白名单，替用户发布IM相关的在线信息，用户重新上线时通告并传输存储的消息，以及为恢复先前的聊天历史记录提供可能性。更进一步，IM 服务器还负责处理 MSRP的流量分配。总而言之，IM服务器使用IMS参考点ISC和Mb来处理IM服务相关的控制平面和MSRP用户平面上的传输。

- ![[image-20230328110901829.png]]

###### IM客户端

- 根据OMA标准，IM客户端是存在于UE上的功能实体，可以使用IM特征标签并且使用在SIP REGISTER请求中指明IM的版本号的方式来向IMS进行注册，发送和接收立即消息，初始化/修改/释放IM会话，进行文件传输，支持对IM服务进行设置，获取IM会话的参与者，提取/删除存储的消息，激活/吊销聊天历史以及在IM用户平面调用MSRP。	

##### IM通信

- OMA IM支持三种基本的IM通信模式
  1. 寻呼模式：很适合用于简短消息的交流，比如确认通告
  2. 大型消息模式：用在单个消息较长情况下的短消息交流（比如携带了多媒体内容的消息)。大型消息模式也被认为是立即消息传送模式，这是因为SIP会话仅被用来传输一个大型消息，然后SIP会话就被拆除。
  3. IM会话模式：近似于网络主持的会议，随着时间推移，不断有用户加人和退出

###### OMA IM立即消息

- 通过引人新的特征从而得到增值。在发端添加的新特征有:能够使用消息好友列表，可以将已发送的消息存储在网络中，以及增强了运营商对消息发送服务的控制。除了刚才提到的最后两个新特征外，终结IM服务器的使用也使得用户能够基于自己的喜好来创建白名单与黑名单，暂时阻隔所有到来的立即消息，以及离线时对到来的消息进行网络存储。
- IMS AS通过ISC参考点连接到IMS，通过建立适当的IMS初始过滤准则,所有发端的立即消息请求都被路由到IM服务器。
  1. ![[image-20230328113506301.png]]
     - 发端IM服务器会执行所有必要的运营商服务控制步骤。如果请求不符合运营商的策略，IM服务器就使用一条合适的SIP错误消息来拒绝该请求。
  2. ![[image-20230328113545383.png]]
     - 一旦这个请求到达了接收端网络，就被按照IMS初始过滤准则路由至本地IM服务器。终端IM服务器首先检查接收者是否愿意接收立即消息，可以通过检查用户的IM服务设置值来得知，用户在注册了IM服务后就有权发布这些值。如果激活了屏蔽（ bar-ring)，那么IM服务器就立即回复一个 SIP 403 Forbidden来拒绝该请求，并附带相应的警告文本显示在发信者的显示屏上。下一个检查就是分析终端用户的白名单和黑名单。如果该检查不允许请求通过，则会用一个SIP 403 Forbidden进行拒绝。接下来如果该消息仍旧存活，则根据运营商的策略对携带的内容（如果有的话，例如图像和语音片段）进行检查。只要符合策略（如果不符合，则回应一条415 Unsupported Mediatype 的错误响应)，最终的测试通过，注册检验完成。若用户在线，则该消息会被直接传给用户;若用户离线，则将该消息保存在IM服务器中，待用户下次上线时再传输。
  3. ![[image-20230328113555837.png]]

###### 基于OMA IM会话的消息

- 拨出式消息会话:在拨出式会话中，用户可以邀请一个或一群用户参与到消息传送会话中。在群通信的情况下，被邀请的群可以是预定义的IM群，也可以是由从发起用户的电话簿上选出的用户组成的临时群（即所谓的自组织IM群)。对于后一种情况，尤其是在拨出会话前就获悉其他用户的在线状态，可以给用户带来显然的额外价值。拨出式会话适用于非计划的情况，或是必须要逐个挑选参与者的情况下。被邀请的用户客户端会收到会话到来的提示，可能自动接受消息请求，或者是询问终端用户的许可，以接受通信请求。
- 加人式消息会话和聊天群: 其中，参与者自己可以明确地选择加人一个IM消息会话。在这种模式下，用户对加人哪个群有充分的控制权。用户只有在加入某些群后，才能接收到消息。加入式模式适用于预先计划好的或是惯常的通信。加入到一个聊天群其实和现实生活中的一些行为类似，比如看电视、去电影院看电影或是参加一个会议。聊天IM会话可以持续数小时，但真正在通信的时间可能只占一小部分。因此，对于一个进行聊天IM会话的用户，他还应该可以同时接受其他的会话。当然用户也可以同时参与到几个不同的聊天会话中（比如,“我的家人”,“一起打篮球的朋友”,“酒友”)。一个聊天群可以是没有任何接入控制的公共群，也可以是有特定成员的私人群。公共群对任何知道群识别符（该群的SIP URI)的用户开放。群识别符可以在比如运营商的门户网站或是聊天室清单上找到。公共IM聊天群适用于公开讨论的论坛，有普遍或特定的讨论主题（比如钓鱼，汽车，足球)。而私人群则只对那些预先定义的用户开放。
  - ![[image-20230328165656141.png]]
- ![[image-20230328170035735.png]]
  - 一旦UE收到来自用户的请求，它就会生成一条发往终端的SIP IN-VITE请求。该请求包括了一些OMA专有的特征，例如，请求中的Accept-Contact和Contact消息头会包含OMA IM专有的特征标签，即+ g. oma. sip-im;请求中包含指明IM版本号的SIP User-Agent消息头。若会话用于一对一或是预定义的IM群，那么目标用户的地址或是预定义IM群的名称就会包含在Request-URI消息头中。在自组织IM群会话的情况下，Request-URI消息头会包含conference factory URI，而有意加入的群组成员会包含在MIME资源列表正文中
- ![[image-20230328170049639.png]]
  - 位于IMS#A 的S-CSCF会执行初始过滤准则，并根据是否出现OMA IM专有的特征标签，请求将被路由至发端IM服务器。发端IM服务器会执行所有必要的服务检查(比如核实建议的SDP媒体属性是否遵从运营商的策略，用户是否有有效的消息订阅，是否是IM服务器所属的预定义群，是否允许用户使用预定义的IM群，或是被邀请用户的数量是否超过了群/运营商的限制)。如果未违反任何服务限制，那么IM服务器就跟会话参与者发起会话建立过程（图例所示是只有一个接收者的情形)
  - 针对每位会话参与者，重复进行以下步骤。使用正常的IMS路由机制将IM会话请求路由至终端网络。就像在发端网络中一样，S-CSCF会检测OMA IM专用的特征标签是否出现，并将该请求路由至终端的IM服务器。终端的IM服务器首先会通过检查用户在注册完成后公布的IM服务设置值，来检验终端用户是否愿意接收会话请求。在服务设置中，有一个值是用来阻挡所有呼入的会话请求( incoming-session-barring)的。如果屏蔽被激活，那么IM服务器会立即拒绝会话请求，并回复一条SIP 403 For-bidden消息，该回复包含相应的警告文本，会在发起者的屏幕上显示。下一个检查就是分析终端用户的白名单/黑名单。如果该检查不允许请求通过，则会用一条SIP 403Forbidden消息进行拒绝。接下来如果该消息仍旧存活，则根据运营商的策略对携带的内容（如果有的话，例如图像和语音片段）进行检查。只要符合策略（如果不符合，则回应一条488 Not Acceptable Here的错误响应)，最终的测试通过，注册检验完成。若用户在线，则该会话请求会被直接传给用户;若用户离线，则使用一条SIP 480Temporarily Unavailable拒绝请求。
  - 当会话建立完成后，所有会话成员就可以使用MSRP开始发送实际数据了。通常MSRP流量本身会经过IM服务器处的 MSRP交换机

###### IM会话期间的私有消息

- IM会话中的默认行为是由IM服务器把所有发出的消息都传送给对应的会话参与者。有时候用户会向IM会话中的一个或多个参与者发送特定的消息，向特定的会话参与者群发送消息被称为私有消息传送。这项功能并不包含在基本的IETFMSRP中，并且IETF对这个特色功能的标准化也没有很大兴趣。因此，OMA就定义了自己的应用逻辑来支持私有消息发送功能。

###### 聊天昵称

- 在公共聊天室和讨论组中，用户更希望使用别的代号来代替他们的真实身份。另外，用户可能希望在不同的论坛中使用不同的昵称，并可能随时地改变。不幸的是，IETF SIP和 MSRP规范目前都不支持聊天昵称的协商。而OMA IM则制定了自己的一套聊天昵称协商机制，采用了如下的SIP隐私能力和会议状态事件包。
- 为了能在IM会话中使用聊天昵称，IM客户端在为IM会话进行初始化 INVITE时，会请求匿名。该请求将包含用户所想使用的聊天昵称，这个聊天昵称填在From消息头的 display-name域中
  - ![[image-20230328174407136.png]]

###### IM通信拦截

- IM用户可以指示IM服务器拒绝所有新到来的IM通信请求，并可以分别拦截立即消息和会话模式下的消息。在拦截功能激活期间，参与IM服务器会拒绝所有到来的请求，并回复一条SIP 480 Temporarily Unavailable响应，同时它也会确保正在进行的IM会话不受干扰。

###### 参与者信息

- IM用户可以请求获得IM会话参与者的信息以及他们目前在该IM会话中的状态。IM客户端使用会议状态事件包来获悉IM参与者的变化。换句话说，用户可以通过通知来获悉谁加入/离开了会议。用户可以向控制IM功能的SIP地址发送SIP SUB-SCRIBE请求，以订阅会议的状态。控制IM功能扮演了事件包的通知者的角色。
  - OMA IM 版本1.0规范只使用了如下有限的一些功能:
    - IM群格式的标识符取决于IM会话类型。
    - IM用户身份识别现在作为IM会话的一部分。
    - IM 用户状态（连接，未连接)。
    - 在IM客户端将该信息显示给用户之前，IM客户端会将接收到的列表与用户的IM黑名单进行比较。如果找到匹配的，IM客户端就将此额外的消息加亮显示给用户。

##### 聊天历史

- 聊天历史功能使得用户可以按自己的意愿，对全部或者选择的一部分消息在网络中进行备份。这些备份消息的所有者可以搜索和浏览他的所有存储消息，并且可以提取或是删除一条或是多条消息。

###### 激活与中止

- 当用户要存储立即消息或是IM会话的备份时，可以向IM服务器请求激活聊天历史记录功能。有两种途径来激活聊天历史记录功能。一种方法是，IM客户端可以通过进行IM服务设置发布，将历史配置设置为合适的值，来激活消息的存储功能。该方案适用于用户欲将所有的消息存储在网络中的情况。另一种方法则适用于IM会话，用户请求把网络存储器作为一个新成员加入到当前的会话中，从而开始存储正在进行的聊天消息。若用户要停止该项功能，IM客户端需要再次发布设为特定值的IM服务设置，或是从当前的IM会话中移除会话历史功能。

###### 创建消息发送历史

- ![[image-20230331162055280.png]]
  - 一旦聊天历史功能被激活，参与IM服务器功能会存储所有到来（终端请求）的和出去的（发端请求)的消息。在寻呼模式下，SIP 消息( SIP MESSAGE)会被完整地保存下来。大型消息模式和会话模式下，所有与消息发送相关的INVITE，200 OK和BYE请求的相关SIP消息头（比如，发件人，收件人，P-Asserted-ldentity，主题，日期）都会被保存，同时所有与实际的MSRP消息有关的内容也会被保存。IM服务器会为每条存储的消息分配一个独一无二的历史索引，用来以后提取/删除某条存储的消息。除了保存实际的消息外，参与IM服务器还在IM-XDMS中存储消息的元数据。该元数据包括比如日期、时间、历史索引、存储消息的大小、消息种类和发送者身份等信息。

###### 利用聊天历史功能提取所保存的消息

- 提取所保存的消息包括三步:获悉所要提取消息的历史索引，在IM客户端和聊天历史记录功能之间建立SIP会话，接收真正的MSRP消息。要完成第一步，IM服务器可以连接到IM XDMS，提取已经汇总了所有储存消息的XML文档，也可以选择连接到搜索代理，使用关键字来搜索某条消息。在获得了描述所需要的那条（些）消息，并包含了相应的历史索引的XML文档后，IM客户端发送SIP INVITE请求到如下的SIP地址 History@hostname (比如，History@imserverl. ex-ample. com)。该请求也包括了URI列表正文，该正文包括了要提取的消息的历史索引。
  - ![[image-20230331171259760.png]]
- IM服务器会核实并授权到来的请求。若允许此用户提取消息，那么IM服务器就接受此会话请求，下载存储的消息，为每条消息发起 MSRP传输。一旦IM客户端收到MSRP传输，就可以像传递其他消息一样将此消息传给用户。

###### 利用聊天历史功能删除保存的消息

- 类似于提取操作，在操作之前IM客户端需要得知要删除消息的历史索引。IM客户端使用XDM架构来获得历史索引。一旦IM客户端获得了历史索引，就调用SIP REFER请求来删除消息。该请求被发送至预指定的SIP地址 Delete@hostname (比如，Delete@imserverl. example. com)。使用Refer-To域来指明用户想要删除单条、多条还是全部的消息。
  - 删除单条消息:Refer-To域中只有单条消息的历史索引。
  - 删除多条消息:Refer-To域引用一个XML正文，该正文包含了要删除的消息的历史索引列表。
  - 删除所有消息:Refer-To域内容为:sip:History@hostname。

##### 消息延缓发送

- 类似于SMS、MMSC和Email服务，OMA IM也为离线的用户提供存储立即消息的能力，以便稍后进行传递。IM服务器的消息延缓发送功能就可以实现此项服务。用户离线时，消息被保存在终端网络，而保存消息的元数据则被存放到IM XDMS中。元数据包括，比如，日期、时间、消息索引、被保存消息的大小以及发送者的身份等。对于SIP MESSAGES，整个消息都将保存下来;在大型消息模式下，所有与INVTTE，200 OK和BYE请求相关的SIP消息头（比如发件人、收件人、P-As-sert-ldentity、主题和日期）以及真正的 MSRP消息的内容都会被保存下来。IM服务器会为每个存储的消息分配一个独一无二的消息索引，以供在以后提取/删除被存储的消息时使用。
- 可以采用推（ push)或拉（ pull)的模式来获取延缓发送的消息。在推模式下，IM客户端需要在IM服务设置中指明它要提取所有被延缓的消息。一旦IM收到此请求，就会发起与客户端之间的SIP会话，并使用MSRP将延缓的消息“推进来”。在拉模式下，IM客户端会联系IM XDMS并提取被延缓消息的消息索引，在选择了要提取的消息后，IM客户端会发送SIP INVITE请求给sip: Deferred@hostname (比如sip: Deferred@ imserver1. example. com)。如果只提取其中一些消息，那么这些消息通过INVITE请求中URI-list正文里的消息索引来识别
- 要删除延缓发送的消息，在初始化删除操作之前，IM客户端要从IM XDMS中获取消息索引。IM客户端一旦获悉了索引，就发送SIP REFER 请求来删除消息。该请求被发送至预指定的SIP地址Delete@ hostname (比如，Delete@ im-serverl. example. com)。使用Refer-To域来指明用户想要删除单条、多条还是全部的消息。
- ![[image-20230331172400462.png]]

##### IM服务设置

- IM用户可以使用IM服务设置来开/关IM通信屏蔽功能、激活/中止IM聊天历史功能、请求立即发送暂存消息以及指明该用户是否对其他IM用户可见（状态显示在线还是不在线)等先前描述过的功能。
- IM重用了OMA PoC服务设置中的服务设置传输机制。也就是，IM客户端使用SIP PUBLISH 把服务设置发送到IM服务器，SIP PUBLISH中包含了OMA特定的XML负载。更准确地说，IM使用了两种已有的PoC服务设置XML元素，来用于寻呼模式屏蔽（ ipab-settings）和IM会话屏蔽（ isb-settings)，并在XML框架之上为PoC定义了三种新的XML元素。为了防患于未然，如果一个IMS应用服务器同时使用IM和PoC服务，会引入额外的XML属性“service-id”以明确的区别IM和PoC服务的屏蔽值。
- ![[image-20230331172910340.png]]

##### 投递报告

- 在很多的消息交换系统中，消息发送者都希望知道接收者是否确实收到了消息，这就是投递报告机制。对于寻呼模式消息（SIP MESSAGE)和基于MSRP消息（大型消息和会话模式消息)，有着不同的实现方法。寻呼模式下的消息投递报告机制完全基于[ draft-ietf-simple-imdn-06]中定义的 IETF的解决方案。而对于基于 MSPR 的消息通信，OMA在基于MSPR 提出的上述解决方案的基础上定义了额外的功能。

###### 寻呼模式消息

- 若用户希望收到投递报告，就需要基于[ draft-ietf-simple-imdn-06]，在发出的SIPMESSAGE请求上附加一些适当的消息/CPIM净荷。控制IM功能会返回一条单独的SIP MESSAGE给该用户，该消息包含了关于已发出消息状态的信息/CPIM净荷。
  - ![[image-20230331173339465.png]]
    - Tobias预先创建了一个IM群，fcunited@imservice. example. com,该群的成员是他所属足球队的骨干球员，现在Tobias需要通知他们，比赛要推迟一些进行。由于这个信息很重要，因此他要确认消息是否成功地送达。为了满足Tobias的这个需要，IM客户端将真正要传送的内容封装在一个消息/CPIM 包裹中，并且该消息/CPIM包裹包含一个特殊的消息头“imdn. Disposition-Notification”，以此来表明发送者的需求。在本例中，该消息头表明了，用户希望收到肯定的（ positive）与否定的( negative）投递报告。另外，“imdn. Message-ID”消息头也包含了一个惟一的值，使得IM发送端可以将收到的投递报告与之前发出的IM消息进行匹配。

###### 会话模式下的消息发送和大型消息模式下的消息发送

- 若用户希望收到对应于MSRP SEND请求的投递报告，就要附加含有OMA IM特定内容的消息/CPIM 净荷。该特定内容由两部分组成:一个是新的名称空间( namespace)<urn: oma: xml: poc: final-report >;另一个是位于消息/cpim 正文中的新消息头。这个消息头的名称是“Final-Report”，从属于上面提到的名称空间。
  - ![[image-20230331174254570.png]]
- 为了提供真实的投递报告，在 MSRP REPORT 或是MSRP SEND请求的message/CPIM净荷中附加一个OMA特定的MIME正文“application/ vnd. oma. poc. final-report”。投递报告由控制IM功能来发送，控制IM功能可能会把多条不同回复整合在一条投递报告中，从而来减少信令开销。下面是一个最终的回应IM客户端请求的投递报告的MIME正文
  - ![[image-20230331174337504.png]]
    - 最终投递报告文档从根元素`<Final>`开始。`<Final>`元素由一些`<leg>`元素和两个属性“last”和“Message-ID”构成。`<last>`属性只用在最后的Final Report 中，表示这是最后的Final Delivery Report文档。“Message-ID”则包含了SEND消息的Mes-sage-ID，Final Delivery Report正是为这条SEND消息产生的。每个`<leg>`元素都必须包括一个“uri”属性，里面含有接受者（如Alice，Bob，Cecile)的URI 和一个“status”属性（如200，9999)，以及一个可有可无的“max-size”属性。
    - 若MSRP消息成功地传至接收者，或是失败，那么`<leg >`元素中的“status”属性就会置为每个接收者的MSRP状态代码。若由于接收者SDP的“a = max-size”属性值小于MSRP消息的长度而导致MSRP消息发送失败，那么将`<leg>`元素中的“status”属性设置为“9999”，将“max-size”设置为之前协商过的值。

## 详细过程

### 概述

- IP多媒体子系统（IMS）中会话初始化协议（ SIP)和会话描述协议( SDP)相关过程的一个详细例子。通过对IMS注册和其后两个用户间的IMS会话，来阐述信令流程、协议消息及其元素。
- 详细地展示语音会话连续性是如何工作的。
- IMS信令是如何工作的，并且可以了解前面所描述的概念和体系在协议层的具体实现。不过本部分更专注于直接前转的情形，而并不深入涉及出错和异常处理过程。

#### 举例

##### 协议

- ![[image-20230331175510969.png]]

##### 场景

1. 本节基于如下假设:两个用户都已经附着到GPRS网络上，在本节中都以GPRS作为接入技术的例子。
2. 法国学生Tobias正在芬兰游览，他要呼叫他的姐姐Theresa。Theresa在匈牙利工作，但此时正在奥地利出差
   - ![[image-20230331175651305.png]]
3. ![[image-20230331175719210.png]]
   1. Tobias 的归属运营商位于法国。由于他正在芬兰，而其归属地运营商与芬兰的运营商签署了IMS漫游协议，所以芬兰的运营商为其提供了代理呼叫会话控制功能（P-CSCF)。因此Tobias所使用的GPRS网关支持节点（GGSN)也位于芬兰。
   2. Theresa的归属运营商位于布达佩斯，没有与奥地利的运营商签署IMS漫游协议。因此她的终端是附着在她的匈牙利归属网络的P-CSCF上，所用的CGSN 也是位于那里。Theresa接入IMS是基于归属网络和拜访网络之间的GPRS层的漫游协议。
   3. 假设在Tobias 刚刚打开手机时，Theresa已经注册了她的SIP URI（统一资源标识)，即 sip: theresa@home2.hu。Tobias要呼叫姐姐并向她展示奥鲁（Oulu)的一栋漂亮的木屋，因此他把摄像机连接到手机上并对准木屋。与此同时，他的手机还要给Theresa发送另一个他脸部的视频流，这是由内置在手机中的摄像头完成的。但是，在呼叫他姐姐之前，Tobias需要先注册他的公共用户身份sip: tobias@ home1. fr。

### IMS注册过程

- 执行会话初始化协议（SIP)注册过程的目的是建立用户的当前IP地址与用户的公共用户身份（即统一用户标识，SIP URI)之间的对应关系。Tobias 呼叫 Theresa的时候，他向Theresa 的地址“sip: theresa@home2.hu”发出一条SIP INVITE请求，而并不需要知道她用的是哪个终端。这个INVITE消息被传送到Theresa位于home2. hu的注册服务器（ registrar)。该注册服务器在Theresa的注册过程中已经知道了她当前的终端地址，这样它将地址 sip: theresa@home2.hu替换成已注册的联系地址（某个IP地址)，然后将该请求路由到Theresa的终端上。
- ![[image-20230403100631517.png]]
  1. 利用所得到的通用的、与 IMS相关的配置参数，对UE进行配置，该配置过程在每个UE上极可能只会发生一次，且并不需要在每次注册时都重复;
  2. 在Tobias 的用户设备（UE)与GPRS网关支持节点（GGSN)(在GPRS的情况下)之间建立专用的信令分组数据协议（ PDP)上下文;
  3. UE发现代理呼叫会话控制功能（P-CSCF)的地址，该实体在注册过程中用于SIP出站代理,在注册完成后服务于所有其他的SIP信令;
  4. UE向Tobias 的归属网络发出REGISTER消息，来完成他的公共用户身份的SIP注册;
  5. 问询CSCF ( I-CSCF)选择服务CSCF ( S-CSCF)为已注册的用户提供服务;
  6. S-CSCF从归属用户服务器( HSS）中下载用户的认证数据;·UE和 P-CSCF对安全机制达成一致;
  7. UE和网络( S-CSCF)之间相互认证;
  8. UE和P-CSCF之间建立IP安全( IPsec)联盟;·UE和P-CSCF之间启动SIP压缩;
  9. UE学习到S-CSCF间的路由;. S-CSCF学习到UE之间的路由;
  10. S-CSCF从 HSS 中下载用户的用户配置;.S-CSCF 注册该用户默认的公共用户身份;
  11. UE在S-CSCF处注册它所支持的IMS通信服务;
  12. 基于用户配置，S-CSCF可以隐性地注册该用户的更多的公共用户身份;
  13. UE获知分配给Tobias 的所有公共用户身份以及其当前的注册状态;
  14. P-CSCF获知分配给Tobias 的所有公共用户身份及其当前的注册状态。
- 由于要求进行所有这些基本操作，因此Tobias在完成注册之前，是无法向她的姐姐发出INVITE消息的。

#### 初始化参数和IMS管理对象

1. 为了让Tobias的UE创建SIP RECISTER请求，需要知道一些信息。这些信息中，有的由UE上所配备的UICC提供。为了让网络运营商能够对UE进行更多参数配置，并让运营商能够从UE读取配置信息，在这里使用了IMS管理对象( IMS Management Object，IMS MO)。
   - IMS MO通过OMA设备管理（OMA DM）协议被传送到UE上。OMA设备管理( OMA DM)协议的用法已超出IMS领域，OMA DM在此只是用来传送相关的配置参数
2. IMS MO给Tobias的UE提供以下设置参数:
   1. 一个或多个指向GPRS 接入点配置的指针（ConRefs ):通过单独的OMA DMMO在电话中进行配置。UE将使用列表中的一个接入点来连接到3GPP网络，从而实现在此连接之上的IMS注册;
   2. 运营商可以进行偏好设置:该设置决定了UE为IMS使用专用的信令PDP上下文还是使用一般的PDP上下文就足够了( PDP_ContextOperPref)。
   3. P-CSCF地址:只适用于早期利用IPv4的 IMS部署或者不提供P-CSCF发现机制的网络。在本例中该域未进行设置，因为UE是通过IPv6连接到网络的，并使用P-CSCF发现机制;
   4. 运营商特有的、用于SIP计时器T1、T2、T4 (Timer_T1 , Timer_T2，Timer_T4)控制SIP事务( SIP transaction）重传的值。在某些情况下，特定的网络可能会改变这些计时器的默认值。在本例中，不考虑这种情况;
   5. IMS通信业务标识列表(ICSI_List):该列表向UE指示，网络能支持哪些ICSI值。这样，UE就只需要注册那些它本身支持、并且网络同时也支持的ICSI值，本例中，ICSI列表包含以下三个值:
      - ![[image-20230403102805360.png]]
        - 注意，一旦这些URN注册到IANA ( Internet Assigned Number Authority，因特网编号管理委员会)后,URN中的“xxx”将被具体数值取代。
        - 除了这些配置参数之外，IMS MO能够让运营商从UE读取一系列的信息，例如，当UE接收到IMS MO时，它会通过OMA DM协议机制，根据当前设置以及以下字段中的可用值进行响应
          - 所有可用于上述配置字段（ configuration field)的值，例如，ConRefs，PDP_ContextOperPref，P-CSCF_Address，Timer_T1，Timer_T2，Timer_T4，以及ICSI_List。
          - 私有用户身份( Private_user_identity)，所有的公共用户身份（ Public_user_iden-tity_list)以及归属网络域名(Home_network_domain_name)。

#### 建立信令PDP上下文

1. 在Tobias 的UE启动IMS注册之前，它需要与网络建立P连接。在GPRS的情况下，这个IP连接可以是一个专用的信令PDP上下文，也可以是一个通用的PDP上下文。
2. 基于IMS MO中的配置信息，Tobias 的UE知道:
   - 使用哪一个GPRS接口（根据IMS MO的 ConRefs设置得知）来建立GPRS连接;
   - 必须建立专用的信令PDP 上下文（根据IMS MO的PDP_ContextOperPref参数设置得知)。
3. 当UE建立这个信令PDP上下文之后，就可以通过空中接口发送SIP信令了。

#### P-CSCF发现

- <img src="Communication Technology.assets/image-20230406112139275.png" alt="image-20230406112139275" style="zoom:150%;" />

1. P-CSCF是Tobias 的 UE向IMS发送的所有SIP消息的惟一人口。因此，在发送第一个SIP消息之前，UE必须知道P-CSCF的地址。由于本例中该地址不是事先配置好的，因此UE首先要发现该地址。
2. 在GPRS中，UE可以在建立通用或者信令PDP上下文的过程中请求P-CSCF地址。GGSN在对PDP上下文激活请求的应答中返回P-CSCF的IPv6地址前缀。
3. 此外，UE也可以选择使用DHCPv6 ( IPv6的动态主机配置协议）来发现P-CSCF。如果DHCP返回的P-CSCF地址是一个全合格域名（FQDN)而非一个IP地址，那么与其他SIP服务器一样，P-CSCF的地址可以通过域名系统（ DNS）来解析。
4. ![[image-20230404114401574.png]]

##### 使用DHCPv6进行SIP服务器和DNS 服务器配置

1. UE可以通过使用所谓的 DHCP Options来向DHCP服务器请求得到很多配置选项。而且相对于其他基于IP的通信而言，UE和 DHCP服务器之间的通信（即通过所谓的本地连接地址）也很特别。还应该提到的是，DHCP 和 DNS的编码方式与SIP的编码方式相比也有很大不同，在本例中我们选择的是易读的表示方式，而事实上UE和服务器之间的协议消息都是以二进制的格式进行传输的。
2. 为了保证举例的简洁性而仅仅关注IMS和SIP的需求，我们不会考虑DHCP的特殊通信请求，而是进一步假设Tobias的UE从本地DHCP服务器中请求如下两种类型的消息，即
   - DNS服务器的地址;
   - P-CSCF的地址。
3. 为了获得该信息，UE发送一条包含DHCP Options Request Option ( OPTION_ORO,code: 6)的 DHCP REQUEST消息。其中，OPTION_ORO 中包含了一个 DHCP OptionCodes 的列表，该列表显示了UE请求服务器发送给它的 DHCP Options。
   - ![[image-20230403111542811.png]]
     - 第一项用于请求 DNS服务器的地址，第二项则是请求SIP服务器的域名。这里为SIP定义了两项DHCP IPv6 OPTIONS，一个用于域名服务（OPTION_SIP_SERVER_D-code 21)，另一个用于IP地址服务（OPTION_SIP_SERVER_A-Code 22)。在本例中，我们假设UE只请求域名选项。
4. DHCP服务器对此请求返回 DHCP Reply，DHCP Reply将提供所请求的信息。
   - ![[image-20230403111656917.png]]
     - Tobias 的UE现在配置有两个DNS服务器，并知道“visited 1.fi”域允许SIP服务，即提供有P-CSCF。但是，UE不能直接路由到 DHCP REPLY中返回的域名，它需要首先找到P-CSCF的主机名以及它的IP地址，然后才能进行SIP消息传送。

##### DNS名称权威指针( NAPTR)解析

1. 为了找到所请求的地址，UE向 DNS服务器（由DHCP REPLY消息返回的列表中的其中一个）发送一条DNS查询消息，以获取NAPTR RR (NAPTR 资源记录)，询问所接收域名的进一步信息
   - ![[image-20230403111947647.png]]
2. DNS服务器进行应答，其中包含该域所提供的两项服务
   - ![[image-20230403112024872.png]]
     - 该应答显示:拜访域为SIP提供两种不同的服务，一种基于UDP (“E2U + sip”) ,另―种基于TCP(“E2T + sip”)。在这个例子中，我们不对响应中的其他参数进一步解释,之后将会提到另外一个更复杂的例子。

##### 传输协议选择和DNS 服务( SRV)解析

1. IMS对于UE和P-CSCF之间的SIP传输协议没有更多的限制。本例中，假定UDP(用户数据报协议）是首选的传输协议，所以UE选择UDP。UE可以自由选择传输协议，因为DNS NAPTR响应中不包含对于UDP(“E2U + sip")或TCP (“E2T + sip”)的偏好选择。网络运营商也可以在 NAPTR响应中放置服务项偏好设置值
2. 只要消息不超过1300B，UDP将可用于在Tobias 的UE和P-CSCF之间传送SIP消息。当超过该限制时，则必须使用传输控制协议(TCP)。由于SIP也允许SIP消息体携带一些内容（例如，图片可以携带在MESSAGE请求的主体内容中)，所以在进行用户注册时，有可能是同时使用UDP和TCP。
3. UE决定使用UDP来连接P-CSCF，因此通过进一步给本地 DNS 服务器发送DNSSRV查询请求，来解析所指示的服务名称。
   - ![[image-20230403112411800.png]]
4. DNS 服务器返回支持该业务（即UDP之上的SIP)的拜访域visited1.fi中的所有SIP服务器主机名。
   - ![[image-20230403112447923.png]]
   - DNS SRV响应可能包含不止一个主机名，因而主机名需要由特定的程序进行选择。UE从该响应中得知，在拜访网络中，有一个P-CSCF支持基于UDP连接的SIP，该P-CSCF的主机名是pcscf1. visited1. fi，可通过UDP端口5060到达。

##### DNS IPv6地址解析

1. 最后，为了能够向P-CSCF 发送IP包（该IP包会传送SIP消息)，UE请求该P-CSCF的IPv6地址。于是，它需要再一次查询DNS服务器，以便将P-CSCF的主机名解析成IPv6地址
   - ![[image-20230403112916450.png]]
2. DNS服务器发送以下信息来响应AAAA请求
   - ![[image-20230403113020619.png]]
     - UE收集到了将SIP REGISTER请求路由到拜访网络中第一跳P-CSCF的所有信息。

#### SIP注册和注册路由问题

1. 与路由有关的消息头

   - | 消息头        | 功能                                                         | 设置                                                         |
     | ------------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
     | Via           | 对请求消息进行路由转发                                       | 在请求的路由转发过程中，每个途经的SHIP实体都来 设置，将其地址写入 Via消息头 |
     | Route         | 对请求消息进行路由转发                                       | 初始请求:由发起请求的UE来设置，它将填人P- CSCF（出站代理）地址和Service-Route消息头的条目 初始请求:由CSCF来设置，它们从请求URI中的公 共用户身份（通过查询DNS和HSS）或者收到的Path 消息头中发现下一跳 后续请求:由发起请求的UE来设置，它根据初始请 求路由过程中由Record-Route消息头所采集的条目放入 Route消息头 |
     | Record-Route  | 为一个会话中的后续请求 记录Route消息头中的条目               | 由CSCF来设置，如果它们希望收到对话中的后续请 求，就将其地址放入Record-Route消息头 |
     | Service-Route | 指示初始请求的Route消息 头条目，初始请求由UE发往 用户的S-CSCF(用户发起) | 由S-CSCF来设置，它在对REGISTER请求的200 ( OK）响应中返回本消息头 |
     | Path          | 收集Route消息头条目，用 于从S-CSCF向用户P-CSCF 发出初始请求（用户终结) | 由P-CSCF来设置，它将自己的地址放人REGISTER 请求的Path消息头中，并将其发往S-CSCF |

2. Tobias的UE首先会生成一个REGISTER请求，发往 Tobias运营商的归属域。相关信息将从Tobias的 USIM模块（通用用户标识模块）上的IP多媒体服务标识模块(ISIM)应用中获得。该请求将经过P-CSCF和 I-CSCF，如果没有事先指定S-CSCF，I-CSCF将为Tobias选择一个S-CSCF。

3. S-CSCF将根据REGISTER请求中的信息来建立Tobias 公共用户身份与UE的IP地址之间的绑定关系。这使得来自其他用户的请求可以通过S-CSCF路由到Tobias的UE。S-CSCF会更新HSS中的注册信息，下载Tobias 的用户配置，并根据从HSS中收到的初始过滤准则来通知所有与Tobias注册状态相关的应用服务器（AS)。

4. 在注册过程中，UE可以从Service-Route消息头中获知通往S-CSCF的直接路由。此后，当Tobias 的UE需要发出初始请求时，就不需要再联络I-CSCF 了。

5. S-CSCF 从 Path消息头中得知P-CSCF的地址。这是必需的，因为所有发往Tobias的初始化请求都必须首先经过P-CSCF才能达到UE。

6. ![[image-20230406165940374.png]]

##### 构造REGISTER请求

1. 在建立信令PDP上下文并发现P-CSCF地址之后，Tobias的UE可以开始生成初始的REGISTER请求
   - ![[image-20230406112806332.png]]
     1. 上述消息不是一个完整的IMS RECISTER请求，其中隐去了一些消息头和参数。它只包含了为解释本节中的过程而必需的信息，后续的消息也是这样。
     2. 该请求消息的最终目的地是注册服务器，在请求URI中标志为sip: home1. fr（从ISIM中读出的Tobias 的归属网络的域名)。
     3. 在To消息头中有要注册的公共用户身份sip: tobias@ home1. fr，是从ISIM中读出。SIP注册的目的是告诉注册服务器:公共用户身份sip: tobias@home1.fr是可以通过Contact消息头中所指出的P地址访问到的。该IP地址包含一个IPv6前缀，这是UE在建立专用信令PDP上下文时分配的
     4. 在Contact消息头中，UE还指出这个IP地址和SIP URI 之间的绑定可以持续600000s(大约一星期)。在 IMS中强制要求UE注册如此长的时间，然而网络可以调整这个时间。
        1. 在注册过程中，在 REGISTER请求的200 ( OK)响应消息Contact消息头中，将超时时间设置为一个小些的值。
        2. 在用户注册之后，使用状态注册事件通知（例如网络发起的重新认证部分)。
     5. UE的IP地址还包含端口号（“:1357”)
     6. Contact消息头还包含字符串“Mobile Phone-Tobias”作为显示名称。该名称不是必需的，但会对某些高级服务场景有用，例如将呼叫从一个设备转移到另一个设备。
     7. UE还将它的I地址放到请求消息的 Via消息头中，这就可以保证所有对该请求的响应都可以路由回UE。Via消息头中还包含一个 Branch参数用于惟一标识该事务( Transaction)。路由上的每个实体都将加人它自己的 Via消息头。
     8. UE还将它的IP地址放到请求消息的Via消息头中，这就可以保证所有对该请求的响应都可以路由回UE。Via消息头中还包含一个Branch参数用于惟一标识该事务( Transaction)。路由上的每个实体都将加入它自己的 Via消息头。
     9. 解析得到的P-CSCF地址也放到Route消息头中。P-CSCF是该RECISTER消息的下一跳，因此它是Route消息头最顶部也是惟一的一个条目。“; lr”参数表示该P-CSCF是一个宽松路由器，即它支持如RFC3261中描述的SIP路由机制。早期的SIP版本使用所谓的直接路由机制，这种机制在IMS中并未使用。
     10. From消息头标识了正在进行注册的那个用户。可以看出在From消息头与To消息头中的公共用户身份是一样的，这是因为Tobias进行的是所谓的第一方(First-party)注册（即他在注册他自己)。
     11. 还有Call-ID消息头，它和CSeq消息头一起标识这个RECISTER事务(Transac-tion)。
     12. 最后，由于Content-Length消息头中的内容为0，因此表示该RECISTER请求的正文部分是空的。
     13. 消息头的名字都是以长格式给出的。为了避免空中接口传送不必要的过长的信令，Tobias的UE可以使用压缩格式，这时该RECISTER请求是这样的:
         - ![[image-20230406145526428.png]]

##### 从UE到P-CSCF

1. 现在Tobias 的UE可以发出该REGISTER请求了，其下一跳为Route消息头的最顶部的条目（即 P-CSCF)。该请求通过UDP发送，因为UE 从 DNS NAPTR响应中选择了“E2U + sip”服务)。为了到达 P-CSCF，UE在下层消息中放入了如下信息:
   1. UDP端口设置成5060，在DNS SRV响应中，用它来标识pcscf1. visited1. fi;
   2. IP地址设置成5555:: 67:87:59:32，它是从 DNS AAAA 响应中的 pcscf1. visited1.fi解析得来的。

##### 从P-CSCF到I-CSCF

1. 当接收到初始的REGISTER请求时，P-CSCF首次获知Tobias的UE正在使用它作为SIP的出站代理。由于此时Tobias还没有通过认证，P-CSCF还只能承担SIP出站代理的功能，因此它将尝试把REGISTER请求转发到下一跳。
2. P-CSCF 从 Route消息头中移去它自己的条目，这样Route消息头就空了。现在所留下的惟一-路由信息是请求URI中的注册服务器地址，该地址指向Tobias 的归属网络。为了找到归属网络中SIP代理的地址，P-CSCF需要通过DNS进行域名解析（域名在请求URI中给出)。通过使用DNS NAPTR、SRV和AAAA查询，P-CSCF可以解析出Tobias归属网络中某个I-CSCF的地址。
3. 然而，P-CSCF并不把I-CSCF的地址放在 Route消息头中，因为它不能确定该I-CSCF是否可以承担宽松路由器( Loose Router)的功能。因此，P-CSCF将I-CSCF的地址放在传送SIP请求的UDP分组中，直接作为UDP的目的地址。
   - 宽松路由器是相对于严格路由器而言。后者要求发往它的SIP请求的请求URI必须是它的地址，而前者则不要求这一点。
4. 在发送 REGISTER消息之前，P-CSCF还将自己加入到Via消息头中，以便可以接收到对该请求的响应。它还在Via消息头中增加一个分支(Branch）参数。

##### 从I-CSCF到S-CSCF

1. I-CSCF是到达Tobias归属网络的入口，它将收到Tobias 的UE所发起的每一个RECISTER请求。由于I-CSCF并不知道用户配置到特定S-CSCF的分配情况，它需要找出它应该将RECISTER请求转发给哪个S-CSCF。因此，它需要查询HSS。在本例中，我们假设网络中只有一个HSS，所以I-CSCF不需要首先查询SLF。
2. 为了得到S-CSCF地址，I-CSCF通过Cx 接口执行User Registration Status Query(主用注册状态查询)的过程。
3. I-CSCF向 HSS 发出一个 Diameter UAR(用户授权请求)，其中包含以下信息:
   1. “R”命令标志设置成“1”，表明这是一个Diameter请求;
   2. Commond-Code设置成“300”，表明是一条Diameter“User Authorization”命令;.“Visited-Network-Identifier”AVP (600)，表明此时包含在接收到的SIP REGIS-TER请求中的 P-Visited-Network 消息头的值是“Kaunis MustaKissa”;
   3. 可选的“User-Authorization-Type”AVP ( 623)。这个AVP表明了接收到的RECISTER请求的目的。如果Contact消息头中包含的终止时间是0，那么必须要有一个重新注册的过程。在初始注册过程，该值被设置成600000s，因此AVP设置成“REGISTRATION”(O)，这是一个默认值,此时也可以忽略该AVP。
   4. “User-Name”AVP ( 1）设置成Tobias 的私有身份，该私有身份包含在SIPREGISTER请求中Authorization消息头的用户名字段中，即设置为“tobias_private@home1. fr”;
   5. “Origin-host”AVP (264）设置查询I-CSCF的地址，即“icscf1. home1. fr”;.“Origin-Realm”AVP (296）设置成I-CSCF所在的运营商网络的域名，即“home1. fr”;
   6. “Destination-Realm”AVP(283）设置成HSS的归属域，即“home1. fr”，因为这是查询用户位置信息的域;
   7. “Destomation-Host”AVP (293）设置成HSS的地址，这个地址已经在S-CSCF中本地配置,而不需要执行SLF查询。
      接收到UAR之后，HSS首先检查是否允许I-CSCF (“Origin-Host”AVP中所标识）查询Tobias 的认证状态，在本例中当然是允许的。HSS接着检测到当前没有S-CSCF被分配给Tobias，因此将关于选择哪一个S-CSCF给Tobias的决定权留给I-CSCF。它返回一条 Diameter位置信息应答(LIA)消息，其中包含以下内容:
      1. “R”命令标志设置成“0”，表明这是一个Diameter回复;
      2. Commond-Code设置成“300”，表明这是一条Diameter“User Authorization"命令;
      3. “Result-Code”AVP (268）设置成“DIAMETER_SUCCESS”(2001 )，表明查询成功;
      4. “Server-Capabitities”AVP (603）包含一系列Mandatory-Capability AVP (604)以及Optional-Capability AVP (605)，这些能力用整数来表示，其含义是运营商网络特定的。运营商需要确保I-CSCF能理解所有列出来的必选和可选能力，因为I-CSCF将要基于这个列表来选择一个S-CSCF用于后续注册。基于所接收到的必选和可选能力列表，I-CSCF为Tobias选择一个S-CSCF。在这种情况下，S-CSCF的地址为sip:scscf1. home1. fr. lr。
4. I-CSCF 在把自己的条目放在Via消息头的顶部，然后把该REGISTER请求发往S-CSCF。s-CSCF的地址要么是I-CSCF 从 HSS中查询得到的，要么是I-CSCF自己选择的。
   - ![[image-20230406154630001.png]]

##### 在S-CSCF处注册

1. 接到初始的REGISTER请求之后，S-CSCF要求Tobias进行认证。这将导致Tobias发来另一个 RECISTER请求。第二个RECISTER请求包含相同的有关注册的信息，并且它所经过的路由也与初始REGISTER请求完全相同。但是，第二个RECISTER请求将产生一个新的Call-ID。因此，它将包含新的CSeq号码、Branch参数和一个新的From标签。S-CSCF接到的第二个REGISTER 消息如下:
   - ![[image-20230406155003970.png]]
2. 假设认证过程成功，S-CSCF将对Tobias进行注册。这意味着S-CSCF将创建一个绑定关系，绑定REGISTER请求To消息头中的公共用户身份( sip: tobias@home1. fr)和Contact地址（ sip: [5555:: a: b: c: d])。这个绑定将严格的存在600000s，即UE在Contact消息头“expires”参数中填写的值，除非S-CSCF基于本地策略而决定缩短该时间。
3. s-CSCF还会更新HSS中的数据，指示Tobias现在已经注册。HSS会通过Cx 接口向S-CSCF下载Tobias 的用户数据。所以S-CSCF通过Cx接口给HSS发送一条Diameter服务器分配请求(SAR)消息，执行Diameter S-CSCF Registration Noti-fication过程,其中包含以下内容:
   1. .“R”命令标志设置成“1”，表明这是一个 Diameter请求;
   2. Commond-Code设置成“301”，表明是一条Diameter“Server Assignment”命令;“Pubic-Identity”AVP (600)，表明所注册的公共用户身份，即包含在REGIS-TER请求中TO消息头的URI“sip: Tobias@ home1. fr”;
   3. “Server-Name”AVP (602）设置成执行SAR的S-CSCF的 SIP URI，即“sip;scscfl. home1. fr”;
   4. “User-Name”AVP ( 1）设置成Tobias 的私有身份，该私有身份包含在SIPREGISTER请求中Authorization消息头的用户名字段中，即设置为“tobias_private@home1. fr”;
   5. “Server-Assignment-Type”AVP (614)设置为“RECISTRATION” (1)，因为这是一个初始注册。Server-Assignment-Type AVP 的其他值可以是例如“RE-REGIS-TRATION”(2)(此时Tobias 的手机发送出另一个RECISTER请求，以保持注册仍处于active状态），或者是“USEr-DERECISTRATION”(5)(此时，Tobi-as 发送另一个过期时间设置为“O”的REGISTER请求);
   6. “UserData-Already-Available”AVP (624）设置成“USER_DATA_NOT_AVAIL-ABLE”(O)，表明S-CSCF本地没有可用的Tobias的服务信息;
   7. “Origin-host”AVP (264）设置S-CSCF的地址，即“scscf1. home1. fr”;
   8. “Origin-Realm”AVP (296）设置成I-CSCF所在的运营商网络的域名，即“Home1.fr”;
   9. “Destination-Realm”AVP (283）设置成HSS的归属域，即“home1.fr”，因为这是查询用户位置信息的域;
   10. “Destination-Host”AVP (293）设置成HSS 的地址，这个地址已经在S-CSCF中本地配置,而不需要执行SLF查询。
       HSS把S-CSCF名称分配给Tobias公共用户身份的注册集合。这就意味着，只要Tobias 保持与S-CSCF 的注册，每个发送给HSS的有关询问如何进一步路由到Tobias的位置查询，HSS将用S-CSCF的地址进行应答。
       HSS还将Tobias 的用户配置信息 ( user profile）设置成为“registered”，这有可能引发向相关的应用服务器（AS）发送 Sh-Notification消息。
       HSS给S-CSCF返回一条Diameter服务器分配应答（ SAA)，其中包含以下内容:
       1. “R”命令标志设置成“0”，表明这是一个 Diameter应答;
       2. Commond-Code设置成“301”，表明这是一条Diameter“Server Assignment "命令;
       3. “User-Name”AVP (1）设置成Tobias的私有身份，即设置为Tobias_private@home1. fr ;
       4. “Result-Code”AVP (268）设置成“DIAMETER_SUCCESS”(2001)，表明请求已成功;
       5. “User-Data”AVP (606)，包含了Tobias的用户配置信息;
       6. “Charging-Information”AVP(618)，在如下AVP中包含计费功能的地址:
          1. “Primary-Event-Charging-Function-Name”AVP (619)，包含主在线计费功能(OCF）的地址“5555::f66: e77: d88: c77”，该地址将会在 P-Char-ging-Function-Address 消息头中出现;
          2. “Secondary-Event-Charging-Function-Name”AVP (620)，包含次在线计费功能的地址，secondary OCF存储在S-CSCF中;
          3. “Primary-Charging-Collection-Function-Name”AVP (621）包含主计费数据功能(CDF，见3.11节）地址“5555:: a55: b44:c33:d22”，该地址将会在P-Charging-Function-Address消息头中出现;
          4. “Secondary-Charging-Collection-Function-Name”AVP (622）包含次计费数据功能的地址，secondary OCF存储在S-CSCF中;
          5. 可选择的“Associated-Identity”AVP (632)，包含属于同一个用户的相关私有身份（注意:不是公共身份)，在本例中是Tobias。Tobias可能有多个电话，每一个都配置USIM/ISIM，他可能还有HTTP Digest用户名（私有身份）和密码，在这种情况下，私有身份列表会被发送给S-CSCF。
   11. 可选择的“Associated-ldentity”AVP (632)，包含属于同一个用户的相关私有身份（注意:不是公共身份)，在本例中是Tobias。Tobias可能有多个电话，每一个都配置USIM/ISIM，他可能还有HTTP Digest用户名（私有身份）和密码，在这种情况下，私有身份列表会被发送给S-CSCF。

##### 200( OK)响应

- ![[image-20230406160023613.png]]
  - ![[image-20230406161042554.png]]
  - s-CSCF在To消息头中增加了一个tag标签。
  - 这个响应被路由回UE时途经所有接收过RECISTER请求的 CSCF，之所以可以这样是由于各CSCF 在接收REGISTER请求时都把自己的地址放在了Via消息头的顶端。现在，当接收到200 ( OK)响应时，它们所作的就是从Via列表中移除自己的条目，并将请求转发到当前Via消息头中最顶端的地址。
  - 当收到响应后，UE就得知注册过程已经成功了。

##### Service-Route消息头

- 在注册过程中UE和P-CSCF都不知道S-CSCF的地址，因此必须联系I-CSCF以便从 HSS获得S-CSCF的地址。
- 为了避免UE发起每个初始消息时都要将I-CSCF作为额外的一跳，S-CSCF需要在反馈给RECISTER请求的200 (OK)响应中的Service-Route消息头中填入它的地址
  - ![[image-20230406160908378.png]]
  - ![[image-20230406161224799.png]]
    - 本例中S-CSCF在其Service-Route条目中增加了一个用户部分(“orig")，因为它需要区分两类不同的请求:
      - 从服务对象用户（例如Tobias)发起的请求;
      - 发往Tobias UE的请求。
    - 任何时候当S-CSCF收到一个初始请求（例如INVITE请求）时，它需要判断该请求是来自用户还是发往服务对象的用户。利用Route消息头中的用户部分，S-CSCF能容易地知道所收到的请求是否是由服务对象用户发起的，因为Tobias 的UE会在发出的所有请求中的Route 条目中填入S-CSCF的 Service-Route 条目。
  - 当接收到200 (OK）响应时，UE将保存Service-Route消息头中所有的条目。这样无论何时当UE发出任何REGISTER 以外的初始请求时，它将:
    - ![[image-20230406161256380.png]]
      - 把Service-Route消息头中得到的地址填写在初始请求的 Route消息头中;
      - 把P-CSCF地址放在初始请求Route消息头的最顶端。

##### Path消息头

- S-CSCF将接到所有发往Tobias 的初始请求，因为它充当了他的注册服务器。在正常的SIP过程中，注册服务器能够直接向UE发送请求。但在IMS中，这是不可能的，因为需要首先联系P-CSCF。这是因为P-CSCF已经和UE建立IPsec SA安全联盟，保证所有收发的消息都得到完整性保护。不仅如此，P-CSCF还在媒体授权上扮演重要角色，因为它是IMS中惟一与GGSN有直接连接的网元。
- S-CSCF需要确保发往UE的每个请求都要首先经过P-CSCF。为了达到这个目的，P-CSCF 在所有RECISTER请求中添加Path消息头，填入自己的地址。
  - ![[image-20230406164154890.png]]
    - 当用户成功注册后，S-CSCF保存下这个P-CSCF地址。任何时候当接收到发往Tobias 的请求时，S-CSCF就添加一个Route消息头，填入从Path消息头中得到的地址。

##### 向应用服务器的第三方注册

- 在成功注册后，S-CSCF 要检查所下载的该用户的过滤规则。我们假设有一个在线状态服务器为Tobias提供服务，该在线状态服务器需要知道Tobias 现在已经注册并且因而是可达的。为了将此信息通知给该在线状态服务器，需要设置过滤规则，触发所有由Tobias 公共用户身份发起的RECISTER请求。
  - ![[image-20230406164501126.png]]



- 由于这些过滤规则，无论何时Tobias成功地实施了注册，S-CSCF就要生成一个第三方REGISTER请求并发往在线状态服务器。
  - ![[image-20230406165227144.png]]
  - ![[image-20230406165423618.png]]
    - 这个RECISTER请求发往在线状态服务器presence. home1. fr，如请求URI 所示。由于没有包含Route消息头，因此该请求将直接发往这个地址。
    - To消息头中包含Tobias的公共用户身份，这是被注册了的URI。
    - s-CSCF在From消息头中给出自己的地址，它代表Tobias (即作为第三方）来注册Tobias 的公共用户身份。此外，S-CSCF还在Contact消息头中给出了自己的地址，这保证了在线状态服务器永远不会直接路由到Tobias 的 UE，而总是会先与S-CSCF联络。
- 在线状态服务器将为这个REGISTER请求向S-CSCF发回一个200 ( OK)响应，但并不会充当Tobias 的注册服务器。它会认为这个REGISTER 请求意味着Tobias已经在S-CSCF上成功地注册，而这个S-CSCF才是Tobias的注册服务器。如果在线状态服务器需要关于Tobias注册状态的更多信息（例如Tobias隐含注册的所有其他公共用户身份)，它可以采取与UE和P-CSCF相同的方式，以订阅Tobias 的注册状态信息。

##### 用户配置信息更新

1. s-CSCF 从 HSS下载的用户配置信息，可以在任何时间被Tobias所在网络的运营商修改，包括在Tobias进行注册期间。如果进行了修改，HSS会执行Diameter User Profile Update过程，通过Cx接口通知S-CSCF。HSS给s-CSCF发送一条Diameter推送配置请求（PPR)，其中包含如下信息:
   1. “R”命令标志设置成“1”，表明这是一个Diameter请求;
   2. Command-Code设置成“305”，表明是一条Diameter“Server Assignment”命令;
   3. “User-Name”、“User-Data”和“Charging-Information”AVP与服务器分配应答( SAA)消息中的定义一样;
   4. “Origin-Host”和“Origin-Realm”AVP设置HSS的地址和域名（ homel. fr);“Destination-host”和“Destination-Realm”AVP分别是S-CSCF的地址( scscf1.home1. fr)和域名( home1. fr)。
2. S-CSCF相应地更新Tobias的用户配置信息，并发回一条Diameter推送配置应答( PPM)消息。其中，PPM仅包含“Result-Code”AVP ( 268)，并将其设置成“DI-AMETER_SUCCESS”(2001 )，以表明请求成功。新的用户配置信息将会在S-CSCF中立刻启用，用于所有由Tobias新发起或最新到达Tobias的、单独的SIP事务和对话。对于那些已经存在的事务和对话,用户配置信息不能被更改。

#### 认证

![[image-20230406175018447.png]]

##### 概述

1. ![[image-20230406170313208.png]]

   - IMS中有几组安全关系。其中两个会影响SIP信令:用户与网络间的认证，UE与P-CSCF间的SA安全联盟。IMS中的认证和SA建立过程都与SIP注册过程直接结合在一起。
   - 假设3GPP AKA用于用户的认证。介绍一个关于CIBA( GPRS-IMS-bundled authentication，GPRS-IMS绑定认证)的例子。

2. IMS认证基于一个共享密钥和一个序列号( SQN)，它们仅在 HSS和Tobias手机UICC（统一集成芯片)的ISIM应用处可见。由于 HSS从不直接和UE通信，因此由s-CSCF执行认证过程以及S-CSCF需要的所有安全性相关的参数。在注册过程中，S-CSCF 从 HSS处下载所谓的认证向量(AV)。

3. 为了进行认证，Tobias 在初始的REGISTER请求中发送他的私有用户身份（在我们的例子中是tobias_private@homel. fr)。该私有用户身份保存在ISIM应用中，只用于认证和注册过程。

4. 当收到REGISTER请求时，S-CSCF 从 HSS 中下载AV。该AV本身并不包含共享密钥和 SQN,而是包括（此外还有其他参数):

   1. ·一个随机挑战（RAND) ;
   2. 所期望的结果（XRES) ;
   3. 网络认证令牌（ AUTN) ;
   4. 完整性密钥(IK);Integrity-Key
   5. 加密密钥（CK)。Confidentiality-Key

5. 这些参数使得S-CSCF不需要知道共享密钥和SQN就可以执行认证过程。为了进行认证，S-CSCF用一个401（未授权）响应来拒绝用户发出的初始 REGISTER请求，响应中包括RAND、AUTN、IK和CK（此外还有其他参数)。当接收到401（未授权）响应后，P-CSCF去掉其中的IK和CK，然后才发往UE。IK是随后在 P-CSCF和UE之间建立的SA的基础。

   - ```
     WWW-Authenticate: Digest realm="one.att.net",algorithm=AKAv1-MD5,qop="auth",nonce="VVVVVVVVVVVVVVVVVVVVVVZRUFNSXYAAVVRXVlFQ01I=",opaque="5ccc069c403ebaf9f0171e9517f40e415ccc069c403ebaf9f0171e9517f40e415ccc069c403ebaf9f0171e9517f40e41"
     ```

6. 在接收到响应后，UE将收到的参数传给ISIM应用，后者:

   1. 基于共享密钥和SQN来校验AUTN。若AUTN校验成功，网络就通过认证了(即UE可以确认认证数据是从归属运营商网络中发来的);
   2. 基于共享密钥和收到的RAND来计算结果（RES) ;
   3. 计算IK，P-CSCF和UE将共享该IK，作为SA的基础。

7. 然后，UE在第二个REGISTER请求中把认证挑战响应（RES）反馈给S-CSCF,s-CSCF将其与来自HSS的AV中的XRES相比较。如果校验成功，S-CSCF 就认为用户通过了认证，并继续执行SIP注册过程。

8. 任何时候当UE再发出另一个 REGISTER请求时（即由于重注册或注册解除)，它总是包含与第二个RECISTER请求相同的认证参数，直到S-CSCF重新认证UE。

##### HTTP摘要和3GPP AKA

1. [ RFC2617]定义了超文本传输协议（HTTP)摘要，[ RFC3261 ]中介绍了如何在SIP中使用它。另一方面，IMS是第三代伙伴计划/通用移动通信系统( 3GPP/UMTS)体系的一部分，它使用3GPP认证和密钥协商(AKA)机制来进行认证。
2. 为了在IMS中实现基于3GPP AKA 的认证，[ RFC3310]定义了3GPP AKA 参数(如上文所述）如何映射到HTTP摘要认证中。因此，用于承载3GPP AKA信息的信令元素（SIP消息头和参数）与用于承载HTTP摘要所使用的信令元素是完全一样。但是，它们的含义（即它们在UE、P-CSCF和S-CSCF处的解释)却不同。
3. 为了将3GPP AKA认证机制与其他的 HTTP摘要机制（例如MD5）区别出来，它被授予了一个新的算法值:“AKAv1-MD5”。

##### 初始REGISTER请求中的认证信息

1. 在初始REGISTER请求中，Tobias 的UE使用HTTP摘要的Authorization消息头来传输Tobias的私有用户身份。为了满足HTTP摘要的要求，UE在 Authorization消息头中包含以下字段:
   - ![[image-20230406172754064.png]]
   - 认证模式——由于3GPP AKA被映射到HTTP摘要机制，因此该值设置为“Di-gest”;
   - 用户名字段——其值设置为Tobias的私有用户身份，它将被S-CSCF 和 HSS用于识别用户并找到相应的AV;
   - 域和URI字段——其值设置为Tobias的归属域;
   - 响应和 nonce域——其值设为空。该字段在 HTTP摘要中是必需的，但不用于初始REGISTER请求中。
2. 由于在UE和P-CSCF相互之间没有建立任何类型的SIP信令级相互安全机制，P-CSCF 不能保证RECISTER请求真的是Tobias 发出的。例如，一个恶意用户可能伪造这个请求并把它发给P-CSCF，而P-CSCF并不了解真相。因此，P-CSCF在 Authoriza-tion消息头中增加integrity-protected字段并将值设为“no”，然后再将请求发往Tobias的归属网络。
   - ![[image-20230406172853294.png]]



##### S-CSCF从 HSS下载认证向量

- 收到REGISTER请求后，S-CSCF通过Cx 接口发送 Diameter 多媒体认证请求(MAR)）消息给HSS，执行Diameter认证过程，从而实现从HSS下载认证向量(AV)。


##### S-CSCF挑战UE

- ![[image-20230406173350507.png]]

- 基于AV中的数据，S-CSCF通过401（未授权）响应返回WWW-Authenticate消息头并将其字段填写如下:

  - 在nonce字段填入 RAND和AUTN参数，都是32B长度并采用Base64 编码( nonce字段还可能包含其他的服务器专用数据)。
  - 在算法字段填入“AKAv1-MD5”，表示3GPP AKA机制。
  - 在IK和CK扩展字段中填入完整性密钥和加密密钥，就像在MAA消息中的Confi-dentiality-Key 和 Integrity-Key AVP呈现的那样。注意〔RFC3261]对wWW-Authenticate消息头的原始定义中并不包含这两个字段。这两个字段在[3CPP TS 24.229]中定义。

- 在接收到401（未授权）响应后，P-CSCF必须从 WWW-Authenticate消息头中去除ik和ck并将其存储起来，然后再将响应发往UE:

  - ![[image-20230406173937580.png]]

  - ```
    WWW-Authenticate: Digest realm="one.att.net",algorithm=AKAv1-MD5,qop="auth",nonce="VVVVVVVVVVVVVVVVVVVVVVZRUFNSXYAAVVRXVlFQ01I=",opaque="5ccc069c403ebaf9f0171e9517f40e415ccc069c403ebaf9f0171e9517f40e415ccc069c403ebaf9f0171e9517f40e41"
    ```

    - opaque：一个服务器指定的带引号的字符串，应在 [`Authorization`](https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Authorization) 中原封不动的返回。这对客户端是不透明的。建议服务器包含 Base64 或十六进制数据。
    - qop：带引号的字符串，表示服务器支持的保护程度。这必须提供，并且必须忽略无法识别的选项。
      - `"auth"`：身份验证
      - `"auth-int"`：有完整保护的身份验证

##### UE对挑战的响应

1. 根据收到的AUTN参数，Tobias UE的ISIM应用确定该401（未授权）响应确实是Tobias 的归属运营商网络所发送的。它还可以从AUTN 参数中推导出:HSS和 ISIM之间的SQN(序列号)仍处于同步状态。
2. 根据所收到的参数和共享密钥，ISIM 能够生成响应消息所需要的数值，并将其交给UE。UE在第二个REGISTER请求中加上Authorization消息头，包含以下字段（之外还有其他参数):
   1. 用户名字段——该字段中包含Tobias的私有用户身份。
   2. nonce字段——该字段原样返回401（未授权）响应中 WWW-Authentication消息头中的同名字段的值。
   3. 响应字段——该字段包含认证挑战结果 RES，它是ISIM根据接收到的 RAND和共享密钥而计算生成的。
3. ISIM还会计算K，P-CSCF也知道该值。根据这个密钥（以及其他信息)，UE和P-CSCF建立IPsec SA安全联盟，在此基础上UE发送第二个RECISTER请求:
   - ![[image-20230406174732347.png]]

##### 完整性保护和成功认证

1. 在P-CSCF能够检验出所收到的RECISTER请求在从UE到P-CSCF的路上是否被篡改过，因为它现在能够检查其完整性。如果检验成功，P-CSCF在Authentication消息头的“integrity-protected”字段内写入“yes”，并将RECISTER请求发往Tobias 的归属网络。
   - ![[image-20230406174916413.png]]
2. S-CSCF将比较所接收到的RES 和AV中的 XRES（包含在从HSS接收到的MAA消息的SIP-Authorization AVP中)。如果两个参数是完全相同的，则S-CSCF就成功地认证了用户。只有完成这一步之后，它才会继续进行正常的SIP注册过程。

#### 接入安全性 一 IPsec SA

- ![[image-20230406175330652.png]]


##### 概述

- Gm接口的安全性是基于IPsec SA 实现的，它要求在SIP信令级完成特定的处理。本节描述UE和P-CSCF如何协商安全性机制，如何交换IPsec有关的参数，以及SA 如何建立和处理。
- 由于IPsec SA的建立是基于用户认证的基础上，因此每次重认证过程中都要建立新的SA，所以在UE和 P-CSCF之间就必须建立新的IPsec SA 对。

##### 初始注册过程中建立SA

1. 初始RECISTER请求以及401（未授权）响应在UE和P-CSCF之间传递时，没有受到任何保护措施。这两个消息传递了必要的信息，使得UE和P-CSCF之间可以协商安全机制，并对SA 要使用的参数和端口达成一致。
2. 在注册过程中，UE和P-CSCF之间建立了两对IPsec SA。如不特别说明，将这两对SA 安全联盟称为“一组SA”，而将这四个中的单个的或特定的IPsec SA安全联盟称为一个“SA”。
3. 这四个IPsec SA 并不是静态的连接（例如TCP连接)，它们可以看作UE和P-CSCF之间的逻辑联合，使SIP消息得以安全交换。
4. 一组SA使用四个端口;
   - 受保护的UE客户端端口(uc1 ) ;
   - 受保护的UE服务器端口( us1 ) ;
   - 受保护的P-CSCF客户端端口 ( pc1 ) ;
   - 受保护的P-CSCF 服务器端口( ps1 )。
5. ![[image-20230407095711912.png]]
   1. 在初始注册中，UE和P-CSCF使用SIP安全机制协议的Security-Client、Security-Server和Security-Verify等消息头，来协商这些端口。
   2. 这组SA的建立需要使用共享的密钥。然而，P-CSCF对Tobias ISIM应用与归属网络HSS之间共享的安全参数一无所知。因此，S-CSCF在401（未授权)响应中使用wWW-Authenticate消息头将IK和CK发给P-CSCF。P-CSCF必须将这两个密钥从消息头中去掉并保存在本地，然后才能将401（(未授权）响应发给UE。之后P-CSCF就使用IK作为这组SA 的共享密钥。Gm接口另一侧的UE就从收到的401（未授权)响应中的挑战来计算IK，并将其作为共享密钥。
   3. 通过Ik，P-CSCF 和UE可以在四个端口之间建立起一组SA，关于这四个端口的信息已经事先在初始REGISTER请求及其响应中进行了交换:
      1. 在uc1和 ps1之间用于UE向P-CSCF发送 SIP请求;
      2. 在us1和 pc1 之间用于P-CSCF向UE发送 SIP响应;
      3. 在us1和 pcl 之间用于P-CSCF向UE发送 SIP请求;
      4. 在uc1 和 ps1之间用于UE向P-CSCF发送 SIP响应。
   4. 一组SA在建立之后被分配一个临时的生命周期。虽然UE将要通过这组临时SA来发送所有后续的请求和响应，但是必须等到UE和S-CSCF之间的认证过程完成之后，这组SA 才能投入使用。这样做是为了确保UE和P-CSCF之间的安全机制是建立在对用户成功认证的基础上。
   5. 在向UE发送200 ( OK）响应时，P-CSCF将更新这组SA 的生命周期，变为注册时的生命周期（即Contact消息头中的超时时间）再加上30s。UE在接收到200 ( OK)响应后也进行同样的操作。
   6. 如果是初始注册（即现在所描述的情况)，P-CSCF和UE双方随后都将立刻开始使用这组SA。这意味着P-CSCF将通过所建立的这组SA来发送所有去往UE的SIP消息。UE也将同样通过所建立的这组SA发出所有SIP消息。

##### 重认证情况下对多组SA的处理

1. 我们已经见到第一组SA是如何在初始注册过程中建立的。由于一组SA的建立是基于S-CSCF 发出的401（未授权）响应中的认证数据，因此每次重认证都会在UE和P-CSCF之间建立一组新的SA。在重认证成功后，UE和P-CSCF之间会维护两组SA
   - ![[image-20230407101241854.png]]
     - 在重注册发生之前已经建立并投入使用的那组SA，现在称为“旧SA组”;
     - 基于重认证而建立一组新的SA，现在称为“新SA组”。
2. 这种情况的复杂之处在于，P-CSCF无法确认Tobias 的UE是否已经收到对第二个REGISTER 请求的200 (OK)响应，因为SIP没有定义对收到响应的确认机制，只有对INVITE请求的响应除外。如果UE没有接收到对第二个RECISTER 的 200 (OK）响应，它就无法使用新SA组。所以，P-CSCF必须等待UE使用新SA组发来新请求，它自己才能开始使用新SA组。这意味着，只要P-CSCF还没有在新SA组上收到UE发来的请求，它就:
   - 在向UE发送请求时使用旧SA 组，即从它的受保护的客户端端口pcl到UE的受保护的服务器端口us1 ;
   - 保持两组SA，直到其中之一或两者全部超时，或者接收到一个来自UE的新请求。
3. 当UE需要发送新请求时，它会使用新SA组，P-CSCF就能确认新SA组已经完全可以投入使用。此外，此时还不能立刻放弃旧SA组，因为有可能UE已经通过它收到或发出了一-个请求，而对端还没有响应。因此，旧SA组还需要再保存64 * Ts ( IMS环境下一般是128s)后才可以丢弃。
   - ![[image-20230407102243610.png]]
4. 还要注意UE不能用新SA组对来自旧SA组的请求（例如一个 MESSAGE请求)发送响应（例如200 ( OK)响应)。由于P-CSCF的 Via消息头或者TCP连接的约束，UE必须使用与请求相同的端口和相同的SA组发送该请求的响应。
5. 任何时候一旦一个临时的SA建立起来，UE就要丢弃所有其他的SA，唯独发送最后一个REGISTER请求所使用的那个SA除外。因此，UE永远不需要同时处理多于两组的SA。

##### SA的生命周期

1. 在一个正在进行的认证过程中，临时SA组的生命周期被限制为4min，这保证可以完成认证过程。在认证成功后，新SA组的生命周期被设置为以下两者之一:
2. 刚结束的注册过程的超时时间加上30s。该注册过程超时时间如对 REGISTER的200 ( OK)响应中Contact消息头 expire参数所示。或者
3. 如果已经存在另一组SA，只要这组SA的生命周期超过刚结束的注册过程的超时时间加30s，则设为该组SA的生命周期。
4. 任何时候一旦重注册成功完成，P-CSCF和UE就要把所有现存SA 的生命周期更新为刚结束的注册过程的超时时间再加30s，只要这个值超过现存SA组已分配的生命周期。
5. 因此，UE和P-CSCF间的SA 的生命周期总是比Tobias向 IMS网络注册的生命周期长30s。
6. 当P-CSCF得知Tobias 不再是注册状态时（例如，收到了包含Tobias注册状态信息的NOTIFY 消息，指示网络发起了注册解除)，P-CSCF将在64 *T, s之后丢弃所有到达该UE的SA。

##### 端口设置和路由

1. 使用SA端口需要特别注意，因为这严重影响P-CSCF 和UE间的路由。Tobias 的UE:
   1. 将从受保护的客户端端口(2468)发出所有请求;
   2. 期望从受保护的服务器端口( 1357)收到所有的响应;
   3. 期望从受保护的服务器端口( 1357)收到所有的请求;
   4. 将从受保护的客户端端口(2468)发出对所收到请求的所有响应。
2. 另一方面，P-CSCF:
   1. 将从受保护的客户端端口(8642)发送所有发往UE的请求;
   2. 期望从受保护的服务器端口(7531)收到所有来自UE的响应;
   3. 期望从受保护的服务器端口(7531)收到所有来自UE的请求;
   4. 将从受保护的客户端端口(8642)发送所有发往UE的响应。
3. 为了确保所有请求都是通过IPsec SA 发出的:
   1. UE将其受保护的服务器端口设置为其地址的一部分:
      1. 在每个请求的Contact消息头中（包括所有的REGISTER请求);
      2. 在每个请求的Via消息头中，不止是首个REGISTER请求。
   2. UE在它发出的每个初始请求的Route消息头中，将P-CSCF 的受保护的服务器端口设为出站代理（即 P-CSCF)地址的一部分。
   3. P-CSCF将其受保护的服务器端口设为其地址的一部分:
      1. 在每个发往UE的初始请求的Record-Route消息头中;
      2. 在每个响应的Record-Route消息头中，这些响应是发往UE，并携带P-CSCF的Record-Route条目(在Record-Route消息头中设置端口号)。

###### 注册过程中的端口设置

1. Tobias的UE使用如下信息来进行初始注册:

   - ![[image-20230407103226855.png]]

     - UE将按照以下端口建立IPsec SA:
       - 将端口2468作为受保护的客户端端口(Security-Client消息头中的port-c参数);
       - 将精口1357作为受保护的服务器端口（Security-Client 消息头中的port-s参数)。
     - UE期望所有呼入请求都被路由到它的受保护的服务器端口（Contact消息头中的port值)。
     - UE将这个初始RECISTER请求发往P-CSCF未受保护的端口5060，因为Route消息头中没有指定端口号。
     - UE将在未受保护的端口5060上等候对该初始RECISTER的所有响应，因为Via消息头中没有指定端口号。

   - ```
     Security-Client: ipsec-3gpp; alg=hmac-md5-96; ealg=des-ede3-cbc; spi-c=2683907603; spi-s=1525066104; port-c=43779; port-s=40925,ipsec-3gpp; alg=hmac-md5-96; ealg=aes-cbc; spi-c=2683907603; spi-s=1525066104; port-c=43779; port-s=40925,ipsec-3gpp; alg=hmac-md5-96; ealg=null; spi-c=2683907603; spi-s=1525066104; port-c=43779; port-s=40925,ipsec-3gpp; alg=hmac-sha-1-96; ealg=des-ede3-cbc; spi-c=2683907603; spi-s=1525066104; port-c=43779; port-s=40925,ipsec-3gpp; alg=hmac-sha-1-96; ealg=aes-cbc; spi-c=2683907603; spi-s=1525066104; port-c=43779; port-s=40925,ipsec-3gpp; alg=hmac-sha-1-96; ealg=null; spi-c=2683907603; spi-s=1525066104; port-c=43779; port-s=40925
     ```

2. 随后UE收到的401(未授权)响应将如下所示:

   - ![[image-20230407103534178.png]]
     - 这意味着P-CSCF将使用以下端口建立IPsec SA:
       - 将端口8642作为受保护的客户端端口(Security-Server消息头中的port-c参数)﹔
       - 将端口 7531作为受保护的服务器端口( Security-Server消息头中的 port-s参数)。

3. 在上述交换之后，UE和P-CSCF之间就建立起临时的SA 组，UE将按保护方式发出第二个RECISTER 请求，如下所示:

   1. ![[image-20230407110219252.png]]
      1. 注意，这个请求仍然包含Security-Client和 Security-Verify消息头，但由于它们对于SA的建立和路由已经不再有什么影响了，因此就没有显示在这个例子中。上述RECISTER请求意味着UE会:
         1. 希望所有呼入初始请求都被路由到它的受保护的服务器端口(Contact消息头中的端口号);
         2. 已经通过临时IPsec SA 发送该REGISTER请求（即发往P-CSCF受保护的服务器端口——Route消息头中的端口号);
         3. 希望对于该RECISTER请求的所有响应都通过临时IPsec SA发送过来（即它的受保护的服务器端口1357——Via消息头中的端口号)。

###### 重认证过程的端口设置

1. 如前所述，每次重认证都会生成一对新的IPsec SA。当根据SIP安全机制协议而为新建SA交换安全参数索引和受保护的端口号时，P-CSCF 和UE仅仅改变它们的受保护的客户端端口:
   1. 对于两组SA，UE都是通过它受保护的服务器端口(us1）接收请求和响应;
   2. 对于两组SA，P-CSCF都是通过它受保护的服务器端口( ps1）接收请求和响应;
   3. 对于新SA组，UE使用一个新的受保护客户端端口(uc2）向P-CSCF 发送请求和响应;
   4. 对于新SA组，P-CSCF使用一个新的受保护客户端端口(pc2)向UE发送请求和响应。
2. 这是由于两组SA不能使用完全相同的端口参数。而且，如果受保护的服务器端口发生改变,将产生重大问题,意味着:
   1. UE将需要进行重认证，因为它已注册的联系方式中包含受保护的服务器端口;
   2. UE将需要对所有已建立的会话发送re-INVITE，因为它发送给对端的联系方式信息中包含受保护的服务器端口;
   3. P-CSCF将在旧的受保护的服务器端口上接收UE对每个已建立对话的所有后续请求（包含UE的所有订阅信息)，因为SIP不可能对已建立的对话变更其路由信息。
      1. 改变受保护的服务器端口将导致SIP路由产生很多问题。因此非常重要的就是，只要用户保持注册状态，就不能对该值进行修改。

###### UDP和TCP两种情况下的端口使用

1. 介绍了如何通过一个或多个SA组对请求和响应进行传送。在所选的例子中，只使用了UDP作为传输协议。然而对于TCP，这些过程稍有不同。
   若通过UDP发送请求时，所有相关的响应都要传送到Via消息头所指示的IP地址和端口号。当通过TCP发送请求时，Via消息头中的信息被覆盖掉，响应被传送回发送该请求的IP地址和端口号。这里需要注意TCP本质上是面向连接的传输协议。通过使用这个规则，可以确保不需要建立额外的TCP连接，来发送对TCP接收的请求的响应。这使得P-CSCF 和UE之间SIP消息的路由行为会根据协议的不同而有所不同。不论使用UDP还是TCP，UE将在其发出的每个请求的Via消息头中设置其受保护的服务器端口(us1)。所有的请求都是从UE的受保护的客户端端口( uc1)发出。
   - ![[image-20230407111738611.png]]
2. 当使用UDP时，对于该请求的响应将发往Via消息头中所指示的UE受保护的服务器端口( us1 )。
3. 当使用TCP时，对于该请求的响应将发往UE受保护客户端端口(uc1 )，请求就是从该端口发出的。对于另一个方向也是同样的（即由P-CSCF 发往UE的请求及其响应)。

#### SIP安全机制协议

- ![[image-20230407140917902.png]]

##### 概述

1. 必要性
   - 3GPP版本5和版本6的IMS采用IPsec作为P-CSCF和UE之间的安全机制。IPsec仅是几种可能的安全机制之一。IMS的设计还允许Gm接口使用其他的安全机制。提供这种开放性往往会导致后向兼容性问题，例如，兼容版本6的UE可能无法理解任何其他的安全机制，但是它应该可以附着到一个更高版本的、已经支持IPsec 以外的其他安全机制的P-CSCF上。
   - 因此，设计了SIP安全机制协议（ Sip-Sec-Agree）以使UE和P-CSCF间可以协商和采用共同的安全机制。在版本8中，还会引入TLS和HTTP Digest。
2. 假设UE支持IPsec 和 HITP摘要，而P-CSCF支持IPsec和传输层安全（TLS)，并优先选择TLS。
3. UE发往P-CSCF的初始REGISTER请求是没有安全保护的。为了建立一个共同的安全机制，Tobias的UE通过初始REGISTER的 Security-Client消息头公布那些它已经支持的机制,该消息头中包含对所支持的机制的列表。
4. P-CSCF在401（未授权)响应中返回Security-Server消息头，包含P-CSCF侧所支持的机制的列表。而且，P-CSCF对每个机制添加一个优先级（q值)。
   基于这些信息，UE和P-CSCF现在都可以得知双方所共同支持的安全机制。如果有超过一个的安全机制，将选择和采用被P-CSCF赋予最高优先级的机制。为了保证这个机制可以立刻建立起来，P-CSCF还会在401（未授权）响应中发送进一步的信息，使UE可以建立起该机制。例如，在一个非IMS环境下，如果所选择的机制是HTTP摘要，可以发送一个Proxy-Authenticate消息头。
5. UE和P-CSCF随后就会建立起安全机制，在本例中是基于IPsec SA。之后两个实体间的所有消息都通过这些SA受保护地进行传递。然而，初始的REGISTER 请求及其响应仍然是得不到保护的，因此该消息就有可能被恶意用户篡改或者在易误码的空中接口上发生错误。
6. UE发出的第二个RECISTER请求会重复所有为认证和注册过程所必需的信息，认证和注册都是在UE与S-CSCF之间进行的。为了确保与SIP安全机制协议有关的信息也没有被改变，UE会:
   1. 在第二个REGISTER中重复初始RECISTER中的Security-Client消息头;
   2. 将来自P-CSCF的401（未授权）响应中Security-Server消息头中的内容复制到Security-Verify消息头中，并在第二个REGISTER中发送出去。
7. 只要建立的安全联盟在使用中，UE就会在每个发往P-CSCF的请求中重复Securi-ty-Verify消息头。
8. 通过交换Security-Client(来自UE)和Security-Server(来自P-CSCF)消息头，双方还可以对IPsec SA的一些参数达成一致，也就是说，它们会相互告知受保护的客户端和服务器端口( port-c和port-s）以及安全参数索引(SPI:spi-c和 spi-s)。

##### 初始REGISTER请求中与SIP安全机制协议有关的消息头

1. 为了激活安全机制协定，UE在初始REGISTER请求中包含如下信息:
   - ![[image-20230407114157470.png]]
     - Proxy-Require消息头中包含了选项标签“sec-agree”，它指示下一跳代理（这里就是P-CSCF)必须支持SIP安全机制协议的过程，以便进一步处理本请求。如果下一跳代理不支持SIP安全机制协议的过程，它会根据〔 RFC3261]定义的对Proxy-Require消息头的处理规定，发回一个420（无效扩展）响应，其中包含一个 Unsupported消息头，其内容是选项标签“sec-agree”。由于本例中的P-CSCF完全兼容IMS版本5和版本6，它当然会支持SIP SA过程而不会向UE发送这样的响应。
     - 此外，还包括一个 Require消息头，指示了“sec-agree”选项标签。[ RFC 3329 ]定义了SIP安全机制协议，强制要求包括该字段。Require消息头与Proxy-Require的用法相同，但它是被远端UE所用（而非代理)。它的存在仅仅是为了防止如下情况:如果请求（本例中是REGISTER请求）直接从源UE发往最终目的地( S-CSCF)，而后者根本不看Proxy-Require消息头，这就意味着不会发生安全机制的协商。Require消息头则可以强制接收方执行sec-agree过程。
     - 由于P-CSCF可以执行SIP安全机制协议过程，它将Require 和 Proxy-Require 中的sec-agree选项标签删除,然后将请求送往Tobias的归属运营商网络。
     - Tobias UE在Security-Client消息头中将所支持的安全机制列表发送给P-CSCF。根据该消息头中的信息，P-CSCF了解到Tobias UE支持两种安全机制:一个是HTIP摘要(“digest”)，另一个是3GPP所使用的IPsec (“IPsec-3gpp")。这两种机制在消息头中使用逗号隔开。后者的参数列表（用“;”隔开)包括:
       1. 算法（ alg参数)——用于IPsec加密和保护，在本例中是 HMAC SHA 1-96算法，在[RFC2404]中定义;
       2. 受保护的客户端端口( port-c）和受保护的服务器端口( port-s)——用于UE侧的IPsec SA;
       3. SPI—IPsec SA中与受保护的客户端端口相关的spi-c，以及 IPsec SA中与受保护的服务器端口相关的spi-s。
     - P-CSCF也会删除Security-Client消息头，然后再进一步转发REGISTER请求。注意在IMS 中，只有IPsec-3gpp安全机制是可用的。此处的例子使用了摘要和TLS，作为SIP-Sec-Agree有关的消息头中可能使用的额外的安全机制。这仅仅是为了解释协商过程隐含的原理。

##### 401(未授权）响应中的Security-Server消息头

- 当接到来自S-CSCF的对于REGISTER请求的401（未授权）响应时，P-CSCF在响应的Secutity-Server消息头中包含了一个所支持的安全机制的列表。
  - ![[image-20230407134353531.png]]
    - 在这个例子中，P-CSCF支持两个安全机制:3GPP特定的IPsec和TLS。它还给予TILS较高的优先级:只要UE也支持TLS，就应该选择它作为UE和P-CSCF之间消息的安全保护。
    - 此外，P-CSCF使用与UE相同的方式，发送关于SPI、受保护的客户端和服务器端口等与IPsec有关的信息。
    - 当向UE发送401（未授权)响应时，P-CSCF已经知道将使用IPsec作为安全机制，因为它了解到这是UE和它自己都能支持的惟一的机制。

##### 第二个REGISTER消息中的SIP安全机制协议消息头

- 在接到401（未授权）响应后，UE就可以建立 IPsec SA了。当这完成之后，它可以使用已经建立起来的SA来发送第二个 REGISTER请求。在这个RECISTER请求中包含以下有关信息:
  - ![[image-20230407135705139.png]]
    - 这里Require和 Proxy-Require消息头又一次包含了选项标签“sec-agree”。它们的作用与初始REGISTER请求一样，并且会重复出现在UE发出的每一个RECISTER请求中。P-CSCF总会先将它们删掉再继续转发该请求，与初始REGISTER请求的处理方式一样。如果在删除sec-agree之后发现Proxy-Require或Require消息头之一(或全部）变成空，则P-CSCF也会将其删除。
    - Security-Verity消息头复制了所收到的Security-Server消息头。Security-Client 的内容就是对初始REGISTER请求的简单重复。
    - P-CSCF将会比较初始和第二个RECISTER请求中的两个 Security-Client消息头，看它们是否匹配。它还会比较两个消息头的内容:一是它所发送的401（未授权）响应中的Security-Server消息头，二是它所收到的第二个REGISTER请求中的Security-Verify 消息头。
    - 在进一步发送这个RECISTER请求之前，P-CSCF将从中删除Security-Client和 Se-curity-Server消息头。

##### SIP安全机制协议与重注册

1. 在每次重注册过程中，S-CSCF都可以决定对UE进行重新认证;通过重新认证,它强制UE和P-CSCF之间建立一组新的IPsec SA，因为IPsec SA所依赖的IK在每次重认证过程中都要改变。建立一组新的SA也就意味着，要协商一组新的SPI、新的受保护的客户端和服务器端口。
2. 当UE发送新的RECISTER请求来重注册时，它还不能确定S-CSCF是否会要求重认证。因而它需要在每个新的REGISTER请求中加人新的Security-Client消息头，其中包含新的SPI值、受保护的客户端和服务器端口。
   1. ![[image-20230407140257496.png]]
      1. 请注意，Security-Client消息头中SPI的值和受保护的客户端端口号已经发生了改变，在S-CSCF要求重认证UE时，这样才能建立一组新的SA。UE的受保护的服务器端口没有变化，在用户的注册状态下始终保持不变。
      2. Security-Verify消息头的内容没有改变，因为它是最后一次收到的Security-Server消息头的复制品。
      3. 在收到S-CSCF发来的对该RECISTER请求的响应时，P-CSCF 和UE就能知道是否需要建立新的 IPsec SA:也就是说，是接到了一个401（未授权）响应还是接到了一个200 ( OK)响应。
      4. 当从S-CSCF收到一个401（未授权）响应时，P-CSCF将会在这个响应中添加一个新的 Security-Server消息头，提供新的受保护端口值和新的SPI。
   2. ![[image-20230407140517473.png]]
   3. 此外，P-CSCF不会改变受保护的服务器端口(7531)。于是，UE和P-CSCF之间就建立了一组新的临时SA.。作为对重认证挑战的响应，REGISTER请求将通过这组新的临时SA发送出去，并包含以下消息头:
      1. ![[image-20230407140652815.png]]
   4. 与初始注册过程一样，第二个RECISTER请求仍然重复了上一个REGISTER请求的Security-Client消息头（但采用新值)，并将刚才收到的401（未授权）响应的Security-Server消息头的值复制到Security-Verify消息头中。重注册过程的第二个 RECISTER请求，将不再承载与以前建立的SA组有关的任何信息。
      - ![[image-20230407140812760.png]]

#### IMS通信服务标识和其他被叫方能力

- ![[image-20230407143212143.png]]

##### 概述

1. IMS 允许一个用户同时有多个终端在工作，这些终端都使用用户相同的公共用户身份( SIP AOR)。每个终端可能支持特定的能力，其中有些终端会限制只能给用户提供某些服务。例如，移动电话可以在进行SIP会话的同时，发送和接收视频流，而固定电话则可能不支持此项功能，并且也不能用于移动场景。
2. 我们假设Tobias 既通过移动电话也通过固定电话进行了注册，那么他向IMS 网络指明这些电话特定能力会很有用，这样到达他的呼叫就可以被路由到与呼叫方偏好最匹配的终端。
3. 我们会介绍Tobias 的电话如何在注册过程中向网络表明自己的能力（被叫方能力)。随后介绍主机方如何表达出自己的偏好，从而将呼叫路由到支持一种或多种特定能力的终端。为了将呼叫路由到那些被叫方终端，终端能力需要首先在网络中进行注册。
4. 被叫方能力和主叫方偏好可以用所谓的特性标签来表示。特性标签被用来选择被呼叫用户的终端,以最大可能地满足呼叫用户的偏好选择。
5. 在IMS中，特性标签被用来表示IMS通信服务标识(ICSI)和IMS应用参考标识(IARI)。

##### 特性标签:被叫方能力

1. 在注册过程中，Tobias的UE向网络表明以下被叫方能力:
   1. UE支持语音流的发送和接收(语音);
   2. UE支持视频流的发送和接收（视频);·
   3. UE是一个移动电话（移动性);
   4. UE支持接收的SIP方法( methods = )。
2. 由于这些特性标签表达的是设备能力，因此它们会被包含在Contact消息头中，即终端所注册的IP地址会将相关的特性标签作为参数。所以，RECISTER消息的Contact消息头如下:
   1. ![[image-20230407141858219.png]]
      1. Contact消息头现在包含了一个很长的参数列表，每个参数彼此用“;”隔开。最开始的三个参数（“;audio ; video ; mobility”)是没有特定数值的特性标签，即它们直接表示了UE的能力。
      2. 而最后一个参数则加上了tag-value-list，即表明UE支持所有被列出的SIP方法。这就意味着，如果一个呼叫要求支持一个或多个上面所列的方法，当这个呼叫到来时,它将会被传递给该UE。

##### IMS通信服务标识和IMS应用参考标识

1. SIP特性标签还可用来表示IMS通信服务标识（ICSI)和 IMS应用参考标识( IARI)。
2. 在 IMS中 ICSI支持两个不同的目的:一个是网络中的服务标识，另一个是将请求路由到支持该服务的终端。当在IMS注册过程中将ICSI指示为一个特性标签时，这是仅用作第二个目的，即它将请求路由到正在进行注册的终端。
3. IARI值仅用于将请求路由到支持相关服务的终端。
4. 在本例中，我们假设Tobias的终端支持三种IMS通信服务和一种特定的IMS应用，即
   1. IMS多媒体电话通信服务( urn: urn-xxx :3gpp-service-Ims. icis. mmtel) ;
   2. 一个在线游戏，假设将它的ICSI值定义为urm: urn-xxx: other-vendor-service-Ims. icsi. ongame;
   3. 一个通过SIP支持设备远程控制的服务，它的ICSI值为urn: urn-xxx: other-vendor-service-Ims. icsi. remotecontrol;
   4. 一个特定的可以对Tobias家乡的消防员进行报警的应用，因为Tobias是一名消防志愿者。假定为这个应用定义的IARI为urn: urn-xxx: other-app-Ims. iari. firefighter。
      - 注意，当这些URN与因特网编号管理委员会（ IANA）进行注册后，其中的“xxx”将被确定的数值替代。
5. 运营商会在IMS MO下发一个ICSI值的列表。Tobias 的电话只会使用如下这些ICSI值，即在IMS MO的列表中出现过，同时其电话支持，而且仅留下IMS多媒体电话和在线游戏的ICSI值。运营商不会限制IARI数值，因此Tobias可以使用上面所列的IARI值。
6. 这些ICSI 和 IARI值被定义为服务URN，会通过以下方式表示出来:
   1. 一个被称为“g.3gpp. icsi_ref”的新的SIP特性标签，它把ICSI数值的列表记为tag-value-list ;
   2. 一个被称为“g. 3gpp. iari_ref”的新的SIP特性标签，它把 IARI数值的列表记为tag-value-list，与“methods”特性标签表示方式相同。
7. 由于将ICSI和 IARI定义为URN了，所以在对Contact消息头编码时会遇到另外一个问题。在[ RFC 3840]中定义的 tag-value-list不支持将冒号(“:”)作为有效字符，因此需要如〔RFC 3986]所定义那样，避开在ICSI和 IARI URN 中的冒号。这就意味着当每次出现冒号字符时，就要用字符串“%3A”来替代。所以现在本例中的Contact消息头表示如下:
   - ![[image-20230407143015030.png]]
     - 为简便起见，后面大多数例子中的Contact消息头都没有包含前两章中所介绍的特性标签。另外需要注意的是，本例给出的ICSI和IARI值中，只有IMS多媒体电话通信服务标识( urmn;urn-xxx :3gpp-service-Ims. icis. mmtel)已进行标准化并投人使用了。上述其他ICSI 和 IARI 值都是为举例而创造的。

#### 压缩协商

- ![[image-20230407172559086.png]]

##### 概述

1. 对于IMS而言，空中接口上对SIP消息进行压缩的能力十分重要。本节介绍UE和P-CSCF如何告知对方它们支持SigComp并且都愿意启用它。
2. P-CSCF 和 IMS UE都必须支持SIP信令压缩( SigComp)，但不是必须启用。因此,它们需要一种机制来表达它们是否愿意使用信令压缩。
3. [ RFC3486]定义了一个新的URI参数“comp”，可以被UE或SIP代理（在IMS中只能是P-CSCF)设置为“comp = SigComp”来表达它们愿意收发某些压缩后的SIP消息。
4. Tobias UE在初始REGISTER请求中就已经向P-CSCF表明它是否愿意启用信令压缩。P-CSCF在401（未授权)响应中给出类似的指示。由于这两个SIP消息都是没有保护的，因此此时UE和P-CSCF都不会为信令压缩创建状态（容器，compartment):这是为了确保防止因恶意用户强制P-CSCF预留海量的不必要的信令压缩容器而导致 P-CSCF过负荷，比如想对P-CSCF发起拒绝服务（DOS）攻击的恶意用户。
5. 只有在UE和 P-CSCF之间建立IPsec SA后，才会创建状态（容器)。

##### 指示是否愿意使用 SigComp

1. "comp”参数可以设置成:
   1. 由UE在RECISTER请求的Contact消息头中设置——这意味着UE愿意接受以自己为目的地、采用压缩形式的初始请求，因为发往UE的初始请求都是根据UE注册的Contact地址来进行路由的。
   2. 由UE在任何其他的初始请求的Contact消息头，或对初始请求的第一个响应中的Contact消息头中设置——这意味着UE愿意接受该对话的所有后续请求都采用压缩形式，因为后续请求是根据初始请求中（从请求发起侧）或初始请求的第一个响应中(从请求终结侧)的 Contact消息头中的地址进行路由的。
   3. 由UE在任何请求的Via消息头中设置——这意味着UE愿意接受对于这个请求的所有响应都采用压缩形式，因为响应是根据相关请求中的Via消息头进行路由的。
   4. 由P-CSCF在发往UE的Record-Route消息头中自己的条目中设置——这意味着P-CSCF愿意接受该对话的后续请求都采用压缩形式，因为发往SIP代理的后续请求是根据Route消息头（由Record-Route消息头产生)中的条目进行路由的。
   5. 由P-CSCF在任何请求的 Via消息头中设置——这意味着P-CSCF愿意接受所有对这个请求的响应都采用压缩形式，因为响应是根据相关请求中 Via消息头进行路由的。

##### 注册过程中的comp = SigComp参数

1. UE发送的初始RECISTER请求中包含以下与压缩有关的信息:
   - ![[image-20230407171728993.png]]
     - Via消息头包含了comp = SigComp参数，指示UE愿意接受对于该请求的所有响应都采用压缩形式。因此，P-CSCF可以按照压缩形式发送401（未授权)响应，但是它不应该由此就创建一个状态（即一个容器)。
     - Contact消息头也出现了comp = SigComp参数。这个参数将包含在UE所接收到的每个初始请求中，因为S-CSCF会将每一个初始请求的请求-URI（指向sip: tobias@home1. fr）替换为已注册的联系地址（即sip:[5555: 1: 2:3:4]:1357; comp =SigComp)。
     - 来自P-CSCF的401（未授权）响应不会包含任何关于P-CSCF执行信令压缩能力的进一步信息。在首次注册之前发现的P-CSCF地址（见10.3节)中不会见到comp = Sig-Comp参数。由于只有在下一跳地址中设置了comp = SigComp参数时，SIP消息才会采用压缩形式，因此UE不会向P-CSCF发送任何压缩格式的初始请求。
2. 后续请求（例如ACK、PRACK、UPDATE和BYE)可以按压缩形式发送，由于从UE到P-CSCF的路由遵循P-CSCF的 Record-Route条目，其中P-CSCF可以设置comp = SigComp参数。从UE到P-CSCF的响应也是同样的，因为它们是根据P-CSCF的Via消息头条目进行路由的，其中 P-CSCF也进行了设置。
3. 虽然要求使用comp参数来指示是否采用了压缩，但3GPP TS 24.229并未明确要求指示初始消息是否采用了压缩格式。这样就存在一种可能性，即UE只要按照压缩形式发送所有初始请求就可以，因为P-CSCF无论如何也要支持SigCompo
4. 于是UE将comp = SigComp参数添加在之前发现的P-CSCF地址中。这样它就可以按压缩形式发送第二个REGISTER请求。
   - ![[image-20230407172301988.png]]



##### 其他请求中的comp =SigComp参数

#### 接入和位置信息

- ![[image-20230407174043297.png]]

##### P-Access-Network-Info

1. P-Access-Network-Info消息头是3GPP特有的消息头，用于向IMS网络指示UE正通过哪种接入技术附着到IMS上。在我们的例子中所使用的接入技术是GPRS。它还包含小区全球ID(CGI)，标志用户所处的位置。
2. Tobias UE在其发送的每个请求（包括ACK和CANCEL 请求）和每个响应（包括对CANCEL请求的响应）中包含P-Access-Network-Info消息头，但必须是当该请求具有完整性保护时（即通过SA发送)。
3. 因此，该消息头首次发送是在第二个REGISTER请求中，在UE收到401（未授权)响应之后。该消息头如下所示:
   - ![[image-20230407173518468.png]]
     - Tobias的 S-CSCF从每个请求或响应中删除P-Access-Network-Info消息头，然后转发给下一个实体。该规则的惟一例外是:当AS 与S-CSCF处于同一个信任域时。
     - 当一个紧急呼叫的 INVITE请求中包含P-Access-Network-Info消息头时，P-CSCF和S-CSCF可以从Cell-ID 中判断出离用户最近的应急中心而进行联络。

##### P-Visited-Network-ID

1. P-Visited-Network-ID消息头向Tobias 的归属网络指示他正在漫游的网络的标志。Tobias UE当前所附着的P-CSCF添加了该消息头。S-CSCF用该消息头中的信息检查与拜访网络间的漫游协议。
2. 假设Tobias正在芬兰漫游，并附着到虚构的芬兰运营商Musta Kissa。由于P-CSCF也是由该运营商提供，它在每个发往Tobias归属网络的REGISTER请求中增加一个P-Visited-Network-ID消息头。该消息头中有一个字符串，用于S-CSCF识别拜访网络。
   - ![[image-20230407174022855.png]]

#### 注册过程中与计费有关的信息

1. 在注册过程中与计费有关的SIP消息头的内容及其处理。
2. 当P-CSCF收到初始REGISTER请求时，它生成IMS计费ID(ICID)，只要用户处于注册状态，该ID对于所有的IMS有关的信令就是有效的。该ICID值通过P-Char-ging-Vector消息头从P-CSCF传送到S-CSCF。
   - ![[image-20230407174315404.png]]
     - 当收到这个消息头后，S-CSCF会保存ICID，并执行计费过程。P-Charging-Vector消息头在[RFC3455]中定义，该消息头的扩展和在IMS中的用法在[ 3GPP TS 24.229] 中描述。

#### 用户身份

- ![[image-20230419165641630.png]]

##### 概述

1. Tobias需要向他的归属网络进行注册才能发起对他姐姐的呼叫。在本例中，目前他使用SIP URI sip: tobias@home1.fr来进行注册。当Tobias使用与工作无关的服务时他使用这个用户身份。然而，Tobias 在其法国的运营商处注册了一整套用户身份
   - ![[image-20230407174734676.png]]
     - 一个注册组可由几个SIP URI和 tel URL组成。对于每个tel URL,在网络中必须要有一个相关SIP URI可用，即 SIP URI用户部分取tel URL的数值。这些tel URL和它们相关的SIP URI都是公共用户身份的别名（Alias ID)，这就意味着它们分享HSS中的相同用户配置信息。
     - 在初始注册过程中，Tobias 只能明确地注册这些URI的其中之一，在我们的例子中就是sip: tobias@ home1. fr。然而，IMS 允许隐性地和明确地注册更多的公共用户身份:
       1. 在初始注册阶段，上面列出的部分身份可以被网络自动（隐性地）注册。
       2. 其他的身份可以保持未注册状态，直到Tobias 明确地请求注册它们。
2. 当接收到对第二个REGISTER请求的200 (OK)响应时，Tobias的终端和P-CSCF都会发现Tobias 的默认公共用户身份，这是就是P-Associated-URI消息头中第一个URI。
   为了发现分配给Tobias 的其他公共用户身份的更多注册状态，UE自动订阅归属网络S-CSCF所提供的注册状态事件信息。在首次注册成功后，要求UE必须立刻执行这个订阅，这是由于:
   1. UE需要了解关联URI的注册状态;
   2. 该订阅使得网络(S-CSCF)能够强制UE进行重认证;
   3. 该订阅使得网络（( S-CSCF)能够解除用户的注册。
3. 与此同时，P-CSCF也订阅了用户注册状态信息，主要是为了获知网络发起注册解除。

##### 注册的公共和私有用户身份

1. 初始RECISTER请求中所携带的身份是从ISIM中读出的，ISIM是UE的UICC卡(通用集成电路)上的应用之一。ISIM中读出的数据包括:
   1. 用户的私有用户身份;
   2. 用于注册的公共用户身份;
   3. 用户的SIP注册服务器的地址。
2. 私有用户身份仅用于认证。公共用户身份就是Tobias 将要首次注册的SIP URI。Tobias可以有其他多个公共用户身份，其中一些甚至可以存储在ISIM中,但是在开始只有一个可以显式注册的。
3. 如果UE中没有配备ISIM，它可以从同样存在于UICC中的USIM应用中得到用户身份和注册服务器地址。USIM应用包含了所有与用户电路交换（CS）域和分组交换（ PS）域的注册和认证有关的数据。
4. 拥有了这些参数，UE可以填写初始RECISTER请求中的如下字段:
   - ![[image-20230407180057140.png]]
     - 从ISIM中读出的公共用户身份，写入To和 From消息头。Authorization消息头中username字段取值为私有用户身份，而注册服务器的地址则放入请求URI中以及Au-thorization消息头的realm和uri字段中。

##### 从USIM派生出的身份

1. 当Tobias注册时，其UE从 UICC上运行的ISIM应用中读出 SIP URI“sip: tobiashome1. fr”，该UICC是从运营商处得到并置于UE中。ISIM总是保存至少一个有效的公共用户身份。
2. 然而，IMS服务也可以提供给UICC卡上没有ISIM应用的用户，于是也就没有有效的公共用户身份。因此，UE需要依据USIM应用内的数据来创建一个临时的公共用户身份，并使用这个临时身份进行注册。
3. 由于临时公共用户身份是依据USIM中与安全相关的数据生成的，因此不允许暴露给IMS 以外的任何网元。因此，它被视为“被隔离的身份（ Barred Identity)”来处理，也就是说，强烈建议网络拒绝除用户注册以外的情况下以任何形式使用这个身份。
4. 在这种情况下，私有用户身份也从USIM 数据中生成。其用户部分遵照IMSI(国际移动用户标识）的形式;继之以一个宿主部分，包括IMSI中的MCC（移动国家代码）和MNC（移动网络代码)。例如，Tobias 的私有用户身份可能类似如下:22330999999999@ims. mnc33. mcc222. 3gppnetwork.org。
5. Tobias 的归属网络的域名也可以从 USIM中得到，看上去类似于用户身份的域名部分，即 ims. mnc33. mcc222.3gppnetwork.org。

##### 默认的公共用户身份/P-Associated-URI消息头

1. 如果Tobias在初始注册中使用了临时公共用户身份，他将遇到这样的问题:虽然已经注册过，但是不能进行任何其他操作（例如，呼叫他的姐姐或者订购服务)，因为他注册中所使用的身份不能再继续使用（被屏蔽的身份)。他的终端需要知道另一个隐性注册的身份。
2. 任何时候一旦用户成功地进行了认证和注册，S-CSCF于是就会对RECISTER 请求发出一个200 ( OK）响应，在该响应中发送P-Associated-URI消息头。该消息头列出了该用户的所有SIP URI和 tel URL （即公共用户身份)，这些都与用户关联，但并非必须注册。消息头中只有第一个列出的URI总是有效的、已注册的公共用户身份，可被UE和 P-CSCF用来实施进一步操作。
3. 对应于Tobias RECISTER请求的200 ( OK）响应中，其中的P-Associated-URI 如下所示：
   1. ![[image-20230417170721944.png]]
      - 通过这些信息，Tobias可以知道至少有一个公共用户身份“sip: tobias @home1. fr”是已经注册的。他还可以得知还可使用其他两个SIP URI和两个tel URL,但他并不知道这些标识现在是否已经注册。
      - 由于P-Associated-URI只定义为传递SIP URI，因此它用SIP URI 的格式来表示所包含的、与Tobias关联的两个tel URL ( tel:+44123456789和tel:+44123456111)。

##### 全球可路由用户代理URI的分配

1. 至此我们已经看到了两种类型的身份标识，它们都是与用户有关，即公共用户身份和私有用户身份。而在有些情况下，不仅是对某个用户，而且对某个设备进行寻址也很重要。一个例子如:一个用户想要把正在进行的固定电话呼叫无缝地转移到某个特定的移动电话上去。虽然也可以用私有身份来标识（至少比如当电话配备有UICC时）该设备，但它不能用于注册上下文以外的地方，否则会泄露安全相关的信息。
2. 为了弥补这个不足，引入了全球可路由用户代理URI ( GRUU)。GRUU允许设备以SIP寻址方式对设备进行标识。
   - 会暴露用户身份的公共 GRUU，即对于分配有CRUU的用户，他的SIP地址很容易从GRUU中得知。例如，sip: tobias@ home1. fr;gr = jklhzzqu7as9asfd;
   - 能隐藏用户身份的临时CRUU，即 CRUU有一个SIP地址，但该地址不会让人知道对应于GRUU用户的SIP地址，例如，sip: 98hzah4pmmn@ home1.net;gro
3. 在注册过程中，IMS终端被强制要求同时申请一个公共CRUU和一个临时GRUU。S-CSCF在没有任何HSS的参与下分配GRUU，而且 GRUU也不会存储在 HSS 中。
4. 为了请求CRUU的分配，Tobias 的电话在它发送的RECISTER请求的Contact消息头中包含一个instance-ld参数，即
   1. ![[image-20230417171336021.png]]
5. 如果注册成功，那么S-CSCF将同时分配公共 GRUU和临时GRUU，并在200(OK)(对 REGISTER请求的响应)的Contact消息头中将它们发回:
   - ![[image-20230417171445777.png]]
     - 如上所述，GRUU与注册状态下的公共用户身份和Contact 地址（即进行注册的设备的地址)都有关联。GRUU总是同时与用户和设备进行绑定。
     - GRUU由SIP URI中的“gr”参数标识。在这里分配的公共CRUU是Tobias的SIPURI，并且将“gr”参数设置为所注册的instance ID。这样，可以很容易地知道CRUU分配给了哪个用户。临时GRUU使用在用户名字符串中，它是由S-CSCF创建的，并且不会显示任何与Tobias或Tobias 的电话之间的关系。为了确保在不将该地址存储在HSS中的情况下仍能对其进行路由，该临时GRUU会在其用户部分显示所分配的S-CSCF的地址（( scscf1. home1. fr)，这就确保I-CSCF 不用从SLF/HSS中解析GRUU（见12.3.3.4节)，因为基于GRUU主机部分的信息，它可以直接转发到分配CRUU的S-CSCF。另外，临时GURR也包含“gr”参数，但这次它是空的，因为用户名中的字符串是全球惟一的，不需要进一步区分。
     - s-CSCF和 Tobias的电话都会存储公共GRUU和临时GRUU。

##### UE订阅注册状态信息

1. ![[image-20230417174349296.png]]
2. 在成功进行初始注册和认证之后，Tobias 的终端发送一个SUBSCRIBE请求，包含如下信息:
   - ![[image-20230417172156620.png]]
     1. 没有显示 SUBSCRIBE请求的所有信息，以上只列出了必需的消息头，以便理解注册状态事件订阅的实质和请求消息的路由。
     2. 该订阅仅针对名为“reg”的事件，就是注册状态事件包，在请求消息的Event消息头中指示。
     3. 请求URI指示了要订阅哪个用户的注册状态信息，因此，需要设置为Tobias已注册的公共用户身份，并在To消息头中明示。
     4. 为了标识他自己，Tobias UE将To和P-Preferred-ldentity消息头设置为据他所知目前已注册的SIP URI。这可以是:
        - 收到的P-Associated-URI消息头中默认公共用户身份。
        - 在初次注册时所显式注册的公共用户身份，只要它不是一个临时的公共用户身份。如果没有使用临时公共用户身份，那么有可能这个显式注册的公共用户身份与默认公共用户身份相同。
     5. 由于SUBSCRIBE是初始请求，因此To消息头中并不包含标签，因此这个标签需要由远端（本例中即 S-CSCF)来指定。
     6. Expires消息头要设置为与初始注册中超时时间相同的值（即 600000s，大约7天)。
     7. Accept消息头指示在本次订阅中，UE只能处理“reginfo + xml”类型的信息，即XML（扩展标记语言)格式的注册状态信息。
     8. Contact消息头设置的联系信息与注册过程中的联系信息相同，即由接人网分配的UE的IP地址和由IPsec SA 使用的受保护的服务器端口。
     9. Route消息头:它包含了REGISTER请求的200 ( OK）响应中Service-Route消息头中的路由集合，其中最顶端的就是P-CSCF的地址，它用作出站代理。这使得SUBSCRIBE请求首先被路由到P-CSCF，而后直接继续转发到注册过程中指派的S-CSCF。
3. P-CSCF接到UE发来的SUBSCRIBE请求后，将检查P-Preferred-Identity消息头中的信息集合是否是Tobias 的有效的公共用户身份。如果是，它将P-Preferred-Identity消息头换成P-Asserted-ldentity消息头。
   - ![[image-20230417174217272.png]]
4. s-CSCF在接收到SUBSCRIBE请求后，会检查P-Asserted-Identity消息头中的用户身份是否已经在S-CSCF上注册。随后，它会检查它是否可以向订阅者用户提供Tobias的注册状态信息。由于本例中Tobias订阅的是他自己的注册状态信息，是允许的。因此，S-CSCF会立即:
   - 对SUBSCRIBE请求返回一个200 ( OK)响应，指示该订阅已经成功;
   - 生成一个reginfo类型的XML文件，包含Tobias 关联的URI的当前注册状态信息;
   - 通过一个NOTIFY消息将所生成的XML文件发送给订阅者（本例中即TobiasUE)。
5. 由于200 ( OK)响应和NOTIFY 请求几乎是同时发送的，NOTIFY 请求有可能在200 ( OK）响应之前到达。在这种异常情况下，UE必须能够根据NOTIFY 请求创建相关的订阅对话，也就是说，不能够由于事先没有收到SUBSCRIBE请求的200 ( OK)响应，而丢弃NOTIFY请求中的信息。

##### P-CSCF订阅注册状态信息

1. ![[image-20230417175708574.png]]
2. P-CSCF也需要订阅Tobias的注册状态信息，因此它也创建一个SUBSCRIBE请求，看上去与终端创建的请求类似。
   - ![[image-20230417175533506.png]]
     - 两者主要的区别在于这次是P-CSCF要订阅Tobias的注册状态信息。因此它要在From消息头和P-Asserted-Identity消息头中标识自己。由于P-CSCF是可信任的实体，它直接在请求中加入P-Asserted-Identity消息头。
3. 由于初次注册阶段，P-CSCF并没有出于自身路由的目的而保存任何路由信息，因此它不知道为用户指定了哪个S-CSCF，因此也就无法包含Route消息头。所以，它只能根据请求URI的主机部分（即“home1.fr”）来进行该请求消息的路由，可以通过DNS解析找到Tobias归属网络中一个或多个I-CSCF-的地址。然后I-CSCF查询HSS得到分配给URI sip: tobias@homel.fr的S-CSCF地址，并将请求发给S-CSCF。
   1. 注意：通过这个SUBSCRIBE请求也建立起一个新的对话，这次是在P-CSCF和S-CSCF之间。这个对话与UE是否订阅了同样的注册状态信息完全没有关系，因此S-CSCF要分别针对UE的订阅和P-CSCF 的订阅，生成包含Tobias注册状态信息的、单独的NOTIFY请求。

##### 注册状态信息的元素

1. 在收到一个新的订阅后，无论何时注册状态信息发生变化时（例如注册了一个新的公共用户身份)，S-CSCF都会立刻用Tobias的注册状态信息创建一个NOTIFY 消息。
2. 本节中我们仅仅看一下Tobias终端在订阅之后立刻收到的NOTIFY 请求和注册状态信息。这些信息与P-CSCF收到的完全一样，而且基本上是同时收到的。
   - ![[image-20230417180224545.png]]
     - 由于这个请求是从通知者（S-CSCF) 发往订阅者(Tobias 的UE)的，To和From消息头发生了改变。尽管这两个消息头的内容几乎完全相同，但是它们的标签不同。S-CSCF又增加了一个“To”标签（“peruna")，但现在出现在From消息头中。
     - 增加了Subscription-State消息头，指示该订阅是活跃的，并将在599999s后超时。

##### NOTIFY请求正文中的注册状态信息

- NOTIFY请求消息的正文部分包含了Tobias关联URI的注册状态信息。注册状态信息是一个分级的列表．

- ```
  2023 Mar 21  23:05:04.127  [0F]  0x156E  IMS SIP Message  --  IMS_SIP_NOTIFY/INFORMAL_RESPONSE
  Subscription ID = 1
  Version = 1
  Direction = NETWORK_TO_UE
  SDP Presence = 0
  SIP Call ID Length = 62
  SIP Message Length = 3311
  SIP Message Logged Bytes = 3312
  Message ID = IMS_SIP_NOTIFY
  Response Code = INFORMAL_RESPONSE (0)
  CM Call ID = 255
  SIP Call ID = 1970469123_1559107196@fc01:bbbb:cdcd:efe0:ac35:a1ff:fe80:ac6e
  Sip Message = NOTIFY sip:4ee79861-fbbe-4a73-a739-539069e6a74d@[fc01:bbbb:cdcd:efe0:ac35:a1ff:fe80:ac6e]:40925 SIP/2.0
  Call-ID: 1970469123_1559107196@fc01:bbbb:cdcd:efe0:ac35:a1ff:fe80:ac6e
  Contact: <sip:scscf.att.net>
  Content-Type: application/reginfo+xml
  CSeq: 1 NOTIFY
  Event:  reg
  From: <tel:+11234567890>;tag=abc-SubscribeToTag
  Max-Forwards: 69
  Subscription-State: active;expires=3600
  To: <tel:+11234567890>;tag=1970469127
  Via: SIP/2.0/TCP [fc01:abab:cdcd:6fee::1]:5064;branch=z9hG4bK784503296,SIP/2.0/TCP scscf.att.net;branch=z9hG4bK1829863936
  Content-Length: 2742
  
  <?xml version="1.0" encoding="UTF-8"?>
  
  <reginfo xmlns="urn:ietf:params:xml:ns:reginfo" version="0" state="full">
    <registration aor="tel:+11234567890" id="a100" state="active">
      <contact state="active" event="created" id="980">
        <uri>sip:4ee79861-fbbe-4a73-a739-539069e6a74d@[fc01:bbbb:cdcd:efe0:ac35:a1ff:fe80:ac6e]:40925</uri>
        <unknown-param name="+g.3gpp.accesstype">"cellular2"</unknown-param>
        <unknown-param name="mobility">mobile</unknown-param>
        <unknown-param name="+sip.instance">"&lt;urn:gsma:imei:01618800-006875-0&gt;"</unknown-param>
        <unknown-param name="+g.gsma.rcs.botversion">"#=1"</unknown-param>
        <unknown-param name="audio"/>
        <unknown-param name="text"/>
        <unknown-param name="+g.3gpp.nw-init-ussi"/>
        <unknown-param name="+g.3gpp.iari-ref">"urn%3Aurn-7%3A3gpp-application.ims.iari.rcs.geopush,urn%3Aurn-7%3A3gpp-application.ims.iari.rcs.fthttp,urn%3Aurn-7%3A3gpp-application.ims.iari.rcs.chatbot"</unknown-param>
        <unknown-param name="+g.3gpp.smsip"/>
        <unknown-param name="video"/>
        <unknown-param name="+g.3gpp.icsi-ref">"urn%3Aurn-7%3A3gpp-service.ims.icsi.mmtel,urn%3Aurn-7%3A3gpp-service.ims.icsi.oma.cpm.session,urn%3Aurn-7%3A3gpp-service.ims.icsi.oma.cpm.largemsg,urn%3Aurn-7%3A3gpp-service.ims.icsi.oma.cpm.filetransfer,urn%3Aurn-7%3A3gpp-service.ims.icsi.oma.cpm.msg"</unknown-param>
      </contact>
    </registration>
    <registration aor="sip:+11234567890@one.att.net" id="a101" state="active">
      <contact state="active" event="registered" id="981">
        <uri>sip:4ee79861-fbbe-4a73-a739-539069e6a74d@[fc01:bbbb:cdcd:efe0:ac35:a1ff:fe80:ac6e]:40925</uri>
        <unknown-param name="+g.3gpp.accesstype">"cellular2"</unknown-param>
        <unknown-param name="mobility">mobile</unknown-param>
        <unknown-param name="+sip.instance">"&lt;urn:gsma:imei:01618800-006875-0&gt;"</unknown-param>
        <unknown-param name="+g.gsma.rcs.botversion">"#=1"</unknown-param>
        <unknown-param name="audio"/>
        <unknown-param name="text"/>
        <unknown-param name="+g.3gpp.nw-init-ussi"/>
        <unknown-param name="+g.3gpp.iari-ref">"urn%3Aurn-7%3A3gpp-application.ims.iari.rcs.geopush,urn%3Aurn-7%3A3gpp-application.ims.iari.rcs.fthttp,urn%3Aurn-7%3A3gpp-application.ims.iari.rcs.chatbot"</unknown-param>
        <unknown-param name="+g.3gpp.smsip"/>
        <unknown-param name="video"/>
        <unknown-param name="+g.3gpp.icsi-ref">"urn%3Aurn-7%3A3gpp-service.ims.icsi.mmtel,urn%3Aurn-7%3A3gpp-service.ims.icsi.oma.cpm.session,urn%3Aurn-7%3A3gpp-service.ims.icsi.oma.cpm.largemsg,urn%3Aurn-7%3A3gpp-service.ims.icsi.oma.cpm.filetransfer,urn%3Aurn-7%3A3gpp-service.ims.icsi.oma.cpm.msg"</unknown-param>
      </contact>
    </registration>
  </reginfo>
  
  ```

  1. 根元素“reginfo”，包含与一个用户关联的注册状态信息;
     1. “reginfo”根元素的一个或多个子元素“registration”。每个“registration”子元素仅包含与一个URI（即一个公共用户身份)的信息;
        1. 每个“registration”子元素包括零个或多个“contact”子元素。每个“contact"子元素包含了关于地址的信息，该地址已经用于为“registration”子元素中的URI进行注册（或解除注册)。
           1. 每个“contact”子元素的“uri”子元素，指示注册的contact地址;
           2. 每个“contact”子元素包括零个或一个“display-Name”子元素，指示在Contact消息头中为相关contact地址所设置的该显示名称;
           3. 每个“contact”子元素包括零个或一个“gr: pub-gruu”子元素以及零个或一个“gr: temp-gruu”子元素，指示在注册过程中，分配给设备的公共和临时的GRUU;
           4. 每个“contact”子元素包括零个或多个“unknown-parameter”子元素。每个“unknown-parameter”子元素包含注册过程中，Contact消息头中更多的参数。
  2. registration子元素中可以包含以下属性:
     1. 记录地址（ AOR)）属性,后面是公共用户身份的URI。
     2. ID属性，惟一标识了每个registration子元素，将它们相互区别开。registration子元素的state属性，指示相应的URI处于以下哪种状态
        1. “活跃(Active)”(即已注册);
        2. “已终结(Terminated)”(即已解除注册); .
        3. “初始化（Init)”(即处于正在注册的过程中，例如已经接到一个初始的REGISTER 请求,但还没有完成认证过程)。
  3. contact子元素包含了注册的contact地址，并可以包含以下属性:
     1. ID属性，惟一标识每个contact子元素，将它们相互区别开。
     2. contact子元素的state属性，指示相应的contact地址处于以下哪种状态，该状态与registration子元素URI的状态相关联:
        1. “活跃（ Active)”（即URI使用本contact 地址进行了注册)﹔
        2. “已终结(Terminated)”(即刚刚解除了URI和本 contact信息之间的绑定关系)。
     3. contact子元素的event属性，指示导致contact 的state属性发生最后一次变化的事件。
        1. 已注册（Registered)——该事件将contact地址状态从“初始化”变成“活跃”，并指示AOR已经被显式注册了（即收到了一个针对本AOR的有效的REGISTER请求,并且已经绑定了相关的contact 信息)﹔
        2. 已生成(Created)——该事件与“已注册”事件的含义相同，但它指示了AOR是隐性注册的（即绑定是自动创建的，例如当收到一个对其他AOR的REGISTER请求时);
        3. 已刷新(Refreshed) --—该事件发生在对一个AOR进行重新注册时，也可能是隐性的（即对关联的AOR进行了重新注册);
        4. 已缩短（Shortened)——该事件发生在网络缩短了AOR的超时时间时（例如要触发网络发起的重认证);
        5. 去激活（ Deactivated)—---该事件发生在网络删除绑定关系时（例如由于网络发起的解除注册)，使用户能够以后再尝试进行新的初始注册;
        6. 探测( Probation)——通过本事件，网络可以解除用户的注册，并要求一定时间（取决于retry-after值)后再发送一个新的初始注册;
        7. 注册解除（Unregistered)——该事件发生在用户明确地解除该contact信息的注册状态时;
        8. 拒绝( Rejected )——该事件发生在网络不允许用户注册某特定的contact时。
     4. 附加的属性，例如:
        1. expire属性——指示某特定contact 地址的已注册状态的剩余超时时间（在“已缩短”事件中必须设置,在其他事件中为可选);
        2. duration-registered属性——指明该contact已经注册了多长时间;
        3. callid属性——指明用来注册contact地址的 REGISTER请求中Call-ID消息头的值;
        4. cseq属性——指明用来注册contact地址的REGISTER请求中CSeq 消息头的值;
        5. retry-after属性——仅为“探测”事件设置，指示UE应等候多长时间后再次尝试进行注册。

- 举例

  1. Tobias 的注册状态信息包含在 NOTIFY请求消息的正文部分中，这个NOTIFY请求是S-CSCF发往UE和P-CSCF的。它首先包含一个XML文件的头部:
     1. ![[image-20230419110817327.png]]
        1. 该头部指示所使用的XML版本（ 1.0)。注册信息总是从根元素“reginfo”开始，它包括很多属性:
        2. xmlns属性指向统一资源名称（URN)，它定义了XML文件和XML命名空间。
        3. version属性总是从“O”开始，并且在每次有新版本（即更新后)的注册状态信息发往同一接收者时，该属性的值就递增1。
        4. state属性指示下面的注册状态信息是与Tobias有关的所有AOR的完整列表。第一个版本（“O”)的reginfo文件总是要作为完整列表(“full”）来发送，后续信息(从“1”开始）可以是“部分”的，可以仅包含上一次通知之后发生的改变。
  2. 和Tobias有关的所有公共用户身份及其注册状态在如下文档中列出:
     1. ![[image-20230419111327769.png]]
        1. 第一个AOR或URI是sip: tobias@home1. fr，在前面的例子中已经了解。它现在的状态是已注册（ state =“active")。这个registration子元素的内容是一个contact子元素，它指示S-CSCF创建了在sip; tobias@home1.fr 和联系信息sip:[5555:: 1: 2: 3:4](“uri”子元素〉之间的绑定。event属性设置为“registered”，表示该AOR显式注册为这个contact地址。除此之外，我们看到一些其他的属性，给出了关于注册的contact的更多信息，例如duration-registered属性，可以显示contact 已注册多长时间。
        2. 和contact 一起显式注册的更多信息和参数如下所示:
           1. Tobias 的电话所设置的显示名称，以便从所有其他正在进行的注册中识别当前的电话;
           2. 已注册的语音、视频、移动性和方法的支持能力
           3. IMS通信服务标识（ICSI）和 IMS应用参考标识（IARI)
           4. 客户端的instance-id
           5. 被分配给设备的公共GRUU和临时GRUU，gr: pub-gru和gr: temp-gruu元素。
  3. ![[image-20230419141844469.png]]
     1. 另一个AOR是另一个隐性注册的SIP URI ( event = “ created”)，与第一个AOR使用相同的I地址。这个隐性注册是由S-CSCF根据Tobias的用户配置数据来完成的。由于是隐性注册，所有显式注册的公共用户身份的callee 能力（即各个特性标签，包含ICSI 和 IARI值）也都应用于隐式注册的用户身份，因此也都被复制为未知参数。
     2. 此外，该URI也分配有公共GRUU和临时GRUU，只是与显式注册的公共用户身份的取值不同。公共 GRUU将instance-Id加到注册元素的SIP URI 中，而临时GRUU则赋予一个不同的值。每个隐式注册的公共用户身份将被分配不同的GRUU值。
  4. ![[image-20230419142231108.png]]
     1. 另一个AOR是一个隐式注册的tel URL ( event = “ created")，并且与第一个AOR有相同的IP地址。由S-CSCF基于Tobias 的用户配置信息来执行该隐式注册。
  5. ![[image-20230419142450679.png]]
     1. 这两个AOR目前都还是未注册状态（ state = “ terminated")，因此registration子元素并不包含任何信息。
  6. ![[image-20230419142539176.png]]
     1. Tobias还是一个在线角色扮演游戏（RPG)的游戏管理员。他非常重视他这个游戏管理员的工作，因此他总是通过一个游戏控制台保持注册状态，控制台地址是sip:[5555 : : 101:102:103: 104]:1458。控制台的contact地址是显式注册的 （ event = “registered”)。但是，Tobias还希望在他通过IMS UE在线时也能获知游戏的进展状态，因此接收到对sip: tobias@home1.fr的 RECISTER请求时，这个AOR也被S-CSCF隐性注册( event = " created") 了。

##### 多个终端和注册状态信息

- 可以通过不同的终端（即不同的UE)注册一个或多个公共用户身份。Tobias还可能拥有一个简单的寻呼设备，也使用他的公共用户身份sip: tobi-as@home1. fr。在使用IMS服务之前，这个设备也需要执行注册过程。这个注册过程可以通过另一个不同的P-CSCF进行，但是最终必须与第一个注册使用同一个S-CSCF。于是S-CSCF执行显式以及隐式注册。由于注册地址属于三个不同公共用户身份的注册组，因此所有三个都会用新的contact地址进行注册。
- 在寻呼设备注册之后，Tobias 的UE和他的P-CSCF会接收到另一个 NOTIFY 消息，指示关于其公共用户身份出现了另一个contact 信息

#### 重注册和重认证

- ![[image-20230419171728734.png]]

##### 用户发起的重注册

- Tobias 的UE在任何时候实施重注册，只需要向网络发出一个新的REC-ISTER请求。例如由于注册时间即将超时，注册就需要进行刷新，这时就会发生重注册。由于重注册的处理与初始SIP注册过程完全一样，这里不再进一步介绍。
  - ![[image-20230419170134640.png]]

##### 网络发起的重认证

1. IMS UE对于其contact信息的注册有效期长度是600000s，这意味着S-CSCF将把已注册公共用户身份和物理IP地址的绑定关系保持约7天。由于用户认证过程是与注册过程直接结合在一起，因此在这段时间内S-CSCF 无法发起对用户的重认证。然而，有些情况下，S-CSCF确实需要对UE进行重新认证。
2. 为实现这一目的，S-CSCF可以缩短用户注册的超时时间。我们假设Tobias 已经注册了3h了，他的归属运营商希望实施一次随机的重认证。为Tobias 分配的S-CSCF将把Tobias注册状态的超时时间缩短为600s ( 10min)。但此时Tobias UE还无法知道注册时间已经缩短，因此不会实施重新注册，而重注册是为实现重认证所必需的。为了将这个情况通知UE，S-CSCF利用了UE对注册状态事件包的订阅功能。
3. s-CSCF为注册状态事件包生成一个NOTIFY 请求，并发送给Tobias UE，指示缩短了UE的注册时间。接到这个请求后，UE立刻更新其注册超时时间信息。
4. 然后，所有订阅了Tobias注册状态信息的订阅者（例如P-CSCF以及有订阅的AS)都将收到来自S-CSCF的 NOTIFY 请求，携带了更新后的状态信息。
5. 当所指示的时间过去一半以后（即 300s)，UE将发出另一个REGISTER请求。从那时起，进人正常注册过程，S-CSCF就可以再次对用户进行认证。

##### 网络发起的重认证通知

- ![[image-20230419171529885.png]]
- ![[image-20230419171417034.png]]
  - 所有注册和相关contact信息的状态仍然设置为“active”，但对contact信息所发生的最后一个事件指示为“shortened”。超时时间值显示UE在10min之后就需要再次进行注册。在上述文件中，只传递了部分的注册状态信息（文档头中state =“par-tial”)，因为其他的注册状态信息没有改变。
  - 因为S-CSCF只发送部分信息，所以没有缩短的contact元素也就没有显示在这条注册状态信息中。

#### 解除注册

1. 关机时，手机会向S-CSCF 发出另一个 RECISTER请求，包含我们已经见到的所有信息，但指示这次该消息是为了解除注册。s-CSCF则清除为Tobias所保存的所有信息，更新HSS 数据，并向TobiasUE发出一个200 ( OK)响应。
   - ![[image-20230419172055869.png]]
2. 有时网络也会需要解除用户的注册。可能是由于S-CSCF需要关机。这些情况下，S-CSCF只需要向Tobias UE发出另一个携带注册状态信息的NOTIFY 消息，但这次是指示他已经被解除注册。
   1. ![[image-20230419172248334.png]]
   2. 如果注册时间过期，而且Tobias 也没有进一步发送任何RECISTER请求，那么注册就被终止，NOTIFY请求会被发送给所有订阅了Tobias 注册状态信息的订阅者，但这时并不解除UE的注册。由于绑定已过期，因此不能向它发送任何消息。
   3. 在以上任何一种情况下，S-CSCF都会发出 NOTIFY请求给P-CSCF以及所有订阅了Tobias注册状态信息的订阅者，指示Tobias 已经被解除注册。通过发送这个 NOTI-FY请求，也将关闭在订阅注册状态事件期间创建的对话。

##### 用户发起的注册解除

- 当Tobias 关闭手机时，UE会向网络发出一个RECISTER请求，以便解除注册。
  - ![[image-20230419172448551.png]]
    1. 以上信息与其他REGISTER请求中已经看到过的信息基本相同，主要区别在于超时时间设置成0，意味着用户希望解除公共用户身份（在To消息头中）和IP地址（在Contact消息头中)之间已注册的绑定关系。
    2. 这个REGISTER请求和其他每个REGISTER请求经历完全相同的路由（即不会按照已存储的Service-Route进行路由)。因此，它将:
       - 穿越P-CSCF——进行完整性保护检查，并在Authorization消息头中增加integri-ty-protected = yes的标志;
         穿越I-CSCF—向HSS 询问为用户指定了哪个S-CSCF地址;
       - 最终到达S-CSCF——将在这里实施注册解除。
    3. s-CSCF通过Cx接口给HSS 发送一条SAR ( Diameter Server-Assignment Request )消息，来执行Diameter注册解除通知过程。 
    4. HSS 从Tobias 的注册相关数据中删除S-CSCF的名称，并返回一条Diameter 服务器分配应答( SAA)消息给S-CSCF
    5. s-CSCF 会立刻向UE发回一个200 (OK）响应，包含的expires消息头也设为0。随后，S-CSCF会创建NOTIFY请求，发往所有订阅了Tobias注册状态信息的订阅者，包括Tobias UE。每个 NOTIFY 请求都包含Subscription-State消息头，并设置为“terminated”，表示已经终止了对于该用户的注册状态信息的订阅关系。
       - ![[image-20230419175727375.png]]
    6. 这些NOTIFY请求的消息正文中会包含Tobias的注册状态信息
       - ![[image-20230419175902121.png]]
         - 这个XML文件仍然包含一个“partial”状态指示，因为它并不显式地列出尚未注册的公共用户身份
    7. ![[image-20230419180412246.png]]
       - 公共用户身份sip: tobias@ home1.fr仍然是激活的，因为它还已被Tobias的寻呼机注册，只有移动电话的contact地址设置为已结束。
       - 游戏的URI sip: gameMaster@homel.fr也保持了注册状态，因为另一个UE正在活跃地使用它。只有显式解除注册的contact地址才会被删除。

##### 网络发起的注册解除

- 如果注册在S-CSCF处本地超时，即 Tobias没有进一步发送 REGISTER消息来刷新注册过期，并且这是Tobias当前惟一激活的注册（即他没有从其他终端注册)，那么S-CSCF 和 HSS会通过Cx接口执行Diameter注册解除通知过程。

##### 管理方注册解除时的Cx通信

- 如果Tobias 的归属网络因为管理因素让Tobias解除注册，则HSS将通知S-CSCF对用户进行注册解除。HSS会通过Cx 接口给S-CSCF发送一条Diameter注册终止请求（(RTR)消息，来执行Diameter网络发起的注册解除过程。

##### 网络发起注册解除时的用户注册状态信息

- 任何时候只要网络发现需要解除用户的注册状态，或者需要解除用户的某些用户身份的注册状态时，S-CSCF就会生成NOTIFY 请求，方式和之前只是XML文件的内容看起来不一样。在本例中，我们假设Tobias 已经通过他的移动电话进行了注册解除，此时只有其寻呼设备仍处于激活（ active）状态:







































## SIP

- RFC 3261- SIP: Session Initiation Protocol
- 在基于互联网的应用程序中，存在着创建和管理会话的需求，这些会话被视为参与者之间进行数据交换的方式。然而，这些应用程序的实现受到参与者行为复杂性的影响，因为用户可能在不同的终端之间切换，可能具有多个可寻址的标识，并且可能同时使用多种不同的媒体进行通信。为了传输实时多媒体会话数据（如语音、视频或文本消息），已经开发了多种协议。会话初始化协议（SIP）与这些协议协同工作，使得互联网终端（也称为用户代理）能够相互发现并就共享的会话进行协商。为了定位潜在的会话参与者并执行其他功能，SIP可以建立一个网络主机基础设施（代理服务器），用户代理可以向这些代理服务器发送注册、会话邀请和其他请求。SIP是一种灵活且通用的工具，用于创建、修改和终止会话，它独立于底层传输协议，并且不依赖于正在建立的会话类型。
- SIP is an application layer protocol that is used for establishing, modifying and terminating multimedia sessions in an Internet Protocol (IP) network. 
  - Call-ID包含了此通话的全局唯一标识符，由随机字符串和softphone的主机名或IP地址的组合生成。To标签、From标签和Call-ID三者组合完全定义了Alice和Bob之间的点对点SIP关系，并被称为对话（dialog）。

- SIP, as part of the IETF process, is based on the Hypertext Transfer Protocol (HTTP) and the Simple Mail Transfer Protocol (SMTP)
  - ![[image-20221213133025084.png]]
- 目标
  - transport protocol neutrality - able to run over reliable(TCP, SCTP) and unreliable(UDP) protocols;
  - request routing - direct (performance) or proxy-routed (control);
  - separation of signalling and media description -can add new applications or media;extensibility;
  - personal mobility.

### 架构

- 成员：
  - User Agents (UAs) 
    - User Agent Client (UAC)- the caller application that initiates requests.
    - User Agent Server (UAS)- accepts, redirects, rejects requests and sends responses to incoming requests on behalf of the user.
    - Gateways  are  special  cases  of  UAs.
    - ![[image-20221213173756995.png]]
  - intermediaries (servers)
    - SIP intermediaries are logical entities through which SIP messages pass on their way to their ﬁnal destination. These intermediaries are used to route and redirect requests.These intermediaries are used to route and redirect requests.
    - Proxy server:receives and forwards SIP requests
      - dialog-statefull proxy – a proxy is dialog-statefull if it retains the state for a dialog from the initiating request (INVITE request) right through to the terminating request (BYE request);
      - transaction-statefull  proxy  –  a  proxy  that  maintains  client  and  server  transaction-state  machines  during  the  processing  of  a  request;
      - stateless  proxy  –  a  proxy  that  forwards  every  request  it  receives  downstream  and every  response  it  receives  upstream.
    - Redirect  server : maps  the  address  of  requests  to  new  addresses.  It  redirects  requests 
      but  does  not  participate  in  the  transaction.
    - Location  server  –  keeps  track  of  the  location  of  users.
    - Registrar server – a server that accepts REGISTER requests. It is used to store explicit binding between a user’s address of record (SIP address) and the address of the host where the user is currently residing or wishes to receive requests.
    - Application  server  –  an  AS  is  an  entity  in  the  network  that  provides  end-users  with  a service.
    - B2BUA（Back-to-Back User Agent，背靠背用户代理）是通讯网络中，使用SIP（Session Initiation Protocol，会话发起协议）实现会话的一种逻辑实体。B2BUA作为SIP呼叫两端的用户代理，负责处理呼叫两端的所有SIP信令，从呼叫确立到终止全程跟踪每个呼叫。

### 术语定义

1. 地址记录（Address-of-Record，AOR）是一个指向具有位置服务的域的SIP或SIPS URI，该位置服务可以将URI映射到用户可能可用的另一个URI。通常，位置服务是通过注册来填充的。AOR通常被视为用户的“公共地址”。
2. 后向用户代理（Back-to-Back User Agent，B2BUA）是一个逻辑实体，它接收请求并将其作为用户代理服务器（UAS）进行处理。为了确定应该如何回答请求，它充当用户代理客户端（UAC）并生成请求。与代理服务器不同，它维护对话状态，并且必须参与在其建立的对话中发送的所有请求。由于它是UAC和UAS的串联，因此不需要对其行为进行显式定义。
3. 通话（Call）：通话是一个非正式术语，指的是对等方之间的某种通信，通常用于进行多媒体对话的目的。**用Call-ID来标识；不论两方通话还是在多方通话中，在每个UA中是使用同一个Call-ID；**
4. 通话分支（Call Leg）：对话的另一个名称；
5. 通话状态保持（Call Stateful）：如果代理服务器在从发起的INVITE请求到终止的BYE请求期间保留对话状态，则称其为通话状态保持代理。通话状态保持代理始终是事务状态保持的，但反之不一定成立。
6. 客户端（Client）：客户端是指发送SIP请求并接收SIP响应的任何网络元素。客户端可以直接或间接地与人类用户进行交互。用户代理客户端和代理服务器都是客户端。
7. 会议（Conference）：包含多个参与者的多媒体会话。
8. 核心（Core）：核心指的是特定类型的SIP实体（如有状态或无状态代理、用户代理或注册服务器）的特定功能。除了无状态代理的核心之外，所有核心都是事务用户
9. 对话（Dialog）：对话是两个用户代理之间持续一段时间的点对点SIP关系。对话是通过SIP消息建立的，例如对INVITE请求的2xx响应。对话由呼叫标识符、本地标签和远程标签来标识。**To标签、From标签和Call-ID三者组合定义了Dialog**
10. 下行（Downstream）：在事务中指的是消息转发的方向，表示请求从用户代理客户端流向用户代理服务器的方向。
11. 最终响应（Final Response）：终止SIP事务的响应，与不具有终止作用的临时响应相对。所有2xx、3xx、4xx、5xx和6xx响应都是最终响应。
12. 头部（Header）：头部是SIP消息的组成部分，用于传递消息的信息。它结构化为一系列头字段。
13. 头字段（Header Field）：头字段是SIP消息头部的组成部分。一个头字段可以出现为一个或多个头字段行。头字段行由头字段名称和零个或多个头字段值组成。在给定的头字段行上，多个头字段值之间用逗号分隔。某些头字段只能有一个头字段值，因此始终显示为单个头字段行。
14. 头字段值（Header Field Value）：是一个单独的值；头字段由零个或多个头字段值组成。
15. 本地域（Home Domain）：为SIP用户提供服务的域。通常，这是在注册的地址记录（address-of-record）的URI中存在的域。
16. 信息响应（Informational Response）：与临时响应（provisional response）相同。
17. 发起方、呼叫方、主叫方（Initiator, Calling Party, Caller）：通过INVITE请求发起会话（和对话）的一方。主叫方在发送建立对话的初始INVITE请求之后，保持这个角色直到对话终止。
18. 邀请（Invitation）：一个INVITE请求。
19. 被邀请方、被叫方、被呼叫方、被叫号码（Invitee, Invited User, Called Party, Callee）：接收INVITE请求以建立新会话的一方。被叫方在接收INVITE请求直到由该INVITE建立的对话终止时保持这个角色。
20. 位置服务（Location Service）：SIP重定向或代理服务器使用位置服务来获取有关被叫方可能位置的信息。它包含一个地址记录键到零个或多个联系地址的绑定列表。这些绑定可以通过多种方式创建和删除；本规范定义了一个更新绑定的REGISTER方法。
21. 循环（Loop）：一个请求到达代理服务器，被转发，然后再次到达同一个代理服务器。当它第二次到达时，其请求URI与第一次相同，并且其他影响代理操作的头字段保持不变，以便代理在第一次请求上做出相同的处理决策。循环请求是错误的，协议描述了检测和处理它们的过程。
22. 宽松路由（Loose Routing）：如果代理服务器遵循本规范定义的处理Route头字段的过程，则称其为宽松路由。这些过程将请求的目的地（在请求URI（Request-URI）中）与需要在途中访问的代理服务器集合（在Route头字段中）分开。符合这些机制的代理服务器也被称为宽松路由器。
23. 消息（Message）：作为协议的一部分，在SIP元素之间发送的数据。SIP消息可以是请求或响应。
24. 方法（Method）：方法是请求在服务器上执行的主要功能。方法包含在请求消息本身中。示例方法包括INVITE和BYE。
25. 出站代理（Outbound Proxy）：即使它可能不是由Request-URI解析的服务器，也会接收来自客户端的请求的代理服务器。通常，用户代理（UA）通过手动配置或通过自动配置协议了解出站代理。
26. 并行搜索（Parallel Search）：在收到传入请求时，代理服务器向可能的用户位置发出多个请求进行并行搜索。与顺序搜索中发出一个请求，然后等待最终响应再发出下一个请求不同，一个并行搜索在不等待上一个请求的结果的情况下发出请求。
27. 临时响应（Provisional Response）：服务器用来表示进展的响应，但不终止SIP事务。1xx响应是临时响应，其他响应被视为最终响应。
28. 代理，代理服务器（Proxy, Proxy Server）：一个中间实体，既作为服务器又作为客户端，代表其他客户端发出请求。代理服务器主要扮演路由的角色，即确保请求被发送到“更接近”目标用户的另一个实体。代理还有助于强制执行策略（例如，确保用户有权进行呼叫）。代理在转发请求之前解释并可能重写请求消息的特定部分。
29. 递归（Recursion）：当客户端生成一个新的请求，发送到响应中Contact头字段中的一个或多个URI时，它对3xx响应进行递归。
30. 重定向服务器（Redirect Server）：重定向服务器是一个用户代理服务器，它对收到的请求生成3xx响应，指示客户端联系一个备用的URI集合。
31. 注册服务器（Registrar）：注册服务器是一个接受REGISTER请求并将其接收到的信息放入所处理域的位置服务中的服务器。
32. 常规事务（Regular Transaction）：除了INVITE、ACK或CANCEL之外的任何具有方法的事务。
33. 请求（Request）：从客户端发送到服务器的SIP消息，用于执行特定操作。
34. 响应（Response）：从服务器发送到客户端的SIP消息，用于指示客户端发送的请求的状态。
35. 回铃音（Ringback）：呼叫方应用程序产生的信令音，表示正在提醒（响铃）被叫方。
36. 路由集（Route Set）：路由集是一组有序的SIP或SIPS URI，代表在发送特定请求时必须经过的代理服务器列表。路由集可以通过Record-Route等头字段学习，也可以进行配置。
37. 服务器（Server）：服务器是一个网络元素，接收请求以便为其提供服务，并向这些请求发送响应。服务器的示例包括代理服务器、用户代理服务器、重定向服务器和注册服务器。
38. 顺序搜索（Sequential Search）：在顺序搜索中，代理服务器按顺序尝试每个联系地址，只有在前一个地址生成最终响应后才继续下一个地址。2xx或6xx类的最终响应总是终止顺序搜索。
39. 会话（Session）：根据SDP规范：“一个多媒体会话是一组多媒体发送方和接收方，以及从发送方到接收方流动的数据流。多媒体会议是多媒体会话的一个示例。”（按照SDP的定义，一个会话可以由一个或多个RTP会话组成。）根据定义，被叫方可以通过不同的呼叫多次邀请到同一个会话。如果使用SDP，会话由SDP用户名、会话ID、网络类型、地址类型和发送字段(in the origin field)中的地址元素串联定义：
    1. SDP user name
    2.  session id,
    3. network type,
    4. address type,
    5. address elements 
40. SIP事务（SIP Transaction）：SIP事务发生在客户端和服务器之间，包括从客户端发送到服务器的第一个请求到服务器发送给客户端的最终（非1xx）响应的所有消息。如果请求是INVITE并且最终响应是非2xx，事务还包括对响应的ACK。对于INVITE请求的2xx响应的ACK是一个单独的事务。
41. 螺旋（Spiral）：螺旋是指将SIP请求路由到一个代理服务器，继续转发，并再次到达该代理服务器，但这次与原始请求有所不同，将导致不同的处理决策。通常，这意味着请求的Request-URI与之前到达的不同。螺旋不是一个错误条件，与循环不同。这种情况的典型原因是呼叫转发。用户呼叫joe@example.com。example.com代理将其转发到Joe的PC，然后由Joe的PC转发到bob@example.com。这个请求被代理返回到example.com代理。然而，这不是一个循环。由于请求针对的是不同的用户，它被认为是一个螺旋，是一个有效的条件。
42. 有状态代理（Stateful Proxy）：在处理请求期间，维护本规范定义的客户端和服务器事务状态机的逻辑实体，也称为事务有状态代理。有状态（事务）代理与有通话状态的代理不同。
43. 无状态代理（Stateless Proxy）：在处理请求时，不维护本规范定义的客户端或服务器事务状态机的逻辑实体。无状态代理将接收到的每个请求向下游转发，将接收到的每个响应向上游转发。
44. 严格路由（Strict Routing）：如果代理服务器遵循RFC 2543和本RFC的许多之前的工作版本的路由处理规则，则称其为严格路由。这个规则导致代理在存在Route头字段时销毁Request-URI的内容。本规范不使用严格路由行为，而是使用宽松路由行为。执行严格路由的代理也被称为严格路由器。
45. 目标刷新请求（Target Refresh Request）：在对话中发送的目标刷新请求被定义为可以修改对话的远程目标的请求。
46. 事务用户（TU）：位于事务层之上的协议处理层。事务用户包括UAC核心、UAS核心和代理核心。
    1. UAC（User Agent Client）和UAS（User Agent Server）的角色，以及代理服务器和重定向服务器的角色是基于每个事务进行定义的。例如，发起呼叫的用户代理在发送初始的INVITE请求时充当UAC，在接收到被叫方的BYE请求时充当UAS。同样，同一个软件可以在一个请求中充当代理服务器，在下一个请求中充当重定向服务器。

### SIP Messages

- SIP是一种基于文本的协议，使用UTF-8字符集。
- SIP消息可以是客户端向服务器发出的请求，也可以是服务器向客户端发出的响应。

- ![[image-20221215160703268.png]]
  - 一次呼叫只能建立一次session，但可以建立多个Dialog，因为接受请求的可能不止一个。
- 组成部分：无论是请求还是响应消息，都使用了RFC 2822 的基本格式，尽管语法在字符集和具体语法方面有所不同（例如，SIP允许存在一些在RFC 2822中无效的头字段）。这两种类型的消息都由起始行、一个或多个头字段、表示头字段结束的空行以及可选的消息体组成。
  - ![[image-20230725114358777.png]]
     - the   start   line
       - The start line contents vary depending on whether the SIP message is a request or a response. For requests it is referred to as a ‘‘request line’’ and for responses it is referred to as a ‘‘status line’’.
  
     - message  headers  
     - body.
     - 起始行、每个消息头行和空行必须以回车换行序列（CRLF）结尾。注意，即使消息体不存在，空行也必须存在。
  
  - ![[image-20221214114332115.png]]
  

#### Requests

- SIP请求通过在起始行带一个 Request 行和其他的 method 加以区别。一个请求行包含method 名称，一个 Request URI ，和由单空格字符分开的协议版本。
- 请求行以换行符CRLF 结束。可以允许无回车或换行，除了在以换行符结束 的序列中。不允许在任何网元中有任意数量的空白格（ LWS ）存在。
  1. ![[image-20230801172744206.png]]
  2. Method:此规范定义了六个方法 : REGISTER 支持注册联系消息， INVITE ACK ，和CANCEL 支持会话创建， BYE 支持结束会话， OPTIONS 支持对服务器的能力查询。SIP 拓展中定义了其他的方法。
  3. Request URI: Request URI 是一个 SIP 或 SIP URL,它指示了此请求所针对的用户或服务。请求URI不得包含未转义的空格或控制字符，并且不得用“<>”括起来。
  4. SIP-Version: 请求和响应消息都包含正在使用的SIP版本，并遵循[H3.1]（其中将HTTP替换为SIP，HTTP/1.1替换为SIP/2.0）关于版本排序、合规要求和版本号升级方面的规定。为了符合本规范，发送SIP消息的应用程序必须包含一个"SIP/2.0"的SIP-Version。SIP-Version字符串不区分大小写，但实现必须使用大写字母。


#### Response

- SIP响应通过具有Status-Line作为起始行来与请求进行区分。Status-Line由协议版本、数字状态码及其关联的文本短语组成，每个元素之间用一个空格字符（SP）分隔。
- 请求行以换行符CRLF 结束。可以允许无回车或换行，除了在以换行符结束 的序列中。
  1. ![[image-20230801173558298.png]]
  2. 状态码:是一个三位整数的结果代码，它表示一个测试输出的响应理解，满足请求的要求。
     1. 状态码的第一个数字定义了响应的级别。状态码后两位没有层级的设置。因为这个原因，任何状态码介于 100 和 199 之间的响应被看作是 "1xx response"，任何状态码介于 200 和 299 的响应看作是一个 "2xx 响应，以此类推。以第一个数字为划分类别， SIP/2.0 支持了六个级别的状态响应码
        1. 1xx: Provisional 请求收到的响应码，表示是临时响应，会继续处理此请求；
        2. 2xx: Success 成功收到处理流程，理解，接受了处理流程；
        3. 3xx: Redirection 需要进一步的流程处理来完成此请求；
        4. 4xx: Client Error 此请求中包含错误语法或不能满足服务器的要求；
        5. 5xx: Server Error 服务器端不能满足一个明确有效请求；
        6. 6xx: Global Failure 任何服务器都不能满足此请求流程。
  
  3. 原因短语的目的是对状态码给予一个短语解释。使用状态码的目的是为了系统的自动处理，而原因短语的目的是方便用户阅读理解状态原因，具有可阅读性。用户不要求检查或显示原因短语。
  
- **Status  codes**  are  classiﬁed  in  six  classes  (classes  2xx  to  6xx  are  ﬁnal  responses)
  - 临时应答1xx：临时应答，也就是消息性质的应答，标志了对方服务器正在处理请求，并且还没有决定最后的应答。如果服务器处理请求需要花200ms以上才能产生终结应答的时候，它应当发送一个1xx应答。注意1xx应答并不是可靠传输的。他们不会导致客户端传送一个ACK应答。临时性质的（1xx）应答可以包含消息体，包含会话描述。
    1. 100 Trying：这个应答表示下一个节点的服务器已经接收到了这个请求并且还没有执行这个请求的特定动作（比如，正在打开数据库的时候）。这个应答，就像其他临时应答一 样，种植了UAC重新传送INVITE请求。100(Trying)应答和其他临时应答不同的是，在这里，它永远不会被有状态proxy转发到上行流中。
    2. 180 Ringing：UA收到INVITE请求并且试图提示给用户。这个应答应当出世化一个本地回铃。
    3. 188 Call is Being Forwarded(呼叫被转发)：服务器可以用这个应答代码来表示呼叫正在转发到另一个目的地集合。
    4. 182 Queued：当呼叫的对方暂时不能接收呼叫的时候，并且服务器决定将呼叫排队等候，而不是拒绝呼叫的时候，那么就应当发出这个应答。当被叫方一旦恢复接收呼叫，他会返回 合适的终结应答。对于这个呼叫状态，可以有一个表示原因的短语，比如：”5 calls queued;expected waiting time is 15minutes”。服务器可以给出好几个182（Queued）应答告诉呼叫方排队的情况（比如排队靠前了等等）。
    5. 183 会话进度：183（Session Progress）应答用于提示建立对话的进度信息。Reason-Phrase（表达原因的句子）、头域或者消息体可以用于提示呼叫进度的更消息的信息。
  - 成功信息2xx：这个应答表示请求是成功的。
    - 200 OK：请求已经处理成功。这个信息取决于不同方法的请求的应答。
  - 转发请求3XX：3xx系列的应答是用于提示用户的新位置信息的，或者为了满足呼叫而转发的额外服务地点。
    1. 300 Multiple Choices：请求的地址有多个选择，每个选择都有自己的地址，用户或者（UA）可以选择合适的通讯终端，并且转发这个请求到这个地址。应答可以包含一个具有每一个地点的在Accept请求头域中允许的资源特性，这样用户或者UA可以选择一个最合适的地址来转发请求。没有未这个应答的消息体定义MIME类型。这些地址选择也应当在Contact头域中列出（20.10节）。不同于HTTP，SIP应答可以包含多个Contact头域或者一个Contact头域 中具有一个地址列表。UA可以使用Contact头域来自动转发或者要求用户确认转发。不过，本规范没有定义自动转发的标准。如果被叫方可以在多个地址被找到，并且服务器不能或者不愿意转发请求的时候，可以使用这个应答来给呼叫方。
    2. 301 Moved Permently：当不能在Request-URI指定的地址找到用户的时候，请求的客户端应当使用Contact头域(20.10)所指出的新的地址重新尝试。请求者应当用这个新的值来更新本地的目录，地址本，和用户地址cache，并且在后续请求中，发送到这个/这些列出的地址。
    3. 302 Moved Temporarily：请求方应当把请求重新发到这个Contact头域所指出的新地址(20.10)。新请求的Request-URI应当用这个应答的Contact头域所指出的值。在应答中的Expires(20.19节)或者Contact头域的expires参数定义了这个Contact URI的生存周期。UA或者proxy在这个生存周期内cache这个URI。如果没有严格的有效时见，那么这个地址仅仅本次有效，并且不能在以后的事务 中保存。如果cache的Contact头域的值失败了，那么被转发请求的Request-URI应当再次尝试一次。临时URI可以比超时时间更快的失效，并且可以有一个新的临时URI。
    4. 305 Use Proxy：请求的资源必须通过Contact头域中指出的proxy来访问。Contact头域指定了一个proxy的URI。接收到这个应答的对象应当通过这个proxy重新发送这个单个请求。305（UseProxy）必须是UAS产生的。
    5. 380 Alternative Service：呼叫不成工，但是可以尝试另外的服务。另外的服务在应答的消息体中定义。消息体的格式在这里没有定义，可能在以后的规范中定义。
  - 请求失败4xx：4xx应答定义了特定服务器响应的请求失败的情况。客户端不应当在不更改请求的情况下重新尝试同一个请求。（例如，增加合适的认证信息）。不过，同一个请求交给不同服务器也许就会成功。
    1. 400 Bad Request：请求中的语法错误。Reason-Phrase应当标志这个详细的语法错误，比如”Missing Call-ID header field”。
    2. 401 Unauthorized：请求需要用户认证。这个应答是由UAS和注册服务器产生的，当407（Proxy Authentication Required）是proxy服务器产生的。
    3. 402 Payment Required：保留/以后使用
    4. 403 Forbidden：服务端支持这个请求，但是拒绝执行请求。增加验证信息是没有必要的，并且请求应当不被重试。
    5. 404 Not Found：服务器返回最终信息：用户在Request-URI指定的域上不存在。当Request-URI的domain和接收这个请求的domain不匹配的情况下， 也会产生这个应答。
    6. 405 Method Not Allowed：服务器支持Request-Line中的方法，但是对于这个Request-URI中的地址来说，是不允许应用这个方法的。应答必须包括一个Allow头域，这个头域包含了指定地址允许的方法列表。
    7. 406 Not Acceptable：请求中的资源只会导致产生一个在请求中的Accept头域外的，内容无法接收的错误。
    8. 407 Proxy Authentication Required：这个返回码和401（Unauthorized）很类四，但是标志了客户端应当首先在proxy上通过认证。这个返回码用于应用程序访问通讯网关（比如，电话网关），而很少用于被叫方要求认证。
    9. 408 Request Timeout：在一段时间内，服务器不能产生一个终结应答，例如，如果它无法及时决定用户的位置。客户端可以在稍后不更改请求的内容然后重新尝试请求。
    10. 410 Gone：请求的资源在本服务器上已经不存在了，并且不知道应当把请求转发到哪里。这个问题将会使永久性的。如果服务器不知道，或者不容易检测，这个资源消失是临时性质的还是永久性质的，那么应当返回一个404（Not Found）。
    11. 413请求实体过大。：服务器拒绝处理请求，因为这个请求的实体超过了服务器希望或者能够处理的大小。这个服务器应当关闭连接避免客户端重发这个请求。如果这个情况是暂时的，那么服务端应当包含一个Retry-After头域来表明这是一个暂时的故障，并且客户端可以过一段时间再次尝试。
    12. 414 Request-URI Too Long：服务器拒绝这个请求，因为Request-URI超过了服务器能够处理的长度。
    13. 415 Unsupported Media Type：服务器由于请求的消息体的格式本服务器不支持，所以拒绝处理这个请求。这个服务器必须根据内容的故障类型，返回一个Accept，Accpet-Encoding,或者Accept-Language头域列表。
    14. 416 Unsupported URI Scheme：服务器由于不支持Request-URI中的URI方案而终止处理这个请求。
    15. 420 Bad Extension：服务器不知道在请求中的Proxy-Require(20.29)或者Require(20.32)头域所指出的协议扩展。服务器必须在Unsupported头域中列出不支持的扩展。
    16. 421Extension Required：UAS需要特定的扩展来处理这个请求，但是这个扩展并没有在请求的Supported头域中列出。具有这个应答码的应答必须包含一个Require头域列出所需要的扩展。UAS不应当使用这个应答除非它真的不能给客户端提供有效的服务。相反，如果在Support头域中没有列出需要的扩展，服务器应当根据基准的SIP兼容的方法和客户端支持的扩展来进行处理。
    17. 423 Interval Too Brief：服务器因为在请求中设置的资源刷新时间（或者有效时间）过短而拒绝请求。这个应答可以用于注册服务器来拒绝那些Contact头域有效期过短的注册请求。
    18. 480 Temporarily Unavailable：请求成功到达被叫方的终端系统，但是被叫方当前不可用（例如，没有登陆，或者登陆了但是状态是不能通讯，或者有”请勿打扰”的标记）。应答应当在 Retry-After中标志一个合适的重发时间。这个用户也有可能在其他地方是有效的（在本服务器中不知道）。Reason-Phrase(原因短句) 应当提示更详细的原因，为什么被叫方暂时不可用。这个值应当是可以被UA设置的。状态码486（Busy Here）可以用来更精确的表示本请求失败的特定原因。这个状态码也可以是转发服务或者proxy服务器返回的，因为他们发现Request-URI指定的用户存在，但是没有一个给这个用户的合适的当前转发的地址。
    19. 481 Call/Transaction Does Not Exist：这个状态表示了UAS接收到请求，但是没有和现存的对话或者事务匹配。
    20. 482 Loop Detected：服务器检测到了一个循环(16.3/4)
    21. 483 Too Many Hops：服务器接收到了一个请求包含的Max-Forwards(20.22)头域是0
    22. 484 Address InComplete：服务器接收到了一个请求，它的Request-URI是不完整的。在原因短语中应当有附加的信息说明。这个状态码可以和拨号交叠。在和拨号交叠中，客户端 不知道拨号串的长度。它发送增加长度的字串，并且提示用户输入更多的字串，直到不在出现484（Address Incomplete）应答为止。
    23. 485 Ambiguous：Request-URI是不明确的。应答可以在Contact头域中包含一个可能的明确的地址列表。这个提示列表肯囊个在安全性和隐私性对用户或者组织造 成破坏。必须能够由配置决定是否以404（NotFound）代替这个应答，又或者禁止对不明确的地址使用可能的选择列表。部分email和语音邮箱系统提供了这个功能。这个状态码和3xx状态码不同：对于300来说，它是假定同一个人或者服务有不同的地址选择。所以对3xx来说，自动选择系统或者连续查找就有效，但是对485（Ambiguous）应答来说，一定要用户的干预。
    24. 486 Busy Here：当成功联系到被叫方的终端系统，但是被叫方当前在这个终端系统上不能接听这个电话，那么应答应当回给呼叫方一个更合适的时间在Retry-After头域 重试。这个用户也许在其他地方有效，比如电话邮箱系统等等。如果我们知道没有其他终端系统能够接听这个呼叫，那么应当返回一个状态码600（Busy Everywhere）。
    25. 487 Request Terminated：请求被BYE或者CANCEL所终止。这个应答永远不会给CANCEL请求本身回复。
    26. 488 Not Acceptable Here：这个应答和606（Not Acceptable）有相同的含义，但是只是应用于Request-URI所指出的特定资源不能接受，在其他地方请求可能可以接受。包含了媒体兼容性描述的消息体可以出现在应答中，并且根据INVITE请求中的Accept头域进行规格化（如果没有Accept头域，那么就是application/sdp）。这个应答就像给OPTIONS请求的200(OK)应答的消息体一样。
    27. 491 Request Pending：在同一个对话中，UAS接收到的请求有一个依赖的请求正在处理。
    28. 493 Undecipherable：UAS接收到了一个请求，包含了一个加密的MIME,并且不知道或者没有提供合适的解密密钥。这个应答可以包含单个包体，这个包体包含了合适的公钥，这个公钥用于给这个UAS通讯中加密包体使用的。细节描述在23.2节。
  - Server Failure 5xx：5xx应答是当服务器本身故障的时候给出的失败应答。
    1. 500 Server Internal Error：服务器遇到了未知的情况，并且不能继续处理请求。客户端可以显示特定的错误情况，并且可以在几秒种以后重新尝试这个请求。如果这个情况是临时的，服务器应当在Retry-After头域标志客户端过多少秒钟之后重新尝试这个请求。
    2. 501 Not Implemented：服务器没有实现相关的请求功能。当UAS不认识请求的方法的时候，并且对每一个用户都无法支持这个方法的时候，应当返回这个应答。（proxy不考虑请求的方法而转发请求）。注意405（Method Not Allowed）是因为服务器实现了这个请求方法，但是这个请求方法在特定请求中不被支持。
    3. 502 Bad Gateway：如果服务器，作为gateway或者proxy存在，从下行服务器上接收到了一个非法的应答（这个应答对应的请求是本服务器为了完成请求而转发给下行服务器的）。
    4. 503 Service Unavailable：由于临时的过载或者服务器管理导致的服务器暂时不可用。这个服务器可以在应答中增加一个Retry-After来让客户端重试这个请求。如果没有Retry-After指出，客户端必须就像收到了一个500（Server Internal Error）应答一样处理。客户端（proxy或者UAC）收到503（Service Unavailable）应当尝试转发这个请求到另外一个服务器处理。并且在Retry-After头域中指定的时间内，不应当转发其他请求到这个服务器。作为503(Service Unavaliable)的替代，服务器可以拒绝连接或者把请求扔掉。
    5. 504 Server Time-out:服务器在一个外部服务器上没有收到一个及时的应答。这个外部服务器是本服务器用来访问处理这个请求所需要的。如果从上行服务器上收到的请求中的Expires头域超时，那么应当返回一个408（Request TimeOut）错误。
    6. 505 Version Not Supported:服务器不支持对应的SIP版本。服务器是无法处理具有客户端提供的相同主版本号的请求，就会导致这样的错误信息。
    7. 513 Message To Large:服务器无法处理请求，因为消息长度超过了处理的长度。
  - Global Failures 6xx:global failure responses. The request cannot be fulﬁlled at any server. The server responding with this response class needs to have deﬁnitive information about the user.
    1. 600 Busy Everywhere:成功联系到被叫方的终端系统，但是被叫方处于忙的状态，并不打算接听电话。这个应答可以通过增加一个Retry-After头域更明确的告诉呼叫方多久以 后可以继续呼叫。如果被叫方不希望提示拒绝的原因，被叫方应当使用603（Decline）。只有当终端系统知道没有其他终端节点（比如语音邮箱系统）能 够访问到这个用户的时候才能使用这个应答。否则应当返回一个486（Busy Here）的应答。
    2. 603 Decline:当成功访问到被叫方的设备，但是用户明确的不想应答。这个应答可以通过增加一个Retry-After头域更明确的告诉呼叫方多久以后可以继续呼叫。只有当终端知道没有其他任何终端设备能够响应这个呼叫的势能才能给出这个应答。
    3. 604 Does Not Exists Anywhere:服务器验证了在请求中Request-URI的用户信息，哪里都不存在
    4. 606 Not Acceptable:当成功联系到一个UA,但是会话描述的一些部分比如请求的媒体，带宽，或者地址类型不被接收。606（NotAcceptable）应答意味着用户希望通讯，但是不能充分支持会话描述。606（Not Acceptable）应答可以在Warning头域中包含一个原因列表，用于解释为何会话描述不能被支持。在应答中，可以出现一个包含媒体兼容性描述的消息体，这个消息体的格式根据INVITE请求中的Accept头域指出的格式进行规格化（如果没有Accept头域，那么就是application/sdp），就像给OPTIONS亲求的200(OK)应答中的消息一样。我们希望这些媒体协商不要经常需要，并且当一个新用户被邀请加入已经存在的会话的时候，这个媒体协商可能不需要。这取决于邀请的初始化者是否需要对606（Not Acceptable）进行处理。这个应答只有当客户端知道没有其他终端能够处理这个请求的时候才能发出。

#### Header  ﬁelds

- SIP（Session Initiation Protocol）的头字段在语法和语义上与HTTP头字段非常相似。比如，SIP头字段遵循消息头的语法定义和扩展头字段跨多行的规则。然而，后者在HTTP中使用隐式的空格(space)和折行(folding)来指定。SIP仅使用显式的空格和折行作为语法的一部分。这样做是为了确保数据的一致性和可读性。因此，SIP头字段与HTTP头字段在语法和语义上相似，但在折行规则方面有所不同。

  - HTTP头字段folding规定：为了方便处理每行的998/78字符限制，头字段的字段内容部分可以拆分为多行表示，这被称为"折行(folding)"。一般规则是，在标准允许折行空白（不仅仅是WSP字符）的位置，可以在任何WSP之前插入CRLF。

    - WSP字符是指"White Space"字符，即空白字符。在RFC 2822中，WSP字符包括空格（SP）和制表符（Horizontal Tab,HT）。

  - 如果多个具有相同字段名称且值为逗号分隔列表的头字段可以合并为一个头字段。这同样适用于SIP，但由于语法不同，具体规则也有所不同。

    - ```
      假设有两个SIP消息，每个消息都包含一个"Accept"头字段，值为逗号分隔的媒体类型列表
      
      SIP消息1:
      Accept: application/json, text/html
      
      SIP消息2:
      Accept: application/xml, audio/mp3
      
      具有相同字段名的多个头字段可以合并为一个头字段。因此，这两个SIP消息可以合并为一个SIP消息，其中"Accept"头字段的值是两个消息中"Accept"头字段的所有值的组合。
      
      合并后的SIP消息:
      Accept: application/json, text/html, application/xml, audio/mp3
      ```

    - 允许将相同名称的头字段合并为逗号分隔的列表。在SIP中，"Contact"头字段允许使用逗号分隔的列表，除非头字段的值为"*"


##### Header Field Format

- 头字段是由字段名称、冒号（":"）、字段内容组成的行，并以CRLF（回车换行）结束。字段名称必须由可打印的US-ASCII字符组成（即取值在33到126之间的字符），除了冒号。字段内容可以由任何US-ASCII字符组成，但不能包含CR（回车）和LF（换行）字符。然而，在头部的“折叠”和“展开”中，字段内容可以包含CRLF

  - ```http
    field-name: field-value
    ```

    - 允许在冒号的两侧使用任意数量的空白字符。然而，实现应该避免在字段名称和冒号之间使用空格，并在冒号和字段值之间使用单个空格（SP）。

- 头字段可以通过在额外的行之前使用至少一个SP（空格）或HT（水平制表符）来拓展到多行。换行和下一行开头的空白被视为一个单独的SP字符。

- 具有不同字段名称的头字段的相对顺序不重要。然而，建议将那些需要用于代理处理的头字段（例如Via，Route，Record-Route，Proxy-Require，Max-Forwards和Proxy-Authorization）出现在消息的顶部，以便于快速解析。

- 具有相同字段名称的头字段行的相对顺序很重要。如果消息中的整个字段值被定义为逗号分隔的列表（即遵循第7.3节定义的语法），则可以在消息中存在具有相同字段名称的多个头字段行。将多个头字段行组合成一个"字段名：字段值"对必须是可行的，而且不会改变消息的语义，只需将每个后续的字段值用逗号分隔附加到第一个字段值后即可。

  - 这个规则的例外是WWW-Authenticate，Authorization，Proxy-Authenticate和Proxy-Authorization头字段。这些字段名称的多个头字段行可以在消息中存在，但由于它们的语法不符合“逗号分隔的列表”，它们不能被合并为单个头字段行。
  - Implementations必须能够处理具有相同名称的多个头字段行，无论是单值每行形式还是逗号分隔值形式的任何组合。

- 头字段值的格式根据头字段名进行定义。它可以是不透明的TEXT-UTF8八位组序列，也可以是由空白字符、标记、分隔符和引号括起来的字符串组合而成。许多现有的头字段将遵循值后面是用分号分隔的参数名和参数值对的一般形式

  - ```
    field-name: field-value *(;parameter-name=parameter-value)
    
    Content-Type头字段的值可以是以下格式：
    
    text/plain; charset=utf-8
    
    "text/plain"是值，"charset"是参数名，"utf-8"是参数值。
    ```

  - 不同的头字段可能具有不同的值格式和语法规则。实现应该根据每个头字段的定义来解析和处理头字段值。

  - 确保了头字段值的灵活性，允许在每个头字段中使用不同的格式和参数。

  - 尽管可以将任意数量的参数对附加到头字段值上，但任何给定的参数名不能出现超过一次。

    - 在一个头字段值中，不允许出现重复的参数名。每个参数名应该是唯一的，并且与其对应的参数值一起定义头字段的语义和行为。
    - 确保了头字段值的一致性和可解析性，防止重复参数名引起的混淆或歧义。

- 当比较头字段时，字段名始终是不区分大小写的。除非在特定头字段的定义中另有说明，字段值、参数名和参数值都是不区分大小写的。标记（tokens）始终不区分大小写。除非另有规定，以引号括起来的字符串的值是区分大小写的。

  - 在比较头字段时，不应考虑字段名的大小写差异。而对于字段值、参数名和参数值，通常也应该忽略大小写。只有在特定头字段的定义中明确指定了大小写敏感性，比如以引号括起来的字符串，才需要区分大小写。
  - 确保了头字段的一致性和可比较性，同时允许一些特定字段的值区分大小写。

- Some   headers   are   mandatory   in   every   SIP   request   and   response

  - | header              | example                                               |
    | ------------------- | ----------------------------------------------------- |
    | To header           | To:SIP-URI(;parameters)                               |
    | From header         | From: SIP-URI(;parameters)                            |
    | Call-ID header      | Call-ID: unique-id                                    |
    | CSeq header         | CSeq: digit method                                    |
    | Via header          | Via: SIP/2.0/[transport-protocol] sent-by(parameters) |
    | Max-Forwards header | Max-Forwards: digit                                   |
    | Contact header      | Contact: SIP-URI(;parameters)                         |

    - that the brackets around parameters indicate that they are optional

##### Header Field Classification

- 有些头字段只在请求或响应中有意义。它们分别被称为请求头字段和响应头字段。
  - 在处理消息时，如果一个头字段出现在不符合其类别的消息中，Implementations必须忽略该头字段，不应该对其进行处理或使用。
  - 确保了头字段的正确使用和解析，防止在不适当的上下文中使用头字段引起的混淆或错误。

##### Compact Form

- SIP提供了一种表示常见头字段名称的缩写形式的机制。当消息本身过大以至于无法在可用的传输中传送（例如使用UDP时超过了最大传输单元（MTU）），这种缩写形式就会很有用。
  - 可以随时用紧凑形式替代头字段名称的长形式，而不会改变消息的语义。
  - 一个头字段名称可以在同一个消息中同时以长形式和短形式出现。
  - Implementations必须接受每个头字段名称的长形式和短形式。

#### Body

- 在请求中，可以根据需要添加消息正文，而在响应中，响应的方法和状态码决定了消息正文的类型和解释。

##### Message Body Type

- 消息正文的互联网媒体类型必须由Content-Type头字段指定。如果消息正文经过了压缩等编码处理，则必须通过Content-Encoding头字段进行指示；否则，Content-Encoding必须省略。如果适用，消息正文的字符集会作为Content-Type头字段值的一部分进行指示。
  - RFC 2046中定义的"multipart" MIME类型可以在消息的正文中使用。如果远程Implementations通过不包含multipart的Accept头字段请求，发送请求的实现必须将会话描述作为非multipart消息正文发送。
  - SIP消息可以包含二进制正文或正文部分。如果发送方没有提供显式的字符集参数，"text"类型的媒体子类型的默认字符集值被定义为"UTF-8"。

##### Message Body Length

- 在SIP中，消息的消息体长度以字节为单位由Content-Length头字段提供。
- SIP不允许使用HTTP/1.1的"chunked"传输编码方式。
  - chunked编码修改消息体，将其分割成一系列具有自己大小指示符的块进行传输。

#### Framing SIP Messages

- 与HTTP不同，SIP实现可以使用UDP或其他不可靠的数据报协议。每个数据报携带一个请求或响应。不可靠传输的使用有限制。
- 在处理通过面向流的传输方式传输的SIP消息时，Implementations必须忽略在起始行之前出现的任何CRLF。
- Content-Length头字段的值用于在流中定位每个SIP消息的结束位置。当SIP消息通过面向流的传输方式发送时，Content-Length头字段将始终存在。

### General User Agent Behavior

- 用户代理（User Agent）代表终端系统。它包含一个用户代理客户端（UAC），用于生成请求，以及一个用户代理服务器（UAS），用于响应请求。UAC能够根据外部刺激（用户点击按钮或PSTN线路上的信号）生成请求，并处理响应。UAS能够接收请求，并根据用户输入、外部刺激、程序执行的结果或其他机制生成响应。
- 当UAC发送请求时，请求会经过一些代理服务器，这些代理服务器将请求转发到UAS。当UAS生成响应时，响应会被转发到UAC。
- UAC和UAS的行为取决于两个因素。首先，基于请求或响应是否在对话(dialog)内部或外部，其次，基于请求的方法。对话代表了用户代理之间的点对点关系，并通过特定的SIP方法（如INVITE）建立。
- 讨论UAC和UAS在处理在对话外部的请求时的方法无关的规则。这当然包括那些自身建立对话的请求。
- 具体而言，存在机制用于UAS和UAC进行相互身份验证。同时，通过使用S/MIME对消息正文进行加密，还支持有限的隐私功能。

#### UAC 行为

- UAC在对话(dialog)之外的规则

##### Generating the Request

- 当UAC生成一个有效的SIP请求时，至少必须包含以下头字段：To，From，CSeq，Call-ID，Max-Forwards和Via。这些头字段在所有SIP请求中都是必需的。这六个头字段是SIP消息的基本构建模块，它们共同提供了大部分关键的消息路由服务，包括消息的寻址、响应的路由、消息传播的限制、消息的排序和事务的唯一标识。
- 在对话之外发送的请求的示例包括用于建立会话的INVITE请求和用于查询功能的OPTIONS请求

###### Request-URI

- 消息的初始Request-URI应设置为To字段中的URI值。值得注意的例外是REGISTER方法；出于隐私或方便起见，将这些字段设置为相同的值可能是不可取的（特别是如果源用户代理希望在传输过程中更改Request-URI）。
- 在某些特殊情况下，现有路由集合的存在可以影响消息的Request-URI。现有路由集合是一个有序的URI集合，用于标识一系列服务器，UAC将向其中发送在对话之外的传出请求。通常情况下，这些路由集合是由用户或服务提供商手动配置在用户代理上，或者通过其他非SIP机制进行配置的。当服务提供商希望为用户代理配置出站代理时，建议使用一个包含单个URI（即出站代理的URI）的现有路由集合进行配置。
- 当存在现有路由集合时，必须遵循填充Request-URI和Route头字段的过程（即使没有对话），使用所需的Request-URI作为远程目标URI。

###### To

- To头字段首先指定了请求的期望的“逻辑”接收者，或者是请求的目标用户或资源的地址记录。这可能是请求的最终接收者，也可能不是。To头字段可以包含SIP或SIPS URI，但在适当的情况下，也可以使用其他URI方案（例如tel URL，RFC 2806 [9]）。所有的SIP实现都必须支持SIP URI方案。任何支持TLS的实现都必须支持SIPS URI方案。To头字段允许使用显示名称。


- UAC可以通过多种方式了解如何填充特定请求的To头字段。通常情况下，用户会通过人机界面建议To头字段，可能手动输入URI或从某种地址簿中选择。用户通常不会输入完整的URI，而是输入一串数字或字母（例如“bob”）。如何解释此输入取决于用户代理的自主选择。使用该字符串形成SIP URI的用户部分意味着用户代理希望该名称在SIP URI中“@”符号右侧（例如sip:bob@example.com）的域中解析。使用该字符串形成SIPS URI的用户部分意味着用户代理希望进行安全通信，并且该名称在“@”符号右侧的域中解析。右侧域通常是请求者的本地域，允许本地域处理传出请求。这对于需要在本地域中解释用户部分的诸如“速拨”之类的功能非常有用。当用户代理不希望指定应该解释用户输入的域时，可以使用tel URL。而是，通过请求经过的每个域都有机会解释该号码。例如，机场中的用户可能通过机场的出站代理登录并发送请求。如果他们输入“411”（这是美国本地电话簿查询的电话号码），那么这个号码需要由机场的出站代理解释和处理，而不是用户的本地域。在这种情况下，tel:411是正确的选择。


- 在对话(dialog)之外的请求中，不能包含To标签；请求中To字段的标签用于标识对话的对等方。由于没有建立对话，因此没有标签存在。

- ```
  To: Carol <sip:carol@chicago.com>
  ```

###### From

- From头字段指示请求的发起者的逻辑身份，可能是用户的地址记录。与To头字段类似，它包含一个URI和可选的显示名称。SIP元素使用它来确定对请求应用哪些处理规则（例如，自动呼叫拒绝）。因此，非常重要的是，From URI不应包含IP地址或UA运行的主机的FQDN，因为这些不是逻辑名称。

- From头字段允许使用显示名称。如果需要隐藏客户端的身份，UAC应该使用显示名称“Anonymous”，以及一个在语法上正确但没有其他意义的URI（例如sip:[thisis@anonymous.invalid](mailto:thisis@anonymous.invalid)）。

- 通常情况下，由特定UA生成的请求中填充From头字段的值是由用户或用户所在本地域的管理员预配置的。如果一个特定的UA被多个用户使用，它可能具有可切换的配置文件，其中包括与配置文件化用户的身份相对应的URI。请求的接收者可以通过对请求的发起者进行身份验证来确定他们是否是From头字段所声称的人（有关身份验证的更多信息，请参见第22节）。

- From字段必须包含由UAC选择的新的“tag”参数。

  - ```
    From: "Bob" [sips:bob@biloxi.com](javascript:void(0)) ;tag=a48s
    From: sip:[+12125551212@phone2net.com](mailto:+12125551212@phone2net.com);tag=887s
    From: Anonymous [sip:c8oqz84zk7z@privacy.org](javascript:void(0));tag=hyh8
    ```

###### Call-ID

- Call-ID头字段充当一个唯一标识符，用于将一系列消息分组在一起。对话中的所有请求和响应都必须使用相同的Call-ID。在每个UA的注册中，它应该是相同的。

- 在没有任何对话的情况下，由UAC创建的新请求中，Call-ID头字段必须由UAC选择为一个全局唯一的标识符，跨越空间和时间，除非被特定方法的行为覆盖。所有的SIP UAs必须有一种方法来确保它们生成的Call-ID头字段不会被任何其他UA意外生成。请注意，在针对某些故障响应的重试请求（例如，用于身份验证的挑战）之后，这些重试请求不被视为新请求，因此不需要新的Call-ID头字段；

- 建议在生成Call-ID时使用加密随机标识符（RFC 1750 [12]）。实现可以使用"localid@host"的形式。Call-ID是区分大小写的，并且仅通过逐字节比较进行比较。使用加密随机标识符提供了一定程度的会话劫持保护，并降低了意外Call-ID碰撞的可能性。

- ```
  Call-ID: f81d4fae-7dec-11d0-a765-00a0c91e6bf6@foo.bar.com
  ```

###### CSeq

- CSeq头字段用于识别和排序事务。它由一个序列号和一个方法组成。方法必须与请求的方法匹配。对于对话之外的非注册请求，序列号的值是任意的。序列号的值必须能够表示为32位无符号整数，并且必须小于2的31次方。只要遵循上述准则，客户端可以使用任何机制来选择CSeq头字段的值。

  - ```
    CSeq: 4711 INVITE
    ```

###### Max-Forwards

- Max-Forwards头字段用于限制请求在传输到目的地时经过的跳数。它由一个整数组成，每经过一个跳数就会减一。如果Max-Forwards的值在请求到达目的地之前达到0，它将被拒绝，并返回一个483（Too Many Hops）的错误响应。
- 每个UAC在发起的每个请求中都必须插入一个Max-Forwards头字段，其值应为70。选择这个数字是为了保证在没有循环的情况下，请求不会在任何SIP网络中丢失，同时也不会在出现循环时消耗代理资源。较低的值应谨慎使用，并且只在UA已知网络拓扑的情况下使用。

###### Via

- Via头字段表示用于事务的传输方式，并标识响应将被发送到的位置。只有在选择用于到达下一跳的传输方式之后，才会添加Via头字段值。
- 当UAC创建请求时，必须在该请求中插入一个Via头字段。头字段中的协议名称和协议版本必须分别为SIP和2.0。Via头字段值必须包含一个branch参数，该参数用于标识由该请求创建的事务。该参数由客户端和服务器都使用。
- branch参数值必须对于UA发送的所有请求在空间和时间上是唯一的。这个规则的例外是非2xx响应的CANCEL和ACK。如下所述，CANCEL请求的branch参数值与其取消的请求相同。非2xx响应的ACK也具有与其所确认的INVITE相同的分支ID。
- branch ID参数的唯一性属性，以便将其用作事务ID，不是RFC 2543的一部分。

###### Contact

- Contact头字段提供了一个SIP或SIPS URI，用于与该特定UA实例进行后续请求的联系。在可能导致对话建立的任何请求中，Contact头字段必须存在且只包含一个SIP或SIPS URI。对于本规范中定义的方法，这仅包括INVITE请求。对于这些请求，Contact的范围是全局的。也就是说，Contact头字段的值包含了UA希望接收请求的URI，即使在任何对话之外的后续请求中使用，该URI也必须有效。

- 如果请求URI或顶级Route头字段的值包含SIPS URI，则Contact头字段也必须包含SIPS URI。

###### Supported and Require

- 如果UAC支持服务器可以应用于响应的SIP扩展，UAC应该在请求中包含一个Supported头字段，列出这些扩展的选项标签

- 在请求中，可以根据需要添加消息正文，而在响应中，响应的方法和状态码决定了消息正文的类型和解释。

- 列出的选项标签必须仅指向在标准跟踪RFC中定义的扩展。这是为了防止服务器坚持要求客户端实现非标准的、供应商定义的功能以获得服务。实验性和信息性RFC定义的扩展明确被排除在请求中的Supported头字段的使用之外，因为它们通常被用于记录供应商定义的扩展。

- 如果UAC希望坚持UAS理解UAC将应用于请求以处理请求的扩展，它必须在请求中插入一个Require头字段，列出该扩展的选项标签。如果UAC希望将扩展应用于请求，并坚持任何经过的代理理解该扩展，它必须在请求中插入一个Proxy-Require头字段，列出该扩展的选项标签。

- 与Supported头字段一样，Require和Proxy-Require头字段中的选项标签必须仅指向在标准跟踪RFC中定义的扩展。

- ```
  INVITE sip:example@example.com SIP/2.0
  Via: SIP/2.0/UDP 192.0.2.1:5060;branch=z9hG4bK12345678
  From: <sip:user@example.com>;tag=12345
  To: <sip:example@example.com>
  Call-ID: 98765@192.0.2.1
  CSeq: 1 INVITE
  Supported: 100rel, replaces
  Contact: <sip:user@example.com>
  Content-Type: application/sdp
  Content-Length: 123
  
  ...SDP body...
  ```

###### Additional Message Components

- 一旦创建了一个新的请求，并且上述描述的头字段已经正确构建，任何所需的额外可选头字段都会被添加，以及特定于该方法的头字段。
- SIP请求可以包含一个MIME编码的消息体。无论请求包含何种类型的消息体，都必须构建特定的头字段来描述消息体的内容

##### Sending the Request

- 根据本地策略，计算请求的目标。除非本地策略另有规定，否则必须按照DNS程序确定目标，具体步骤如下。如果路由集中的第一个元素指示了一个严格的路由器，则必须将程序应用于请求的请求URI。否则，程序将应用于请求中第一个路由头字段的值（如果存在），或者应用于请求的请求URI（如果没有路由头字段）。这些程序将产生一组有序的地址、端口和传输方式进行尝试。
  - 严格路由器是指在SIP通信中，路由器严格按照路由集合中指定的顺序将请求发送到下一个目的地。如果第一个元素是严格路由器，那么请求将按照其指定的顺序进行路由。这意味着请求的目的地必须是路由集合中的下一个地址。
  - 宽松路由是指在SIP通信中，路由器可以根据自身的策略和规则，在路由集合中选择一个目的地来发送请求。它不一定需要严格按照路由集合中的顺序进行路由，可以根据特定的规则选择一个合适的目的地。
  - 在SIP协议中，严格路由器和宽松路由的选择取决于路由集合中的第一个元素。如果第一个元素是严格路由器，那么整个路由集合都将按照严格路由的方式进行处理。如果第一个元素不是严格路由器，那么就可以使用宽松路由的方式进行选择。
  - 需要注意的是，严格路由器和宽松路由是根据路由集合中的元素来决定的，并不是所有的路由器都支持这两种方式。具体的路由器行为取决于其实现和配置。
- 本地策略可以指定要尝试的备选目标集。如果请求URI包含SIPS URI，则必须使用TLS与任何备选目标进行联系。除此之外，如果请求中不包含路由头字段，则对备选目标没有任何限制。这为预先存在的路由集提供了一种简单的备选方案，用于指定出站代理。然而，不建议使用这种配置出站代理的方法；应改为使用带有单个URI的预先存在的路由集。如果请求包含路由头字段，则应将请求发送到其顶部值派生的位置，但可以发送到UA确定将遵守本文档中指定的路由和请求URI策略（而不是RFC 2543中的策略）的任何服务器。特别是，配置了出站代理的UAC应尝试发送请求到第一个路由头字段值所示的位置，而不是采用将所有消息发送到出站代理的策略。
- 这样可以确保不添加Record-Route头字段值的出站代理将退出后续请求的路径。它允许无法解析第一个路由URI的端点将该任务委托给出站代理。
- UAC应按照定义的有状态元素的程序进行操作，尝试每个地址，直到联系上服务器。每次尝试都构成一个新事务，因此每个都带有具有新分支参数的不同顶部Via头字段值。此外，Via头字段中的传输值设置为确定目标服务器的传输方式。

##### Processing Responses

- 响应消息首先经过传输层进行处理，然后传输到事务层。事务层执行自己的处理流程，然后将响应传递回事务用户（TU）。在TU中，大部分响应处理流程与具体的方法相关。然而，也存在一些基本的处理方式不依赖于具体的方法。

###### Transaction Layer Errors

- 在某些情况下，事务层返回的响应消息不是SIP消息，而是一个事务层错误。当从事务层接收到超时错误时，它必须被视为408错误。如果传输层报告了致命的传输错误（通常是由于UDP中的致命ICMP错误或TCP连接错误），这种状态必须被视为503错误代码（服务不可用）。

###### Unrecognized Responses  

- UAC必须处理任何未分类的最终响应消息，并且UAC还必须能够处理任何以x00开头的响应消息。例如，如果UAC收到一个响应代码为431的未分类响应消息，那么UAC可以合理地认为请求中可能存在错误。UAC必须将临时的响应消息视为与100响应不同，并且不将其视为183响应消息。UAC必须能够处理100响应和183响应消息。

###### Vias

- 如果响应消息中出现多个Via头字段值，UAC应该丢弃该消息。多个Via头字段值的出现是由请求发起方放置的值，这些消息是由于错误的设置或配置文件损坏导致的。

###### Processing 3xx Responses

- 客户端在处理转发协议时，应该基于转发请求，在Contact头中使用URL重新构建一个或多个新的请求。这个过程与代理对3xx类别响应的递归处理类似客户端在启动时携带初始的目标地址列表，其中包含完整的URL。这个URL是初始请求的请求地址。如果客户端希望基于3xx重构新的请求，它会将这些URL放入目标列表中。在这个规范中，对目标组的限制是，客户端可以选择将哪些URL放入目标组中。当代理进行递归处理时，客户端处理3xx类别响应时，一定不能再次将任何已经给定的URL添加到目标组中。如果初始请求中的Request-URL已经是一个SIPS URL，客户端可以选择递归到一个非-SIPS URI，但是应该通知转发用户，这是一个不安全的URL。

- 任何新的请求都可以接收到3xx响应，这些响应自身包含初始的URL作为联系方式。可以配置两个地址进行互相转发。在目标地址组中放置一个给定的URL的目的是防止发生无限转发环路。

- 当目标组设置增加时，客户端可以按任何顺序生成新的请求。一般的机制是在Contact头中设置一个"q"参数值来表示顺序。对于基于URL生成的请求，可以选择并行方式或连续方式处理。一种方式是连续处理递减的q-值组，并以并行方式处理每个q-值组中的URL。另一种方式是按照递减的q-值顺序，只进行连续处理，在相同q-值的联系方式之间任意选择一个值。

- 如果在列表中的联系方式连接失败，则继续连接列表中的下一个地址，直到列表中的所有地址连接失败。如果所有地址连接都失败，则该请求被认为是失败的。失败的结果应该通过失败的响应码（响应码大于399）来检测；对于网络错误，客户端事务层将向事务层用户报告传输层发生的错误。需要注意的是，一些响应码（参见8.1.3.5）表示请求可以被重新获取；重新发送请求不应被视为失败的响应。

- 当收到针对特定联系方式地址的失败时，客户端应该尝试下一个联系方式地址。这将导致为发送的新请求创建一个新的客户端事务。

- 为了基于联系方式地址在3xx响应中创建请求，除了"method-param"和"header" URI之外，UAC必须从目标组中复制所有的URL到Request-URI中。它使用"header"参数为新请求创建头值，覆盖和转发请求中相关的头字段值，具体操作规范请参考19.1.5章节。

- 需要注意的是，在一些例子中，已经建立通信关系的头可以替换或追加到已存在的请求头中，这些请求头是在初始转发请求中的头部。作为一个一般规则，如果头字段可以接受以逗号隔开的域值列表，那么新的头值可以追加到初始转发请求中。如果头字段不支持追加多个值，初始转发请求中的值可以被联系方式地址中已建立通信关系的头字段值覆盖。例如，如果返回的联系方式地址携带如下值：

  - ```
    sip:user@host?Subject=foo&Call-Info=[http://www.foo.com](http://www.foo.com/)
    
    ```

- 那么初始转发请求中的Subject头可以被覆盖，但是这个HTTPURL很少被追加到任何已存在的Call-Info头值中。

- 规范建议UAC重用初始转发请求中的To、From和Call-ID，但是UAC也可以选择更新Call-ID以支持新的请求。

- 最后，一旦生成了一个新的请求，新请求将使用一个新的客户端事务发送，因此必须在顶部的Via头中生成一个新的分支ID。

- 从另一个角度来看，期望的转发响应接收方将头字段和消息体重用于初始请求。

- 在一些例子中，Contact头字段的值可能在UAC端被临时或永久缓存，这取决于收到的状态码和内部超时设置状态。

###### Processing 4xx Responses  

- 当收到401（Unauthorized）或407（Proxy Authentication Required）响应时，用户代理（UA）应按照第22.2章和第22.3章的认证处理流程重新发送请求以获取安全消息。
- 如果收到413（Request Entity Too Large）响应，即请求体大小超过服务器可接受的大小（21.4.11），如果可能，UA应该重新发送请求，可以忽略请求体或重新发送一个较小的请求体。
- 如果收到415（Unsupported Media Type）响应，即请求中包含服务器不支持的媒体类型（第21.4.13章），UA应该重新发送请求，仅使用响应消息中列出的支持的内容类型，这些支持的类型可以在Accept-Encoding头或Accept-Language的语言列表中找到。
- 如果收到416（Unsupported URI Scheme）响应，即服务器不支持请求中使用的URI scheme（第21.4.14章），客户端应该重新发送请求，这次使用SIP URI。
- 如果收到420（Bad Extension）响应，即请求中的option-tag标签包含Require或Proxy-Require头值，并且这些标签支持的功能是代理或UAS无法支持的（第21.4.15章），UA应该重新发送请求，并忽略任何不支持的拓展头字段。
- 在上述情况中，请求的重发是通过创建一个新的请求来完成的，新请求可能需要进行一些必要的修改以满足协商机制。这个新请求将创建一个新的事务，并且应该具有与原始请求相同的Call-ID和To头值，但CSeq应该包含一个新的序列号，这个序列号比原请求的序列号高。
- 对于其他的4xx响应以及未定义的响应，是否重发请求取决于使用的方法和用户场景。

#### UAS Behavior

- 当UAS处理一个处于dialog外部的请求时，规范规定了一系列的处理流程，这些流程与请求的方法（method）无关。在第12章中有一个指导，指导UAS如何识别请求是处于内部还是外部的dialog。需要注意的是，这些请求的处理是非常确定的。具体来说，如果接受了这样的请求，就必须执行与该请求相关的所有状态修改。如果拒绝了此请求，就不能执行与该请求相关的任何状态修改。
- 根据规范，UAS应该按照以下步骤处理请求：开始进行认证处理，检查请求的方法，检查头字段，并按照本章节的其他处理步骤进行处理。

##### Header Inspection

如果UAS无法理解请求中的某个头字段（即规范中未定义该头字段或规范不支持该扩展头），服务器必须忽略该头字段并继续处理消息。如果出现异常的头字段，UAS应该忽略异常的头字段值，因为这些头字段值对进一步处理请求没有必要。

###### To and Request-URI

- To头字段定义了请求的初始接收方，即由From头字段中定义的用户发起的请求。由于可能存在呼叫前转或其他代理操作，初始接收方可能是正在处理该请求的UAS，也可能不是。当To头字段不是UAS的确认身份时，UAS可以使用任何策略来决定是否接受请求。然而，规范推荐UAS接受请求，即使它们无法识别To头字段中的URI scheme（例如，tel:URL），或者如果To头字段不能处理UAS已知的或当前用户。如果UAS决定拒绝请求，它应该生成一个响应消息，响应状态码为403（Forbidden），并将该响应码返回给服务器事务层的传输。
- 如果Request-URI定义了UAS来处理该请求。如果Request-URI使用的scheme不是UAS所支持的scheme，它应该拒绝该请求，并返回一个416（Unsupported URI Scheme）的响应消息。如果Request-URI没有定义一个地址，即地址是UAS愿意接受该请求的地址，它应该拒绝该请求，并返回一个404（Not Found）的响应消息。在典型的环境中，一个UA会使用REGISTER方法将自己的address-of-record（aor）绑定到一个具体的contact地址上，contact地址可以是多个地址形式。UA将会看到请求中的Request-URI地址与contact地址相同。其他潜在地址源接收Request-URIs包括请求的Contact头和由UA发送到响应地址源，该响应地址源是用于创建或刷新dialogs的地址。

###### Merged Requests

- 如果请求中的To头字段没有标签（tag），UAS核心必须进行比对检查将要处理的事务。如果From标签（tag），Call-ID和CSeq与将要处理的事务完全匹配，但是请求事务（transaction）的话，UAS核心应该生成一个482（Loop Detected）的响应消息，并将该响应传递给该服务器的事务层。

###### Require

##### Content Processing

- 假设UAS能够理解所有客户端请求的扩展功能，然后UAS会检查消息体的内容和头字段。如果其中任何消息的类型（由Content-Type表示）、语言（由Content-Language表示）或编码（由Content-Encoding表示）不被支持，并且消息体部分不是一个可选值（由Content-Disposition头表示），UAS必须拒绝该请求，并返回一个错误状态码415（Unsupported Media Type）的响应。这个响应必须包含一个Accept头的列表，列表表示UAS可以理解的消息体类型，并且在列表中包含UAS无法理解的消息体类型。
- 如果UAS无法理解请求中包含的内容编码方式，UAS响应中必须包含一个UAS可接受的Accept-Encoding头列表，该列表列出了UAS支持的解码方式。如果UAS无法理解请求头中列出的支持的内容语言，响应中必须包含一个Accept-Language头，该头列出了UAS支持的语言。

##### Applying Extensions  

- 当UAS生成响应消息时，不能直接期望使用扩展功能，除非请求中的Supported头字段已表示支持该扩展。如果所希望的扩展不被支持，服务器应仅依赖基本的SIP和其他客户端支持的扩展来处理。在极少数情况下，如果服务器不能处理请求而没有扩展支持，服务器可以发送一个421（Extension Required）的响应消息。这个响应消息表示，如果没有特定的扩展功能，服务器无法生成规范的响应。这些服务器所需支持的扩展必须包含在响应消息的Require头字段中。规范不推荐使用这种方式，因为它可能破坏流程的兼容性处理。
- 任何在非421响应中列出的扩展功能必须包含在响应消息的Require头列表中。当然，服务器也不能使用在请求的Supported头中未列出的扩展。因此，响应消息中的Require头字段只能包含在标准RFC中定义的可选标签中。

##### Stateless UAS Behavior  

- Stateless UAS Behavior是关于无状态UAS的行为的内容。无状态UAS是一种不保存事务状态的UAS，它会转发请求并且在发送后丢弃自身的状态消息。无状态UAS的重要处理方式包括以下几个方面：
  1. 无状态UAS不能发送临时响应(1xx)。
  2. 无状态UAS不能重复发送响应消息。
  3. 无状态UAS必须按照规则处理请求的结构和流程，这些规则控制请求的结构和生成响应的消耗 。
  4. 无状态UAS在核心网元模块中可能会与有状态代理一起使用，但其与有状态UAS在其他方面的处理规范是一样的 。

#### Redirect Servers  

重定向服务器扮演着重要的角色，它们能够接收请求并生成3xx响应，将用户重定向到另一个URI地址。重定向服务器的部署可以降低处理负载并优化信令路径。然而，需要注意的是，攻击者可能会冒充远程服务器并拦截用户代理发送的请求。

为了确保安全部署，重定向服务器、代理服务器和注册服务器必须遵循第22章的要求。它们应该配置至少一个摘要realm域，并且服务器支持的realm字符串应与服务器主机名或选定的服务器相关联。如果请求不符合服务器的配置，服务器可能会拒绝连接或丢弃请求，而不是以503服务不可用的状态码进行响应。

重定向服务器的作用是将用户重定向到另一个URI地址，从而提高网络的扩展性。它们由服务器事务层和事务用户组成，事务用户可以访问特定的位置服务获取额外的注册和位置信息。

### Canceling a Request

- 取消请求（CANCEL）的处理流程在SIP中是通过发送CANCEL请求来实现的。对于基于最终响应的待处理客户端事务的CANCEL请求，不能保证对于一个INVITE请求，终端将不会收到多个200（OK）响应。取消请求的处理方式取决于服务器类型和具体实现方式，有状态代理可能会生成自己的CANCEL请求来取消之前的请求，并生成响应消息，而无状态代理则会将取消请求前转到下一个节点。

- 在处理CANCEL请求时，UAS首先处理该请求，具体处理方式取决于标准的UAS处理方式，但由于CANCEL请求是逐跳处理的，因此不能重新提交该请求。在服务器端执行CANCEL请求的流程也取决于服务器类型，无状态代理会前转取消请求，而有状态代理可能会生成自己的CANCEL请求，基于之前的INVITE请求的超时头部信息。

- 此外，如果被取消的请求中包含Route头字段值，CANCEL请求必须包含该Route头字段的值。

### Registrations

- 注册（Registrations），介绍了SIP中的注册机制。注册是SIP协议提供的一种机制，用于创建绑定关系并将用户代理（User Agent）注册到特定的服务。
- 注册过程涉及到发送REGISTER请求给注册服务器（Registrar），该服务器负责处理注册相关的操作。注册服务类似于定位服务的前端角色，它允许用户代理向特定的域注册，并将相关信息存储在注册服务器中。
- 作为用户代理通过发送REGISTER请求向注册服务器进行注册。REGISTER请求中包含了必要的头字段，如Via、Max-Forwards、To、From、Call-ID等。此外，还可以通过CSeq头字段指定请求的序列号。
- 注册请求被发送给注册服务器，并在成功注册后得到了响应。注册成功后，Bob的用户代理可以通过注册服务器来维护其当前的位置信息，并能够接收来自其他用户代理的通信请求
- 通过注册机制，SIP协议提供了一种灵活的方式来管理用户代理的注册信息，并允许用户代理在网络中可用和可发现。

### Querying for Capabilities  

- SIP中使用OPTIONS方法来查询其他用户代理或代理服务器的能力支持
- SIP中的OPTIONS方法允许用户代理查询目的地用户代理或代理服务器的支持能力，包括支持的方法、内容类型、扩展、编解码器等。通过向目的地发送OPTIONS请求，用户代理可以了解到目的地的能力，而无需进行实际的呼叫或会话。
- OPTIONS请求中的头字段可以包含一些信息，例如Require头选项，用于查询目的地是否支持某个特定的选项。目的地用户代理或代理服务器会返回一个OPTIONS响应，其中包含了支持的方法、能力列表等信息。
- 通过查询能力，用户代理可以在发起呼叫之前获取到目的地的能力信息，以便更好地进行呼叫处理和协商。这种方式可以避免在呼叫过程中出现不支持的选项或功能，提高呼叫的成功率和质量。

### Dialog

- SIP中的对话概念和对话的创建、维护以及状态转换。
- 对话（Dialog）在SIP中表示两个用户代理之间的点对点关系，用于支持用户代理之间的通信。对话的创建是通过SIP消息实现的，例如在INVITE请求的2xx响应中创建对话。一个对话由一个呼叫标识符（call identifier）、本地标签（local tag）和远程标签（remote tag）来定义。
- 对话的状态转换和维护流程的详细描述。对话的状态转换包括从早期对话到确认对话的转换，以及对话的终止。对话的状态转换遵循一定的规则和流程，如在收到INVITE请求时的处理规则。
- 对话的创建和维护是SIP协议中的核心功能之一。通过对话，用户代理能够在一段时间内与其他用户代理保持通信，并提供正确的请求路由。

### Initiating a Session

- 在SIP中如何发起一个会话和创建一个或多个SIP对话。
- 会话的发起是通过SIP消息实现的，主要使用INVITE方法。INVITE方法用于邀请另一个用户代理参与一个会话，并创建一个SIP对话。在INVITE请求中，需要包含一些必要的头字段，如From、To、Call-ID等，以及描述会话属性的SDP（Session Description Protocol）信息。
- 发起方（主叫方）发送INVITE请求给目的地用户代理（被叫方），并在接收到200 OK的响应后创建了一个SIP对话。该对话通过唯一的呼叫标识符（call identifier）和本地标签（local tag）与会话参与方关联。
- 会话的发起过程涉及到路由选择、信令交换和媒体协商等步骤。通过INVITE请求和响应，会话参与方可以协商会话的属性和参数，并在对话建立后进行媒体流的交换。
- 通过SIP协议的会话发起功能，用户代理可以向其他用户代理发送INVITE请求，实现实时的语音、视频或文本会话。会话的发起是SIP协议中的核心功能之一，为用户代理之间的点对点通信提供了基础。

### Modifying an Existing Session  

- 如何通过SIP中的INVITE方法来修改已经存在的会话的属性。
- 在SIP中，通过发送INVITE请求可以对已经建立的会话进行修改。这种修改可以涉及地址、端口的变更，增加或删除媒体等细节。这种在同一对话（已经创建的会话）中发送新的INVITE请求来实现会话修改的方式被称为re-INVITE。
- re-INVITE允许会话参与方对已经建立的会话进行更新和调整，以满足会话的需求变化。在re-INVITE请求中，需要包含必要的头字段，如From、To、Call-ID等，以及描述会话属性的SDP（Session Description Protocol）信息。
- 发起方发送一个带有更新会话属性的INVITE请求给目的地用户代理，目的地用户代理则通过200 OK响应来确认会话的修改。
- 通过re-INVITE，会话参与方可以调整会话的属性和参数，以适应不同的需求和场景。这种灵活性和可扩展性使得SIP成为一种强大的协议，用于实现实时媒体会话的动态修改和调整。

### Terminating a Session  

- 如何通过SIP中的BYE请求来结束已经建立的会话。
- 在SIP中，通过发送BYE请求可以终止已经建立的会话。当会话的一方决定结束会话时，它可以发送一个包含必要头字段的BYE请求，如From、To、Call-ID等。BYE请求的构建方式与其他在对话中的请求相同。
- 会话终止的具体行为。当BYE消息构建完成后，用户代理核心（UAC core）会创建一个新的非INVITE客户端事务，并将BYE请求传递给该事务。这个事务负责向目的地用户代理发送BYE请求，并处理相关的响应。
- 会话的终止流程需要遵循一定的规则和机制。BYE请求的发送和处理是会话终止的关键步骤，它们确保会话的安全、可靠地结束。
- 通过SIP协议的会话终止功能，会话参与方可以根据需求主动终止会话，释放相关资源，并结束会话的交互。会话的终止是SIP协议中的重要功能之一，它使得用户代理能够灵活地管理和控制会话的生命周期。

### Proxy Behavior

- 代理服务器的角色：代理服务器在SIP网络中充当转发和路由消息的中间人。它们接收来自客户端的请求，并将其转发到适当的目标。
- 无状态代理：无状态代理是一种简单的消息转发者，不维护任何关于请求或响应状态的信息。它们仅仅将消息转发到下一个节点，不做进一步处理。
- 有状态代理：有状态代理维护请求和响应之间的状态信息。它们可能会对请求进行修改或者执行其他处理操作，例如路由选择、身份验证等。
- 请求处理流程：RFC-3261将请求处理流程分为INVITE和非INVITE两个层面。INVITE层面涉及会话的建立和修改，而非INVITE层面涉及其他所有方法。
- 代理服务器的响应处理：代理服务器在处理响应时需要注意与无状态代理的区别。当无状态代理收到响应时，它必须在顶部的Via头字段中插入“sent-by”值。

### Transactions

- SIP事务的定义：SIP是一个事务协议，它通过一系列相互独立的消息交互来实现模块之间的交互。一个SIP事务由一个单独的请求和对该请求的响应组成。
- SIP事务的组成：一个SIP事务从客户端发出的第一个请求开始，一直到服务器端最终的响应。在此过程中，可能会有多个临时的响应被发送。
- INVITE服务器端事务：针对INVITE请求的服务器端事务有一个特定的状态图。当服务器端事务被创建以支持请求时，它进入“Proceeding”状态。在这个状态下，服务器端事务必须生成一个100（Trying）的临时响应。
- 服务器端事务的状态转换：服务器端事务的状态图示例在RFC-3261的Figure 7中展示。在不同的状态下，服务器端事务的行为和生成的响应可能会有所不同。
- SIP的架构中，语法和解码层是最底层，定义了消息的语法结构。传输层定义了用户如何发送请求和接收响应。事务层是SIP的核心模块，处理用户端事务和服务器端事务的请求和响应。

### Transport

- 传输层在SIP中负责实际的请求和响应传输，包括连接的建立和管理，以及选择适当的传输协议。
- 传输层支持多种传输协议，包括UDP、TCP、TLS和SCTP。其中，UDP是无连接的传输协议，TCP是面向连接的传输协议，TLS是基于TCP的安全传输协议，而SCTP是提供传输层可靠性和多路复用功能的协议
- SIP的传输层负责确定使用哪种传输协议来支持请求或响应的传输，并管理与该传输协议相关的连接的持久性。它负责发送请求、接收响应以及服务器通过网络接收请求和发送响应。
- 传输层的功能还包括处理传输协议的特性，例如TCP和SCTP的连接保持功能，以确保可靠的传输和连接的稳定性。

### Common Message Components

- SIP消息中包含各种模块构件，这些构件出现在SIP消息的不同位置，并且值得分别讨论。该章节详细讨论了这些消息组件。
- 介绍了SIP和SIPS统一资源指示符（URI）。SIP或SIPS URI定义了通信的资源，类似于其他URL。它们可以被嵌入到网页中，遵循SIP请求头字段和SIP消息体细节进行处理。
- 进一步讨论了SIP和SIPS URI的组成。使用"sip:"和"sips:"架构，遵循RFC2396的规范，它们与邮件URL类似，可以设置主题、媒体类型，并且可以在页面中设定URL或邮件中的初始化的紧急情况。
- 涵盖了其他重要的消息组件，如MIME-Version和Organization。MIME-Version字段指定消息的MIME版本，通常为"1.0"。Organization字段用于传输SIP请求签发或应答的网元所属的组织名字，可用于支持客户端软件的过滤。

### Header Fields

- SIP消息中的头字段承载了关于请求或响应的元数据信息，用于描述消息的属性和特性。第20章对头字段进行了分类和解释。
- 介绍了Date头字段，它包含了请求或响应的日期和时间。SIP只支持最近的RFC1123格式的日期，且时区限定为"GMT"。RFC1123日期对大小写敏感。
- 讨论了MIME-Version头字段，该字段指定了SIP消息的MIME版本。通常为"1.0"。
- 涉及Organization头字段，它用于传输SIP请求或响应的网元所属的组织名称。该字段可以用于支持客户端软件的过滤。
- 介绍了Subject头字段，它提供了关于呼叫属性的汇总或指示说明。Subject头字段允许呼叫实现进行过滤，而无需解析会话描述内容。
- 讨论了Supported头字段，它枚举了UAC（User Agent Client）或UAS（User Agent Server）所支持的扩展或特性。

### Response Codes

- 介绍了SIP消息中的响应码，包括临时响应、成功响应、重定向响应、客户端错误响应、服务器错误响应和全局失败响应。
- 21.1节讨论了临时响应，也称为消息响应。它表示连接的服务器正在执行进一步的处理，并且尚未确认响应。临时响应的例子包括100 Trying、180 Ringing和183 Session Progress。
- 21.2节涵盖了成功响应，表示请求已成功处理。其中，21.2.1节描述了200 OK响应，它表示请求已成功，并且返回消息的内容取决于请求中使用的方法。
- 21.3节介绍了重定向响应，提供了有关用户新位置或其他相关信息的响应。常见的重定向响应代码包括302 Moved Temporarily和305 Use Proxy。
- 21.4节讨论了客户端错误响应，表示请求中存在错误。常见的客户端错误响应代码包括400 Bad Request、401 Unauthorized和404 Not Found。
- 21.5节涵盖了服务器错误响应，表示服务器在处理请求时遇到了错误。常见的服务器错误响应代码包括500 Server Internal Error和503 Service Unavailable。
- 21.6节讨论了全局失败响应，表示请求无法在任何地方成功处理。全局失败响应的示例包括600 Busy Everywhere和603 Decline。

### Usage of HTTP Authentication-HTTP

- 介绍了SIP中使用HTTP身份验证的机制。它基于HTTP身份验证的挑战-响应机制，使用401和407响应代码和头字段来传递挑战和安全信息。
- RFC-3261中的第22章对SIP摘要验证的用法进行了详细介绍。摘要验证是基于HTTP摘要验证结构的，并允许重放保护和单向认证。
- 在SIP中，摘要认证方案遵循RFC2617中定义的规范。摘要认证的用法与HTTP的用法几乎完全相同。SIP服务器必须向后兼容RFC2069，并且支持RFC2617。
- Authorization头字段用于包含用户代理进行认证的凭证。该头字段的语法和语义遵循RFC2617的规范。
- 407 Proxy Authentication Required是一个响应代码，类似于401 Unauthorized，但它指示客户端必须首先对代理进行认证。SIP访问认证在第26章和第22.3章中进行了详细说明。

### S/MIME-MIME

- SIP中使用S/MIME和MIME的安全和完整性机制。它涵盖了消息体的加密、签名和验证，以及处理SIP头字段中的差异的规则。
- 在SIP中，S/MIME和MIME被用于提供消息体的安全性和完整性。S/MIME是一种基于PKI的加密和签名协议，而MIME是一种消息格式化协议。
- SIP消息体可以使用"MIME multipart/mixed"消息体或"message/sip"消息体来发送。当使用"S/MIME"机制时，消息体的完整性和安全性属性可能会与外部消息中的属性存在差异。介绍了如何处理这些差异并遵守相应的规则。
- S/MIME的应用需要注意网络中介，如代理服务器，可能需要查看或修改SIP消息体。为了确保MIME的安全性，防止这些中介运行，部署用户应该注意这一点。
- S/MIME还涉及远程证书的使用。发送方的S/MIME消息体应该包含"SMIMECapabilities"属性，以表明发送方的加密和签名能力。

### The  SIP  URI

- The SIP URI follows the same form as an email address: user@domain. There are two URI  schemes
  - sip:bob.smith@nokia.com   is   a   SIP   URI.   This   is   the   most   common   form   and   was introduced  in  [RFC2543].
  - sips:bob.smith@nokia.com    is    a    SIPS    URI.    This    new    scheme    was    introduced    in [RFC3261]  and  requires  TLS  over  TCP  as  transport  for  security.
- There  are  two  types  of  SIP  and  SIPS  URIs
  - Address Of Record (AOR)：this is a SIP address that identiﬁes a user. This address can be handed out to people in much the same way as a phone number: e.g., sip:bob.smith@nokia.com (needs DNS SRV records to locate SIP servers for the nokia.com domain).
  - Fully Qualiﬁed Domain Name (FQDN) or IP address (identiﬁes a device) of the host 。e.g., sip:bob.smith@127.233.4.12 or sip:bob.smith@pc2.nmp. nokia.com (which needs no resolution for routing).
- The   SIP   URI   has   the   form:   `sip:userinfo@hostport[parameters][headers]`.   The   SIPS URI  follows  exactly  the  same  syntax  as  the  SIP  URI
  - Userinfo ： a  user  name  or  a  telephone  number.
  - Hostport ：the  domain  name  or  numeric  network  address  and  port.
  - Parameters ： deﬁnes   speciﬁc   URI   parameters,   such   as   transport,   time   to   live,   etc. 
  - Headers ：another  rarely  used  form  that  passes  on  extra  information.

### The  tel  URI

- The telephone URI (tel URI) is used to identify resources using a telephone number. SIP allows requests to be sent to a tel URI. This means that the request-URI of a SIP request can contain a tel URI.
- The tel URI can contain a global number or a local number. A global number follows the rules of E.164 numbers and starts with a ‘‘+’’, while a local number follows the rules of local private numbering plans. Local numbers need to have the phone-context parameter, which identiﬁes the context (owner) of the local number and, therefore, the scope of the number.

### SIP  structure

- SIP is a layered protocol that allows diﬀerent modules within it to function indepen-dently with just a loose coupling(连接器) between each layer
- ![[image-20221214155656033.png]]
  1. Syntax  and  encoding  layer：Encoding makes use of augmented Backus-Naur Form (BNF) grammar, the complete description 
     of which can be found in [RFC3261].
     - 巴科斯范式（英语：Backus Normal Form，缩写为 BNF），又称为巴科斯-诺尔范式（英语：Backus-Naur Form，缩写同样为 BNF，也译为巴科斯-瑙尔范式、巴克斯-诺尔范式），是一种用于表示上下文无关文法的语言，上下文无关文法描述了一类形式语言。它是由约翰·巴科斯（John Backus）和彼得·诺尔（Peter Naur）首先引入的用来描述计算机语言语法的符号集。
  2. transport layer： As the name indicates, this is the layer that dictates how clients send requests and receive responses and how servers receive requests and send responses. The transport layer is closely  related to the sockets layer of a  SIP  entity.
  3. Transaction  layer：A transaction, in SIP terms, is a request that is sent by a client to a server, along with all responses to that request sent from the server back to the client. The transaction layer handles the matching of responses to requests.Application-layer re-transmissions and application-layer transaction timeouts are also handled in this layer and are dependent on the transport protocol used. A client transaction sends requests and receives responses, while a server transaction receives requests and sends responses. The transaction layer uses the transport layer for sending and receiving requests and responses.The   transaction   layer   has   four   transaction-state   machines.   Each   transaction-state machine  has  its  own  timers,  re-transmission  rules  and  termination  rules
     - INVITE  client  transaction; 
     - non-INVITE  client  transaction; 
     - INVITE  server  transaction; 
     - non-INVITE  server  transaction.
  4. Transaction User (TU) layer
     - This is the layer that creates client and server transactions. When a TUwishes to send a SIP request it creates a client transaction instance and sends the request along with the destination IP address, port and name of the transport protocol to use. TUs are deﬁned to be UAC 
       core and UAS core, or simply UAC and UAS.
       - There are two factors that can aﬀect TUbehaviour: one is the method name in the SIP message and the other is the state of the request with regard to dialogs
     - UAC  behaviour
       - The  To  header  is  populated  with  the  target’s  AOR  (an  AOR  is  similar  to  a  business card  address).
       - The  From  header  is  populated  with  the  sender’s  AOR.  It  is  also  populated  with  a  tag parameter.  The  tag  is  one  of  the  components  used  to  identify  a  dialog.
       - The  Call-ID  header  is  populated  with  an  identiﬁer  that  is  unique.
       - The CSeq header is used to identify the order of transactions. The CSeq number is arbitrary for requests outside a dialog. It contains two parts, a CSeq and a method name separated by a space. The method part is populated with the same method as the one in the request line.
       - The Max-Forwards header is used to limit the number of hops a request traverses and is used to avoid loops. It is typically set to 70 (indicating the number of hops). Each hop decrements the value by 1.
       - The Via header contains two vital pieces of information: the transport protocol and the address where the response is to be sent. The protocol name and value are always set to SIP and 2.0, respectively. The Via header contains a branch parameter that identiﬁes transactions and is used to match requests to responses. It must be unique. The branch inserted by an element compliant with this speciﬁcation always begins with the characters ‘‘z9hG4bK’’.
       - The  Contact  header  is  populated  with  a  URI  that  is  typically  the  address  of  the  host where  the  request  originated.
       - The request-URI is normally populated with the value in the To header. REGISTER requests are special cases in which the request-URI is populated by the registrar address.

### Registration

- SIP supports the concept of user mobility and discovery. A user can make herself available for communication by explicitly binding her AOR to a certain host address. 
  - Address Of Record：ARO
- A user can be registered at many devices simultaneously by sending a REGISTER request from each device. Similarly, a user can create multiple bindings from the same device; this can be achieved by sending one REGISTER request with multiple bindings to the AOR. To do this, a user adds multiple contact headers in the REGISTER request.
- SIP registrations are, by nature, soft-state: this means that registration bindings must be periodically refreshed (updated). The expiration time of a binding is indicated by the registering entity using the expires parameter in a Contact header. If this parameter is not present, the registrar assumes an expiration time of 1 hour.

### Dialogs

- A dialog is a SIP relationship between two collaborators. The dialog provides the necessary states required for the routing and sequencing of messages between those collaborators.
- A dialog state is needed for creating, sending, receiving and processing of messages within a dialog. This state consists of the dialog-ID, a local sequence number, a remote sequence number, a local URI, a remote URI, a remote target, a Boolean ﬂag called a ‘‘secure’’ ﬂag and a route set.
  - via的作用就是标记请求所经过的节点，好让其对应的响应能按照via标记好的路径返回回去；
  - Route set（一个请求或应答中可以包含多个Route标记，这些Route标记称为Route Set）的作用是强制请求必须从Route set中设定的节点通过，Route set的生成可以是手动配置也可以是协议自己生成，需要手动配置的情况如，客户端向registar注册的时候，registar的路径就应该是通过手动配置，协议自己生成的情况如在对话生成前各个proxy往请求中添加Record-Route为了让后续的请求能继续通过该proxy发送，当对话建立好后就确定了后续的请求该走的路由，之后将Record-Route中的记录登记在Route set中来强制请求的路由。
  - Record-Route的是各个想在后续请求对话中还继续接收请求和应答的Proxy，将自己的地址信息添加在Record-Route中来帮助协议生成最终的Route set（也就是为什么说对话中的请求和应答包含的是Route-set，对话外的请求包含的Record-Route的原因，Route set用在对话外的情况就是在注册时客户端最初不清楚该往哪里去注册，需要手动配置，总之一句话，Route set的作用就是强制让请求通过其包含的路由列表传输请求和应答）。

### Session

- A multimedia session consists of a set of multimedia senders and receivers and the data streams that ﬂow between them. Sessions use SIP dialogs and follow SIP rules for sending requests within dialogs.
- INVITE  requests  can  also  be  sent  within  dialogs  to  re-negotiate  the  session  description.
- It is important to remember that all transactions must complete independently of each other.
- A   session   is   terminated   by   a   BYE   request.   The   BYE   request   is   sent   in   exactly   the same  way  as  any  other  request  within  a  dialog.

### The  SDP  Oﬀer/Answer  model  with  SIP

- Using basic SIP, Oﬀer and Answer can only appear in INVITE requests, reliable responses to INVITE requests and ACK requests. 

### Security

- threats  and  attacks：Denial of service、Eavesdropping、Tearing down sessions、Registration hijacking、Session hijacking、Impersonating  a server、Man in the middle
- Security  framework：Authentication、Authorization 、Conﬁdentiality、Integrity、Privacy  、Non-repudiation
- AKA：Authentication and Key Agreement (AKA) protocol
-  random challenge (RAND) 
-  the network authentication token (AUTN)
- S/MIME：Secure Multipurpose Internet Mail Extension (S/MIME) provides message integrity, conﬁdentiality and authentication, which is achieved by protecting SIP headers in an encrypted and/or signed S/MIME SIP message body. It does not require a shared secret.

### SIP  extensions

#### Event notification framework

- SIP has been the extension used for the purpose of event notiﬁcation. A user or resource subscribes to another resource that has an event of interest and receives notiﬁcations of the state and any changes in such an event.The  SIP  SUBSCRIBE  method  is  used  for  subscription  while  the  NOTIFY  method  is used  to  deliver  notiﬁcations  of  any  changes  to  an  event.
- SUBSCRIBE、NOTIFY
  - Event    header    –    this    identiﬁes    the    event    to    which    a    subscriber    is    subscribing    for notiﬁcations.
  - Allow-Events header – this indicates to the receiver that the sender of the header understands the event notiﬁcation framework. The tokens present in the header indicate the event packages that it supports.
  - Subscription-State header – this indicates the status of a subscription. ‘‘Active’’, ‘‘pending’’ and ‘‘terminated’’ are the three deﬁned subscription states. This header also carries the reason for a subscription state: ‘‘deactivated’’, ‘‘probation’’, ‘‘rejected’’, ‘‘timeout’’, ‘‘giveup’’ and ‘‘noresource’’. Extensions are possible for subscription-state and reason values.
  - ‘‘202 Accepted’’ response – this indicates that the subscription request has been preliminarily accepted, but is still pending a ﬁnal decision, which will be indicated in the NOTIFY request.
  - ‘‘489   Bad   Event’’   response   –   this   response   is   returned   when   the   notiﬁer   does   not understand  an  event  as  described  in  the  Event  header.
  - Much like registration, subscriptions are in soft state and need refreshing. The duration of a subscription is indicated in an Expires header. The default value is 1 hour if the header is not present in the SUBSCRIBE request.
- State  publication  (the  PUBLISH  method)
  - The event notiﬁcation framework speciﬁes how to subscribe to the state of an event and how to get notiﬁcation of changes to the state of an event. It does not specify how the state can be published. However, the SIP extension for state publication speciﬁcation [RFC3903] allows a client to publish its event state to the state agent, which acts as the compiler of such state and generating notiﬁcations. This is achieved using the 
    PUBLISH method.
- SIP  for  instant  messaging
  - SIP  is  extended  for  instant  messaging  by  the  introduction  of  the  MESSAGE  method in  [RFC3428].
  - There are two modes of instant message exchange: page mode and session mode. The MESSAGE method is used in page mode. Page mode is a one-shot instant message where a subsequent instant message is not related, at the protocol level, to the preceding one. It is used when a conversation or interaction is not unexpected.

#### Reliability  of  provisional  responses

- It was later discovered that reliability in the transmission of provisional responses in some cases was both important and useful: therefore, 
  [RFC3262] was created. In 3GPP, reliable provisional responses and their acknowledgments are used to exchange additional SDP Oﬀer/Answer messages.
- The reliability of the provisional  responses extension    only    applies    to    INVITE requests.
- A UAC receiving a reliable provisional response responds to it with a provisional response acknowledgment (PRACK) request. The PRACK request carries a RACK header, which reﬂects the value in the RSeq header and that in the CSeq header, in that order.

#### The  UPDATE  method

- The UPDATE method is an extension to SIP that enables UAs to update a session description without having any impact on a dialog. The UPDATE method can be sent within early and conﬁrmed dialogs, but must not be sent if a dialog is not created (i.e., before a dialog-creating provisional response is sent/received). It is constructed like any other request within a dialog.
- UPDATE requests are only used for dialogs created using INVITE requests.An UPDATE request can be sent by the caller (the INVITE UAC) as well as the 
  callee (the INVITE UAS) and is only used for sessions

#### Integration  of  resource  management  and  SIP  (preconditions)

- the caller indicates by means of an SDP oﬀer a set of constraints about the session. The answerer responds to the oﬀer with an SDP answer; however, it neither establishes a session nor does it alert the user

#### The  SIP  REFER  method

- The sender of a REFER request refers the recipient to a resource that is identiﬁed in the REFER request itself
- One application of the REFER method is call transfer. For instance, a secretary receives a call from an associate asking for the manager. The secretary then transfers the call to the manager by sending the associate a REFER request with the manager’s contact information. The associate’s UA then calls the manager by sending an INVITE.
- The receiver of a REFER request typically responds to it with a ‘‘202 Accepted’’ response. Its recipient also creates a subscription and sends notiﬁcations of the outcome. According to the event notiﬁcation framework, a NOTIFY request is gener- ated and sent immediately after accepting the REFER request. 

## SDP

###  Introduction

- SDP是一种用于描述多媒体会话和会话相关信息的协议。它用于在会话发起者和接收者之间交换信息，以便建立和管理多媒体通信会话。SDP提供了一种机制，用于描述会话的参与者、媒体类型、媒体参数、网络传输信息等。
- 在介绍中，指出SDP的主要用途是在多媒体会话初始化阶段，通过交换SDP消息来协商和协调会话的参数和功能。SDP消息包含了关于会话的详细描述，包括媒体流的编码格式、传输地址、会话控制和会话描述等。
- SDP的发展历史和标准化工作。SDP最初由IETF定义于RFC 2327中，后来经过多个版本的迭代和RFC文档的发布，不断完善和发展。RFC 4566取代了RFC 2327，引入了一些变化和更新。

### Glossary of Terms

- Conference：多媒体会议是一组两个或更多的通信用户及其用于通信的软件。
- Session：多媒体会话是一组多媒体发送者和接收者，以及从发送者到接收者的数据流。多媒体会议是多媒体会话的一个示例。
- Session Description：一种明确定义的格式，用于传达足够的信息以发现和参与多媒体会话。

### Examples of SDP Usage

- 提供了SDP的使用示例，涵盖了不同方面的应用场景。
  1. Session Initiation: 介绍了使用Session Initiation Protocol (SIP) [15] 时，如何使用SDP来创建会话。SIP消息中携带的会话描述允许参与者就一组兼容的媒体类型达成一致。
  2. Streaming Media: 展示了如何使用SDP来描述流媒体会话。SDP提供了媒体流的编码格式、传输地址等信息，以便发送者和接收者能够协商和建立流媒体会话。
  3. Email and the World Wide Web: 展示了如何使用SDP来描述与电子邮件和万维网相关的会话。SDP可以用于描述与这些应用场景相关的多媒体会话参数和功能。
  4. Multicast Session Announcement: 展示了如何使用SDP来进行多播会话的通告。SDP提供了一种机制，用于向网络中的其他参与者广播会话的相关信息。

### Requirements and Recommendations

- 对SDP的要求和建议，以确保SDP的正确使用和互操作性。

1. SDP Version: SDP的版本号必须是"v=0"，以指定SDP的版本。
2. Origin Field: 必须包含一个"o="字段，用于指定会话的创建者和会话的唯一标识符。
3. Session Name: 必须包含一个"s="字段，用于指定会话的名称。
4. Timing Information: 必须包含一个"t="字段，用于指定会话的起止时间。
5. Media Description: 必须包含一个"m="字段，用于描述媒体流的类型、传输协议和端口号。
6. Media Format: 必须指定媒体流的格式，可以通过"fmtp"和"rtpmap"字段来描述。
7. Connection Data: 可以使用"c="字段来指定媒体流的连接信息。
8. Bandwidth Information: 可以使用"b="字段来指定会话或媒体流的带宽要求。
9. Encryption and Security: 可以通过使用"k="字段来指定加密密钥和安全策略。
10. Session Attributes: 可以使用"a="字段来指定与会话相关的属性和参数。
11. Media Attributes: 可以使用"a="字段来指定与媒体流相关的属性和参数。
12. Offer/Answer Model: SDP使用Offer/Answer模型来进行会话协商，参与者可以通过交换SDP消息来协商会话参数和协议。

### SDP Specification

- 详细规定了SDP的各个字段的含义和用法，以及如何描述会话的相关信息，包括会话的创建者、会话名称、媒体流的连接信息、带宽要求、时间信息等。此外，还介绍了如何使用属性字段来指定与会话和媒体流相关的属性和参数。

1. Protocol Version ("v="): 使用"v="字段来指定SDP的版本号，当前版本为0。
2. Origin ("o="): 使用"o="字段来指定会话的创建者和会话的唯一标识符。
3. Session Name ("s="): 使用"s="字段来指定会话的名称。
4. Session Information ("i="): 使用"i="字段可选地提供有关会话的附加信息。
5. URI ("u="): 使用"u="字段可选地提供有关会话的URI。
6. Email Address ("e="): 使用"e="字段可选地提供会话创建者的电子邮件地址。
7. Phone Number ("p="): 使用"p="字段可选地提供会话创建者的电话号码。
8. Connection Data ("c="): 使用"c="字段来指定媒体流的连接信息。
9. Bandwidth Information ("b="): 使用"b="字段可选地指定会话或媒体流的带宽要求。
10. Timing ("t="): 使用"t="字段来指定会话的起止时间。
11. Repeat Times ("r="): 使用"r="字段可选地指定重复的会话时间。
12. Time Zones ("z="): 使用"z="字段可选地指定会话的时区信息。
13. Session Attributes ("a="): 使用"a="字段可选地指定与会话相关的属性和参数。
14. Media Descriptions ("m="): 使用"m="字段来描述媒体流的类型、传输协议和端口号。
15. Media Format Attributes ("a=rtpmap:" and "a=fmtp:"): 使用"a=rtpmap:"和"a=fmtp:"字段可选地指定媒体流的格式和属性。

### SDP Attributes

- 介绍了SDP属性的定义、语法和用法。它解释了属性在会话和媒体级别的适用性，并提供了一些常见属性的示例和用途。此外，还指导了如何向IANA注册新的属性。

1. 属性的定义和语法：该章节介绍了SDP属性的定义和语法。属性以"a="开头，后面跟着属性名称和属性值。
2. 会话级别属性：会话级别属性适用于整个会话，如会话描述、会话创建者的联系信息等。
3. 媒体级别属性：媒体级别属性适用于特定的媒体流，如媒体格式、传输参数等。
4. 属性值的字符集：某些属性的值可能受到字符集的影响，该章节介绍了如何在属性值中指定字符集。
5. 属性的用途和意义：该章节提供了一些常见属性的用途和意义的示例，如带宽属性、时间属性、加密属性等。
6. IANA注册：该章节说明了如何向IANA注册新的SDP属性，包括提交注册的要求和所需的信息。

### Security Considerations

- 介绍了SDP会话的安全性考虑。它讨论了密钥管理、安全性协议、加密和身份验证的重要性，以及可能的安全威胁和限制。通过遵循这些安全性考虑，用户和实现者可以增强SDP会话的安全性和保护其内容。

1. 密钥管理：会话中的安全性依赖于密钥的管理。该章节介绍了使用密钥协商和交换方法来确保会话的机密性和完整性。
2. 安全性协议：为了保护SDP会话的内容，可以使用各种安全性协议，如Secure Real-time Transport Protocol (SRTP)。该章节介绍了SRTP的基本原理和使用方法。
3. 加密和身份验证：该章节强调了在SDP会话中使用加密和身份验证的重要性。它提供了一些安全性属性和参数的示例，如加密算法、密钥长度和身份验证机制。
4. 安全性威胁：该章节列举了可能对SDP会话造成安全威胁的几种情况，如窃听、篡改和拒绝服务攻击。它提供了一些建议和措施来减轻这些安全威胁。
5. 安全性的限制：该章节指出了SDP安全性的一些局限性和限制。它提供了一些警告和注意事项，以帮助用户和实现者在使用SDP时保持警惕。

### IANA Considerations

- 介绍了SDP中与IANA相关的考虑事项。它涵盖了SDP中各种元素和参数的注册过程，包括媒体类型、传输协议、媒体格式、属性名称、带宽指定符、网络类型和地址类型等。此外，还提供了已经通过IANA注册的属性名称的列表。

1. 注册过程：该章节描述了SDP中的各种元素和参数的注册过程。包括媒体类型（media）、传输协议（proto）、媒体格式（fmt）、属性名称（att-field）、带宽指定符（bwtype）、网络类型（nettype）和地址类型（addrtype）等。
2. 注册的细节：该章节提供了每个元素和参数的详细注册要求和规范。它指定了每个注册项目的名称、级别（会话级别或媒体级别）以及是否依赖字符集。
3. 已注册的属性名称：该章节列出了已经通过IANA注册的SDP属性名称。每个属性名称都附有其级别（会话级别或媒体级别）和是否依赖字符集的标记。

### SDP Grammar

- 描述了SDP的ABNF语法。它提供了SDP协议各个元素和参数的语法结构，并使用ABNF语法表示。此外，还讨论了SDP的扩展性，并给出了一些扩展语法的示例。

1. ABNF语法：该章节提供了SDP的ABNF语法，用于描述SDP协议的各个元素和参数的语法结构。ABNF是一种扩展的BNF（巴科斯范式）语法，它定义了SDP的各种数据类型、规则和语法约束。
2. 语法规则：该章节列出了SDP的语法规则，包括会话描述、协议版本、原始字段、会话名称字段等。每个语法规则都使用ABNF语法表示，并提供了相应的解释和说明。
3. SDP扩展：该章节讨论了SDP的扩展性，并提供了一些扩展语法的示例。它说明了如何使用扩展语法来支持自定义的SDP元素和参数。

### SDP  message  contents

1. Session-level description – this includes the session identiﬁer and other session-level parameters, such as the IP address, subject, contact info about the session and/or creator.
   - ![[image-20230103153909525.png]]
2. Timing   description   –   start   and   stop   times,   repeat   times,   one   or   more   media-level descriptions.
   - ![[image-20230103153929447.png]]
3. Media   type   and   format   –   transport   protocol   and   port   number,   other   media-level parameters. Note that the media address may be diﬀerent from the signalling address.
   - ![[image-20230103153959868.png]]

### Format

- The  SDP  syntax  is  very  strict  and  all  lines  follow  the  same  format.  Every  SDP  line  has the  format:`<character>=<value>`.
- No spaces are allowed on either side of the ‘‘=’’ sign. The <value> part of the line contains one or more parameters and there is exactly one space between each parameter.
- Each   SDP   line   ends   with   a   Carriage-Return Line-Feed   (CRLF)   and   each   line   has   a deﬁned  number  of  parameters.

# RCS

- 为可发现和互操作的高级通信服务提供了框架，并提供了一套此类高级通信服务的基础集合的详细规范。
- OMA CPM:Open Mobile Aliance Converged lP(Internet Protocol) Messaging 
- SIMPLE: Session Initiation Protocol for Instant Messaging and Presence Leveraging Extensions
- MSRP: Message Session Relay Protocol

## RCS基础功能

### RCS架构

- 对于RCS来说，基础网络元素是IMS核心系统，其实现了RCS客户端之间的点对点通信。服务提供商可以部署其他网络节点，以提供RCS功能集的其他部分。
- ![[image-20230423110206706.png]]
  1. PS/CS网关用于电路交换（CS）和分组交换（PS）语音之间的互操作，如基于VoLTE的语音
  2. MSG Store relates to the CPM (Converged IP Messaging) Message Store Server
  3. Legacy Msg refers to the Short Message Service (SMS)/Multimedia Message Service (MMS) services that may be utilized via an IWF (Interworking Function) located in the group of Application Servers (ASs) which in addition to these IWF node(s) may also include various other nodes used by the RCS services, for example:
     1. Presence Server
     2. Messaging Server
     3. XML (Extensible Markup Language) Document Management (XDM) Server (XDMS)
     4. Multimedia Telephony (MMTEL) Application Server
     5. Video Share Application Server, as utilized in [PRD-IR.84]
  4. two RCS Service Providers exchanging traffic with each other using the standard NNI mechanisms (IPX, IP Packet Exchange)
  5. RCS还通过将Chatbot平台整合到总体架构中，为Chatbot通信提供支持。这些平台可以通过互联互通基础设施连接，也可以直接连接到RCS服务提供商的网络。

### RCS 设备和客户端类型

- **Primary device**：a device carrying a Subscriber Identity Module (SIM) that is associated with the identity (i.e. IMPU/MSISDN) used for RCS. 
  - Two types of RCS clients exist for such a device that connect directly to the IMS
    - RCS embedded client
    - RCS downloadable client
- **Secondary device**: a device that does not carry a SIM that is associated to the identity used for RCS。
  - 注意：还可能存在使用终端API（例如[PRD-RCC.53]）的可下载客户端，以访问由设备的RCS嵌入式客户端提供的RCS功能。由于这种类型的客户端不会改变由设备的RCS嵌入式客户端处理的UNI（用户网络接口），因此rrc.7文档不考虑此类客户端。


### 配置流程

#### 客户端配置参数（Client configuration parameters）

- 仅当服务提供商通过相关客户端配置参数授权使用时，客户端才能向用户提供个别RCS服务。此外，服务提供商需要向客户端提供IMS核心网络配置数据。RCS客户端应支持客户端配置的相关流程。
- 如果设备通过在[PRD-RCC.15]中定义的IMS公共APN注册服务，则某些与IMS核心网络相关的配置参数不适用。
- 如果客户端配置授权客户端使用RCS服务的配置数据，那么RCS客户端应根据对应的方式向网络注册。一旦注册过程成功完成，用户就能够使用RCS服务。
- 服务提供商可以使用相应的机制更新和撤销客户端配置参数。
- 所有的RCS客户端配置参数必须限制用户的修改。

#### RCS服务

- ![[image-20231229000838150.png]]

- ![[image-20231228172554211.png]]

####ACS

- rcc.14、rcc.15、rcc.20
- ACS是一种终端设备从远程服务器检索其RCS配置，并为RCS 操作进行自我配置的机制。RCS配置高度依赖于终端设备的RCS堆栈实现和网络运营商的要求。在RCS实施的早期阶段，大多数终端设备提供了一个特殊的图形用户界面，通过该界面可以手动配置RCS操作，或者将一个特殊的配置文件放置在终端设备上。然而，随着RCS实施的成熟和网络运营商开始在真实网络（或至少在实验网络）中部署RCS，这种情况发生了变化。
- 流程上终端设备通过HTTP（非安全协议）和HTTPS（安全协议）与核心网络中的自动配置服务器进行通信。它是一个包含4个步骤的协商过程。前两个步骤只是为了检查服务器是否可用。真正的配置过程只在第3步和第4步中完成。
  - ![[image-20231228165725815.png]]


##### 解密ssl后的流程

- ![[image-20231228165912692.png]]

- ```http
  (1) HTTP GET Request
  
      GET / HTTP/1.1
  
      Cache-Control: max-age=0
  
      Host: config.rcs.mnc001.mcc001.pub.3gppnetwork.org
  
      User-Agent: 3gpp-gba
  
      Connection: Keep-Alive
  
      Accept-Language: en-US
  
  ```

- ```http
  (2) HTTP 200 OK  
  
      HTTP/1.1 200 OK
  
      Cache-Control: private
  
      Transfer-Encoding: chunked
  
      Content-Type: text/html
  
      Expires: Mon, 07 Nov 2016 04:05:20 GMT
  
      Server: Microsoft-IIS/7.5
  
      X-AspNet-Version: 4.0.30319
  
      Set-Cookie: PHPSESSID=dv+z7IckAiXiBX+aFEJh+g==; path=/
  
      X-Powered-By: ASP.NET
  
      Date: Mon, 07 Nov 2016 05:05:20 GMT
  ```

- ```
  (3) HTTPS GET
  
   
  
      GET /?IMEI=353756074161860
  
           &terminal_vendor=testVendor
  
           &rcs_version=5.1B
  
           &terminal_model=SM-N920T
  
           &client_version=RCSAndr-5.0
  
           &IMSI=001001123456789
  
           &terminal_sw_version=N920TUVS2COKC
  
           &client_vendor=SEC
  
           &vers=20160401
  
           &rcs_profile=joyn_blackbird HTTP/1.1
  
      Cookie: PHPSESSID=dv+z7IckAiXiBX+aFEJh+g==; path=/
  
      Cache-Control: max-age=0
  
      Host: config.rcs.mnc001.mcc001.pub.3gppnetwork.org
  
      User-Agent: IM-client/OMA1.0 testVendor/SM-N920T-OKC testVendor-RCS/5.0 3gpp-gba
  
      Connection: Keep-Alive
  
      Accept-Language: en-US
  ```

  - ![[image-20231228170551662.png]]

- ```
  (4) HTTPS 200 OK
  
  
  
      HTTP/1.1 200 OK
  
      Cache-Control: private
  
      Content-Type: text/xml; charset=utf-8
  
      Server: Microsoft-IIS/7.5
  
      X-AspNet-Version: 4.0.30319
  
      X-Powered-By: ASP.NET
  
      Date: Mon, 07 Nov 2016 05:05:20 GMT
  
      Content-Length: 8687
  
  
  
      <?xml version="1.0" encoding="utf-8"?>
  
      <wap-provisioningdoc version="1.1">
  
      <characteristic type="VERS">
  
      <parm name="version" value="20160401" />
  
      <parm name="validity" value="300" />
  
      </characteristic>
  
      <characteristic type="APPLICATION">
  
      <parm name="AppID" value="ap2001" />
  
      <parm name="Name" value="IMS Settings" />
  
      <parm name="AppRef" value="ims" />
  
      <characteristic type="ConRefs">
  
      <parm name="ConRef" value="0" />
  
      </characteristic>
  
      <parm name="PDP_ContextOperPref" value="0" />
  
      <parm name="Timer_T1" value="500" />
  
      <parm name="Timer_T2" value="4000" />
  
      <parm name="Timer_T4" value="5000" />
  
      <parm name="Private_User_Identity" value="001001123456789@ims.mnc001.mcc001.pub.3gppnetwork.org" />
  
      <characteristic type="Public_User_Identity_List">
  
      <parm name="Public_User_Identity" value="sip:001010123456789@ims.mnc001.mcc001.3gppnetwork.org" />
  
      </characteristic>
  
      <parm name="Home_network_domain_name" value="msg.testnet.com" />
  
      <characteristic type="Ext">
  
      <parm name="NatUrlFmt" value="0" />
  
      <parm name="IntUrlFmt" value="1" />
  
      <parm name="Q-Value" value="0.5" />
  
      <characteristic type="SecondaryDevicePar">
  
      <parm name="VoiceCall" value="0" />
  
      <parm name="Chat" value="0" />
  
      <parm name="SendSms" value="0" />
  
      <parm name="SendMms" value="0" />
  
      <parm name="FileTransfer" value="0" />
  
      <parm name="VideoShare" value="0" />
  
      <parm name="ImageShare" value="0" />
  
      <parm name="VideoCall" value="0" />
  
      <parm name="GeoLocPush" value="0" />
  
      </characteristic>
  
      <parm name="MaxSizeImageShare" value="5242880" />
  
      <parm name="MaxTimeVideoShare" value="300" />
  
      <characteristic type="Ext" />
  
      </characteristic>
  
      <characteristic type="ICSI_List">
  
      <parm name="ICSI" value="" />
  
      <parm name="ICSI_Resource_Allocation_Mode" value="" />
  
      </characteristic><characteristic type="LBO_P-CSCF_Address">
  
      <parm name="Address" value="ss.epdg.epc.mnc001.mcc001.pub.3gppnetwork.org" />
  
      <parm name="AddressType" value="FQDN" />
  
      </characteristic><parm name="Voice_Domain_Preference_E_UTRAN" value="1" />
  
      <parm name="SMS_Over_IP_Networks_Indication" value="1" />
  
      <parm name="Keep_Alive_Enabled" value="0" />
  
      <parm name="Voice_Domain_Preference_UTRAN" value="1" />
  
      <parm name="Mobility_Management_IMS_Voice_Termination" value="1" />
  
      <parm name="RegRetryBaseTime" value="300" />
  
      <parm name="RegRetryMaxTime" value="3600" />
  
      <characteristic type="PhoneContext_List">
  
      <parm name="PhoneContext" value="0" />
  
      <parm name="Public_User_Identity" value="sip:+14448880000@msg.testnet.com" />
  
      </characteristic><characteristic type="APPAUTH"><parm name="AuthType" value="AKA" />
  
      <parm name="Realm" value="msg.testnet.com" />
  
      <parm name="UserName" value="001001123456789@ims.mnc001.mcc001.pub.3gppnetwork.org" />
  
      <parm name="UserPwd" value="ims*1234" />
  
      </characteristic>
  
      </characteristic>
  
      <characteristic type="APPLICATION">
  
      <parm name="AppID" value="ap2002" />
  
      <parm name="Name" value="RCS Settings" />
  
      <parm name="AppRef" value="rcs" />
  
      <characteristic type="IMS">
  
      <parm name="To-AppRef" value="ims" />
  
      <characteristic type="Ext">
  
      <parm name="rcsVolteSingleRegistration" value="1" />
  
      </characteristic>
  
      </characteristic>
  
      <characteristic type="SERVICES">
  
      <parm name="presencePrfl" value="1" />
  
      <parm name="ChatAuth" value="1" />
  
      <parm name="GroupChatAuth" value="1" />
  
      <parm name="ftAuth" value="1" />
  
      <parm name="standaloneMsgAuth" value="1" />
  
      <parm name="geolocPushAuth" value="0" />
  
      <parm name="geolocPullAuth" value="0" />
  
      <parm name="VSAuth" value="0" />
  
      <parm name="ISAuth" value="0" />
  
      <parm name="rcsIPVoiceCallAuth" value="1" />
  
      <parm name="rcsIPVideoCallAuth" value="1" />
  
      <characteristic type="Ext" />
  
      </characteristic>
  
      <characteristic type="PRESENCE">
  
      <parm name="AvailabilityAuth" value="1" />
  
      <characteristic type="FAVLINK">
  
      <parm name="AutMa" value="Auto" />
  
      <characteristic type="LINKS">
  
      <parm name="OpFavUrl1" value="" />
  
      <parm name="OpFavUrl2" value="" />
  
      <parm name="OpFavUrl3" value="" />
  
      </characteristic>
  
      <parm name="LabelMaxLength" value="200" />
  
      </characteristic>
  
      <parm name="IconMaxSize" value="204800" />
  
      <parm name="NoteMaxSize" value="200" />
  
      <characteristic type="VIPCONTACTS">
  
      <parm name="NonVipPollPeriodSetting" value="200" />
  
      <parm name="NonVipMaxPollPerPeriod" value="1" />
  
      </characteristic>
  
      <parm name="PublishTimer" value="3600" />
  
      <parm name="NickNameLength" value="200" />
  
      <characteristic type="Location">
  
      <parm name="TextMaxLength" value="200" />
  
      <parm name="LocInfoMaxValidTime" value="86400" />
  
      </characteristic><characteristic type="Ext" />
  
      <parm name="client-obj-datalimit" value="4096" />
  
      <parm name="content-serveruri" value="" />
  
      <parm name="source-throttlepublish" value="30" />
  
      <parm name="max-number-ofsubscriptions-inpresence-list" value="100" />
  
      <parm name="service-uritemplate" value="rcs" />
  
      <parm name="RLS-URI" value="" />
  
      </characteristic><characteristic type="XDMS">
  
      <parm name="RevokeTimer" value="86400" />
  
      <parm name="enablePNBManagement" value="0" />
  
      <parm name="enableXDMSubscribe" value="0" />
  
      <characteristic type="Ext" />
  
      <parm name="XCAPRootURI" value="xcap.ims.mnc001.mcc001.pub.3gppnetwork.org" />
  
      <parm name="XCAPAuthenticationUserName" value="GBA" />
  
      <parm name="XCAPAuthenticationSecret" value="GBA" />
  
      <parm name="XCAPAuthenticationType" value="GBA" />
  
      </characteristic><characteristic type="SUPL">
  
      <parm name="TextMaxLength" value="200" />
  
      <parm name="LocInfoMaxValidTime" value="43200" />
  
      <parm name="geolocPullOpen" value="0" />
  
      <parm name="geolocPullApiGwAddress" value="" />
  
      <parm name="geolocPullBlockTimer" value="0" />
  
      <characteristic type="Ext" />
  
      <parm name="Addr" value="" />
  
      <parm name="AddrType" value="" />
  
      </characteristic><characteristic type="IM">
  
      <parm name="imMsgTech" value="1" />
  
      <parm name="imCapAlwaysON" value="1" />
  
      <parm name="GroupChatFullStandFwd" value="1" />
  
      <parm name="GroupChatOnlyFStandFwd" value="1" />
  
      <parm name="imWarnSF" value="0" />
  
      <parm name="SmsFallBackAuth" value="1" />
  
      <parm name="imCapNonRCS" value="1" />
  
      <parm name="imWarnIW" value="0" />
  
      <parm name="AutAccept" value="1" />
  
      <parm name="AutAcceptGroupChat" value="1" />
  
      <parm name="imSessionStart" value="0" />
  
      <parm name="firstMessageInvite" value="0" />
  
      <parm name="TimerIdle" value="210" />
  
      <parm name="MaxConcurrentSession" value="10" />
  
      <parm name="multiMediaChat" value="1" />
  
      <parm name="MaxSize1to1" value="1000" />
  
      <parm name="MaxSize1toM" value="1000" />
  
      <parm name="ftWarnSize" value="9999999" />
  
      <parm name="MaxSizeFileTr" value="10240" />
  
      <parm name="ftThumb" value="1" />
  
      <parm name="ftStAndFwEnabled" value="0" />
  
      <parm name="ftCapAlwaysON" value="0" />
  
      <parm name="ftAutAccept" value="1" />
  
      <parm name="ftHTTPCSURI" value="" />
  
      <parm name="ftHTTPCSUser" value="" />
  
      <parm name="ftHTTPCSPwd" value="" />
  
      <parm name="ftDefaultMech" value="MSRP" />
  
      <characteristic type="Ext" />
  
      <parm name="pres-srv-cap" value="1" />
  
      <parm name="deferred-msg-func-uri" value="sip:CPMDeferredMsgMgmt@msg.testnet.com" />
  
      <parm name="max_adhoc_group_size" value="21" />
  
      <parm name="conf-fcty-uri" value="sip:adhoc@msg.testnet.com" />
  
      <parm name="exploder-uri" value="sip:adhoc@msg.testnet.com" />
  
      <parm name="CPMControllingFuncUri" value="sip:adhoc@msg.testnet.com" />
  
      </characteristic>
  
      <characteristic type="CPM">
  
      <characteristic type="StandaloneMsg">
  
      <parm name="MaxSizeStandalone" value="600" />
  
      </characteristic>
  
      <characteristic type="MessageStore">
  
      <parm name="Url" value="" />
  
      <parm name="AuthProt" value="0" />
  
      <parm name="UserName" value="" />
  
      <parm name="UserPwd" value="" />
  
      </characteristic>
  
      <characteristic type="Ext" />
  
      </characteristic>
  
      <characteristic type="CAPDISCOVERY">
  
      <parm name="pollingPeriod" value="300" />
  
      <parm name="pollingRate" value="20" />
  
      <parm name="pollingRatePeriod" value="1" />
  
      <parm name="capInfoExpiry" value="300" />
  
      <parm name="defaultDisc" value="1" />
  
      <parm name="capDiscCommonStack" value="0" />
  
      <characteristic type="Ext" />
  
      </characteristic>
  
      <characteristic type="APN">
  
      <parm name="rcseOnlyAPN" value="ims" />
  
      <parm name="enableRcseSwitch" value="-1" />
  
      <parm name="alwaysUseIMSAPN" value="1" />
  
      <characteristic type="Ext" />
  
      </characteristic>
  
      <characteristic type="OTHER">
  
      <parm name="endUserConfReqId" value="sip:1234567890@msg.testnet.com" />
  
      <parm name="allowVSSave" value="1" />
  
      <characteristic type=" transportProto">
  
      <parm name="psSignalling" value="SIPoUDP" />
  
      <parm name="psMedia" value="MSRP" />
  
      <parm name="psRTMedia" value="RTP" />
  
      <parm name="wifiSignalling" value="SIPoUDP" />
  
      <parm name="wifiMedia" value="MSRP" />
  
      <parm name="wifiRTMedia" value="RTP" />
  
      </characteristic><parm name="uuid_Value" value="0" />
  
      <parm name="IPCallBreakOut" value="0" />
  
      <parm name="IPCallBreakOutCS" value="0" />
  
      <parm name="rcsIPVideoCallUpgradeFromCS" value="0" />
  
      <parm name="rcsIPVideoCallUpgradeOnCapError" value="0" />
  
      <parm name="rcsIPVideoCallUpgradeAttemptEarly" value="0" />
  
      <characteristic type="Ext" />
  
      </characteristic>
  
      <characteristic type="SERVICEPROVIDEREXT" />
  
      </characteristic>
  
      </wap-provisioningdoc>
  ```

  - ![[image-20231228170927250.png]]


### rcs 注册

- RCS并没有特殊的注册流程，它只是在IMS之上提供的一项额外服务。然而，通常情况下，启用RCS的用户设备在IMS注册过程中需要经历一些额外步骤。这些额外步骤可能会因用户设备实现和运营商要求而有所不同。在IMS注册期间，RCS最常见的额外步骤是SUBCRIBE/NOTIFY 和 PUBLISCH。比如注册时事件为'reg'的SUBCRIBE。但这里的事件是'presence'。

#### Telephony feature tag

- The feature tag is defined as `+g.gsma.rcs.telephony=<values>`.
  - RCS定义了一个电话功能标签，用于向IMS网络表明设备是否支持CS电话服务，从而在设备没有在IMS中注册信息传递时可以接收与RCS使用的身份相关的短信。该功能标签应在注册时包括在联系头中，可能的值包括 "none "或 "CS"。如果特征标签中没有包含任何值，IMS网络将视其为带有 "无none"的值。

#### Services feature tags

- 根据相关的服务规范，当相应的服务已被授权/启用于所使用的接入（即蜂窝或Wi-Fi）时，客户应在SIP REGISTER请求中包括以下功能标签：
  - ![[image-20230423160341335.png]]
  - ![[image-20230423160638760.png]]
    - CPIM：Common Profile for Instant Messaging

#### rcs注册流程

- | Step | Direction  | Protocol | Message                                                  |
  | ---- | ---------- | -------- | -------------------------------------------------------- |
  | 1    | UA1 --> NW | SIP      | `REGISTER sip:test-rcs.com`                              |
  | 2    | UA1 <-- NW | SIP      | 200 OK                                                   |
  | 3    | UA1 --> NW | SIP      | `SUBSCRIBE sip:+339012341234@test-rcs.com;pres-list=rcs` |
  | 4    | UA1 <-- NW | SIP      | 200 OK                                                   |
  | 5    | UA1 --> NW | SIP/XML  | `PUBLISH sip:+339012341234@test-rcs.com`                 |
  | 6    | UA1 <-- NW | SIP      | 200 OK                                                   |
  | 7    | UA1 <-- NW | SIP      | `NOTIFY sip:192.168.1.1:5060;transport=udp`              |
  | 8    | UA1 --> NW | SIP      | 200 OK                                                   |

- ```
  （1) REGISTER sip:test-rcs.com
  
  REGISTER sip:test-rcs.com SIP/2.0
  
  Call-ID: 3Ag0yaUAAA@192.168.1.1
  
  CSeq: 1 REGISTER
  
  From: <sip:+339012341234@test-rcs.com>;tag=PBg0yaUCAA
  
  To: <sip:+339012341234@test-rcs.com>
  
  Via: SIP/2.0/UDP 192.168.1.1:5060;keep;branch=z9hG4bKbf994bf8ba37e52882a1ac4ba748f008383138;rport
  
  Max-Forwards: 70
  
  Contact: <sip:192.168.1.1:5060;transport=UDP>;+sip.instance="<urn:gsma:imei:356432059050620>";
  
               +g.oma.sip-im;
  
               +g.3gpp.cs-voice;
  
               +g.gsma.rcs.ipcall;
  
               +g.3gpp.icsi-ref="urn%3Aurn-7%3A3gpp-service.ims.icsi.mmtel";video;automata;
  
               +g.3gpp.iari-ref="urn%3Aurn-7%3A3gpp-application.ims.iari.gsma-is,
  
                                      urn%3Aurn-7%3A3gpp-application.ims.iari.rcs.fthttp"
  
  Supported: path, gruu
  
  Allow: INVITE,UPDATE,ACK,CANCEL,BYE,NOTIFY,OPTIONS,MESSAGE,REFER
  
  Route: <sip:192.168.1.2:5060;transport=udp;lr>
  
  Expires: 600000
  
  User-Agent: IM-client/OMA1.0 Test-RCS-client/2.5.13
  
  Authorization: Digest username="X",uri="sip:test-rcs.com",algorithm=MD5,realm="X",nonce="",response=""
  
  Content-Length: 0
  ```

  - Contact中携带了rcs feature tag

- ```
  3) SUBSCRIBE sip:+339012341234@test-rcs.com;pres-list=rcs
  
  SUBSCRIBE sip:+339012341234@test-rcs.com;pres-list=rcs SIP/2.0
  
  Call-ID: 8Ih0yaUFAA@192.168.1.1
  
  CSeq: 1 SUBSCRIBE
  
  From: "test user" <sip:+339012341234@test-rcs.com>;tag=8Ih0yaUGAA
  
  To: <sip:+339012341234@test-rcs.com;pres-list=rcs>
  
  Via: SIP/2.0/UDP 192.168.1.1:5060;branch=z9hG4bKcad78c485b12e9ff2a8410e4d375722f383138;rport
  
  Max-Forwards: 70
  
  Route: <sip:192.168.1.2:5060;transport=udp;lr>
  
  Expires: 3600
  
  User-Agent: IM-client/OMA1.0 Test-RCS-client/2.5.13
  
  Contact: <sip:192.168.1.1:5060;transport=UDP>;+sip.instance="<urn:gsma:imei:356432059050620>"
  
  Allow: INVITE,UPDATE,ACK,CANCEL,BYE,NOTIFY,OPTIONS,MESSAGE,REFER
  
  Event: presence
  
  Supported: eventlist
  
  Content-Length: 0
  ```

  - Event: presence
  - Supported: eventlist

- ```
  5) PUBLISH sip:+339012341234@test-rcs.com
  
   
  
  PUBLISH sip:+339012341234@test-rcs.com SIP/2.0
  
  Call-ID: xSh0yaUHAA@192.168.1.1
  
  CSeq: 1 PUBLISH
  
  From: <sip:+339012341234@test-rcs.com>;tag=xSh0yaUIAA
  
  To: <sip:+339012341234@test-rcs.com>
  
  Via: SIP/2.0/UDP 192.168.1.1:5060;branch=z9hG4bK84da5f074a2ba56ea1c0d63f7fa45a54383138;rport
  
  Max-Forwards: 70
  
  Route: <sip:192.168.1.2:5060;transport=udp;lr>
  
  Expires: 3600
  
  SIP-If-Match: ac63be7e9042439dad76da16904cf48d
  
  User-Agent: IM-client/OMA1.0 Test-RCS-client/2.5.13
  
  Event: presence
  
  Content-Type: application/pidf+xml
  
  Content-Length: 2122
  
   
  
  
  <presence xmlns="urn:ietf:params:xml:ns:pidf" xmlns:op="urn:oma:xml:prs:pidf:oma-pres" xmlns:opd="urn:oma:xml:pde:pidf:ext" xmlns:pdm="urn:ietf:params:xml:ns:pidf:data-model" xmlns:ci="urn:ietf:params:xml:ns:pidf:cipid" xmlns:rpid="urn:ietf:params:xml:ns:pidf:rpid" xmlns:gp="urn:ietf:params:xml:ns:pidf:geopriv10" xmlns:gml="urn:opengis:specification:gml:schema-xsd:feature:v3.0" entity="sip:+339012341234@test-rcs.com">
  
  <tuple id="t1">
  
    <status><basic>open</basic></status>
  
    <op:service-description>
  
      <op:service-id>org.openmobilealliance:File-Transfer</op:service-id>
  
      <op:version>1.0</op:version>
  
    </op:service-description>
  
    <contact>sip:+339012341234@test-rcs.com</contact>
  
    <timestamp>2014-06-19T06:30:45.000Z</timestamp>
  
  </tuple>
  
  <tuple id="t2">
  
    <status><basic>open</basic></status>
  
    <op:service-description>
  
      <op:service-id>org.gsma.imageshare</op:service-id>
  
      <op:version>1.0</op:version>
  
    </op:service-description>
  
    <contact>sip:+339012341234@test-rcs.com</contact>
  
    <timestamp>2014-06-19T06:30:45.000Z</timestamp>
  
  </tuple>
  
  <tuple id="t3">
  
    <status><basic>open</basic></status>
  
    <op:service-description>
  
      <op:service-id>org.gsma.videoshare</op:service-id>
  
      <op:version>1.0</op:version>
  
    </op:service-description>
  
    <contact>sip:+339012341234@test-rcs.com</contact>
  
    <timestamp>2014-06-19T06:30:45.000Z</timestamp>
  
  </tuple>
  
  <tuple id="t4">
  
    <status><basic>open</basic></status>
  
    <op:service-description>
  
      <op:service-id>org.openmobilealliance:IM-session</op:service-id>
  
      <op:version>1.0</op:version>
  
    </op:service-description>
  
    <contact>sip:+339012341234@test-rcs.com</contact>
  
    <timestamp>2014-06-19T06:30:45.000Z</timestamp>
  
  </tuple>
  
  <tuple id="t5">
  
    <status><basic>open</basic></status>
  
    <op:service-description>
  
      <op:service-id>org.3gpp.cs-videotelephony</op:service-id>
  
      <op:version>1.0</op:version>
  
    </op:service-description>
  
    <contact>sip:+339012341234@test-rcs.com</contact>
  
    <timestamp>2014-06-19T06:30:45.000Z</timestamp>
  
  </tuple>
  
  </presence>
  ```

  - Event: presence
  - Content-Type: application/pidf+xml

- ```
  7)  NOTIFY sip:192.168.1.1:5060;transport=udp
  
   
  
  NOTIFY sip:192.168.1.1:5060;transport=udp SIP/2.0
  
  Via: SIP/2.0/UDP 192.168.1.2:51417;branch=z9hG4bKb7a8715cd9d04e019149483fac110bee93;rport;transport=udp
  
  Via: SIP/2.0/TCP 192.168.1.2:6061;branch=z9hG4bK299ad82d0390455982d5f305d9d68a43;rport=49793
  
  Max-Forwards: 69
  
  From: <sip:presence@test-rcs.com>;tag=9ab957cb0149442b9e4a6d99d93f3d21
  
  To: <sip:+339012341234@test-rcs.com>;tag=8Ih0yaUGAA
  
  Event: presence
  
  Contact: <sip:presence@test-rcs.com>
  
  Content-Type: application/pidf+xml
  
  Subscription-State: active
  
  Content-Length: 0
  
  CSeq: 1 NOTIFY
  
  Call-ID: 8Ih0yaUFAA@192.168.1.1
  
  Record-Route: <sip:192.168.1.2;lr>
  ```

  - Event: presence
  - Content-Type: application/pidf+xml

### UCE

#### Capability discovery

- 能力或服务发现机制是一个过程，它通过允许用户了解在某些时间点可用于访问和/或与他们的联系人沟通的RCS服务子集来增强服务的可用性。
- When available, the RCS specification provides two alternative mechanisms to perform the capability discovery
  - SIP OPTIONS exchange：SIP OPTIONS端到端消息被用来查询目标联系人的能力（其他用户可用的服务），并传递关于请求者支持哪些能力的信息。使用这种方法，两个用户都能在一次事务中得到更新的信息。
  - Presence：不是执行端到端的事务，而是使用标准的开放移动联盟（OMA）SIP即时通讯和Presence扩展（SIMPLE）Presence程序对服务器进行查询
  - The discovery mechanism that is to be used by the device is by using the configuration parameter CAPABILITY DISCOVERY MECHANISM

- option流程
  - ![[image-20231228193801004.png]]
  - ![[image-20231228194323188.png]]

- SIP OPTIONS response
  - ![[image-20230423174204791.png]]
  - ![[image-20230423174257411.png]]

- Service part of the presence Data Model

  - ```
    1130179, 13:41:08.856 2023/04/13, Protocol 1, SIM 1, MS->NW, fc01:bbbb:cdcd:efe0:ac6d:45f7:8e39:7955, fc01:abab:cdcd:6fee:0:0:0:1, CELLULAR, TCP, PUBLISH tel:+11234567890 SIP/2.0,  1 PUBLISH, UTPt7dYCAA@[fc01:bbbb:cdcd:efe0:ac6d:45f7:8e39:7955]
    PUBLISH tel:+11234567890 SIP/2.0
    Call-ID: UTPt7dYCAA@[fc01:bbbb:cdcd:efe0:ac6d:45f7:8e39:7955]
    CSeq: 1 PUBLISH
    From: <tel:+11234567890>;tag=UTPt7dYDAA
    To: <tel:+11234567890>
    Via: SIP/2.0/TCP [fc01:bbbb:cdcd:efe0:ac6d:45f7:8e39:7955]:5060;branch=z9hG4bK3f14d82331f8525d3375a0704a1480cc383136;rport
    Max-Forwards: 70
    Route: <sip:[fc01:abab:cdcd:6fee:0:0:0:1]:5060;transport=tcp;lr>
    SIP-If-Match: dx200xyz
    User-Agent: ATT U6080AA U6080AA V47 messages.android_20221115_01_RC01
    Event: presence
    Content-Type: application/pidf+xml
    Accept: application/pidf+xml
    Contact: <sip:+11234567890@[fc01:bbbb:cdcd:efe0:ac6d:45f7:8e39:7955]:50001>;mobility="mobile"
    Proxy-Require: sec-agree
    Require: sec-agree
    P-Access-Network-Info: 3GPP-E-UTRAN-FDD;utran-cell-id-3gpp=310410000B0038000
    Content-Length: 1756
    Security-Verify: ipsec-3gpp;alg=hmac-sha-1-96;spi-c=186634097;spi-s=224574659;port-c=5063;port-s=5064;q=0.9, ipsec-3gpp;alg=hmac-md5-96;spi-c=186634097;spi-s=224574659;port-c=5063;port-s=5064;q=0.7
    
    <?xml version='1.0' encoding='utf-8' standalone='yes' ?>
    				<presence entity="tel:+11234567890" xmlns="urn:ietf:params:xml:ns:pidf" xmlns:op="urn:oma:xml:prs:pidf:oma-pres" xmlns:caps="urn:ietf:params:xml:ns:pidf:caps">
    					<tuple id="tid2">
    						<status>
    							<basic>open</basic>
    						</status>
    						<op:service-description>
    							<op:service-id>org.3gpp.urn:urn-7:3gpp-application.ims.iari.rcse.dp</op:service-id>
    							<op:version>1.0</op:version>
    							<op:description>Capabilities Discovery Service</op:description>
    						</op:service-description>
    						<contact>tel:+11234567890</contact>
    					</tuple>
    					<tuple id="tid3">
    						<status>
    							<basic>open</basic>
    						</status>
    						<op:service-description>
    							<op:service-id>org.3gpp.urn:urn-7:3gpp-service.ims.icsi.mmtel</op:service-id>
    							<op:version>1.0</op:version>
    							<op:description>Voice and Video Service</op:description>
    						</op:service-description>
    						<caps:servcaps>
    							<caps:audio>true</caps:audio>
    							<caps:video>true</caps:video>
    							<caps:duplex>
    								<caps:supported>
    									<caps:full/>
    								</caps:supported>
    							</caps:duplex>
    						</caps:servcaps>
    						<contact>tel:+11234567890</contact>
    					</tuple>
    					<tuple id="tid4">
    						<status>
    							<basic>open</basic>
    						</status>
    						<op:service-description>
    							<op:service-id>org.3gpp.urn:urn-7:3gpp-application.ims.iari.rcs.geopush</op:service-id>
    							<op:version>1.0</op:version>
    						</op:service-description>
    						<contact>tel:+11234567890</contact>
    					</tuple>
    					<tuple id="tid5">
    						<status>
    							<basic>open</basic>
    						</status>
    						<op:service-description>
    							<op:service-id>org.openmobilealliance:File-Transfer-HTTP</op:service-id>
    							<op:version>1.0</op:version>
    						</op:service-description>
    						<contact>tel:+11234567890</contact>
    					</tuple>
    					<tuple id="tid6">
    						<status>
    							<basic>open</basic>
    						</status>
    						<op:service-description>
    							<op:service-id>org.openmobilealliance:ChatSession</op:service-id>
    							<op:version>2.0</op:version>
    						</op:service-description>
    						<contact>tel:+11234567890</contact>
    					</tuple>
    				</presence>
    ```

  - ![[image-20230424102523000.png]]

  - ![[image-20230424102546390.png]]

- Service/capability indicators
  - RCS能力表示RCS用户/客户在特定时间点可以访问的服务列表。这些能力取决于以下四个因素：
    - 用户服务提供商的配置状态：服务提供商可以根据订阅状态限制服务范围（例如，提供聊天和文件共享，但不包括视频）。
    - 终端硬件（HW）：具有受限硬件的终端（即无法处理视频的能力）可能无法访问所有RCS服务。
    - 终端状态：即使终端硬件支持所有服务，设备状态可能引入限制（例如，当文件存储已满时，无法接收文件）。
    - 连接状态：某些服务可能需要一定水平的网络服务质量（QoS）。例如，所使用的设备在2G通用分组无线电服务（GPRS）上无法进行视频流媒体。

- feature tags and Service IDs that are used for indicating that a specific RCS service is available:
  - <img src="Communication Technology.assets/image-20230424105147780.png" alt="image-20230424105147780" style="zoom:150%;" />
  - <img src="Communication Technology.assets/image-20230424105323845.png" alt="image-20230424105323845" style="zoom:150%;" />

- Future extensions to the mechanism
  - A Service Provider (or group of Service Providers) to deploy additional services which can benefit from the RCS discovery mechanism, an additional tag and Service ID format is defined.
    - ![[image-20230424111045328.png]]
    - ![[image-20230424111748037.png]]

#### Presence

- Capability discovery via presence
  - 具体的capabilities信息在SIP PUBLISH方法的Presence 文档中进行显示。终端启动后，客户端会发送一个包含能力信息的SIP PUBLISH请求。该SIP PUBLISH请求不应包含Expires头字段。通过OMA Presence Enabler [Presence2.0_TS]或[Presence]进行的服务能力发布必须遵循[PDE_14]规则。
  - 如果需要对已发布的能力进行更改（例如，基于指定行为的需求），则会使用"Sip-If-Match"头字段发送一个存在修改请求。此外，当客户端或设备关闭时，应在注销之前移除已发布的能力，按照[RFC3903]中定义的流程进行操作。
- Service Capabilities Retrieval
  - 另一个RCS用户可以通过其客户端发出的订阅请求，以及相应的授权规则允许的情况下，获取RCS用户的服务能力信息。
  - 在使用Presence作为能力交换的手段时，RCS客户端应通过匿名获取操作来检索联系人的服务能力信息。
  - Authorisation for capabilities retrieval：为了提供使用匿名获取请求检索能力的授权，支持使用presence的能力交换的RCS服务提供商应在presence服务器上提供允许匿名订阅检索能力的服务提供商策略，或者在presence XDMS中为每个RCS用户设置提供这种授权的presence规则文档。

##### Presence流程图

- ![[image-20231228200937881.png]]
- ![[image-20231228201006421.png]]

##### uce sip流程

- rcs注册流程

### RCS 协议

- ![[image-20230424114119705.png]]
- MSRP session matching：For all services using MSRP, an RCS client shall set up MSRP sessions as per [RCS-CPMCONVFUNC-ENDORS].
- SIP Issues
  - An RCS client should use a random originating SIP signalling port of the range 1025-65535， If the selected port is not available, the next port number shall be used for this session.
  - An RCS client shall build its SIP contact address to be unique. A recommended way to do so is to use a hashed value of the +sip.instance tag as user part of the URI of the contact address.
  - The content in the body of SIP request or response could be compressed with the indication of Content-Encoding header as described in [RFC3261].
  - When the size of the SIP request/response content exceeds the configured parameter CONTENT COMPRESS SIZE defined in Section A.1.3 (e.g. Chatbot messages with big JSON payload, Group Chat invitation/1-to-Many Messaging with big MIME resource-list body and CPM Group Session Participant Information via SIP Notify), and SIP Content-Compression is supported by the client, the SIP content (except SDP) should be compressed with the Content-Encoding header indication; an example is shown as below:
    - Content-Encoding: gzip
  - The receiver of the SIP request/response should handle the compressed content accordingly.

End User Confirmation Requests

## RCS 服务

### Messaging

#### 1-to-1 Messaging Technology Selection

- Messaging towards contacts not known as Chatbots
  - ![[image-20230424162536551.png]]
- Messaging towards contacts known as Chatbots
  - ![[image-20230424165621666.png]]
  - If capability discovery is not enabled, and if
    - 如果只启用了Chatbot Standalone Messaging或1对1 Chatbot会话中的一种，那么客户应选择已启用的技术来建立与Chatbot的对话。如果收到一个SIP 405 Method Not Allowed响应，其中的Allow头表示chatbot能理解的方法（即所选技术不被聊天机器人支持），那么聊天机器人就不能使用，如果满足下面提到的条件，客户可以通过SMS重新发送消息。
    - 如果同时启用了Chatbot独立消息和1对1 Chatbot会话，那么客户应选择使用3.6.8.3.1节中定义的1对1 Chatbot会话。如果收到SIP 405 Method Not Allowed响应，包括Allow header中的MESSAGE方法（即聊天工具只支持Chatbot Standalone Messaging），客户应使用3.6.8.3.2节中定义的Chatbot Standalone Messaging重新发送消息。
  - 如果RCS客户端在建立消息通信时没有注册，或者在技术选择程序中没有提供chatbot服务，那么在满足以下条件的情况下，可以使用短信
    - An SMS address is known for the Chatbot through the Chatbot Information dataand
    - The user is sharing their MSISDN with the Chatbot (see section 3.6.5.1)
    - The Chatbot is not known as a party sending spam (see section 3.6.6)
    - The message to be sent is a regular text message i.e. not a File Transfer or one of the message types defined in section 3.6.10.1 and
    - The RCS client is in coverage conditions where a SMS message can be sent.

#### Standalone messaging

- configuration parameter STANDALONE MSG AUTH is set to "1" or "2"
- 使用OMA CPM Standalone messaging，包括文本和多媒体消息服务，消除了基于SMS和MMS服务的消息服务部署所带来的一些限制，例如160个字符的消息大小限制，内容类型限制，对文本消息缺乏显示通知以及对使用多设备的服务用户的支持。
- Standalone messaging服务支持与SMS和MMS的互通
- Standalone messaging采用了OMA CPM的基于SIP的独立消息传递（详见[RCS5-CPM-CONVFUNC-ENDORS]）。它将两种独立的文本和多媒体消息机制发展成一个统一的消息框架。这种融合的消息机制使用了Pager模式消息机制和Large Message模式消息机制的组合。根据消息的大小选择不同的模式。较小的消息通过Pager模式发送，较大的消息通过Large Message模式发送。Standalone messaging的这种内置能力通过使选择对用户透明化来增强用户体验：用户不需要根据媒体类型或人为设定的大小限制来选择消息技术。此外，Standalone messaging进一步促进了从当前独立的SMS和MMS消息服务向单一的全IP消息服务的过渡。

##### Feature description

- Delivery and Display Notifications
  - 在发送包含消息处理状态请求的Standalone Message  时，发送方将收到送达通知，并可能收到显示通知。
- Support for multiple devices per user
  - Standalone Message支持使用多个设备的用户。对于用户的所有兼容设备/客户端，Standalone Message服务应该可用。更具体地说，对于在线并能够处理Standalone Message服务的所有用户客户端，传入的消息应该被送达到这些客户端。如果当一条消息需要被送达时，用户的所有客户端都处于离线状态，那么如果消息在此期间未过期，它将会在第一个上线的客户端上被送达。
- Deferred Messaging
  - 将消息暂时保存在Participating Function  中，并在以后的某个时间进行传递。此外，延迟消息是在终止的RCS用户设备未注册或不可用以接收消息时，推迟独立消息的传递。在这种情况下，未传递的消息会保留在RCS Participating Function  中，直到它们被传递到用户设备、被删除或过期为止。
- Central Message Storage
  - 支持将存储对象与所有注册的RCS设备中的本地存储进行同步。存储始终受到运营商控制的消息大小和存储配额限制的限制。

- The SDP of the SIP INVITE request and response in Large Message Mode should not be compressed even if SIP Content-Compression is supported by the client.

##### Technical Realization

- 无论是CPM Pager Mode还是Large Message Mode独立消息机制，都基于使用IETF SIP协议。Pager Mode消息使用SIP MESSAGE方法，对最大消息大小有限制，而Large Message Mode消息使用专用的SIP/MSRP会话进行传递，不限制消息大小。
- 使用Pager Mode消息进行传递的RCS独立消息的最大大小不能超过1300字节。大小超过此阈值的消息将由Large Message Mode消息处理。因此，Standalone Message将根据消息的大小使用Pager Mode或Large Message Mode进行发送和传递。这个过程对用户来说是透明的，即用户不会决定使用Pager Mode还是Large Message Mode消息，也不会看到服务行为上的差异。

###### Pager Mode Messaging

- ![[image-20231228234707861.png]]
  - 如果提供了基于网络的公共消息存储，任何发送或接收的独立消息都将按照对应要求存储在相应的RCS用户的消息存储中。

###### Large Message Mode Messaging 

- 来自RCS客户端的大型文本或多媒体消息通过[RCS5-CPMCONVFUNC-ENDORS]中描述的大型消息模式传递机制发送，并通过成功的SIP INVITE建立的MSRP会话传递到目标客户端，以便通过起始和终止方的Participating Function达到预期的接收者。SIP INVITE包括独立消息的大小和消息中使用的内容类型。

###### Flows

- | Step | Direction         | Protocol | Message | Comments                      |
  | ---- | ----------------- | -------- | ------- | ----------------------------- |
  | (1)  | UA1 --> Proxy/UA2 | SIP      | MESSAGE | Send a text '123456789abcdef' |
  | (2)  | UA1 <-- Proxy/UA2 | SIP      | 200 OK  |                               |
  | (3)  | UA1 <-- Proxy/UA2 | SIP      | MESSAGE | Delivery Notification         |
  | (4)  | UA1 --> Proxy/UA2 | SIP      | 200 OK  |                               |
  | (5)  | UA1 <-- Proxy/UA2 | SIP      | MESSAGE | Display Notification          |
  | (6)  | UA1 --> Proxy/UA2 | SIP      | 200 OK  |                               |

- ```
  (1) MESSAGE
  
   
  
  MESSAGE sip:+14448880011@sharetechnote.com;user=phone SIP/2.0
  
  P-Preferred-Service: urn:urn-7:3gpp-service.ims.icsi.oma.cpm.msg
  
  Contribution-ID: 477b66ae9662e3ad18549bf5dabf9d26d5e707ca
  
  Conversation-ID: 1710887c7ca47dc2c1274c11673eb0df5a604fd3
  
  P-Preferred-Identity: <sip:310410123456789@sharetechnote.com>
  
  Request-Disposition: no-fork
  
  User-Agent: TEST IMS 5.0
  
  CSeq: 1 MESSAGE
  
  Max-Forwards: 70
  
  P-Access-Network-Info: 3GPP-E-UTRAN-FDD;utran-cell-id-3gpp=31041000010000000
  
  Route: <sip:[2001:0:0:1::2]:5060;lr>
  
  a: *;+g.3gpp.icsi-ref="urn%3Aurn-7%3A3gpp-service.ims.icsi.oma.cpm.msg"
  
  c: message/cpim
  
  f: <sip:310410123456789@sharetechnote.com>;tag=1384874566
  
  i: 3712948749@2001::1:88fe:fccf:2870:5dee
  
  l: 322
  
  m: <sip:310410123456789@[2001::1:88fe:fccf:2870:5dee]:5060>;
  
      +sip.instance="<urn:gsma:imei:35469106-056673-0>"
  
  t: <sip:+14448880011@sharetechnote.com;user=phone>
  
  v: SIP/2.0/TCP [2001::1:88fe:fccf:2870:5dee]:5060;branch=z9hG4bK2629405539smg;transport=TCP
  
   
  
  From: <sip:310410123456789@sharetechnote.com>
  
  To: <sip:+14448880011@sharetechnote.com;user=phone>
  
  DateTime: 2015-02-17T06:54:27Z
  
  NS: imdn <urn:ietf:params:imdn>
  
  imdn.Message-ID: PH7qAIV8cgH5
  
  imdn.Disposition-Notification: positive-delivery, display
  
   
  
  Content-type: text/plain;charset=UTF-8
  
  Content-Length: 15
  
   
  
  123456789abcdef
  ```

  - a: *;+g.3gpp.icsi-ref="urn%3Aurn-7%3A3gpp-service.ims.icsi.oma.cpm.msg"
  - c: message/cpim

- ```
  (2) 200 OK
  
   
  
  SIP/2.0 200 OK
  
  Max-Forwards: 70
  
  Via: SIP/2.0/TCP [2001::1:88fe:fccf:2870:5dee]:5060;branch=z9hG4bK2629405539smg;transport=TCP
  
  From: <sip:310410123456789@sharetechnote.com>;tag=1384874566
  
  To: <sip:+14448880011@sharetechnote.com;user=phone>;tag=73335cbb32b744baaaf5097a34431c92
  
  Call-ID: 3712948749@2001::1:88fe:fccf:2870:5dee
  
  CSeq: 1 MESSAGE
  
  Server: TEST-RCS-serv/OMA1.0
  
  Content-Length: 0
  ```

- ```
  (3) MESSAGE
  
   
  
  MESSAGE sip:310410123456789@[2001::1:88fe:fccf:2870:5dee]:5060 SIP/2.0
  
  Via: SIP/2.0/UDP [2001:0:0:1::2]:5060;
  
        branch=z9hG4bK4b0eb0c6ab9d4ef7bac858d430ea63cc18a;rport;transport=udp
  
  Via: SIP/2.0/TCP [2001:0:0:1::2]:6062;branch=z9hG4bKe7c0830f56394c91985b32740e324dbf
  
  Max-Forwards: 68
  
  From: <sip:+14448880011@sharetechnote.com>;tag=d1d79837cb9140e0a4b75cba91f40178
  
  To: <sip:310410123456789@sharetechnote.com>
  
  P-Asserted-Identity: <sip:+14448880011@sharetechnote.com>
  
  Accept-Contact: *;+g.3gpp.icsi-ref="urn%3Aurn-7%3A3gpp-service.ims.icsi.oma.cpm.msg"
  
  Contribution-ID: f415972d55
  
  Conversation-ID: 1710887c7ca47dc2c1274c11673eb0df5a604fd3
  
  Content-Type: message/cpim
  
  Content-Length: 490
  
  CSeq: 1 MESSAGE
  
  Call-ID: fb87fae7ea0f4eaebdd51c7bce64ccf8
  
  Record-Route: <sip:[2001:0:0:1::2]:5060;lr>
  
   
  
  From: <sip:anonymous@anonymous.invalid>
  
  To: <sip:310410123456789@sharetechnote.com>
  
  DateTime: 2015-02-17T06:54:27.8730740Z
  
  NS: imdn <urn:ietf:params:imdn>
  
  imdn.Message-ID: 92c65678d0
  
   
  
  Content-Disposition: notification
  
  Content-Type: message/imdn+xml
  
   
  
  <?xml version="1.0" encoding="utf-8"?>
  
  <imdn xmlns="urn:ietf:params:xml:ns:imdn">
  
    <message-id>PH7qAIV8cgH5</message-id>
  
    <delivery-notification>
  
      <status>
  
        <delivered />
  
      </status>
  
    </delivery-notification>
  
  </imdn>
  ```

- ```
  (4) 200 OK
  
   
  
  SIP/2.0 200 OK
  
  Contribution-ID: f415972d55
  
  Conversation-ID: 1710887c7ca47dc2c1274c11673eb0df5a604fd3
  
  CSeq: 1 MESSAGE
  
  P-Access-Network-Info: 3GPP-E-UTRAN-FDD;utran-cell-id-3gpp=31041000010000000
  
  f: <sip:+14448880011@sharetechnote.com>;tag=d1d79837cb9140e0a4b75cba91f40178
  
  i: fb87fae7ea0f4eaebdd51c7bce64ccf8
  
  l: 0
  
  t: <sip:310410123456789@sharetechnote.com>;tag=1310629065
  
  v: SIP/2.0/UDP [2001:0:0:1::2]:5060;
  
      branch=z9hG4bK4b0eb0c6ab9d4ef7bac858d430ea63cc18a;rport=5060;
  
      received=2001:0:0:1::2;transport=udp,SIP/2.0/TCP [2001:0:0:1::2]:6062;
  
      branch=z9hG4bKe7c0830f56394c91985b32740e324dbf
  ```

- ```
  (5) MESSAGE
  
   
  
  MESSAGE sip:310410123456789@[2001::1:88fe:fccf:2870:5dee]:5060 SIP/2.0
  
  Via: SIP/2.0/UDP [2001:0:0:1::2]:5060;
  
         branch=z9hG4bK4b0eb0c6ab9d4ef7bac858d430ea63cc18c;rport;transport=udp
  
  Via: SIP/2.0/TCP [2001:0:0:1::2]:6062;branch=z9hG4bK266a90b1785b4b659ea8d0911bf4f48b
  
  Max-Forwards: 68
  
  From: <sip:+14448880011@sharetechnote.com>;tag=c5305ca476f3456a904ca1a31cf2b091
  
  To: <sip:310410123456789@sharetechnote.com>
  
  P-Asserted-Identity: <sip:+14448880011@sharetechnote.com>
  
  Accept-Contact: *;+g.3gpp.icsi-ref="urn%3Aurn-7%3A3gpp-service.ims.icsi.oma.cpm.msg"
  
  Contribution-ID: 70e1ec50d6
  
  Conversation-ID: 1710887c7ca47dc2c1274c11673eb0df5a604fd3
  
  Content-Type: message/cpim
  
  Content-Length: 495
  
  CSeq: 1 MESSAGE
  
  Call-ID: 30210a9d7df84045a75c8b040d6395af
  
  Record-Route: <sip:[2001:0:0:1::2]:5060;lr>
  
   
  
  From: "No Chat" <sip:+14448880011@sharetechnote.com>
  
  To: <sip:310410123456789@sharetechnote.com>
  
  DateTime: 2015-02-17T06:54:45.1650631Z
  
  NS: imdn <urn:ietf:params:imdn>
  
  imdn.Message-ID: cef6f7fe6d
  
   
  
  Content-Disposition: notification
  
  Content-Type: message/imdn+xml
  
   
  
  <?xml version="1.0" encoding="utf-8"?>
  
  <imdn xmlns="urn:ietf:params:xml:ns:imdn">
  
    <message-id>PH7qAIV8cgH5</message-id>
  
    <display-notification>
  
      <status>
  
        <displayed />
  
      </status>
  
    </display-notification>
  
  </imdn>
  ```

- ```
  (6) 200 OK
  
   
  
  SIP/2.0 200 OK
  
  Contribution-ID: 70e1ec50d6
  
  Conversation-ID: 1710887c7ca47dc2c1274c11673eb0df5a604fd3
  
  CSeq: 1 MESSAGE
  
  P-Access-Network-Info: 3GPP-E-UTRAN-FDD;utran-cell-id-3gpp=31041000010000000
  
  f: <sip:+14448880011@sharetechnote.com>;tag=c5305ca476f3456a904ca1a31cf2b091
  
  i: 30210a9d7df84045a75c8b040d6395af
  
  l: 0
  
  t: <sip:310410123456789@sharetechnote.com>;tag=2700955583
  
  v: SIP/2.0/UDP [2001:0:0:1::2]:5060;
  
      branch=z9hG4bK4b0eb0c6ab9d4ef7bac858d430ea63cc18c;rport=5060;
  
      received=2001:0:0:1::2;transport=udp,SIP/2.0/TCP [2001:0:0:1::2]:6062;
  
      branch=z9hG4bK266a90b1785b4b659ea8d0911bf4f48b
  ```

  

#### 1-to-1 Chat

- The Chat service 使用户能够实时地在两个用户之间交换消息。

##### Feature description

1.  存储和转发：此功能要求消息服务器在目标用户离线时存储消息和通知（投递和显示），并在用户再次上线时将其传递给用户（即存储和转发）。
2. chat与短信/彩信的互通：此功能要求Messaging Server 将消息与短信或彩信进行互通。
3. "已送达"消息通知：发送方在消息传递给接收方后可以收到通知。
4. "已显示"消息通知：发送方在其消息在接收方设备上显示后可以收到通知。请注意，此通知无法证明接收方实际已阅读消息，只能表明消息已在接收方终端的用户界面（UI）上显示。
5. 在会话外投递通知（已送达和已显示）：无论是否建立了一对一的聊天，都应该可以独立发送通知。
6. 正在输入指示：聊天对话中的用户可以看到另一个用户正在输入新消息/反馈。
7. 本地黑名单：终端/客户端可以支持本地存储的黑名单来处理传入的聊天请求。允许用户将不需要的传入聊天标记为垃圾邮件。这将阻止来自这些发起者的后续消息显示或甚至通知用户。此外，这些不需要的通信也不会被确认为已阅读。黑名单行为不仅适用于聊天，还适用于文件传输。
8. PNB：网络中存储的由RCS用户设置的PNB包含了RCS用户用于屏蔽目的的联系人（或列表）的URI列表。BPEF使用PNB列表来阻止聊天的传入和传出流量。
   1. PNB：Personal Network Blacklist
   2. BPEF： Blacklist Policy Enforcement Function

9. 本地对话历史：终端/客户端支持本地存储的对话历史。
10. 基于网络的公共消息存储：聊天会话的基于网络的公共消息存储可用于在设备之间同步消息。它还允许用户在网络中备份重要的对话。设备中，本地对话历史与基于网络的公共消息存储的同步预期是一致的。如何实现此对齐由设备实现确定。
11. 用户别名（显示名称）：在与其他用户发起通信时，可以发送用户定义的显示名称。
12. 灵活性以允许在聊天对话中发送多媒体消息：聊天会话中支持多媒体消息交换。然而，是否允许在聊天会话中发送多媒体消息取决于服务提供商，并由配置参数控制。

##### Interaction with other RCS features

###### Switching to Group Chat  

- 只有在部署了消息服务器的服务提供商的用户才能发起群聊。提供群聊功能是可选的，因此从终端的角度来看，如果配置参数CONFFCTY-URI（见表76）未配置或配置为虚拟值，则终端不应允许用户向聊天中添加其他参与者或开始群聊。

- 通过向其中添加新用户，一对一聊天可以由用户A或用户B将其转换为群聊。用户A和用户B在其用户界面中有选项来添加一个或多个聊天伙伴到对话中。用户可能仅限于其设备上已知的RCS用户联系人。否则，发起用户的消息服务器需要准备好通过短信或彩信与非RCS用户进行消息交互。

###### File Transfer within 1-to-1 chat and interaction with the blacklist 

- 在一对一聊天过程中，任何一方用户都可以从聊天编辑窗口向另一方用户发起文件传输。文件传输是通过一个新的SIP会话建立的，并在与聊天会话不同的MSRP会话中进行。
- 在参与聊天的设备上，接收用户将在与发送用户的聊天窗口中收到文件传输邀请，并可以从该窗口接受或拒绝邀请。在多设备环境中，文件传输邀请还会显示在用户的其他设备上，使其也可以从这些设备上接受或拒绝邀请。
- 如果用户接受文件传输，终端设备将要求用户选择存储文件的位置或使用默认目录。一旦接收到文件，用户可以从聊天编辑窗口中打开文件。
- 请注意，垃圾邮件/黑名单行为适用于文件传输，而不仅仅适用于聊天消息。如果从黑名单用户接收到接收文件的邀请，客户端/设备实现在用户界面上不应通知用户收到来自黑名单发送者的文件传输邀请。而是应将事件记录在垃圾邮件文件夹中

##### Technical Realization

###### Two different technical realizations  

- OMA SIMPLE IM 
  1. 对于OMA SIMPLE IM，首条消息始终包含在SIP INVITE请求中的CPIM/IMDN wrapper   中。因此，在表77中定义的配置参数FIRST MSG IN INVITE始终设置为1。客户端应始终在该消息的Disposition-Notification头字段的值中包含"positive-delivery"。这意味着该头字段的值要么是"positive-delivery"，要么是"positive-delivery,display"，具体取决于是否请求了显示通知。在RCS的一对一聊天中，不使用"negativedelivery"的值。如果SIP INVITE请求中携带了CPIM/IMDN封装的消息，并且没有至少包含"positive-delivery"的Disposition-Notification头字段，服务器将拒绝该请求。
  2. 收到的聊天会话邀请包含请求“delivery”通知的IMDN。因此，每个接收设备都会向A发送包含IMDN的SIP MESSAGE请求，指示原始消息成功送达。
  3. 当来自同一用户的新INVITE请求到达时，接收客户端会向未处理的INVITE发送486 BUSY HERE响应，以确保来自同一用户的未处理INVITE请求不超过一个。请求“delivery”通知的IMDN的发送方式与第一次会话邀请类似。
  4. 不支持在聊天中交换多媒体内容，因此在表77中定义的配置参数MULTIMEDIA IN CHAT始终设置为0，以减少与存储转发功能相关的复杂性。因此，在SIP INVITE请求和响应的SDP中，a=accept-wrapped-types属性仅包括text/plain和message/imdn+xml。如果支持使用HTTP进行文件传输，那么a=accept-wrapped-types属性还应包括application/vnd.gsma.rcs-ft-http+xml。如果支持位置推送（Geolocation PUSH），那么a=accept-wrapped-types属性还应包括application/vnd.gsma.rcspushlocation+xml。在聊天过程中传输多媒体内容时，使用文件传输。
- OMA CPM  
  - 如果服务提供商希望在会话建立后发送第一条聊天消息，则在附件A中的配置参数FIRST MSG IN INVITE设置为禁用。
    - 请注意，在使用OMA CPM时，这是推荐的方法，因为它确保与现有标准的兼容性。
  - 如果服务提供商希望将第一条消息放在SIP INVITE请求的CPIM/IMDN wrapper  中，则在表77中定义的配置参数FIRST MSG IN INVITE设置为1。客户端应始终在该消息的Disposition-Notification头字段的值中包含"positive-delivery"。这意味着头字段的值要么是"positive-delivery"，要么是"positive-delivery,display"，具体取决于是否请求了显示通知。在RCS的1对1聊天中，不使用"negative-delivery"的值。如果SIP INVITE请求携带了一个CPIM/IMDN包装器中的消息，并且没有至少包含"positive-delivery"的Disposition-Notification头，则服务器将拒绝该请求。
  - 如果第一条消息在SIP INVITE请求的CPIM/IMDN包装器中，客户端应将该包装器的CPIM From和CPIM To头字段都设置为sip:[anonymous@anonymous.invalid](mailto:anonymous@anonymous.invalid)，以防止在传输过程中泄露用户的身份信息。因此，在接收到一个对话的CPIM消息时，客户端应忽略CPIM头中指示的身份信息。
  - 当允许用户使用多个设备，并且这些设备被配置为自动接受（IM SESSION AUTO ACCEPT设置为1）时，消息服务器需要能够将传入的1对1聊天会话请求分发到接收用户的每个设备，以与每个设备建立MSRP会话。
  - 当从同一用户接收到新的INVITE请求时，接收客户端（或其参与功能）会对未完成的INVITE请求发送486 BUSY HERE响应，以确保来自同一用户的未完成的INVITE请求不超过一个。
  - 如果允许在聊天会话中使用多媒体内容，则在表77中定义的配置参数MULTIMEDIA IN CHAT设置为1。因此，在SIP INVITE请求和响应的SDP中，a=accept-wrapped-types属性应只包括`*`，或者包括聊天会话期间支持的所有内容类型的完整列表（至少包括text/plain和message/imdn+xml），例如，a=accept-wrapped-types:`*`
- common to both OMA SIMPLE IM and OMA CPM  
  - 在建立使用MSRP进行消息交换的会话时，使用SIP协议的过程。
  - 在SIP INVITE请求和响应的SDP中，a=accept-types属性应只包括message/cpim和application/im-iscomposing+xml，即“a=accepttypes:message/cpim application/im-iscomposing+xml”。
  - 如果启动或接受此聊天会话将使并发聊天会话数量超过服务提供商配置的最大限制（请参阅表77中的MAX CONCURRENT SESSIONS），设备将在启动新会话之前关闭其他活动的聊天会话之一（例如，最长时间未使用的聊天会话）。
  - 当会话建立时，消息通过MSRP会话进行传输。每个MSRP SEND请求都包含一个请求以接收即时消息传递通知（IMDN）的“delivery”通知，并可能包含一个请求以接收IMDN“display”通知。因此，客户端应始终在CPIM/IMDN Disposition-Notification头字段的值中包含“positive-delivery”。这意味着头字段的值为“positive-delivery”或“positive-delivery,display”，具体取决于是否请求了显示通知。在RCS中，不使用“negative-delivery”的值进行1对1聊天。
  - 当用户消息被传递时，接收设备必须生成一个包含IMDN状态的MSRP SEND请求，并在请求时，如果被要求，再生成另一个MSRP SEND请求以表示消息已被显示。
    - 注意：如果发送方和接收方之间尚未建立MSRP会话，则使用Pager Mode（即SIP MESSAGE）来传输IMDN（传递通知、显示通知）。

- Chat message size limitations  
  - 消息的最大大小通过在表77中定义的MAX SIZE 1-to-1 IM配置参数进行控制。超过MAX SIZE 1-to-1 IM配置参数中指定的最大大小的消息可以通过文件传输或大消息模式独立消息来传递。

##### Flows

- | Step | Direction         | Protocol | Message              | Comments              |
  | ---- | ----------------- | -------- | -------------------- | --------------------- |
  | (1)  | UA1 --> Proxy/UA2 | SIP/SDP  | INVITE               |                       |
  | (2)  | UA1 <-- Proxy/UA2 | SIP      | 100 Trying           |                       |
  | (3)  | UA1 <-- Proxy/UA2 | SIP      | 183 Session Progress |                       |
  | (4)  | UA1 <-- Proxy/UA2 | SIP/SDP  | 200 OK               |                       |
  | (5)  | UA1 --> Proxy/UA2 | SIP      | ACK                  |                       |
  | (6)  | UA1 --> Proxy/UA2 | MSRP     | SEND                 |                       |
  | (7)  | UA1 <-- Proxy/UA2 | MSRP     | 200 OK               |                       |
  | (8)  | UA1 --> Proxy/UA2 | MSRP     | SEND                 | Send Text 'Hello'     |
  | (9)  | UA1 <-- Proxy/UA2 | MSRP     | 200 OK               |                       |
  | (10) | UA1 <-- Proxy/UA2 | MSRP     | SEND                 | Delivery Notification |
  | (11) | UA1 --> Proxy/UA2 | MSRP     | 200 OK               |                       |

- ```
  (1) INVITE
  
   
  
  INVITE sip:+14448880000@sharetechnote.com;user=phone SIP/2.0
  
  Conversation-ID: 6b79b8bc937e4985b1dffd062b687bd7
  
  Contribution-ID: d5e4121aeec2cc59546ebaef8966ef185a2f37f0
  
  P-Preferred-Service: urn:urn-7:3gpp-service.ims.icsi.oma.cpm.session
  
  P-Preferred-Identity: <sip:310410123456789@sharetechnote.com>
  
  P-Early-Media: supported
  
  Allow: INVITE,ACK,OPTIONS,CANCEL,BYE,UPDATE,INFO,REFER,NOTIFY,MESSAGE,PRACK
  
  User-Agent: Test IMS 5.0
  
  CSeq: 1 INVITE
  
  Max-Forwards: 70
  
  P-Access-Network-Info: 3GPP-E-UTRAN-FDD;utran-cell-id-3gpp=31041000010000000
  
  Route: <sip:[2001:0:0:1::2]:5060;lr>
  
  a: *;+g.3gpp.icsi-ref="urn%3Aurn-7%3A3gpp-service.ims.icsi.oma.cpm.session"
  
  c: application/sdp
  
  f: <sip:310410123456789@sharetechnote.com>;tag=284849603
  
  i: 508868544@2001::1:4c16:9c0f:4986:9e6d
  
  k: timer
  
  l: 363
  
  m: <sip:310410123456789@[2001::1:4c16:9c0f:4986:9e6d]:5060;transport=UDP>;+g.3gpp.icsi-ref="urn%3Aurn-7%3A3gpp-service.ims.icsi.oma.cpm.session"
  
  t: <sip:+14448880000@sharetechnote.com;user=phone>
  
  v: SIP/2.0/TCP [2001::1:4c16:9c0f:4986:9e6d]:5060;branch=z9hG4bK2563646430smg;transport=TCP
  
   
  
  v=0
  
  o=TEST-IMS-UE 1234562 0 IN IP6 2001::1:4c16:9c0f:4986:9e6d
  
  s=SS VOIP
  
  c=IN IP6 2001::1:4c16:9c0f:4986:9e6d
  
  t=0 0
  
  m=message 8880 TCP/MSRP *
  
  a=accept-types:message/cpim application/im-iscomposing+xml // See Ref [2]
  
  a=accept-wrapped-types:text/plain message/imdn+xml
  
  a=setup:active
  
  a=path:msrp://[2001::1:4c16:9c0f:4986:9e6d]:8880/FmnP;tcp
  
  a=msrp-cema
  
  a=sendrecv
  
   
  
   
  
  (2) 100 Trying
  
   
  
  SIP/2.0 100 Trying
  
  Via: SIP/2.0/TCP [2001::1:4c16:9c0f:4986:9e6d]:5060;branch=z9hG4bK2563646430smg;transport=TCP
  
  Max-Forwards: 70
  
  From: <sip:310410123456789@sharetechnote.com>;tag=284849603
  
  To: <sip:+14448880000@sharetechnote.com;user=phone>
  
  Call-ID: 508868544@2001::1:4c16:9c0f:4986:9e6d
  
  CSeq: 1 INVITE
  
  Content-Length: 0
  
   
  
  (3) 183 Session Progress
  
   
  
  SIP/2.0 183 Session Progress
  
  Max-Forwards: 70
  
  Via: SIP/2.0/TCP [2001::1:4c16:9c0f:4986:9e6d]:5060;branch=z9hG4bK2563646430smg;transport=TCP
  
  From: <sip:310410123456789@sharetechnote.com>;tag=284849603
  
  To: <sip:+14448880000@sharetechnote.com;user=phone>;tag=b2fbe90a8c2e488ba04ad6d0c0956a6c
  
  Call-ID: 508868544@2001::1:4c16:9c0f:4986:9e6d
  
  CSeq: 1 INVITE
  
  Contact: <sip:+14448880000@sharetechnote.com>
  
  Record-Route: <sip:[2001:0:0:1::2]:5060;lr>
  
  Content-Length: 0
  
   
  
  (4) 200 OK
  
   
  
  Via: SIP/2.0/TCP [2001::1:4c16:9c0f:4986:9e6d]:5060;branch=z9hG4bK2563646430smg;transport=TCP
  
  From: <sip:310410123456789@sharetechnote.com>;tag=284849603
  
  To: <sip:+14448880000@sharetechnote.com;user=phone>;tag=b2fbe90a8c2e488ba04ad6d0c0956a6c
  
  Call-ID: 508868544@2001::1:4c16:9c0f:4986:9e6d
  
  CSeq: 1 INVITE
  
  Allow: INVITE, ACK, CANCEL, BYE, MESSAGE
  
  Contact: <sip:[2001:0:0:1::2]:49466;transport=tcp>
  
  Content-Type: application/sdp
  
  Record-Route: <sip:[2001:0:0:1::2]:5060;lr>
  
  Content-Length: 292
  
   
  
  v=0
  
  o=- 1192 5963 IN IP6 2001:0:0:1::2
  
  s=-
  
  c=IN IP6 2001:0:0:1::2
  
  m=message 16000 TCP/MSRP *
  
  a=accept-types:message/cpim application/im-iscomposing+xml
  
  a=accept-wrapped-types:*
  
  a=path:msrp://[2001:0000:0000:0001:0000:0000:0000:0002]:16000/558f02b9d0;tcp
  
  a=msrp-cema
  
  a=setup:passive
  
   
  
   
  
  (5) ACK
  
   
  
  SIP/2.0 200 OK
  
  Max-Forwards: 70
  
  ACK sip:[2001:0:0:1::2]:49466;transport=UDP SIP/2.0
  
  CSeq: 1 ACK
  
  Max-Forwards: 70
  
  Route: <sip:[2001:0:0:1::2]:5060;lr>
  
  f: <sip:310410123456789@sharetechnote.com>;tag=284849603
  
  i: 508868544@2001::1:4c16:9c0f:4986:9e6d
  
  l: 0
  
  m: <sip:310410123456789@[2001::1:4c16:9c0f:4986:9e6d]:5060;transport=UDP>
  
  t: <sip:+14448880000@sharetechnote.com;user=phone>;tag=b2fbe90a8c2e488ba04ad6d0c0956a6c
  
  v: SIP/2.0/UDP [2001::1:4c16:9c0f:4986:9e6d]:5060;branch=z9hG4bK1597981393smg;transport=UDP
  
   
  
  (6) SEND
  
   
  
  MSRP kePLNmnn6eCcn7lB9X SEND
  
  To-Path: msrp://[2001:0000:0000:0001:0000:0000:0000:0002]:16000/558f02b9d0;tcp
  
  From-Path: msrp://[2001::1:4c16:9c0f:4986:9e6d]:8880/FmnP;tcp
  
  Message-ID: IeGt4q5QsCmzD
  
  Success-Report: no
  
  Failure-Report: yes
  
  -------kePLNmnn6eCcn7lB9X$
  
   
  
  (7) 200 OK
  
   
  
  MSRP kePLNmnn6eCcn7lB9X 200 OK
  
  To-Path: msrp://[2001::1:4c16:9c0f:4986:9e6d]:8880/FmnP;tcp
  
  From-Path: msrp://[2001:0000:0000:0001:0000:0000:0000:0002]:16000/558f02b9d0;tcp
  
  -------kePLNmnn6eCcn7lB9X$
  
   
  
  (8) SEND
  
   
  
  MSRP RgGcYXJW2nHr SEND
  
  To-Path: msrp://[2001:0000:0000:0001:0000:0000:0000:0002]:16000/558f02b9d0;tcp
  
  From-Path: msrp://[2001::1:4c16:9c0f:4986:9e6d]:8880/FmnP;tcp
  
  Message-ID: ZNsPlykpMApIABRrejarbO37ADMMae
  
  Success-Report: no
  
  Failure-Report: yes
  
  Byte-Range: 1-430/430
  
  Content-Type: message/cpim
  
   
  
  From: <sip:anonymous@anonymous.invalid>   
  
  To: <sip:anonymous@anonymous.invalid>
  
  DateTime: 2015-02-24T06:48:09Z
  
  NS: imdn <urn:ietf:params:imdn>
  
  NS: MyFeatures <mailto:RCSFeatures@test.com>
  
  MyFeatures.PANI: 3GPP-E-UTRAN-FDD;utran-cell-id-3gpp=31041000010000000
  
  imdn.Message-ID: wYcJuXBbGOfCtBqIPQqz0I
  
  imdn.Disposition-Notification: positive-delivery, display
  
   
  
  Content-type: text/plain;charset=UTF-8
  
  Content-Length: 5
  
   
  
  Hello
  
  -------RgGcYXJW2nHr$
  
   
  
   
  
  (9) 200 OK
  
   
  
  MSRP RgGcYXJW2nHr 200
  
  To-Path: msrp://[2001::1:4c16:9c0f:4986:9e6d]:8880/FmnP;tcp
  
  From-Path: msrp://[2001:0000:0000:0001:0000:0000:0000:0002]:16000/558f02b9d0;tcp
  
  -------RgGcYXJW2nHr$
  
   
  
  (10) SEND
  
   
  
  MSRP 69172e29 SEND
  
  To-Path: msrp://[2001:0000:0000:0001:4C16:9C0F:4986:9E6D]:8880/FmnP;tcp
  
  From-Path: msrp://[2001:0000:0000:0001:0000:0000:0000:0002]:16000/558f02b9d0;tcp
  
  Message-ID: fd2f8f3e7c
  
  Byte-Range: 1-500/500
  
  Content-Type: message/cpim
  
   
  
  From: <sip:anonymous@anonymous.invalid>
  
  To: <sip:anonymous@anonymous.invalid>
  
  DateTime: 2015-02-24T06:48:10.7749079Z
  
  NS: imdn <urn:ietf:params:imdn>
  
  imdn.Message-ID: 2252a2757d
  
   
  
  Content-Type: message/imdn+xml
  
  Content-Disposition: notification
  
   
  
  
  <imdn xmlns="urn:ietf:params:xml:ns:imdn">
  
    <message-id>wYcJuXBbGOfCtBqIPQqz0I</message-id>
  
    <delivery-notification>
  
      <status>
  
        <delivered />
  
      </status>
  
    </delivery-notification>
  
  </imdn>
  
  -------69172e29$
  
   
  
   
  
  (11) 200 OK
  
   
  
  MSRP 69172e29 200 OK
  
  To-Path: msrp://[2001:0000:0000:0001:0000:0000:0000:0002]:16000/558f02b9d0;tcp
  
  From-Path: msrp://[2001::1:4c16:9c0f:4986:9e6d]:8880/FmnP;tcp
  
  Message-ID: fd2f8f3e7c
  
  -------69172e29$
  ```

#### Group Chat

- 群聊服务使用户能够即时地在多个用户之间交换消息。

##### Feature description

- 长期有效的群聊对参与者仍然可用:一旦用户发起群聊，即使群聊因长时间不活动而被消息服务器终止，任何剩余的参与者仍可以重新启动它。
- 基本的存储与转发功能:加入群聊后因连接问题而错过的消息将被存储在消息服务器中，并在参与者重新加入群聊时进行传递。
- 完整的存储与转发功能:对于尚未加入群聊或在群聊开始时处于离线状态的参与者错过的消息将被存储，并在参与者重新可用或加入时进行传递。
- 封闭群聊:发起群聊的用户或消息服务器可以指定群聊为封闭状态，意味着任何人都无法将参与者添加到群聊中。
- 离开群聊:对于封闭群聊，明确离开的用户不能重新加入。对于常规群聊，一旦群聊因不活动而终止，明确离开的参与者除非被其他参与者添加，否则不能重新加入或重新启动，因为他们不再在最新的参与者列表中。如果群聊会话仍在进行中，用户即使明确离开后也可以重新加入。

##### Technical Realization

- roup Chat的技术实现基于《RCS5-SIMPLEIM-ENDORS》和《RCS5-CPM-CONVFUNC-ENDORS》中描述的“Ad-Hoc Session Mode messaging”（取决于在附录A的表77中定义的CHAT MESSAGING TECHNOLOGY设置）。对于OMA CPM，还添加了在Group Chat中支持发送“IsComposing”消息的功能。关闭的Group Chat功能由消息服务器提供，并且所有参与者都知道它是关闭状态。每个Group Chat参与者自己的消息服务器提供了Group Chat的存储和转发功能。
  - Ad-hoc:Ad hoc 是一个拉丁文常用短语。这个短语的意思是“特设的、特定目的的、即席的、临时的、将就的、专案的”。
- 在正常情况下，对于给定的RCS Group Chat ID，对于一个RCS用户，最多只有一个会话处于活动状态。

##### Flows

- 群组消息就是多人一对一聊天。所有参与者将建立一个以“focus”为中心的 1:1 聊天。此逻辑角色作为 RCS (CPM/SIMPLE) 服务器功能的一部分来实现。

  - ![[image-20231229094055402.png]]

- 如果 Karin 想要创建群聊，她会将 SIP INVITE 发送到 RCS 服务器。RCS 将通过 Request-URI 将此 INVITE 请求识别为创建新的临时会议的请求。INVITE 通常还包含正文中的参与者列表：

  - ```
    INVITE sip:conf-factory@operator.com SIP/2.0
        To: "Conf Factory" <sip:conf-factory@operator.com>
       Require: recipient-list-invite
       Content-Type: multipart/mixed;boundary="boundary1"
       Content-Disposition: recipient-list
       
       <?xml version="1.0" encoding="UTF-8"?>
       <resource-lists xmlns="urn:ietf:params:xml:ns:resource-lists"
                 xmlns:cp="urn:ietf:params:xml:ns:copyControl">
         <list>
           <entry uri="sip:Johan@operator.com" cp:copyControl="to" />
           <entry uri="sip:Rory@operator.com" cp:copyControl="to" />
           <entry uri="sip:Eric@operator.com" cp:copyControl="cc"/>
         </list>
       </resource-lists>
    ```

- 对于“Ad-hoc”会议。这意味着会议不需要安排或预订，而是“即时”创建。这种方法的好处是用户不需要知道会议 URI；相反，由focus （RCS 服务器）创建并被参与者的 UA 使用。

  - ![[image-20231229094906679.png]]

#### File Transfer

- 文件传输是用户在进行中的会话或没有进行中的会话时，交换不同类型内容（文件）的能力。

##### Feature description

- 在发送方的角度，在将请求发送给预定接收者之前，需要选择要传输的文件和接收者。
- 对于图片或视频剪辑而言，如果接收者在接受或拒绝传输之前能够收到文件的预览，则具有显著的附加价值。因此，只要可能，文件的发送方应在文件传输邀请中包含文件的缩略图。接收到带有缩略图的文件传输请求的客户端应在弹出的文件传输invite窗口中显示缩略图。
- 文件传输请求将发送到所有接收者的设备。当未进行自动接受时，这将触发一个弹窗，提示用户某个联系人希望向其发送所示文件。接收者可以通过在该设备上接受或拒绝文件传输邀请来选择将文件传输到哪个设备。
- 在实际传输文件之前显示的这个弹窗中，预期的接收者有机会了解所提议的文件传输（大小、名称、预览和文件类型，以及发送方的身份），然后根据这些信息接受或拒绝文件传输。
- 如果文件传输因任何原因中断，接收者可以请求恢复文件传输，而无需重新开始。
- 用户可以将不需要的传入文件传输请求标记为垃圾邮件。为此，客户端可以支持本地存储的黑名单来处理传入的文件传输请求。这个黑名单与用于传入聊天请求的黑名单相同。如果从黑名单用户接收到接收文件的邀请，客户端应拒绝文件传输请求，并且在用户体验上不通知用户。而是可以将事件记录在垃圾邮件文件夹中（例如，“用户A于时间/日期尝试发送文件”）。
- 文件传输功能有以下限制：
  - 与一组用户共享文件仅在群组聊天会话中考虑。在群组聊天会话之外，设备界面可以启动多个一对一文件传输会话，将文件传输给多个用户。
  - 每个文件传输会话只能发送一个文件。

##### Interaction with other RCS features

- 在进行中的一对一聊天会话中，任何文件传输的过程都是作为一个独立的会话与正在进行的一对一聊天同时进行的，因此与启动文件传输的独立会话的过程相同。
- 不同类型的内容（文件）可以在进行中的会话期间或没有进行中的会话时进行交换，即在通话或一对一聊天会话期间或之外。
  当在不存在现有会话时传输文件（即与要共享文件的联系人不在通话或聊天会话中），并且在传输开始后（即接收用户接受了传入文件），文件传输以聊天上下文的形式呈现给接收者。这为传输建立了通信上下文，因为接收者可能想知道发送者为什么要共享该文件。在文件呈现时，聊天会话未启动。只有在接收者向文件传输的发送者发送聊天消息时，聊天会话才会启动。
  - ![[image-20231229100435097.png]]
- 当通话中启动文件传输时，文件传输将持续直至完成或取消，即使通话结束，文件传输也不会被终止。
- 在群聊中可以进行文件传输。在这种情况下，文件将发送给所有能够接收文件的参与者。

##### Technical Realization  

- 文件传输基于[RCS5-SIMPLEIM-ENDORS]和[RCS5-CPM-CONVFUNCENDORS]，以及[RFC5547]中描述的扩展。技术选择由配置参数CHAT MESSAGING TECHNOLOGY控制
- 文件传输的SIP INVITE请求将被分发到所有接收者的设备上。如果接收者在一台设备上接受邀请，相应的客户端将回复200 OK响应。如果接收者拒绝会话，客户端将回复603响应。在这两种情况下，他的服务提供商的IMS网络将取消发送到他其他设备的邀请。
- 如果发起者包含在设备的本地黑名单中,SIP 603 Decline响应应用于自动拒绝传入的文件传输邀请
- 据客户端配置参数FT AUT ACCEPT，接收方的客户端可能会自动接受来自未包含在设备本地黑名单中的用户的文件传输邀请，前提是SDP中指示的大小低于文件传输警告大小（FT WARN SIZE）。请注意，在漫游场景中，默认情况下禁用自动接受，并且如果设置了FT AUT ACCEPT参数，RCS客户端应提供一个配置设置给用户，以便启用它。
- 如果FT AUT ACCEPT设置为禁用自动接受（即设置为0），文件传输将永远不会自动接受。

##### Flows

- ![[image-20231229102306778.png]]
  - 客户端在传输下一个文件块之前，不需等待MSRP 200 OK响应，将文件以不同的MSRP块发送。
  - 为了成功地传输文件，客户端应在接收到文件的所有块的MSRP 200 OK响应之后，才发送SIP BYE。
- ![[image-20231229102555561.png]]

#### Geolocation Push services

##### Feature description

- Geolocation services 包括以下两个特性：
  1. "Geolocation PUSH"服务允许RCS用户将位置信息（可以是用户位置或建议的会面地点的位置）推送给另一个RCS用户。
  2. "Geolocation PULL"服务允许RCS用户获取另一个RCS用户的位置信息。
- 值得注意的是，类似的服务可以通过与地理位置存在信息交互的SPI来提供。引入这些服务的原因是，当SPI地理位置信息无法使用时，RCS 5.1用户可能有兴趣共享地理位置信息：
  - SPI: Social Presence Information
  - 因为服务提供商不提供SPI服务（如果这两个用户属于同一服务提供商），或者其中一个服务提供商不提供SPI服务（如果这两个用户不属于同一服务提供商）。
  - 因为服务提供商提供SPI服务（或者两个服务提供商都提供SPI服务，如果这两个用户不属于同一服务提供商），但这两个用户不想共享社交信息。

##### Interaction with other RCS features

- 在已建立的语音/视频通话（单点或多点）或已建立的RCS聊天的情境下，可以使用该功能交互。

##### Technical Realization

- RCS File Transfer服务被用于传递地理位置信息。在群聊中分享位置时，基于群聊的File Transfer是其基础
- 在语音或视频通话中（假设用户希望将位置发送给通话中的对方），使用的是RCS File Transfer 服务来传递地理位置信息。

- ![[image-20230505133610401.png]]
- ![[image-20230505133626507.png]]
  - ![[image-20231229104939074.png]]

##### Flows

- ![[image-20231229111130655.png]]
- PULL
  - ![[image-20231229111544122.png]]
  - ![[image-20231229111427161.png]]
  - ![[image-20231229111639885.png]]

## RCS 服务部署

- 来源：NG.125-v1.0-1 MMTEL RCS NNI Overview
  - NNI：Network-to-Network Interface
- 由于历史原因，MMTEL和RCS服务的部署独立进行，并且在设备端使用不同的IMS客户端和不同的IMS核心网络来提供服务。
  随后，出现了一个旨在通过单一的IMS客户端提供MMTEL和RCS服务的倡议，以实现所谓的融合IP通信设备。这一倡议在GSMA PRD NG.102 [1]中有所描述。这样的设备可以部署在以下任一环境中：
  - 在单注册模式下，设备将注册到一个融合的IMS核心网络，以提供所有（MMTEL和RCS）服务。
  - 在双注册模式下，设备将进行两次注册。一次注册是向提供仅MMTEL服务的IMS核心网络注册，而第二次注册是向提供仅RCS服务的IMS核心网络注册。
    - 在实践中，也有可能将两个IMS注册都注册到同一个IMS核心。然而，这只是一个特殊情况。从NNI互通的角度来看，这样的部署可以暴露一个NNI，与单一融合的IMS核心网络完全相同，也可以同时暴露两个独立的NNI。
    - 设备上的配置可以控制注册模式。

#### RCS Deployment Architectures

- 不同RCS部署方式的基本区别在于是使用单一IMS注册还是使用双重IMS注册，但在双重注册的情况下还存在一些其他差异，导致存在5种已确定的RCS部署架构
  - 所有服务都在单一融合的IMS核心网络上。通常使用单一IMS注册，但也适用于向同一IMS核心网络进行双重IMS注册。这样的融合IMS核心网络由移动网络运营商拥有。
  - 双重IMS核心网络（一个用于MMTEL服务，一个用于RCS服务），两个核心网络都由移动网络运营商拥有。
  - 双重IMS核心网络（一个用于MMTEL服务，一个用于RCS服务），其中MMTEL IMS核心网络由移动网络运营商拥有，RCS IMS核心网络由第三方拥有，并遵守移动网络运营商的条款和条件。
  - 双重IMS核心网络（一个用于MMTEL服务，一个用于RCS服务），其中MMTEL IMS核心网络由移动网络运营商拥有，RCS IMS核心网络由第三方提供托管的RCS解决方案，并获得移动网络运营商的同意（即使用第三方的条款和条件，但使用基于移动国家代码/移动网络代码（MCC/MNC）的域名进行配置）。
  - 双重IMS核心网络（一个用于MMTEL服务，一个用于RCS服务），其中MMTEL IMS核心网络由移动网络运营商拥有，RCS IMS核心网络由第三方提供未经移动网络运营商同意的托管RCS解决方案（即使用第三方的条款和条件，并使用专有的域名进行配置）

#### Different RCS Deployment Options  

- 建议采用基于ENUM的解决方案，向请求者返回一个或多个SIP URI。建议定义一些附加的URI字符串，以涵盖已经确定的所有不同部署选项。此外，使用推荐的结构来创建新的URI，并与当前在GSMA PRD NG.105 [3]中记录的内容保持一致并进一步完善。
- 根据已确定的部署选项，可以使用以下URI字符串：
  - Single IMS core network (MMTEL-only or MMTEL/RCS)
    - `“ims.mncXXX.mccXXX.3gppnetwork.org”`
  - Dual IMS core networks (both core networks are owned by the MNO).  
    - `“ims.mncXXX.mccXXX.3gppnetwork.org”` 
    - `“rcs.mncXXX.mccXXX.3gppnetwork.org”`
  - Dual IMS core networks (MMTEL IMS core network is owned by the MNO and the RCS IMS core network is owned by a 3rd party on behalf of the MNO.)
    - `“ims.mncXXX.mccXXX.3gppnetwork.org”` 
    - `“<provider id>.rcs.mncXXX.mccXXX.3gppnetwork.org”`
  - Dual IMS core networks (MMTEL IMS core network is owned by the MNO and the RCS IMS core network is owned by a 3rd party providing a hosted RCS solution with MNO consent).
    - `“ims.mncXXX.mccXXX.3gppnetwork.org”` 
    -  `“<provider id>.rcs.mncXXX.mccXXX.3gppnetwork.org”`
  - Dual IMS core networks (MMTEL IMS core network is owned by the MNO and the RCS IMS core network is owned by a 3rd party providing a hosted RCS solution without MNO consent).
    - `“ims.mncXXX.mccXXX.3gppnetwork.org”` 
    - `“<provider id>.rcs.3gppnetwork.org”`

# OMA DM

- protocol
  - OMA-TS-DM_Protocol-V2_0-20160209-A
  - OMA-TS-PushOTA-V2_3-20111122-A
  - OMA-TS-DM_Notification-V1_3-20101207-C

- 设备管理（Device Management）指的是从DM Authorities的角度，管理设备配置和其他受管理对象的过程。DM包括但不限于在设备中设置初始配置信息，对设备进行持久信息的后续更新，从设备中检索管理信息，对设备执行基本操作，以及处理设备生成的事件和警报。
- 设备管理（Device Management，DM）允许网络运营商、服务提供商或企业信息管理部门代表最终用户（Customer）执行设备配置的流程。
- 设备管理用于描述允许第三方代表终端用户（客户）进行设备配置的技术。第三方通常可以是运营商、服务提供商或企业信息管理部门。
  - 通过设备管理，外部方可以远程设置参数、进行故障排除、安装或升级软件。从广义上讲，设备管理包括三个部分：
    - 协议和机制：管理服务器与设备之间使用的协议。
    - 数据模型：用于远程操作的可用数据，例如浏览器和邮件设置。
    - 策略：策略决定谁可以操作特定参数或更新设备中的特定对象。
- 架构设计遵循OMA体系结构原则，通过将与传输中立要求与传输特定绑定分离，实现网络技术独立性。所描述的架构还可以预见到其他传输和代理类型的出现，而无需重新制定先前发布的文档。这样可以保护供应商和客户的投资，同时支持未来创新所需的扩展性。
  - 设备管理机构可以：
    - 针对适用于所有实现的通用需求。
    - 关注给定网络环境的传输特定特性。
    - 通过调整供应商特定参数来激活终端特定行为。

## Overview

### Transaction Model

- OMA DM 协议运行在DM session的context中。DM session始终由DM客户端发起。
- DM服务器可以通过向DM客户端发送DM notification的方式来触发DM客户端发起DM会话。
- 一旦建立了DM会话，DM服务器向DM客户端发送DM命令并接收来自DM客户端的响应。DM客户端还通过通用警报（Generic Alerts）通知DM服务器设备上发生的事件。
- 只有DM服务器向DM客户端发送DM命令，DM客户端不能发送任何DM命令。DM服务器通过向DM客户端发送END命令来终止DM会话。
- OMA DM 2.0支持DM Packages 的概念。DM包的发起者应在发送另一个DM包之前等待接收者的响应。由于处理DM包可能需要不可预测的时间，OMA DM协议没有指定DM包之间的任何超时时间。
- DM包只能在兼容HTTP的协议之上传输。

### Security Considerations

- 设备管理是一项敏感的操作，涉及到机密和保密数据（例如密码），因此建议在安全和认证的环境中执行设备管理操作。OMA DM规范并未提供完整的安全功能，但可以利用底层机制来实现安全管理操作

### Management Data Delivery using HTTP

## Package Flow

- ![[image-20240129112306345.png]]
  - 步骤0（Package＃0）：DM服务器通过发送DM通知请求DM客户端启动DM会话。此DM通知称为“Package＃0”。这是一个可选的包流程，因为在客户端发起的情况下不需要DM通知。
  - 步骤1（Package＃1）：DM客户端通过发送“Package＃1”发起DM会话：该包可以包含DM客户端支持的MO的信息，DM服务器可以利用这些信息进行管理操作。
  - 步骤2（Package＃2）：在接收到Package＃1或Package＃3之后，DM服务器向DM客户端发送管理命令：包含DM命令的包被称为“Package＃2”。
  - 步骤3（Command Processing）：DM客户端按顺序处理在Package＃2中收到的DM命令；它可能与DM服务器以外的外部组件进行交互（例如，在SHOW命令的情况下是Web浏览器组件，在HGET / HPOST / HPUT命令的情况下是数据存储库）。
  - 步骤4（Package＃3）：如果Package＃2中不包含END命令，则DM会话继续，DM客户端通过发送“Package＃3”响应DM服务器，其中包含DM命令执行的结果。在Package＃3之后，包流程回到步骤2，由DM服务器发送Package＃2。
  - DM会话由Package＃1到Package＃3的流程定义；Package＃0和由DM客户端发起的HTTP事务来执行提供的DM命令不是DM会话的正式组成部分。

### Package#0: DM Notification

- 许多设备由于安全原因，无法持续监听管理服务器的连接请求，而且有些设备也不愿意开放端口以接受连接。然而，大多数设备可以接收主动通知，有时也被称为“notifications ”。例如，某些手机可以接收短信通知，其他设备可能具备接收类似数据报的消息的能力。DM服务器可以利用这种通知能力要求DM客户端启动DM会话。
- DM通知包括一些强制性参数，称为头部（Headers），以及一些可选参数，称为选项（Options）：选项的数量由头部确定。此数据包的格式在第7.1节中有明确规定。
- DM服务器必须支持Package#0。如果DM客户端至少支持附录中描述的一种传输机制，则必须支持Package#0。

#### Package Headers

- 在DM通知中，所有的头部都必须存在：DM服务器和DM客户端必须支持Package头部。
  - 版本（Version ，VER）：VER字段指定了DM服务器发送的DM通知的版本。本规范的值必须为0x02。请注意，这不是DM协议的版本，而是DM通知的版本。
  - 选项计数（Options Count，OC）：OC字段指定了DM通知中选项的数量。

#### Package Options

- Standard Options  

- | Option No | Name               | Value Format | DM Client Support | DM Server Support | Occurrence |
  | --------- | ------------------ | ------------ | ----------------- | ----------------- | ---------- |
  | 1         | SERVER-ID          | String       | Mandatory         | Mandatory         | ZeroOrOne  |
  | 2         | PREFERRED-CON-TYPE | Opaque       | Mandatory         | Mandatory         | ZeroOrOne  |
  | 3         | NOTIFICATION-ID    | Uint         | Optional          | Mandatory         | ZeroOrOne  |
  | 4         | SHA256-DIGEST      | Opaque       | Optional          | Mandatory         | ZeroOrOne  |
  | 5         | TIMESTAMP          | Opaque       | Optional          | Mandatory         | ZeroOrOne  |
  | 6         | REQ-MOS            | Null         | Mandatory         | Mandatory         | ZeroOrOne  |

  - 选项的值的格式必须是以下格式之一：
    - Uint：一个非负整数，使用Option Length决定的字节数以网络字节顺序表示。Option Value的取值范围由2的Option Length次方计算得出，以位为单位。例如，如果Option Length为2，则Option Value的取值范围为0-65535。
    - String：一个Unicode字符串，使用UTF-8[RFC3629]以Net-Unicode形式[RFC5198]进行编码。请注意，ASCII字符串（不使用特殊控制字符）始终是有效的UTF-8 Net-Unicode字符串。
    - Opaque：一个不透明的字节序列。当需要除Uint或String之外的其他类型时，可以使用此类型。如何处理此类型取决于使用此类型的选项。
    - Null：该选项不携带任何值。

##### 字段说明

- 服务器标识选项（SERVER-ID）：服务器标识选项指定了DM服务器的服务器标识符。这与DM账户MO中的标识符相同。如果DM客户端能够发现发送DM通知的DM服务器的服务器标识符，则此选项可能不存在。

- 首选连接类型选项（PREFERRED-CON-TYPE）：首选连接类型选项指定了DM客户端被要求使用的首选连接类型来连接到DM服务器。如果指定了多个首选连接，则出现在第一位的连接优先级高于其他可用的传输介质。如果可用，DM客户端应该首先使用优先级较高的首选连接。如果没有任何指定的首选连接可用，DM客户端应该等待，直到其中一个可用，除非使用了"ANY_AVAILABLE"。如果使用了"ANY_AVAILABLE"，它必须放在首选连接的末尾，并且如果所有优先级较高的连接当前不可用，DM客户端应该选择当前可用的任何连接类型。

  - 此选项的值必须是以下之一：

    - | Value | Semantics     | Description                                                  |
      | ----- | ------------- | ------------------------------------------------------------ |
      | 0x00  | ANY_AVAILABLE | Indicates the preferred connection is anything currently available |
      | 0x01  | CELLULAR      | Indicates the preferred connection is cellular, e.g. GSM/CDMA/UMTS/LTE |
      | 0x02  | WLAN          | Indicates the preferred connection is WLAN. e.g. IEEE 802.11 a/b/g/n/ac |
      | 0x03  | WIRELINE      | Indicates the preferred connection is wireline               |

- 通知标识选项（NOTIFICATION-ID）
  - 通知标识选项用于指定用于检测DM通知的重复的16位无符号整数。如果底层传输提供了丢弃重复DM通知的功能，该选项可能不会被呈现。该选项的长度必须为2个字节。
  - DM客户端可能会多次接收相同的DM通知，并且可以通过该选项和发送DM通知的DM服务器的服务器标识符来检测重复。DM客户端必须丢弃重复的DM通知。
  - DM服务器必须正确设置该选项，以便DM客户端能够检测到重复。例如，DM服务器可以为每个单独的DM通知逐步增加该字段。
- SHA256摘要选项（SHA256-DIGEST）：SHA256摘要选项用于指定DM通知的摘要。该选项的长度必须为32个字节。DM服务器必须按以下方式设置该选项：
  - 步骤1：DM服务器使用该选项准备DM通知。该选项的初始值必须设置为全零（零摘要），并且所有其他选项必须适当设置。
  - 步骤2：DM服务器根据[RFC6234]计算SHA256摘要。哈希函数的输入必须是DM服务器密钥和DM通知的串联（即Digest=Hash(server-secret|notification-message|auth-data)）。请注意，在此步骤中，DM通知的摘要（零摘要）值为全零。
  - 步骤3：DM服务器用计算得到的摘要替换零摘要。
- 时间戳选项（TIMESTAMP）
  - 时间戳选项用于指定DM服务器发送DM通知的时间。此时间信息可用于防止回复攻击。该选项的值必须是POSIX格式[POSIX]中的时间。当接收到带有该选项的DM通知时，如果该选项指示的时间过旧（具体实现决定），DM客户端可以选择忽略该DM通知。
- 请求MOS选项（REQ-MOS）
  - REQ-MOS选项要求在第1个软件包中按照规定发送MOS数组。该选项不携带任何值。

### Package#1: DM Session Initiation by DM Client

- DM会话由DM客户端发起，它将Package#1发送给DM服务器。
  DM服务器和DM客户端必须支持此包。
  该包必须被实现为HTTP POST请求，OMADM-DevID HTTP头必须包含DevInfo MO中DevInfo/DevID节点的值。

### Package#2: DM Commands from DM Server to DM Client

- DM服务器作为对Package#1或Package#3的响应，向DM客户端发送Package#2，以发送DM命令。可以列出多个DM命令，并且DM命令必须按顺序排列，因为DM客户端必须按照此顺序依次处理DM命令。同一个DM命令也可以多次列出。
- DM服务器和DM客户端必须支持此包。
- 该包必须作为HTTP响应实现，以携带Package#1的HTTP请求。
- Package#2由DM服务器用于将有序的DM命令列表发送给DM客户端执行；列表的每个项包含：
  - DM命令
  - DM命令的参数列表

### Package#3: Response Package from DM Client to DM Server

- DM客户端将Package#3作为对Package#2的响应发送给DM服务器。如果Package#2包含END命令，则不得发送此Package#3。
- DM服务器和DM客户端必须支持此包。
- 该包必须被实现为HTTP POST请求，OMADM-DevID HTTP头必须包含DevInfo MO中DevInfo/DevID节点的值。

## DM Commands

- | Command | Description                                                  | DM Server support | DM Client support |
  | ------- | ------------------------------------------------------------ | ----------------- | ----------------- |
  | HGET    | The DM Server uses this command to requests the DM Client to retrieve data from the Data Repository using HTTP GET, and add or replace the received data into the DM Tree | MUST              | MUST              |
  | HPUT    | The DM Server uses this command to request the DM Client to send data to the Data Repository using HTTP PUT | MUST              | MUST              |
  | HPOST   | The DM Server uses this command to request the DM Client to send data to the Data Repository using HTTP POST | MUST              | MUST              |
  | DELETE  | The DM Server uses this command to delete data in the DM Tree | MUST              | MUST              |
  | EXEC    | The DM Server uses this command to execute an executable node in the DM Tree | MUST              | MUST              |
  | GET     | The DM Server uses this command to retrieve data from the DM Tree. The DM Client sends the data within the current DM Session | MUST              | SHOULD            |
  | SHOW    | The DM Server uses this command to initiate a UI Session between the Web Browser Component and the Web Server Component | MUST              | SHOULD            |
  | CONT    | The DM Server uses this command for the DM Client to continue the DM Session with the specified DM Server URI | MUST              | MUST              |
  | END     | This command is used by the DM Server to terminate the DM session | MUST              | MUST              |
  | DEFAULT | Configure the DM Client to use a specific address to capture configuration if that is missing in the device for an specific MOID | MUST              | SHOULD            |
  | SUB     | The DM Server uses this command to request to the DM Client to report (subscribe) changes in the DM Tree part identified by the provided ClientURI | SHOULD            | SHOULD            |
  | UNSUB   | The DM Server uses this command to request to the DM Client to revoke previous subscription to notification for changes in the DM Tree part identified by the provided ClientURI | SHOULD            | SHOULD            |

## Generic Alert

- DM服务器和DM客户端必须支持通用警报机制。

- 协议定义了一个通用警报消息，用于由DM客户端生成的与MO相关的警报：在这种情况下，SourceURI属性必须标识MO的地址。

- 通用警报生成后，DM客户端可以随时使用Package#1或Package#3向DM服务器发送通用警报消息。通用警报消息只能从DM客户端发送到DM服务器。

- 通用警报可能对Data属性的格式和内容有额外的要求：如果接收到无法识别的AlertType或无法识别的Data属性，则DM服务器必须默默忽略通用警报。无论DM服务器是否成功处理通用警报，都不得向DM客户端发送任何通用警报的状态码。

- 以下表格总结了通用警报支持的属性：

  - | Property  | Description                                                  | Occurrence |
    | --------- | ------------------------------------------------------------ | ---------- |
    | AlertType | The type of the Generic Alert                                | One        |
    | SourceURI | The address to the node in the MO that is related to this Generic Alert | ZeroOrOne  |
    | TargetURI | The additional address related to the Generic Alert. This MUST be a ClientURI as specified in the section 6.1. The usage of the TargetURI is not specified in this specification. | ZeroOrOne  |
    | Mark      | The importance level. The following values are defined: "fatal", "critical", "minor", "warning", "informational", "harmless" and "indeterminate". If the parameter is omitted then the default importance level "informational" is assumed. | ZeroOrOne  |
    | DataType  | The Media Type of the Data content. This property MUST be present if the Data property exists. | ZeroOrOne  |
    | Data      | The additional data for the Generic Alert. The format and the content of the Data are not specified in this specification | ZeroOrOne  |

## HTTP Error handling  

- 如果DM客户端收到对HTTP请求的"4XX"响应代码，并且无法从中恢复，则必须将DM会话视为中止；DM客户端不得重试连接到DM服务器。
- 如果DM客户端收到对HTTP请求的"5XX"响应代码，或者HTTP请求超时（由于连接问题），则必须将DM会话视为中止；DM客户端不得重试连接到DM服务器。

## Push Over The Air

### Introduction

- OMA Push Over-the-Air (Push-OTA)是一组协议及其与各种网络承载的绑定，通过这些协议和绑定，Push代理网关（PPG）或其他推送服务器与推送客户端进行交互，以实现网络发起内容传递到由推送客户端提供的客户端应用程序。OMA推送启用器的架构模型和启用器实体（PPG和推送客户端）在[PushArch]中引入。
  - ![[image-20240129150134042.png]]

- Push-OTA支持各种协议变体和承载绑定
  - Push-OTA协议提供了“无连接”和“面向连接”的服务。面向连接的服务是指推送客户端与PPG建立了特定的传输层“连接”，用于接收基于推送的服务。面向连接的服务通过WAP1无线会话协议（WSP）作为OTA-WSP推送协议、通过基于WAP2的OTA-HTTP推送协议和基于SIP的OTA-SIP推送协议来支持。无连接的服务不依赖于推送客户端和PPG之间预先建立/特定的连接，并且通过OTA-WSP、OTA-SIP和OTA-PTM支持。
  - OTA-PTM是点对多点推送（PTM-Push）中使用的协议变体，指的是在点对多点承载之间进行的推送操作，其中包括MBMS、CBS和BCAST。OTA-PTM被认为支持无连接的服务。虽然推送客户端主动监听OTA-PTM承载上的推送事件，但推送客户端和PPG之间没有创建特定的对话。
    与面向连接的服务相关的重要补充是会话初始化应用程序（SIA），通过该应用程序可以通过无连接推送服务上交付的会话初始化请求（SIR）来初始化连接。
    - 架构实体：推送客户端和推送代理网关
    - 接口
      - Push Over-the-Air协议变体
        - OTA-WSP：基于WAP1传输协议的点对点传递
        - OTA-HTTP：基于WAP2传输协议的点对点传递
        - OTA-SIP：基于SIP传输协议的点对点传递
        - OTA-PTM是基于MBMS、OMA BCAST和Cell Broadcast Service(CBS)作为传输协议的点对多点传输方法。
    - 以下外部实体提供Push客户端和/或Push服务器使用的功能和接口，用于适应Push-OTA协议的变种
      - 在网络端：
        - 通过短信息服务中心（Short Message Service Centers  ，SMSC）提供OTA-WSP/SMS
        - 通过蜂窝广播中心（Cell Broadcast Centers  ，CBC）提供OTA-PTM/CBS
        - 通过SIP/IP核心网络提供OTA-SIP
        - 通过MBMS广播组播服务中心（Broadcast Multicast Service Centers  ，BM-SC）提供OTA-PTM/MBMS
        - 通过OMA BCAST服务分发/适配提供OTA-PTM/BCAST
      - 在客户端：
        - 通过短信客户端（SMS Clients）提供OTA-WSP/SMS和OTA-PTM/CBS
        - 通过OMA BCAST客户端提供OTA-PTM/BCAST
        - 通过MBMS客户端提供OTA-PTM/MBMS

- ![[image-20240129151133426.png]]

### Protocol Variants

- ![[image-20240129151319594.png]]
  - “OTA-WSP”是WSP协议的一种变体，它提供了面向连接和无连接的推送功能。面向连接的OTA-WSP通过WTP/IP进行操作，而无连接的OTA-WSP则通过WDP/SMS或WDP/IP进行操作。
  - “OTA-HTTP”是HTTP协议的一种变体，仅提供面向连接的推送功能，并通过TCP/IP进行操作。如果在OTA-HTTP中实现TLS 以提供逐跳传输层安全性，则将此协议变体称为“OTA-HTTP-TLS”。
  - “OTA-SIP”是SIP协议的一种变体，提供面向连接和无连接的推送功能。OTA-SIP的安全性由底层的SIP/IP核心网络提供，如[SIPPush]中所述。面向连接的OTA-SIP通过SIP/(UDP或TCP)控制平面和MSRP/TCP/IP用户平面进行操作，而无连接的OTA-SIP则通过SIP/(UDP或TCP)控制平面进行操作。
  - “OTA-PTM”是PTM协议的一种变体，提供无连接的推送服务。这三种变体分别通过BCAST/FLUTE/IP、MBMS/TCP/IP和WSP/CBS进行操作。通过OTA-PTM传输的内容的安全性由底层的承载传输协议提供。
  - 终端在实现面向连接的推送时，必须支持OTA-WSP、OTA-HTTP或OTA-SIP中的一种连接导向服务，并且可以支持多种。推送代理网关可以实现所有变体，以支持各种移动终端。推送代理网关可以支持OTA-WSP、OTA-SIP或OTA-PTM提供的无连接服务。支持无连接承载（例如SMS）的终端必须支持OTA-WSP、OTA-SIP或OTA-PTM中的一种无连接服务。
  - 

### Push OTA Protocol over WSP (OTA-WSP)

- 描述了OTA-WSP的实现方式。该变体在WSP [W-TCP]的基础上运行，适用于不支持TCP/IP或SIP的低带宽传输介质，例如短信。

#### Overview

- 定义的原语包括推送操作原语和推送管理原语。推送操作原语用于从服务器（也称为“PPG”）向客户端（也称为“终端”）传递内容，而推送管理原语用于建立和管理推送会话。
  - ![[image-20240129152613909.png]]

##### Push Operational Primitives

###### Po-Push  

- 该原语用于通过面向连接的服务，在推送会话中以非确认方式从服务器发送信息。

- | Primitive Parameter | Po-Push |      |
  | ------------------- | ------- | ---- |
  |                     | req     | ind  |
  | Push Headers        | O       | C(=) |
  | Authenticated       | O       | C(=) |
  | Trusted             | O       | C(=) |
  | Last                | O       | C(=) |
  | Push Body           | O       | C(=) |

  - 推送头部在[PushMsg]中被定义。
  - 通过Authenticated参数，指示发起者URI是否通过服务器进行身份验证。
  - 通过Trusted参数，指示推送内容是否被服务器信任。这为客户端提供了一种将信任策略委托给服务器（例如PPG）的机制。
  - 通过Last参数，向客户端暗示这是服务器最后一条消息。客户端可以在这之后终止网络传输。
  - 推送正文是推送中的内容，语义上相当于HTTP实体正文。如果推送正文为空，则必须先检查和使用其他参数（例如，传输或缓存控制），然后忽略空的推送正文。

###### Po-ConfirmedPush  

- 这个原语被用于通过面向连接的服务，在推送会话中以确认的方式从服务器发送信息。服务用户（例如客户端推送应用程序）通过调用Po-ConfirmedPush.res原语来确认推送，当服务用户对推送消息负责时。如果服务用户无法对推送消息负责，必须通过调用Po-PushAbort.req原语来中止推送操作。服务提供者可以根据自己的判断代表服务用户中止推送（例如，如果服务用户不做出响应）。

###### Po-PushAbort  

- 用于拒绝推送操作，它是ConfirmedPush机制的一部分。它直接映射到[W-TCP]中的S-PushAbort原语。

###### Po-Unit-Push  

- 用于在无连接会话服务[W-TCP]中以不确认的方式从服务器向客户端发送信息。

##### Push Management Primitives  

###### Pom-Connect  

- 用于按照客户端的请求创建推送会话。它被映射到WSP [WTCP]中的S-Connect原语，并带有附加参数。

###### Pom-Suspend  

- 用于请求暂停推送会话，以确保不允许任何活动。该原语直接映射到WSP [W-TCP]中的S-Suspend原语。

#### Protocol Description

- OTA-WSP提供了描述的无连接和面向连接的推送功能。

##### Connectionless Push

- 传输无连接的推送必须通过WSP S-Unit-Push [W-TCP]来执行，它是WSP无连接会话服务原语之一。每个支持无连接推送的客户端都保留了两个已注册的WDP端口[WDP]，分别是安全端口和非安全端口。客户端必须支持非安全端口，可以选择支持安全端口。如果支持安全端口，则必须在该端口上支持WTLS。为了适应服务器发起的WTLS连接，支持安全无连接推送的客户端必须能够作为收到Hello Request消息[WTLS]后发起WTLS协商过程。在这样做时，客户端必须使用Hello Request消息来源的地址四元组。为了防止欺骗，客户端应通过将Hello Request消息的源地址与可信服务器的预先存在的联系点列表进行比较来验证Hello Request。如果验证失败，客户端应忽略Hello Request消息。

##### Connectionless Push over SMS

- 在使用短信承载类型[WDP]执行无连接推送时，需要注意推送的有效负载大小。如果要使用该承载推送较大的有效负载，它将会自动分段成多个较小的协议PDU[WDP]。
- 如果存在大量这些较小的PDU的情况下，可能会出现操作困难（如消息量大、传输延迟等）以及移动设备上的串接问题（缓冲、超时等）。
- 因此，建议将整体有效负载大小限制在不超过4条短信的范围内。最有效的使用短信承载类型的方式是限制消息有效负载，使其能够封装在单条短信中。服务器必须支持至少4条短信的分段。
- 客户端必须支持至少4条短信的重组。
- 有效负载大小的限制不适用于实验性内容类型或服务。
- 推送内容有效负载的限制应由PPG进行管理，并取决于承载类型、服务和推送发起方。

##### Connection-orientated Push  

- 连接导向的推送必须通过WSP会话服务原语中的S-Push（例如未确认的推送）或S-ConfirmedPush来执行。必须建立一个推送会话来执行这些原语。推送会话是一个启用了已确认、未确认或二者都启用的推送能力的WSP会话[W-TCP]。
  推送会话可以使用安全或非安全的传输服务。服务器端口号在[WDP]中为这两种选项保留。如果需要安全传输服务，则必须使用WTLS。如果联系点中的端口号是已注册的安全端口[WDP]，或者在PPG的预先存在的联系点列表中指示了安全传输，则需要安全传输服务。